<!doctype html><html lang=zh itemscope itemtype=http://schema.org/WebPage><head><meta name=generator content="Hugo 0.109.0"><meta charset=utf-8><title>Doris集群弹性扩缩容 · ChenSoul</title><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=description content="Doris 可以很方便的扩容和缩容 FE、BE、Broker 实例，本文主要是对此做一些测试，记录笔记。 集群说明 在测试环境安装和部署了三个节点的集群，每个"><meta name=keywords content="devops,programming"><meta name=google-site-verification content="D8XBzUhT4irNUQLKut79HFni0v3Xow4FY-oxUcsUlVk"><link rel=canonical href=https://blog.chensoul.com/posts/2022/08/18/doris-cluster-elastic-expansion/><link rel=stylesheet href=https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css integrity=sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.2.0/css/all.min.css integrity="sha512-6c4nX2tn5KbzeBJo9Ywpa0Gkt+mzCzJBrE1RB6fmpcsoN+b/w/euwIMuQKNyUoU/nToKN3a8SgNOtPrbW12fug==" crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=https://blog.chensoul.com/css/den.css><link rel=stylesheet href=https://blog.chensoul.com/css/custom.css><meta property="og:title" content="Doris集群弹性扩缩容"><meta property="og:description" content="Doris 可以很方便的扩容和缩容 FE、BE、Broker 实例，本文主要是对此做一些测试，记录笔记。 集群说明 在测试环境安装和部署了三个节点的集群，每个"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.chensoul.com/posts/2022/08/18/doris-cluster-elastic-expansion/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-08-18T11:26:27+08:00"><meta property="article:modified_time" content="2022-08-18T11:26:27+08:00"><meta itemprop=name content="Doris集群弹性扩缩容"><meta itemprop=description content="Doris 可以很方便的扩容和缩容 FE、BE、Broker 实例，本文主要是对此做一些测试，记录笔记。 集群说明 在测试环境安装和部署了三个节点的集群，每个"><meta itemprop=datePublished content="2022-08-18T11:26:27+08:00"><meta itemprop=dateModified content="2022-08-18T11:26:27+08:00"><meta itemprop=wordCount content="3029"><meta itemprop=keywords content="doris,"><meta name=twitter:card content="summary"><meta name=twitter:title content="Doris集群弹性扩缩容"><meta name=twitter:description content="Doris 可以很方便的扩容和缩容 FE、BE、Broker 实例，本文主要是对此做一些测试，记录笔记。 集群说明 在测试环境安装和部署了三个节点的集群，每个"></head><body><div class=header-container style=background:linear-gradient(rgba(0,0,0,.2),rgba(0,0,0,.2)),url(https://blog.chensoul.com/images/background.webp);background-position:50%;background-size:cover><div class=container><nav class="header-nav navbar navbar-expand-md navbar-dark light-dark"><div class="header-logo navbar-brand"><a class=float-left href=https://blog.chensoul.com/><img class="mr20 header-logo-image" src=https://blog.chensoul.com/images/fly.png alt=logo>
ChenSoul</a></div><button class=navbar-toggler type=button data-toggle=collapse data-target=#navbarNav aria-controls=navbarNav aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="nav-menu collapse navbar-collapse" id=navbarNav><ul class=navbar-nav><li class=nav-item><a class=nav-link href=https://blog.chensoul.com/categories/ideas/>思考</a></li><li class=nav-item><a class=nav-link href=https://blog.chensoul.com/links/>友链</a></li><li class=nav-item><a class=nav-link href=https://blog.chensoul.com/about/>关于</a></li><li class=nav-item><a class=nav-link href=https://blog.chensoul.com/search/>搜索</a></li></ul></div></nav></div><div class="container header-wrapper"><div class=row><div class=col-lg-12><div class=header-content><h1 class=header-title>Doris集群弹性扩缩容</h1><p class=header-date>作者:
chensoul
| <span>3029 字, 7 分钟</span>
| 2022-08-18
| 分类:
<a href=https://blog.chensoul.com/categories/notes/>Notes</a></p><div class=header-underline></div><div class=clearfix></div><p class="float-right header-tags"><i class="fas fa-tags" aria-hidden=true></i>
<a href=https://blog.chensoul.com/tags/doris/>doris</a></p></div></div></div></div></div><main><div class="container content"><article><p>Doris 可以很方便的扩容和缩容 FE、BE、Broker 实例，本文主要是对此做一些测试，记录笔记。</p><h2 id=集群说明>集群说明</h2><p>在测试环境安装和部署了三个节点的集群，每个节点混合部署了 FE 和 BE：</p><ul><li>192.168.1.107：部署了 FE、BE</li><li>192.168.1.108：部署了 FE、BE</li><li>192.168.1.109：部署了 FE、BE</li></ul><p>在操作集群之前，有必要了解 doris 的架构：</p><p><img src=https://chensoul.oss-cn-hangzhou.aliyuncs.com/images/doris-overview.png alt=doris架构></p><p>Doris 有两种进程：</p><ul><li>FE：主要负责用户请求的接入、查询解析规划、元数据的管理、节点管理相关工作。FE 节点个数至少为为1，最好必须为奇数，因为多个 FE 需要进行选举。根据选举出来的结果，分为两种角色：<ul><li>Follower：可以为一个或者多个。如果只有一个，则当前 Follower 默认为 Master。如果存在多个 FE，则进行选举之后，会选出一个 FE 作为 Master。同一个时间，有且只有一个 Master。当 Master FE 宕掉之后，会重新选举出下一个 Master。所以，为了保证 FE 的高可用，一般建议 FE 部署多个节点（大于等于3）。</li><li>Observer：可以为0个或者多个。Observer 的存在是为了保证读高可用。</li></ul></li><li>BE：主要负责数据存储、查询计划的执行。</li></ul><h2 id=集群状态>集群状态</h2><p>通过 mysql 客户端连接 FE master，查询当前集群状态：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>mysql -h 192.168.1.107 -P <span class=m>9030</span> -uroot
</span></span></code></pre></div><p>查询 BE 状态：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=n>mysql</span><span class=o>&gt;</span><span class=w> </span><span class=k>SHOW</span><span class=w> </span><span class=n>PROC</span><span class=w> </span><span class=s1>&#39;/backends&#39;</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><p>结果如下：</p><p><img src=https://chensoul.oss-cn-hangzhou.aliyuncs.com/images/doris-be-status.png.png alt=doris-be-status></p><p>查询 FE 状态：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=n>mysql</span><span class=o>&gt;</span><span class=w> </span><span class=k>SHOW</span><span class=w> </span><span class=n>PROC</span><span class=w> </span><span class=s1>&#39;/frontends&#39;</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><p>结果如下：</p><p><img src=https://chensoul.oss-cn-hangzhou.aliyuncs.com/images/doris-fe-status.png alt=doris-fe-status></p><p>从上面可以看到：</p><ul><li>IP</li><li>HostName：主机名称</li><li>Role：角色，所有节点都是 Follower 角色</li><li>IsMaster：192.168.1.107 节点为 Master Follower</li><li>Join：三个 FE 是否加入了集群</li></ul><p>也可以通过 http://192.168.1.107:8030/System?path=//frontends 和 http://192.168.1.107:8030/System?path=//backends 来查看 FE 和 BE 状态。</p><h2 id=fe-扩容和缩容>FE 扩容和缩容</h2><p>FE 节点的扩容和缩容过程，不影响当前系统运行。</p><p>FE 分为 Follower 和 Observer 两种角色。 默认一个集群，可以有多个 Follower 和 Observer。其中多个 Follower 组成一个 Paxos 选择组，集群启动时，Follower 会选举出一个 Master。如果 Master 宕机，则剩下的 Follower 会自动选出新的 Master，保证写入高可用。Observer 同步 Master 的数据，但是不参加选举。如果只部署一个 FE，则 FE 默认就是 Master。</p><p>第一个启动的 FE 自动成为 Master。在此基础上，可以添加若干 Follower 和 Observer。</p><h4 id=增加-fe-节点>增加 FE 节点</h4><p><strong>1、配置及启动 Follower 或 Observer</strong></p><p>Follower 和 Observer 的配置是相同的，都是通过 fe/conf/fe.conf 进行配置。</p><p>在新添加的节点上启动 FE，使用下面的命令：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>fe/bin/start_fe.sh --helper leader_fe_host:edit_log_port --daemon
</span></span></code></pre></div><blockquote><p>说明：</p><p>其中 leader_fe_host 为 Leader 所在节点 ip，edit_log_port 在 Leader 的配置文件 fe.conf 中。<code>--helper</code> 参数仅在 follower 和 observer 第一次启动时才需要。</p></blockquote><p>测试过程中，我是选择 192.168.1.107 作为 FE Master，新添加的节点为 192.168.1.110，所以，在 192.168.1.110 节点第一次启动 FE 命令如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>fe/bin/start_fe.sh --daemon --helper 192.168.1.107:9010 
</span></span></code></pre></div><p><strong>2、将 Follower 或 Observer 加入到集群</strong></p><p>使用 mysql 客户端连接 FE Master：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>mysql -h 192.168.1.107 -P <span class=m>9030</span> -uroot
</span></span></code></pre></div><p>然后，执行下面命令：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ALTER SYSTEM ADD FOLLOWER <span class=s2>&#34;192.168.1.110:9010&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=c1># 或者</span>
</span></span><span class=line><span class=cl>ALTER SYSTEM ADD OBSERVER <span class=s2>&#34;192.168.1.110:9010&#34;</span><span class=p>;</span>
</span></span></code></pre></div><p>使用上面哪个命令，取决于你想让新节点以 FOLLOWER 角色还是 OBSERVER 角色加入集群。</p><blockquote><p><strong>FE 扩容注意事项：</strong></p><ol><li>Follower FE（包括 Master）的数量必须为奇数，建议最多部署 3 个组成高可用（HA）模式即可。</li><li>当 FE 处于高可用部署时（1个 Master，2个 Follower），我们建议通过增加 Observer FE 来扩展 FE 的读服务能力。当然也可以继续增加 Follower FE，但几乎是不必要的。</li><li>通常一个 FE 节点可以应对 10-20 台 BE 节点。建议总的 FE 节点数量在 10 个以下。而通常 3 个即可满足绝大部分需求。</li><li>helper 不能指向 FE 自身，必须指向一个或多个已存在并且正常运行中的 Master/Follower FE。</li></ol></blockquote><h4 id=删除-fe-节点>删除 FE 节点</h4><p>使用以下命令删除对应的 FE 节点：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>ALTER</span><span class=w> </span><span class=k>SYSTEM</span><span class=w> </span><span class=k>DROP</span><span class=w> </span><span class=n>FOLLOWER</span><span class=p>[</span><span class=n>OBSERVER</span><span class=p>]</span><span class=w> </span><span class=s2>&#34;fe_host:edit_log_port&#34;</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><blockquote><p><strong>FE 缩容注意事项：</strong></p><ol><li>删除 Follower FE 时，确保最终剩余的 Follower（包括 Master）节点为奇数。</li></ol></blockquote><h4 id=测试增加和删除-fe-节点>测试增加和删除 FE 节点</h4><p><strong>1、测试 3 个 FE 节点情况下，删除1个FE</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=n>mysql</span><span class=w> </span><span class=o>-</span><span class=n>h</span><span class=w> </span><span class=mi>192</span><span class=p>.</span><span class=mi>168</span><span class=p>.</span><span class=mi>1</span><span class=p>.</span><span class=mi>107</span><span class=w> </span><span class=o>-</span><span class=n>P</span><span class=w> </span><span class=mi>9030</span><span class=w> </span><span class=o>-</span><span class=n>uroot</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mysql</span><span class=o>&gt;</span><span class=w> </span><span class=k>ALTER</span><span class=w> </span><span class=k>SYSTEM</span><span class=w> </span><span class=k>drop</span><span class=w> </span><span class=n>FOLLOWER</span><span class=w> </span><span class=s2>&#34;192.168.1.109:9010&#34;</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><p>查看 FE 状态，可以看到还有两个 FE，192.168.1.107 还是为 Master。</p><p><img src=https://chensoul.oss-cn-hangzhou.aliyuncs.com/images/doris-fe-status-01.png alt=doris-fe-status-01></p><p>根据上面的 <strong>FE 缩容注意事项</strong>，如果删除 FE 节点，需要保证最终剩余的 FE 的总数为奇数。在删除一个节点之后，FE 个数为 2，FE 状态均为正常。</p><p>这时候，如果 Master 宕机了，剩下一个 FE 会成为 Master 吗？我们来停止 192.168.1.107 的 FE。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>fe/bin/stop_fe.sh
</span></span></code></pre></div><p>然后，再来连接 FE Master，猜测这时候的 Master 应该为 192.168.1.108</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>mysql -h 192.168.1.108 -P <span class=m>9030</span> -uroot
</span></span></code></pre></div><p>查看 FE 状态，却提示异常，说明剩下的2个节点（其中一个节点为宕机状态）无法选举出 Master。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=n>mysql</span><span class=o>&gt;</span><span class=w> </span><span class=k>SHOW</span><span class=w> </span><span class=n>PROC</span><span class=w> </span><span class=s1>&#39;/frontends&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>ERROR</span><span class=w> </span><span class=mi>1105</span><span class=w> </span><span class=p>(</span><span class=n>HY000</span><span class=p>):</span><span class=w> </span><span class=k>Exception</span><span class=p>,</span><span class=w> </span><span class=n>msg</span><span class=p>:</span><span class=w> </span><span class=n>Failed</span><span class=w> </span><span class=k>to</span><span class=w> </span><span class=k>get</span><span class=w> </span><span class=n>master</span><span class=w> </span><span class=n>client</span><span class=p>.</span><span class=w>
</span></span></span></code></pre></div><p>这时候再将 192.168.1.107 的 FE 启动起来：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>fe/bin/start_fe.sh --daemon
</span></span></code></pre></div><p>再通过客户端连接 FE，查看 FE 状态：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>mysql -h 192.168.1.108 -P <span class=m>9030</span> -uroot
</span></span></code></pre></div><p>可以看到 变成了 Master：</p><p><img src=https://chensoul.oss-cn-hangzhou.aliyuncs.com/images/doris-fe-status-02.png alt=doris-fe-status-02></p><p>这说明，<strong>剩余偶数个 FE 时，还是能选举出 Master？</strong></p><p>这时候，如果把不是 Master 的 FE 停止，会出现什么情况呢？</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>mysql -h 192.168.1.108 -P <span class=m>9030</span> -uroot
</span></span><span class=line><span class=cl>mysql&gt; SHOW PROC <span class=s1>&#39;/frontends&#39;</span><span class=p>;</span>
</span></span></code></pre></div><p>可以看到如下结果：</p><p><img src=https://chensoul.oss-cn-hangzhou.aliyuncs.com/images/doris-fe-status-03.png alt=doris-fe-status-03></p><p>说明：非 Master 节点宕机，不影响 Master FE 节点的运行，宕机的 FE 的 Alive 状态为 false，异常信息不为空，这里为：<code>socket is closed by peer.</code></p><p>稍等一会，会提示无法连接到服务：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>RROR <span class=m>2013</span> <span class=o>(</span>HY000<span class=o>)</span>: Lost connection to MySQL server during query
</span></span><span class=line><span class=cl>No connection. Trying to reconnect...
</span></span><span class=line><span class=cl>ERROR <span class=m>2003</span> <span class=o>(</span>HY000<span class=o>)</span>: Can<span class=s1>&#39;t connect to MySQL server on &#39;</span>192.168.1.108:9030<span class=s1>&#39; (111)
</span></span></span><span class=line><span class=cl><span class=s1>ERROR:
</span></span></span><span class=line><span class=cl><span class=s1>Can&#39;</span>t connect to the server
</span></span></code></pre></div><p>原因是 Master FE 也就是 192.168.1.108 节点上的 FE 宕机了，查看日志：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>com.sleepycat.je.rep.InsufficientReplicasException: <span class=o>(</span>JE 18.3.12<span class=o>)</span> Commit policy: SIMPLE_MAJORITY required <span class=m>1</span> replica. But none were active with this master.
</span></span><span class=line><span class=cl>at com.sleepycat.je.rep.impl.node.DurabilityQuorum.ensureReplicasForCommit<span class=o>(</span>DurabilityQuorum.java:116<span class=o>)</span> ~<span class=o>[</span>je-18.3.12.jar:18.3.12<span class=o>]</span>
</span></span><span class=line><span class=cl>	at com.sleepycat.je.rep.impl.RepImpl.txnBeginHook<span class=o>(</span>RepImpl.java:1171<span class=o>)</span> ~<span class=o>[</span>je-18.3.12.jar:18.3.12<span class=o>]</span>
</span></span><span class=line><span class=cl>	at com.sleepycat.je.rep.txn.MasterTxn.txnBeginHook<span class=o>(</span>MasterTxn.java:195<span class=o>)</span> ~<span class=o>[</span>je-18.3.12.jar:18.3.12<span class=o>]</span>
</span></span><span class=line><span class=cl>	at com.sleepycat.je.txn.Txn.initTxn<span class=o>(</span>Txn.java:384<span class=o>)</span> ~<span class=o>[</span>je-18.3.12.jar:18.3.12<span class=o>]</span>
</span></span></code></pre></div><p>手动启动 192.168.1.108 的FE 之后，查看日志：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>2022-08-18 18:22:54,958 INFO <span class=o>(</span>UNKNOWN 192.168.1.108_9010_1660793829444<span class=o>(</span>-1<span class=o>)</span><span class=p>|</span>1<span class=o>)</span> <span class=o>[</span>Catalog.waitForReady<span class=o>()</span>:876<span class=o>]</span> <span class=nb>wait</span> catalog to be ready. FE type: UNKNOWN. is ready: <span class=nb>false</span>
</span></span></code></pre></div><p>说明：192.168.1.108 的 FE 还没有获得正确的 FE 类型。原因应该是，目前集群只注册了两个 FE，却只有一个 FE 是存活状态，无法选举出 Master FE。</p><p>在 192.168.1.107 节点查看 FE 状态，发现 FE 也挂了，这时候手动启动 FE。发现，可以再次连接 FE。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>mysql -h 192.168.1.108 -P <span class=m>9030</span> -uroot
</span></span></code></pre></div><p><strong>总结：</strong></p><ul><li>1、删除 Follower FE 时，需要确保最终剩余的 Follower（包括 Master）节点为奇数。</li><li>2、删除 Follower FE 时，如果剩余的 Follower 不为奇数（目前测试的是剩余 2 个情况下），如果有一个 FE 宕掉，则另一个 FE 也会宕掉。所以，<strong>需要在 FE 宕掉之后，能够自动启动</strong>。也就是，在集群里，为了保证高可用，需要<strong>所有实例都应使用守护进程启动，以保证进程退出后，会被自动拉起</strong>。</li></ul><p><strong>2、测试 1 个 FE 节点情况下，添加 FE 节点</strong></p><h2 id=be-扩容和缩容>BE 扩容和缩容</h2><p>BE 节点的扩容和缩容过程，不影响当前系统运行以及正在执行的任务，并且不会影响当前系统的性能。数据均衡会自动进行。根据集群现有数据量的大小，集群会在几个小时到1天不等的时间内，恢复到负载均衡的状态。</p><h4 id=增加-be-节点>增加 BE 节点</h4><p>BE 节点的增加方式同 <strong>BE 部署</strong> 一节中的方式，通过 <code>ALTER SYSTEM ADD BACKEND</code> 命令增加 BE 节点。</p><blockquote><p>BE 扩容注意事项：</p><ol><li>BE 扩容后，Doris 会自动根据负载情况，进行数据均衡，期间不影响使用。</li></ol></blockquote><h4 id=删除-be-节点>删除 BE 节点</h4><p>删除 BE 节点有两种方式：DROP 和 DECOMMISSION</p><p>DROP 语句如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>ALTER</span><span class=w> </span><span class=k>SYSTEM</span><span class=w> </span><span class=k>DROP</span><span class=w> </span><span class=n>BACKEND</span><span class=w> </span><span class=s2>&#34;be_host:be_heartbeat_service_port&#34;</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><p><strong>注意：DROP BACKEND 会直接删除该 BE，并且其上的数据将不能再恢复！！！所以我们强烈不推荐使用 DROP BACKEND 这种方式删除 BE 节点。当你使用这个语句时，会有对应的防误操作提示。</strong></p><p>DECOMMISSION 语句如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>ALTER</span><span class=w> </span><span class=k>SYSTEM</span><span class=w> </span><span class=n>DECOMMISSION</span><span class=w> </span><span class=n>BACKEND</span><span class=w> </span><span class=s2>&#34;be_host:be_heartbeat_service_port&#34;</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><blockquote><p>DECOMMISSION 命令说明：</p><ol><li>该命令用于安全删除 BE 节点。命令下发后，Doris 会尝试将该 BE 上的数据向其他 BE 节点迁移，当所有数据都迁移完成后，Doris 会自动删除该节点。</li><li>该命令是一个异步操作。执行后，可以通过 <code>SHOW PROC '/backends';</code> 看到该 BE 节点的 <code>SystemDecommissioned</code> 状态为 true。表示该节点正在进行下线。</li><li>该命令<strong>不一定执行成功</strong>。比如剩余 BE 存储空间不足以容纳下线 BE 上的数据，或者剩余机器数量不满足最小副本数时，该命令都无法完成，并且 BE 会一直处于 <code>SystemDecommissioned</code> 为 true 的状态。</li><li>DECOMMISSION 的进度，可以通过 <code>SHOW PROC '/backends';</code> 中的 TabletNum 查看，如果正在进行，TabletNum 将不断减少。</li><li>该操作可以通过:
<code>CANCEL DECOMMISSION BACKEND "be_host:be_heartbeat_service_port";</code>
命令取消。取消后，该 BE 上的数据将维持当前剩余的数据量。后续 Doris 重新进行负载均衡</li></ol></blockquote><p><strong>对于多租户部署环境下，BE 节点的扩容和缩容，请参阅 <a href=https://doris.apache.org/zh-CN/docs/admin-manual/multi-tenant>多租户设计文档</a>。</strong></p><h2 id=broker-扩容缩容>Broker 扩容缩容</h2><p>Broker 实例的数量没有硬性要求。通常每台物理机部署一个即可。Broker 的添加和删除可以通过以下命令完成：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>ALTER</span><span class=w> </span><span class=k>SYSTEM</span><span class=w> </span><span class=k>ADD</span><span class=w> </span><span class=n>BROKER</span><span class=w> </span><span class=n>broker_name</span><span class=w> </span><span class=s2>&#34;broker_host:broker_ipc_port&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>ALTER</span><span class=w> </span><span class=k>SYSTEM</span><span class=w> </span><span class=k>DROP</span><span class=w> </span><span class=n>BROKER</span><span class=w> </span><span class=n>broker_name</span><span class=w> </span><span class=s2>&#34;broker_host:broker_ipc_port&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>ALTER</span><span class=w> </span><span class=k>SYSTEM</span><span class=w> </span><span class=k>DROP</span><span class=w> </span><span class=k>ALL</span><span class=w> </span><span class=n>BROKER</span><span class=w> </span><span class=n>broker_name</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><p>Broker 是无状态的进程，可以随意启停。当然，停止后，正在其上运行的作业会失败，重试即可。</p></article><h2>相关文章</h2><dl class=row><dt class=col-md-3>2022-08-18</dt><dd class=col-md-9><a href=/posts/2022/08/18/doris-external-table-load/>Doris通过外部表同步数据</a></dd><dt class=col-md-3>2022-08-18</dt><dd class=col-md-9><a href=/posts/2022/08/18/doris-install-deploy/>Doris安装和部署</a></dd></dl><div class=author-card><div class=underline></div><div class=author-box><div class=author-image><a href=https://blog.chensoul.com><img src=/images/author.webp alt=chensoul></a></div><div class=author-content><p class=author-title>作者</p><p class=author-name>chensoul</p><p class=author-desc>Java 开发工程师，喜欢探索新技术。 可以在 <a href=https://github.com/chensoul>GitHub</a> 了解更多关于我的信息。</p></div></div></div><div align=center><div class=comment-underline></div></div><br><div id=cusdis_thread data-host=https://cusdis.chensoul.com data-app-id=3fce9b16-7416-4c74-9786-757bf28c1b8b data-page-id=034c466a2daadeb9f444a4fea3838342 data-page-url=https://blog.chensoul.com/posts/2022/08/18/doris-cluster-elastic-expansion/ data-page-title=Doris集群弹性扩缩容></div><script async defer src=/js/cusdis.min.js></script></div></main><div class="footer gradient-2"><div class="container footer-container"><div class=row><div class="col-xs-4 col-sm-3 col-md-3 col-lg-3"><div class=footer-title>网站地图</div><ul class=list-unstyled><li><a href=https://blog.chensoul.com/tags/>标签</a></li><li><a href=https://blog.chensoul.com/categories/>分类</a></li><li><a rel=alternate type=application/rss+xml href=https://blog.chensoul.com/index.xml></i>RSS</a></li></ul></div><div class="col-xs-4 col-sm-3 col-md-3 col-lg-3"><div class=footer-title>社交</div><ul class=list-unstyled><li><a href=https://t.me/chenshu_eth rel=noopener target=_blank>Telegram</a></li><li><a href=https://twitter.com/chenshu_eth rel=noopener target=_blank>Twitter</a></li><li><a href=https://space.bilibili.com/699805065/ rel=noopener target=_blank>BiliBili</a></li></ul></div><div class="col-xs-4 col-sm-3 col-md-3 col-lg-3"><div class=footer-title>关于</div><ul class=list-unstyled><li><a href=https://cusdis.chensoul.com rel=noopener target=_blank>GitHub</a></li><li><a href=https://uptime.chensoul.com/status/services rel=noopener target=_blank>Services</a></li><li><a href=https://umami.chensoul.com/share/zWO2pDuP/chenshou rel=noopener target=_blank>Analytics</a></li></ul></div><div class="col-xs-12 col-sm-3 col-md-3 col-lg-3"><p class="pull-right text-right"><small><em>Powered by <a href=https://gohugo.io/ rel=noopener target=_blank>Hugo</a></em></small><br><small><em>Theme - <a href=https://github.com/shaform/hugo-theme-den rel=noopener target=_blank>Den</a></em></small><br><small>&copy;
chensoul
2020 -
2023</small></p></div><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" id=scroll-top class=scroll-top accesskey=g><span class=arrow-icon></span></a>
<script>var mybutton=document.getElementById("scroll-top");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script></div></div></div><script src=https://code.jquery.com/jquery-3.3.1.slim.min.js integrity=sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo crossorigin=anonymous></script>
<script src=https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js integrity=sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy crossorigin=anonymous></script>
<script async src=https://cdn.splitbee.io/sb.js></script>
<script async defer data-website-id=f110cfa0-b737-4690-a032-2b9073a57fc3 src=https://umami.chensoul.com/umami.js></script></body></html>