<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>我的VPS服务部署记录 | ChenSoul</title>
<meta name=keywords content="hugo,docker,rsshub,memos,n8n,vps,nginx"><meta name=description content='我的 VPS 使用的是 centos 服务器，所以以下操作都是基于 centos 系统。
服务器设置 更新 yum 源：
yum update 安装常用软件：
yum install wget curl git vim -y 设置时区为
[可选] 设置系统 Swap 交换分区
因为 vps 服务器的运行内存很小，所以这里先设置下 Swap
# 1GB RAM with 2GB Swap sudo fallocate -l 2G /swapfile && \ sudo dd if=/dev/zero of=/swapfile bs=1024 count=2097152 && \ sudo chmod 600 /swapfile && \ sudo mkswap /swapfile && \ sudo swapon /swapfile && \ echo "/swapfile swap swap defaults 0 0" | sudo tee -a /etc/fstab && \ sudo swapon --show && \ sudo free -h 安装 Nginx 参考 CentOS 7 下 yum 安装和配置 Nginx ，使用 yum 安装：'><meta name=author content="chensoul"><link rel=canonical href=https://blog.chensoul.cc/posts/2023/01/25/notes-about-deploy-services-in-vps/><meta name=google-site-verification content="nBXwg45SBRjTX78SA-mH0asrAbsdu9c1nk0ObSry7aQ"><link crossorigin=anonymous href=/assets/css/stylesheet.48da2331f774073f2b09ec285a9c0e15fd969021a9d2d0fb60b7cbb73cef5ecc.css integrity="sha256-SNojMfd0Bz8rCewoWpwOFf2WkCGp0tD7YLfLtzzvXsw=" rel="preload stylesheet" as=style><link rel=icon href=https://blog.chensoul.cc/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://blog.chensoul.cc/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://blog.chensoul.cc/favicon-32x32.png><link rel=apple-touch-icon href=https://blog.chensoul.cc/apple-touch-icon.png><link rel=mask-icon href=https://blog.chensoul.cc/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://blog.chensoul.cc/posts/2023/01/25/notes-about-deploy-services-in-vps/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta name=baidu-site-verification content="codeva-FYpQY8JdLU"><meta property="og:title" content="我的VPS服务部署记录"><meta property="og:description" content='我的 VPS 使用的是 centos 服务器，所以以下操作都是基于 centos 系统。
服务器设置 更新 yum 源：
yum update 安装常用软件：
yum install wget curl git vim -y 设置时区为
[可选] 设置系统 Swap 交换分区
因为 vps 服务器的运行内存很小，所以这里先设置下 Swap
# 1GB RAM with 2GB Swap sudo fallocate -l 2G /swapfile && \ sudo dd if=/dev/zero of=/swapfile bs=1024 count=2097152 && \ sudo chmod 600 /swapfile && \ sudo mkswap /swapfile && \ sudo swapon /swapfile && \ echo "/swapfile swap swap defaults 0 0" | sudo tee -a /etc/fstab && \ sudo swapon --show && \ sudo free -h 安装 Nginx 参考 CentOS 7 下 yum 安装和配置 Nginx ，使用 yum 安装：'><meta property="og:type" content="article"><meta property="og:url" content="https://blog.chensoul.cc/posts/2023/01/25/notes-about-deploy-services-in-vps/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-01-25T10:38:34+08:00"><meta property="article:modified_time" content="2023-01-25T10:38:34+08:00"><meta property="og:site_name" content="ChenSoul"><meta name=twitter:card content="summary"><meta name=twitter:title content="我的VPS服务部署记录"><meta name=twitter:description content='我的 VPS 使用的是 centos 服务器，所以以下操作都是基于 centos 系统。
服务器设置 更新 yum 源：
yum update 安装常用软件：
yum install wget curl git vim -y 设置时区为
[可选] 设置系统 Swap 交换分区
因为 vps 服务器的运行内存很小，所以这里先设置下 Swap
# 1GB RAM with 2GB Swap sudo fallocate -l 2G /swapfile && \ sudo dd if=/dev/zero of=/swapfile bs=1024 count=2097152 && \ sudo chmod 600 /swapfile && \ sudo mkswap /swapfile && \ sudo swapon /swapfile && \ echo "/swapfile swap swap defaults 0 0" | sudo tee -a /etc/fstab && \ sudo swapon --show && \ sudo free -h 安装 Nginx 参考 CentOS 7 下 yum 安装和配置 Nginx ，使用 yum 安装：'><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://blog.chensoul.cc/posts/"},{"@type":"ListItem","position":2,"name":"我的VPS服务部署记录","item":"https://blog.chensoul.cc/posts/2023/01/25/notes-about-deploy-services-in-vps/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"我的VPS服务部署记录","name":"我的VPS服务部署记录","description":"我的 VPS 使用的是 centos 服务器，所以以下操作都是基于 centos 系统。\n服务器设置 更新 yum 源：\nyum update 安装常用软件：\nyum install wget curl git vim -y 设置时区为\n[可选] 设置系统 Swap 交换分区\n因为 vps 服务器的运行内存很小，所以这里先设置下 Swap\n# 1GB RAM with 2GB Swap sudo fallocate -l 2G /swapfile \u0026amp;\u0026amp; \\ sudo dd if=/dev/zero of=/swapfile bs=1024 count=2097152 \u0026amp;\u0026amp; \\ sudo chmod 600 /swapfile \u0026amp;\u0026amp; \\ sudo mkswap /swapfile \u0026amp;\u0026amp; \\ sudo swapon /swapfile \u0026amp;\u0026amp; \\ echo \u0026#34;/swapfile swap swap defaults 0 0\u0026#34; | sudo tee -a /etc/fstab \u0026amp;\u0026amp; \\ sudo swapon --show \u0026amp;\u0026amp; \\ sudo free -h 安装 Nginx 参考 CentOS 7 下 yum 安装和配置 Nginx ，使用 yum 安装：","keywords":["hugo","docker","rsshub","memos","n8n","vps","nginx"],"articleBody":"我的 VPS 使用的是 centos 服务器，所以以下操作都是基于 centos 系统。\n服务器设置 更新 yum 源：\nyum update 安装常用软件：\nyum install wget curl git vim -y 设置时区为\n[可选] 设置系统 Swap 交换分区\n因为 vps 服务器的运行内存很小，所以这里先设置下 Swap\n# 1GB RAM with 2GB Swap sudo fallocate -l 2G /swapfile \u0026\u0026 \\ sudo dd if=/dev/zero of=/swapfile bs=1024 count=2097152 \u0026\u0026 \\ sudo chmod 600 /swapfile \u0026\u0026 \\ sudo mkswap /swapfile \u0026\u0026 \\ sudo swapon /swapfile \u0026\u0026 \\ echo \"/swapfile swap swap defaults 0 0\" | sudo tee -a /etc/fstab \u0026\u0026 \\ sudo swapon --show \u0026\u0026 \\ sudo free -h 安装 Nginx 参考 CentOS 7 下 yum 安装和配置 Nginx ，使用 yum 安装：\nrpm -ivh http://nginx.org/packages/centos/7/noarch/RPMS/nginx-release-centos-7-0.el7.ngx.noarch.rpm yum install nginx -y systemctl enable nginx 打开防火墙端口\nyum install firewalld -y firewall-cmd --zone=public --permanent --add-service=http firewall-cmd --reload 使用反向代理需要打开网络访问权限\nsetsebool -P httpd_can_network_connect on 安装并生成证书 域名托管在 CloudFlare，可以参考 文章\ncurl https://get.acme.sh | sh -s email=ichensoul@gmail.com export CF_Key=\"XXXXXXXXXXXXXXXXXX\" export CF_Email=\"ichensoul@gmail.com\" .acme.sh/acme.sh --issue --server letsencrypt --dns dns_cf -d chensoul.cc -d '*.chensoul.cc' cp .acme.sh/chensoul.cc_ecc/{chensoul.cc.cer,chensoul.cc.key,fullchain.cer,ca.cer} /etc/nginx/ssl/ .acme.sh/acme.sh --installcert -d chensoul.cc -d *.chensoul.cc --cert-file /etc/nginx/ssl/chensoul.cc.cer --key-file /etc/nginx/ssl/chensoul.cc.key --fullchain-file /etc/nginx/ssl/fullchain.cer --ca-file /etc/nginx/ssl/ca.cer --reloadcmd \"sudo nginx -s reload\" Docker 安装和配置 Docker 安装\ncurl -fsSL https://get.docker.com -o get-docker.sh sh get-docker.sh 启动 docker：\nsystemctl enable docker systemctl start docker 设置 iptables 允许流量转发：\niptables -P FORWARD ACCEPT 安装 Compose\ncurl -L \"https://github.com/docker/compose/releases/download/v2.23.3/docker-compose-$(uname -s)-$(uname -m)\" -o /usr/local/bin/docker-compose 设置执行权限：\nchmod +x /usr/local/bin/docker-compose 参考 Best Practice: Use a Docker network ，创建一个自定义的网络：\ndocker network create custom 查看 docker 网络：\ndocker network ls NETWORK ID NAME DRIVER SCOPE 68f4aeaa57bd bridge bridge local 6a96b9d8617e custom bridge local 4a8679e35f4d host host local ba21bef23b04 none null local 注意：bridge、host、none 是内部预先创建的网络。\n然后，在其他服务的 docker-compose.yml 文件添加：\nnetworks: - custom networks: custom: external: true 服务部署 MySQL 1、使用 docker-compose 安装\nmysql.yaml\nversion: \"3\" services: mysql: image: mysql:8 container_name: mysql platform: linux/amd64 restart: unless-stopped volumes: - /data/volumes/mysql/:/var/lib/mysql/ environment: - MYSQL_ROOT_HOST=% - MYSQL_ROOT_PASSWORD=admin@mysql! - TZ=Asia/Shanghai ports: - \"3306:3306\" command: --default-authentication-plugin=mysql_native_password --explicit_defaults_for_timestamp=true --lower_case_table_names=1 --tls-version='' healthcheck: test: \"/usr/bin/mysql -e 'SHOW DATABASES;'\" interval: 5s timeout: 2s retries: 10 networks: - custom networks: custom: external: true 注意：修改 Docker-MySQL 容器的 默认用户加密规则\n2、启动\ndocker-compose -f mysql.yaml up -d 3、进入容器：\ndocker exec -it mysql bash Rsshub 直接通过 Docker 安装运行：\ndocker run -d --name rsshub -p 1200:1200 diygod/rsshub 配置 nginx ：\nserver { listen 80; listen [::]:80; server_name rsshub.chensoul.cc; return 301 https://$host$request_uri; } server { listen 443 ssl; server_name rsshub.chensoul.cc; ssl_certificate /etc/nginx/ssl/fullchain.cer; ssl_certificate_key /etc/nginx/ssl/chensoul.cc.key; ssl_session_cache shared:SSL:1m; ssl_session_timeout 5m; ssl_ciphers HIGH:!aNULL:!MD5; ssl_prefer_server_ciphers on; location / { proxy_pass http://127.0.0.1:1200; } } Uptime Kuma 参考 kuma，使用 docker compose 部署，创建 uptime.yaml：\nversion: \"3.3\" services: uptime-kuma: image: louislam/uptime-kuma:1 container_name: uptime-kuma volumes: - ~/.uptime-kuma:/app/data ports: - 3001:3001 # : restart: always 启动：\ndocker-compose -f uptime.yaml up -d 配置 nginx 配置文件 /etc/nginx/conf.d/uptime.conf ：\nserver { listen 80; listen [::]:80; server_name uptime.chensoul.cc; return 301 https://$host$request_uri; } server { listen 443 ssl; server_name uptime.chensoul.cc; ssl_certificate /etc/nginx/ssl/fullchain.cer; ssl_certificate_key /etc/nginx/ssl/chensoul.cc.key; ssl_session_cache shared:SSL:1m; ssl_session_timeout 5m; ssl_ciphers HIGH:!aNULL:!MD5; ssl_prefer_server_ciphers on; location / { proxy_pass http://127.0.0.1:3001; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header Host $host; proxy_http_version 1.1; proxy_set_header Upgrade $http_upgrade; proxy_set_header Connection \"upgrade\"; } } 升级\ndocker compose -f uptime.yaml down docker pull louislam/uptime-kuma:1 docker-compose -f uptime.yaml up -d Umami 1、在 mysql 容器创建 umami 数据库和用户：\ndocker exec -it mysql bash mysql -uroot -padmin@mysql! CREATE USER 'umami'@'%' IDENTIFIED BY 'umami@mysql!'; CREATE DATABASE umami; GRANT ALL ON umami.* TO 'umami'@'%'; ALTER USER 'umami' IDENTIFIED WITH caching_sha2_password BY 'umami@mysql!'; 参考：HCL SafeLinx Server with MySQL 8.0 causes “Authentication plugin ‘caching_sha2_password’ reported error: Authentication requires secure connection.”\n2、通过 docker-compose 安装，创建 umami.yaml：\nversion: \"3\" services: umami: image: ghcr.io/umami-software/umami:mysql-latest container_name: umami ports: - \"3000:3000\" environment: DATABASE_URL: mysql://umami:umami@mysql!@mysql:3306/umami DATABASE_TYPE: mysql HASH_SALT: vps@2023 TRACKER_SCRIPT_NAME: random-string.js networks: - custom restart: always networks: custom: external: true 参考 https://eallion.com/umami/，Umami 的默认跟踪代码是被大多数的广告插件屏蔽的，被屏蔽了你就统计不到访客信息了。如果需要反屏蔽，需要在 docker-compose.yml 文件中添加环境变量：TRACKER_SCRIPT_NAME，如：\nenvironment: TRACKER_SCRIPT_NAME: random-string.js 然后获取到的跟踪代码的 src 会变成：\nsrcipt.js =\u003e random-string.js 启动：\ndocker-compose -f umami.yaml up -d 3、设置自定义域名\numami.chensoul.cc\n4、配置 nginx 配置文件 /etc/nginx/conf.d/umami.conf\nserver { listen 80; listen [::]:80; server_name umami.chensoul.cc; return 301 https://$host$request_uri; } server { listen 443 ssl; server_name umami.chensoul.cc; ssl_certificate /etc/nginx/ssl/fullchain.cer; ssl_certificate_key /etc/nginx/ssl/chensoul.cc.key; ssl_session_cache shared:SSL:1m; ssl_session_timeout 5m; ssl_ciphers HIGH:!aNULL:!MD5; ssl_prefer_server_ciphers on; location / { proxy_pass http://127.0.0.1:3000; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; proxy_set_header REMOTE-HOST $remote_addr; add_header X-Cache $upstream_cache_status; # 缓存 add_header Cache-Control no-cache; expires 12h; } } 5、添加网站\n访问 https://umami.chensoul.cc/，默认用户名和密码为 admin/umami。登陆之后，修改密码，并添加网站。\n6、升级\ndocker compose -f umami.yaml down docker pull ghcr.io/umami-software/umami:mysql-latest docker-compose -f umami.yaml up -d Cusdis VPS IP 可能被墙，所以可以使用三方云服务部署，具体参考轻量级开源免费博客评论系统解决方案 （Cusdis + Railway）\n1、在 mysql 容器创建 cusdis 数据库和用户：\ndocker exec -it mysql bash mysql -uroot -p CREATE USER 'cusdis'@'%' IDENTIFIED BY 'cusdis@mysql!'; CREATE DATABASE cusdis; GRANT ALL ON cusdis.* TO 'cusdis'@'%'; ALTER USER 'cusdis' IDENTIFIED WITH caching_sha2_password BY 'cusdis@mysql!'; 2、通过 docker-compose 安装，创建 cusdis.yaml：\nversion: \"3\" services: cusdis: image: djyde/cusdis:latest container_name: cusdis ports: - \"3010:3000\" environment: - USERNAME=admin - PASSWORD=cusdis - JWT_SECRET=vps@2023 - NEXTAUTH_URL=https://cusdis.chensoul.cc - HOST=https://cusdis.chensoul.cc - DB_TYPE=mysql - DB_URL=mysql://cusdis:cusdis@mysql!@mysql:3306/cusdis networks: - custom restart: always networks: custom: external: true 以下配置为 EMAIL 配置可选，下面是使用 Gmail 进行配置，需要首先开启两阶段验证并创建一个应用密码：\nSMTP_HOST=smtp.gmail.com SMTP_PORT=465 SMTP_SECURE=true SMTP_USER=your gmail email SMTP_PASSWORD= SMTP_SENDER=your gmail email 3、启动\ndocker-compose -f cusdis.yaml up -d 4、配置 nginx\nserver { listen 80; listen [::]:80; server_name cusdis.chensoul.cc; return 301 https://$host$request_uri; } server { listen 443 ssl; server_name cusdis.chensoul.cc; ssl_certificate /etc/nginx/ssl/fullchain.cer; ssl_certificate_key /etc/nginx/ssl/chensoul.cc.key; ssl_session_cache shared:SSL:1m; ssl_session_timeout 5m; ssl_ciphers HIGH:!aNULL:!MD5; ssl_prefer_server_ciphers on; location / { proxy_pass http://127.0.0.1:3010; proxy_pass_header Authorization; proxy_pass_header WWW-Authenticate; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; if ($uri = '/js/iframe.umd.js') { add_header 'Access-Control-Allow-Origin' '*'; #add_header 'Access-Control-Allow-Origin' 'http://localhost:1313'; } } } 5、部署一个 Telegram 机器人，参考 Official Telegram bot。\n6、升级\ndocker compose -f cusdis.yaml down docker pull djyde/cusdis:latest docker-compose -f cusdis.yaml up -d memos 1、在 mysql 容器创建 n8n 数据库和用户：\ndocker exec -it mysql bash mysql -uroot -p CREATE USER 'memos'@'%' IDENTIFIED BY 'memos@mysql!'; CREATE DATABASE memos; GRANT ALL ON memos.* TO 'memos'@'%'; ALTER USER 'memos' IDENTIFIED WITH caching_sha2_password BY 'memos@mysql!'; 2、通过 docker-compose 安装，创建 memos.yaml：\nversion: \"3.0\" services: memos: image: neosmemo/memos:latest container_name: memos environment: - MEMOS_DRIVER=mysql - MEMOS_DSN=memos:memos@mysql!@tcp(mysql)/memos volumes: - ~/.memos/:/var/opt/memos ports: - 5230:5230 networks: - custom networks: custom: external: true 启动\ndocker-compose -f memos.yaml up -d 配置 nginx 配置文件 /etc/nginx/conf.d/memos.conf\nserver { listen 80; listen [::]:80; server_name memos.chensoul.cc; return 301 https://$host$request_uri; } server { listen 443 ssl; server_name memos.chensoul.cc; ssl_certificate /etc/nginx/ssl/fullchain.cer; ssl_certificate_key /etc/nginx/ssl/chensoul.cc.key; ssl_session_cache shared:SSL:1m; ssl_session_timeout 5m; ssl_ciphers HIGH:!aNULL:!MD5; ssl_prefer_server_ciphers on; location / { proxy_pass http://127.0.0.1:5230; } } 升级\ndocker compose -f memos.yaml down docker pull neosmemo/memos:latest docker-compose -f memos.yaml up -d n8n 1、在 mysql 容器创建 n8n 数据库和用户：\ndocker exec -it mysql bash mysql -uroot -p CREATE USER 'n8n'@'%' IDENTIFIED BY 'n8n@mysql!'; CREATE DATABASE n8n; GRANT ALL ON n8n.* TO 'n8n'@'%'; ALTER USER 'n8n' IDENTIFIED WITH caching_sha2_password BY 'n8n@mysql!'; 2、通过 docker-compose 安装，创建 n8n.yaml：\nversion: \"3.8\" services: n8n: image: n8nio/n8n container_name: n8n restart: always environment: - DB_TYPE=mysqldb - DB_MYSQLDB_HOST=mysql - DB_MYSQLDB_PORT=3306 - DB_MYSQLDB_DATABASE=n8n - DB_MYSQLDB_USER=n8n - DB_MYSQLDB_PASSWORD=n8n@mysql! - TZ=\"Asia/Shanghai\" - GENERIC_TIMEZONE=\"Asia/Shanghai\" - WEBHOOK_URL=https://n8n.chensoul.cc/ ports: - 5678:5678 volumes: - ~/.n8n:/home/node/.n8n networks: - custom networks: custom: external: true 3、启动\ndocker-compose -f n8n.yaml up -d 4、配置 nginx 配置文件 /etc/nginx/conf.d/n8n.conf\nserver { listen 80; listen [::]:80; server_name n8n.chensoul.cc; return 301 https://$host$request_uri; } server { listen 443 ssl; server_name n8n.chensoul.cc; ssl_certificate /etc/nginx/ssl/fullchain.cer; ssl_certificate_key /etc/nginx/ssl/chensoul.cc.key; ssl_session_cache shared:SSL:1m; ssl_session_timeout 5m; ssl_ciphers HIGH:!aNULL:!MD5; ssl_prefer_server_ciphers on; location / { proxy_pass http://127.0.0.1:5678; chunked_transfer_encoding off; proxy_buffering off; proxy_cache off; access_log /var/log/nginx/n8n.log combined buffer=128k flush=5s; proxy_http_version 1.1; proxy_set_header Upgrade $http_upgrade; proxy_set_header Connection \"Upgrade\"; } } 这里面的转发配置不对的话，会导致直接访问 5678 端口正常，但是访问 nginx 的话，workflow 会一直处于执行。\n5、添加 workflow\n参考这篇文章 http://stiles.cc/archives/237/ ，目前我配置了以下 workflows，实现了 github、douban、rss、memos 同步到 Telegram。\nworkflows 参考：\nReorx Pseudoyu raye Zeabur 6、升级\ndocker compose -f n8n.yaml down docker pull n8nio/n8n docker-compose -f n8n.yaml up -d 7、备份\n安装 jq\nyum install epel-release -y yum install jq -y #!/bin/bash DATE=$(date +%Y%m%d_%H%M%S) BACKUP_DIR=\"/opt/backup/n8n\" mkdir -p $BACKUP_DIR EXPORT_DIR=\"workflow-${DATE}\" docker exec -u node -it n8n n8n export:workflow --backup --output=./$EXPORT_DIR/ docker cp n8n:/home/node/$EXPORT_DIR ${BACKUP_DIR}/$EXPORT_DIR #docker exec -u node -it n8n n8n export:credentials --all --output=./credentials.json #docker cp n8n:/home/node/credentials.json . cd $BACKUP_DIR/$EXPORT_DIR for file in *; do filename=$(cat \"$file\" | jq -r '.name') # 使用-r选项以纯文本形式输出字段值 echo \"$filename\" mv \"$file\" \"$filename\".json done 数据库备份 #!/bin/bash # 容器名称 CONTAINER_NAME=\"mysql\" # 备份目录 BACKUP_DIR=\"/opt/backup/mysql\" # 日期时间 DATE=$(date +%Y%m%d_%H%M%S) # 备份文件名后缀 BACKUP_POSTFIX=\"backup_${DATE}\" # MySQL连接参数 DB_USER=\"root\" DB_PASSWORD=\"admin@mysql!\" # 要备份的数据库列表 DATABASES=(\"memos\" \"n8n\" \"umami\") # 创建备份目录 mkdir -p $BACKUP_DIR # 遍历数据库列表进行备份 for DB_NAME in \"${DATABASES[@]}\" do # 备份文件名 BACKUP_FILE=\"${DB_NAME}_${BACKUP_POSTFIX}.sql\" # 执行备份 docker exec $CONTAINER_NAME mysqldump -u $DB_USER --password=$DB_PASSWORD $DB_NAME \u003e $BACKUP_DIR/$BACKUP_FILE # 检查备份是否成功 if [ $? -eq 0 ]; then echo \"数据库 $DB_NAME 备份成功: $BACKUP_FILE\" else echo \"数据库 $DB_NAME 备份失败\" fi done ","wordCount":"1331","inLanguage":"en","datePublished":"2023-01-25T10:38:34+08:00","dateModified":"2023-01-25T10:38:34+08:00","author":{"@type":"Person","name":"chensoul"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.chensoul.cc/posts/2023/01/25/notes-about-deploy-services-in-vps/"},"publisher":{"@type":"Organization","name":"ChenSoul","logo":{"@type":"ImageObject","url":"https://blog.chensoul.cc/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://blog.chensoul.cc/ accesskey=h title="ChenSoul (Alt + H)">ChenSoul</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://blog.chensoul.cc/categories title=分类><span>分类</span></a></li><li><a href=https://blog.chensoul.cc/tags title=标签><span>标签</span></a></li><li><a href=https://blog.chensoul.cc/search title="搜索 (Alt + /)" accesskey=/><span>搜索</span></a></li><li><a href=https://blog.chensoul.cc/index.xml title=订阅><span>订阅</span></a></li><li><a href=https://github.com/chensoul title=关于><span>关于</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">我的VPS服务部署记录</h1><div class=post-meta><span title='2023-01-25 10:38:34 +0800 +0800'>2023-01-25</span>&nbsp;·&nbsp;7 min&nbsp;·&nbsp;1331 words&nbsp;·&nbsp;chensoul</div></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%ae%be%e7%bd%ae aria-label=服务器设置>服务器设置</a></li><li><a href=#%e5%ae%89%e8%a3%85-nginx aria-label="安装 Nginx">安装 Nginx</a></li><li><a href=#%e5%ae%89%e8%a3%85%e5%b9%b6%e7%94%9f%e6%88%90%e8%af%81%e4%b9%a6 aria-label=安装并生成证书>安装并生成证书</a></li><li><a href=#docker-%e5%ae%89%e8%a3%85%e5%92%8c%e9%85%8d%e7%bd%ae aria-label="Docker 安装和配置">Docker 安装和配置</a></li><li><a href=#%e6%9c%8d%e5%8a%a1%e9%83%a8%e7%bd%b2 aria-label=服务部署>服务部署</a><ul><li><a href=#mysql aria-label=MySQL>MySQL</a></li><li><a href=#rsshub aria-label=Rsshub>Rsshub</a></li><li><a href=#uptime-kuma aria-label="Uptime Kuma">Uptime Kuma</a></li><li><a href=#umami aria-label=Umami>Umami</a></li><li><a href=#cusdis aria-label=Cusdis>Cusdis</a></li><li><a href=#memos aria-label=memos>memos</a></li><li><a href=#n8n aria-label=n8n>n8n</a></li></ul></li><li><a href=#%e6%95%b0%e6%8d%ae%e5%ba%93%e5%a4%87%e4%bb%bd aria-label=数据库备份>数据库备份</a></li></ul></div></details></div><div class=post-content><p>我的 VPS 使用的是 centos 服务器，所以以下操作都是基于 centos 系统。</p><h2 id=服务器设置>服务器设置<a hidden class=anchor aria-hidden=true href=#服务器设置>#</a></h2><p>更新 yum 源：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>yum update
</span></span></code></pre></div><p>安装常用软件：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>yum install wget curl git vim -y
</span></span></code></pre></div><p>设置时区为</p><p><strong>[可选] 设置系统 Swap 交换分区</strong></p><p>因为 vps 服务器的运行内存很小，所以这里先设置下 Swap</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 1GB RAM with 2GB Swap</span>
</span></span><span class=line><span class=cl>sudo fallocate -l 2G /swapfile <span class=o>&amp;&amp;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>sudo dd <span class=k>if</span><span class=o>=</span>/dev/zero <span class=nv>of</span><span class=o>=</span>/swapfile <span class=nv>bs</span><span class=o>=</span><span class=m>1024</span> <span class=nv>count</span><span class=o>=</span><span class=m>2097152</span> <span class=o>&amp;&amp;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>sudo chmod <span class=m>600</span> /swapfile <span class=o>&amp;&amp;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>sudo mkswap /swapfile <span class=o>&amp;&amp;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>sudo swapon /swapfile <span class=o>&amp;&amp;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=nb>echo</span> <span class=s2>&#34;/swapfile swap swap defaults 0 0&#34;</span> <span class=p>|</span> sudo tee -a /etc/fstab <span class=o>&amp;&amp;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>sudo swapon --show <span class=o>&amp;&amp;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>sudo free -h
</span></span></code></pre></div><h2 id=安装-nginx>安装 Nginx<a hidden class=anchor aria-hidden=true href=#安装-nginx>#</a></h2><p>参考 <a href=https://qizhanming.com/blog/2018/08/06/how-to-install-nginx-on-centos-7>CentOS 7 下 yum 安装和配置 Nginx</a> ，使用 yum 安装：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>rpm -ivh http://nginx.org/packages/centos/7/noarch/RPMS/nginx-release-centos-7-0.el7.ngx.noarch.rpm
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>yum install nginx -y
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>systemctl <span class=nb>enable</span> nginx
</span></span></code></pre></div><p>打开防火墙端口</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>yum install firewalld -y
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>firewall-cmd --zone<span class=o>=</span>public --permanent --add-service<span class=o>=</span>http
</span></span><span class=line><span class=cl>firewall-cmd --reload
</span></span></code></pre></div><p>使用反向代理需要打开网络访问权限</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>setsebool -P httpd_can_network_connect on
</span></span></code></pre></div><h2 id=安装并生成证书>安装并生成证书<a hidden class=anchor aria-hidden=true href=#安装并生成证书>#</a></h2><p>域名托管在 CloudFlare，可以参考 <a href=https://github.com/acmesh-official/acme.sh/wiki/dnsapi#dns_cf>文章</a></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl https://get.acme.sh <span class=p>|</span> sh -s <span class=nv>email</span><span class=o>=</span>ichensoul@gmail.com
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>CF_Key</span><span class=o>=</span><span class=s2>&#34;XXXXXXXXXXXXXXXXXX&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>CF_Email</span><span class=o>=</span><span class=s2>&#34;ichensoul@gmail.com&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>.acme.sh/acme.sh --issue --server letsencrypt --dns dns_cf -d chensoul.cc -d <span class=s1>&#39;*.chensoul.cc&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cp .acme.sh/chensoul.cc_ecc/<span class=o>{</span>chensoul.cc.cer,chensoul.cc.key,fullchain.cer,ca.cer<span class=o>}</span> /etc/nginx/ssl/
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>.acme.sh/acme.sh --installcert -d chensoul.cc -d *.chensoul.cc --cert-file /etc/nginx/ssl/chensoul.cc.cer --key-file /etc/nginx/ssl/chensoul.cc.key --fullchain-file /etc/nginx/ssl/fullchain.cer --ca-file /etc/nginx/ssl/ca.cer --reloadcmd <span class=s2>&#34;sudo nginx -s reload&#34;</span>
</span></span></code></pre></div><h2 id=docker-安装和配置>Docker 安装和配置<a hidden class=anchor aria-hidden=true href=#docker-安装和配置>#</a></h2><p>Docker 安装</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl -fsSL https://get.docker.com -o get-docker.sh
</span></span><span class=line><span class=cl>sh get-docker.sh
</span></span></code></pre></div><p>启动 docker：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>systemctl <span class=nb>enable</span> docker
</span></span><span class=line><span class=cl>systemctl start docker
</span></span></code></pre></div><p>设置 iptables 允许流量转发：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>iptables -P FORWARD ACCEPT
</span></span></code></pre></div><p>安装 Compose</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl -L <span class=s2>&#34;https://github.com/docker/compose/releases/download/v2.23.3/docker-compose-</span><span class=k>$(</span>uname -s<span class=k>)</span><span class=s2>-</span><span class=k>$(</span>uname -m<span class=k>)</span><span class=s2>&#34;</span> -o /usr/local/bin/docker-compose
</span></span></code></pre></div><p>设置执行权限：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>chmod +x /usr/local/bin/docker-compose
</span></span></code></pre></div><p>参考 <a href=https://nginxproxymanager.com/advanced-config/#best-practice-use-a-docker-network>Best Practice: Use a Docker network </a>，创建一个自定义的网络：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker network create custom
</span></span></code></pre></div><p>查看 docker 网络：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker network ls
</span></span><span class=line><span class=cl>NETWORK ID     NAME            DRIVER    SCOPE
</span></span><span class=line><span class=cl>68f4aeaa57bd   bridge          bridge    <span class=nb>local</span>
</span></span><span class=line><span class=cl>6a96b9d8617e   custom          bridge    <span class=nb>local</span>
</span></span><span class=line><span class=cl>4a8679e35f4d   host            host      <span class=nb>local</span>
</span></span><span class=line><span class=cl>ba21bef23b04   none            null      <span class=nb>local</span>
</span></span></code></pre></div><blockquote><p>注意：bridge、host、none 是内部预先创建的网络。</p></blockquote><p>然后，在其他服务的 docker-compose.yml 文件添加：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>networks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>custom</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>networks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>custom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>external</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span></code></pre></div><h2 id=服务部署>服务部署<a hidden class=anchor aria-hidden=true href=#服务部署>#</a></h2><h3 id=mysql>MySQL<a hidden class=anchor aria-hidden=true href=#mysql>#</a></h3><p>1、使用 docker-compose 安装</p><p>mysql.yaml</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;3&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>mysql</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>mysql:8</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>container_name</span><span class=p>:</span><span class=w> </span><span class=l>mysql</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>platform</span><span class=p>:</span><span class=w> </span><span class=l>linux/amd64</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restart</span><span class=p>:</span><span class=w> </span><span class=l>unless-stopped</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>/data/volumes/mysql/:/var/lib/mysql/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>environment</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>MYSQL_ROOT_HOST=%</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>MYSQL_ROOT_PASSWORD=admin@mysql!</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>TZ=Asia/Shanghai</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;3306:3306&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>command</span><span class=p>:</span><span class=w> </span>--<span class=l>default-authentication-plugin=mysql_native_password --explicit_defaults_for_timestamp=true --lower_case_table_names=1 --tls-version=&#39;&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>healthcheck</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>test</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;/usr/bin/mysql -e &#39;SHOW DATABASES;&#39;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>interval</span><span class=p>:</span><span class=w> </span><span class=l>5s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>timeout</span><span class=p>:</span><span class=w> </span><span class=l>2s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>retries</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>networks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>custom</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>networks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>custom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>external</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span></code></pre></div><blockquote><p>注意：<a href=https://www.cnblogs.com/atuotuo/p/9402132.html>修改 Docker-MySQL 容器的 默认用户加密规则</a></p></blockquote><p>2、启动</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker-compose -f mysql.yaml up -d
</span></span></code></pre></div><p>3、进入容器：</p><pre tabindex=0><code class=language-bahs data-lang=bahs>docker exec -it mysql bash
</code></pre><h3 id=rsshub>Rsshub<a hidden class=anchor aria-hidden=true href=#rsshub>#</a></h3><p>直接通过 Docker 安装运行：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker run -d --name rsshub -p 1200:1200 diygod/rsshub
</span></span></code></pre></div><p>配置 nginx ：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-nginx data-lang=nginx><span class=line><span class=cl><span class=k>server</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kn>listen</span> <span class=mi>80</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>listen</span> <span class=s>[::]:80</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>server_name</span> <span class=s>rsshub.chensoul.cc</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kn>return</span> <span class=mi>301</span> <span class=s>https://</span><span class=nv>$host$request_uri</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>server</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kn>listen</span>          <span class=mi>443</span> <span class=s>ssl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>server_name</span>     <span class=s>rsshub.chensoul.cc</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kn>ssl_certificate</span>      <span class=s>/etc/nginx/ssl/fullchain.cer</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>ssl_certificate_key</span>  <span class=s>/etc/nginx/ssl/chensoul.cc.key</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kn>ssl_session_cache</span>    <span class=s>shared:SSL:1m</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>ssl_session_timeout</span>  <span class=mi>5m</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kn>ssl_ciphers</span>  <span class=s>HIGH:!aNULL:!MD5</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>ssl_prefer_server_ciphers</span>  <span class=no>on</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kn>location</span> <span class=s>/</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kn>proxy_pass</span> <span class=s>http://127.0.0.1:1200</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=uptime-kuma>Uptime Kuma<a hidden class=anchor aria-hidden=true href=#uptime-kuma>#</a></h3><p>参考 <a href=https://uptime.kuma.pet/>kuma</a>，使用 docker compose 部署，创建 uptime.yaml：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;3.3&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>uptime-kuma</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>louislam/uptime-kuma:1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>container_name</span><span class=p>:</span><span class=w> </span><span class=l>uptime-kuma</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>~/.uptime-kuma:/app/data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=m>3001</span><span class=p>:</span><span class=m>3001</span><span class=w> </span><span class=c># &lt;Host Port&gt;:&lt;Container Port&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restart</span><span class=p>:</span><span class=w> </span><span class=l>always</span><span class=w>
</span></span></span></code></pre></div><p>启动：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker-compose -f uptime.yaml up -d
</span></span></code></pre></div><p>配置 nginx 配置文件 /etc/nginx/conf.d/uptime.conf ：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-nginx data-lang=nginx><span class=line><span class=cl><span class=k>server</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kn>listen</span> <span class=mi>80</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>listen</span> <span class=s>[::]:80</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>server_name</span> <span class=s>uptime.chensoul.cc</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kn>return</span> <span class=mi>301</span> <span class=s>https://</span><span class=nv>$host$request_uri</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>server</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kn>listen</span>          <span class=mi>443</span> <span class=s>ssl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>server_name</span>     <span class=s>uptime.chensoul.cc</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kn>ssl_certificate</span>      <span class=s>/etc/nginx/ssl/fullchain.cer</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>ssl_certificate_key</span>  <span class=s>/etc/nginx/ssl/chensoul.cc.key</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kn>ssl_session_cache</span>    <span class=s>shared:SSL:1m</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>ssl_session_timeout</span>  <span class=mi>5m</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kn>ssl_ciphers</span>  <span class=s>HIGH:!aNULL:!MD5</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>ssl_prefer_server_ciphers</span>  <span class=no>on</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kn>location</span> <span class=s>/</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kn>proxy_pass</span> <span class=s>http://127.0.0.1:3001</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	      <span class=kn>proxy_set_header</span>   <span class=s>X-Real-IP</span> <span class=nv>$remote_addr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kn>proxy_set_header</span>   <span class=s>X-Forwarded-For</span> <span class=nv>$proxy_add_x_forwarded_for</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kn>proxy_set_header</span>   <span class=s>Host</span> <span class=nv>$host</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kn>proxy_http_version</span> <span class=mi>1</span><span class=s>.1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kn>proxy_set_header</span>   <span class=s>Upgrade</span> <span class=nv>$http_upgrade</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kn>proxy_set_header</span>   <span class=s>Connection</span> <span class=s>&#34;upgrade&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>升级</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker compose -f uptime.yaml down
</span></span><span class=line><span class=cl>docker pull louislam/uptime-kuma:1
</span></span><span class=line><span class=cl>docker-compose -f uptime.yaml up -d
</span></span></code></pre></div><h3 id=umami>Umami<a hidden class=anchor aria-hidden=true href=#umami>#</a></h3><p>1、在 mysql 容器创建 umami 数据库和用户：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker <span class=nb>exec</span> -it mysql bash
</span></span><span class=line><span class=cl>mysql -uroot -padmin@mysql!
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>CREATE USER <span class=s1>&#39;umami&#39;</span>@<span class=s1>&#39;%&#39;</span> IDENTIFIED BY <span class=s1>&#39;umami@mysql!&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>CREATE DATABASE umami<span class=p>;</span>
</span></span><span class=line><span class=cl>GRANT ALL ON umami.* TO <span class=s1>&#39;umami&#39;</span>@<span class=s1>&#39;%&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>ALTER USER <span class=s1>&#39;umami&#39;</span> IDENTIFIED WITH caching_sha2_password BY <span class=s1>&#39;umami@mysql!&#39;</span><span class=p>;</span>
</span></span></code></pre></div><blockquote><p>参考：<a href="https://support.hcltechsw.com/csm?id=kb_article&amp;sysparm_article=KB0102948">HCL SafeLinx Server with MySQL 8.0 causes &ldquo;Authentication plugin &lsquo;caching_sha2_password&rsquo; reported error: Authentication requires secure connection.&rdquo;</a></p></blockquote><p>2、通过 docker-compose 安装，创建 umami.yaml：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;3&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>umami</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>ghcr.io/umami-software/umami:mysql-latest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>container_name</span><span class=p>:</span><span class=w> </span><span class=l>umami</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;3000:3000&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>environment</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>DATABASE_URL</span><span class=p>:</span><span class=w> </span><span class=l>mysql://umami:umami@mysql!@mysql:3306/umami</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>DATABASE_TYPE</span><span class=p>:</span><span class=w> </span><span class=l>mysql</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>HASH_SALT</span><span class=p>:</span><span class=w> </span><span class=l>vps@2023</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>TRACKER_SCRIPT_NAME</span><span class=p>:</span><span class=w> </span><span class=l>random-string.js</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>networks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>custom</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restart</span><span class=p>:</span><span class=w> </span><span class=l>always</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>networks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>custom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>external</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span></code></pre></div><p>参考 <a href=https://eallion.com/umami/>https://eallion.com/umami/</a>，Umami 的默认跟踪代码是被大多数的广告插件屏蔽的，被屏蔽了你就统计不到访客信息了。如果需要反屏蔽，需要在 docker-compose.yml 文件中添加环境变量：TRACKER_SCRIPT_NAME，如：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>    environment:
</span></span><span class=line><span class=cl>      TRACKER_SCRIPT_NAME: random-string.js
</span></span></code></pre></div><p>然后获取到的跟踪代码的 src 会变成：</p><pre tabindex=0><code>srcipt.js =&gt; random-string.js
</code></pre><p>启动：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker-compose -f umami.yaml up -d
</span></span></code></pre></div><p>3、设置自定义域名</p><p>umami.chensoul.cc</p><p>4、配置 nginx 配置文件 /etc/nginx/conf.d/umami.conf</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-nginx data-lang=nginx><span class=line><span class=cl><span class=k>server</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kn>listen</span> <span class=mi>80</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>listen</span> <span class=s>[::]:80</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>server_name</span> <span class=s>umami.chensoul.cc</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kn>return</span> <span class=mi>301</span> <span class=s>https://</span><span class=nv>$host$request_uri</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>server</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kn>listen</span>          <span class=mi>443</span> <span class=s>ssl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>server_name</span>     <span class=s>umami.chensoul.cc</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kn>ssl_certificate</span>      <span class=s>/etc/nginx/ssl/fullchain.cer</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>ssl_certificate_key</span>  <span class=s>/etc/nginx/ssl/chensoul.cc.key</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kn>ssl_session_cache</span>    <span class=s>shared:SSL:1m</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>ssl_session_timeout</span>  <span class=mi>5m</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kn>ssl_ciphers</span>  <span class=s>HIGH:!aNULL:!MD5</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>ssl_prefer_server_ciphers</span>  <span class=no>on</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kn>location</span> <span class=s>/</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kn>proxy_pass</span> <span class=s>http://127.0.0.1:3000</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kn>proxy_set_header</span> <span class=s>Host</span> <span class=nv>$host</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kn>proxy_set_header</span> <span class=s>X-Real-IP</span> <span class=nv>$remote_addr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kn>proxy_set_header</span> <span class=s>X-Forwarded-For</span> <span class=nv>$proxy_add_x_forwarded_for</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kn>proxy_set_header</span> <span class=s>X-Forwarded-Proto</span> <span class=nv>$scheme</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kn>proxy_set_header</span> <span class=s>REMOTE-HOST</span> <span class=nv>$remote_addr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kn>add_header</span> <span class=s>X-Cache</span> <span class=nv>$upstream_cache_status</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 缓存
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kn>add_header</span> <span class=s>Cache-Control</span> <span class=s>no-cache</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kn>expires</span> <span class=s>12h</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>5、添加网站</p><p>访问 <a href=https://umami.chensoul.cc/>https://umami.chensoul.cc/</a>，默认用户名和密码为 admin/umami。登陆之后，修改密码，并添加网站。</p><p>6、升级</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker compose -f umami.yaml down
</span></span><span class=line><span class=cl>docker pull ghcr.io/umami-software/umami:mysql-latest
</span></span><span class=line><span class=cl>docker-compose -f umami.yaml up -d
</span></span></code></pre></div><h3 id=cusdis>Cusdis<a hidden class=anchor aria-hidden=true href=#cusdis>#</a></h3><blockquote><p>VPS IP 可能被墙，所以可以使用三方云服务部署，具体参考<a href=https://www.pseudoyu.com/zh/2022/05/24/free_and_lightweight_blog_comment_system_using_cusdis_and_railway/>轻量级开源免费博客评论系统解决方案 （Cusdis + Railway）</a></p></blockquote><p>1、在 mysql 容器创建 cusdis 数据库和用户：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker <span class=nb>exec</span> -it mysql bash
</span></span><span class=line><span class=cl>mysql -uroot -p
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>CREATE USER <span class=s1>&#39;cusdis&#39;</span>@<span class=s1>&#39;%&#39;</span> IDENTIFIED BY <span class=s1>&#39;cusdis@mysql!&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>CREATE DATABASE cusdis<span class=p>;</span>
</span></span><span class=line><span class=cl>GRANT ALL ON cusdis.* TO <span class=s1>&#39;cusdis&#39;</span>@<span class=s1>&#39;%&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>ALTER USER <span class=s1>&#39;cusdis&#39;</span> IDENTIFIED WITH caching_sha2_password BY <span class=s1>&#39;cusdis@mysql!&#39;</span><span class=p>;</span>
</span></span></code></pre></div><p>2、通过 docker-compose 安装，创建 cusdis.yaml：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;3&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>cusdis</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>djyde/cusdis:latest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>container_name</span><span class=p>:</span><span class=w> </span><span class=l>cusdis</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;3010:3000&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>environment</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>USERNAME=admin</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>PASSWORD=cusdis</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>JWT_SECRET=vps@2023</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>NEXTAUTH_URL=https://cusdis.chensoul.cc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>HOST=https://cusdis.chensoul.cc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>DB_TYPE=mysql</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>DB_URL=mysql://cusdis:cusdis@mysql!@mysql:3306/cusdis</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>networks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>custom</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restart</span><span class=p>:</span><span class=w> </span><span class=l>always</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>networks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>custom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>external</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span></code></pre></div><p>以下配置为 EMAIL 配置可选，下面是使用 <a href="https://cusdis.com/doc#/features/notification?id=gmail">Gmail</a>
进行配置，需要首先开启两阶段验证并创建一个应用密码：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-properties data-lang=properties><span class=line><span class=cl><span class=na>SMTP_HOST</span><span class=o>=</span><span class=s>smtp.gmail.com</span>
</span></span><span class=line><span class=cl><span class=na>SMTP_PORT</span><span class=o>=</span><span class=s>465</span>
</span></span><span class=line><span class=cl><span class=na>SMTP_SECURE</span><span class=o>=</span><span class=s>true</span>
</span></span><span class=line><span class=cl><span class=na>SMTP_USER</span><span class=o>=</span><span class=s>your gmail email</span>
</span></span><span class=line><span class=cl><span class=na>SMTP_PASSWORD</span><span class=o>=</span><span class=s>&lt;app password&gt;</span>
</span></span><span class=line><span class=cl><span class=na>SMTP_SENDER</span><span class=o>=</span><span class=s>your gmail email</span>
</span></span></code></pre></div><p>3、启动</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker-compose -f cusdis.yaml up -d
</span></span></code></pre></div><p>4、配置 nginx</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-nginx data-lang=nginx><span class=line><span class=cl><span class=k>server</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kn>listen</span> <span class=mi>80</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>listen</span> <span class=s>[::]:80</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>server_name</span> <span class=s>cusdis.chensoul.cc</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kn>return</span> <span class=mi>301</span> <span class=s>https://</span><span class=nv>$host$request_uri</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>server</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kn>listen</span>          <span class=mi>443</span> <span class=s>ssl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>server_name</span>     <span class=s>cusdis.chensoul.cc</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kn>ssl_certificate</span>      <span class=s>/etc/nginx/ssl/fullchain.cer</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>ssl_certificate_key</span>  <span class=s>/etc/nginx/ssl/chensoul.cc.key</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kn>ssl_session_cache</span>    <span class=s>shared:SSL:1m</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>ssl_session_timeout</span>  <span class=mi>5m</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kn>ssl_ciphers</span>  <span class=s>HIGH:!aNULL:!MD5</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>ssl_prefer_server_ciphers</span>  <span class=no>on</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kn>location</span> <span class=s>/</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kn>proxy_pass</span> <span class=s>http://127.0.0.1:3010</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	      <span class=kn>proxy_pass_header</span> <span class=s>Authorization</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	      <span class=kn>proxy_pass_header</span> <span class=s>WWW-Authenticate</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kn>proxy_set_header</span> <span class=s>Host</span> <span class=nv>$host</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kn>proxy_set_header</span> <span class=s>X-Real-IP</span> <span class=nv>$remote_addr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kn>proxy_set_header</span> <span class=s>X-Forwarded-For</span> <span class=nv>$proxy_add_x_forwarded_for</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kn>if</span> <span class=s>(</span><span class=nv>$uri</span> <span class=p>=</span> <span class=s>&#39;/js/iframe.umd.js&#39;)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        	<span class=kn>add_header</span> <span class=s>&#39;Access-Control-Allow-Origin&#39;</span> <span class=s>&#39;*&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        	<span class=c1>#add_header &#39;Access-Control-Allow-Origin&#39; &#39;http://localhost:1313&#39;;
</span></span></span><span class=line><span class=cl><span class=c1></span>    	<span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>5、部署一个 Telegram 机器人，参考 <a href="https://cusdis.chensoul.cc/doc#/advanced/webhook?id=official-telegram-bot">Official Telegram bot</a>。</p><p>6、升级</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker compose -f cusdis.yaml down
</span></span><span class=line><span class=cl>docker pull djyde/cusdis:latest
</span></span><span class=line><span class=cl>docker-compose -f cusdis.yaml up -d
</span></span></code></pre></div><h3 id=memos>memos<a hidden class=anchor aria-hidden=true href=#memos>#</a></h3><p>1、在 mysql 容器创建 n8n 数据库和用户：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker <span class=nb>exec</span> -it mysql bash
</span></span><span class=line><span class=cl>mysql -uroot -p
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>CREATE USER <span class=s1>&#39;memos&#39;</span>@<span class=s1>&#39;%&#39;</span> IDENTIFIED BY <span class=s1>&#39;memos@mysql!&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>CREATE DATABASE memos<span class=p>;</span>
</span></span><span class=line><span class=cl>GRANT ALL ON memos.* TO <span class=s1>&#39;memos&#39;</span>@<span class=s1>&#39;%&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>ALTER USER <span class=s1>&#39;memos&#39;</span> IDENTIFIED WITH caching_sha2_password BY <span class=s1>&#39;memos@mysql!&#39;</span><span class=p>;</span>
</span></span></code></pre></div><p>2、通过 docker-compose 安装，创建 memos.yaml：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;3.0&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>memos</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>neosmemo/memos:latest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>container_name</span><span class=p>:</span><span class=w> </span><span class=l>memos</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>environment</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>MEMOS_DRIVER=mysql</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>MEMOS_DSN=memos:memos@mysql!@tcp(mysql)/memos</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>~/.memos/:/var/opt/memos</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=m>5230</span><span class=p>:</span><span class=m>5230</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>networks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>custom</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>networks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>custom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>external</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span></code></pre></div><p>启动</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker-compose -f memos.yaml up -d
</span></span></code></pre></div><p>配置 nginx 配置文件 /etc/nginx/conf.d/memos.conf</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-nginx data-lang=nginx><span class=line><span class=cl><span class=k>server</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kn>listen</span> <span class=mi>80</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>listen</span> <span class=s>[::]:80</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>server_name</span> <span class=s>memos.chensoul.cc</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kn>return</span> <span class=mi>301</span> <span class=s>https://</span><span class=nv>$host$request_uri</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>server</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kn>listen</span>          <span class=mi>443</span> <span class=s>ssl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>server_name</span>     <span class=s>memos.chensoul.cc</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kn>ssl_certificate</span>      <span class=s>/etc/nginx/ssl/fullchain.cer</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>ssl_certificate_key</span>  <span class=s>/etc/nginx/ssl/chensoul.cc.key</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kn>ssl_session_cache</span>    <span class=s>shared:SSL:1m</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>ssl_session_timeout</span>  <span class=mi>5m</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kn>ssl_ciphers</span>  <span class=s>HIGH:!aNULL:!MD5</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>ssl_prefer_server_ciphers</span>  <span class=no>on</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kn>location</span> <span class=s>/</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kn>proxy_pass</span> <span class=s>http://127.0.0.1:5230</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>升级</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker compose -f memos.yaml down
</span></span><span class=line><span class=cl>docker pull neosmemo/memos:latest
</span></span><span class=line><span class=cl>docker-compose -f memos.yaml up -d
</span></span></code></pre></div><h3 id=n8n>n8n<a hidden class=anchor aria-hidden=true href=#n8n>#</a></h3><p>1、在 mysql 容器创建 n8n 数据库和用户：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker <span class=nb>exec</span> -it mysql bash
</span></span><span class=line><span class=cl>mysql -uroot -p
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>CREATE USER <span class=s1>&#39;n8n&#39;</span>@<span class=s1>&#39;%&#39;</span> IDENTIFIED BY <span class=s1>&#39;n8n@mysql!&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>CREATE DATABASE n8n<span class=p>;</span>
</span></span><span class=line><span class=cl>GRANT ALL ON n8n.* TO <span class=s1>&#39;n8n&#39;</span>@<span class=s1>&#39;%&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>ALTER USER <span class=s1>&#39;n8n&#39;</span> IDENTIFIED WITH caching_sha2_password BY <span class=s1>&#39;n8n@mysql!&#39;</span><span class=p>;</span>
</span></span></code></pre></div><p>2、通过 docker-compose 安装，创建 n8n.yaml：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;3.8&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>n8n</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>n8nio/n8n</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>container_name</span><span class=p>:</span><span class=w> </span><span class=l>n8n</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restart</span><span class=p>:</span><span class=w> </span><span class=l>always</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>environment</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>DB_TYPE=mysqldb</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>DB_MYSQLDB_HOST=mysql</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>DB_MYSQLDB_PORT=3306</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>DB_MYSQLDB_DATABASE=n8n</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>DB_MYSQLDB_USER=n8n</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>DB_MYSQLDB_PASSWORD=n8n@mysql!</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>TZ=&#34;Asia/Shanghai&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>GENERIC_TIMEZONE=&#34;Asia/Shanghai&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>WEBHOOK_URL=https://n8n.chensoul.cc/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=m>5678</span><span class=p>:</span><span class=m>5678</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>~/.n8n:/home/node/.n8n</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>networks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>custom</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>networks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>custom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>external</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span></code></pre></div><p>3、启动</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker-compose -f n8n.yaml up -d
</span></span></code></pre></div><p>4、配置 nginx 配置文件 /etc/nginx/conf.d/n8n.conf</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-nginx data-lang=nginx><span class=line><span class=cl><span class=k>server</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kn>listen</span> <span class=mi>80</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>listen</span> <span class=s>[::]:80</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>server_name</span> <span class=s>n8n.chensoul.cc</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kn>return</span> <span class=mi>301</span> <span class=s>https://</span><span class=nv>$host$request_uri</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>server</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kn>listen</span>          <span class=mi>443</span> <span class=s>ssl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>server_name</span>     <span class=s>n8n.chensoul.cc</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kn>ssl_certificate</span>      <span class=s>/etc/nginx/ssl/fullchain.cer</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>ssl_certificate_key</span>  <span class=s>/etc/nginx/ssl/chensoul.cc.key</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kn>ssl_session_cache</span>    <span class=s>shared:SSL:1m</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>ssl_session_timeout</span>  <span class=mi>5m</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kn>ssl_ciphers</span>  <span class=s>HIGH:!aNULL:!MD5</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>ssl_prefer_server_ciphers</span>  <span class=no>on</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kn>location</span> <span class=s>/</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kn>proxy_pass</span> <span class=s>http://127.0.0.1:5678</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kn>chunked_transfer_encoding</span> <span class=no>off</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kn>proxy_buffering</span> <span class=no>off</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kn>proxy_cache</span> <span class=no>off</span><span class=p>;</span>
</span></span><span class=line><span class=cl>				<span class=kn>access_log</span> <span class=s>/var/log/nginx/n8n.log</span> <span class=s>combined</span> <span class=s>buffer=128k</span> <span class=s>flush=5s</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>				<span class=kn>proxy_http_version</span> <span class=mi>1</span><span class=s>.1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    		<span class=kn>proxy_set_header</span> <span class=s>Upgrade</span> <span class=nv>$http_upgrade</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    		<span class=kn>proxy_set_header</span> <span class=s>Connection</span> <span class=s>&#34;Upgrade&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>这里面的转发配置不对的话，会导致直接访问 5678 端口正常，但是访问 nginx 的话，workflow 会一直处于执行。</p><p>5、添加 workflow</p><p>参考这篇文章 <a href=http://stiles.cc/archives/237/>http://stiles.cc/archives/237/</a> ，目前我配置了以下 workflows，实现了 github、douban、rss、memos 同步到 Telegram。</p><p><img loading=lazy src=http://chensoul.oss-cn-hangzhou.aliyuncs.com/images/my-n8n-workflows.png alt=my-n8n-workflows></p><p>workflows 参考：</p><ul><li><a href=https://reorx.com/blog/sharing-my-footprints-automation/>Reorx</a></li><li><a href=https://www.pseudoyu.com/zh/2022/09/19/weekly_review_20220919/>Pseudoyu</a></li><li><a href=https://raye.xlog.app/gou-jian-ge-xing-hua-de-shu-zi-ri-ji--zi-dong-hua-gong-zuo-liu-shi-xian-xin-xi-ju-he>raye</a></li><li><a href=https://zeabur.com/docs/marketplace/n8n>Zeabur</a></li></ul><p>6、升级</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker compose -f n8n.yaml down
</span></span><span class=line><span class=cl>docker pull n8nio/n8n
</span></span><span class=line><span class=cl>docker-compose -f n8n.yaml up -d
</span></span></code></pre></div><p>7、备份</p><p>安装 jq</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>yum install epel-release -y
</span></span><span class=line><span class=cl>yum install jq -y
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=cp>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=nv>DATE</span><span class=o>=</span><span class=k>$(</span>date +%Y%m%d_%H%M%S<span class=k>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>BACKUP_DIR</span><span class=o>=</span><span class=s2>&#34;/opt/backup/n8n&#34;</span>
</span></span><span class=line><span class=cl>mkdir -p <span class=nv>$BACKUP_DIR</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>EXPORT_DIR</span><span class=o>=</span><span class=s2>&#34;workflow-</span><span class=si>${</span><span class=nv>DATE</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>docker <span class=nb>exec</span> -u node -it n8n n8n export:workflow --backup --output<span class=o>=</span>./<span class=nv>$EXPORT_DIR</span>/
</span></span><span class=line><span class=cl>docker cp n8n:/home/node/<span class=nv>$EXPORT_DIR</span> <span class=si>${</span><span class=nv>BACKUP_DIR</span><span class=si>}</span>/<span class=nv>$EXPORT_DIR</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#docker exec -u node -it n8n n8n export:credentials --all --output=./credentials.json</span>
</span></span><span class=line><span class=cl><span class=c1>#docker cp n8n:/home/node/credentials.json .</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>cd</span> <span class=nv>$BACKUP_DIR</span>/<span class=nv>$EXPORT_DIR</span>
</span></span><span class=line><span class=cl><span class=k>for</span> file in *<span class=p>;</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>    <span class=nv>filename</span><span class=o>=</span><span class=k>$(</span>cat <span class=s2>&#34;</span><span class=nv>$file</span><span class=s2>&#34;</span> <span class=p>|</span> jq -r <span class=s1>&#39;.name&#39;</span><span class=k>)</span>  <span class=c1># 使用-r选项以纯文本形式输出字段值</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;</span><span class=nv>$filename</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    mv <span class=s2>&#34;</span><span class=nv>$file</span><span class=s2>&#34;</span> <span class=s2>&#34;</span><span class=nv>$filename</span><span class=s2>&#34;</span>.json
</span></span><span class=line><span class=cl><span class=k>done</span>
</span></span></code></pre></div><h2 id=数据库备份>数据库备份<a hidden class=anchor aria-hidden=true href=#数据库备份>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=cp>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=c1># 容器名称</span>
</span></span><span class=line><span class=cl><span class=nv>CONTAINER_NAME</span><span class=o>=</span><span class=s2>&#34;mysql&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 备份目录</span>
</span></span><span class=line><span class=cl><span class=nv>BACKUP_DIR</span><span class=o>=</span><span class=s2>&#34;/opt/backup/mysql&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 日期时间</span>
</span></span><span class=line><span class=cl><span class=nv>DATE</span><span class=o>=</span><span class=k>$(</span>date +%Y%m%d_%H%M%S<span class=k>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 备份文件名后缀</span>
</span></span><span class=line><span class=cl><span class=nv>BACKUP_POSTFIX</span><span class=o>=</span><span class=s2>&#34;backup_</span><span class=si>${</span><span class=nv>DATE</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># MySQL连接参数</span>
</span></span><span class=line><span class=cl><span class=nv>DB_USER</span><span class=o>=</span><span class=s2>&#34;root&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>DB_PASSWORD</span><span class=o>=</span><span class=s2>&#34;admin@mysql!&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 要备份的数据库列表</span>
</span></span><span class=line><span class=cl><span class=nv>DATABASES</span><span class=o>=(</span><span class=s2>&#34;memos&#34;</span> <span class=s2>&#34;n8n&#34;</span> <span class=s2>&#34;umami&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建备份目录</span>
</span></span><span class=line><span class=cl>mkdir -p <span class=nv>$BACKUP_DIR</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 遍历数据库列表进行备份</span>
</span></span><span class=line><span class=cl><span class=k>for</span> DB_NAME in <span class=s2>&#34;</span><span class=si>${</span><span class=nv>DATABASES</span><span class=p>[@]</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=k>do</span>
</span></span><span class=line><span class=cl>  <span class=c1># 备份文件名</span>
</span></span><span class=line><span class=cl>  <span class=nv>BACKUP_FILE</span><span class=o>=</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>DB_NAME</span><span class=si>}</span><span class=s2>_</span><span class=si>${</span><span class=nv>BACKUP_POSTFIX</span><span class=si>}</span><span class=s2>.sql&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1># 执行备份</span>
</span></span><span class=line><span class=cl>  docker <span class=nb>exec</span> <span class=nv>$CONTAINER_NAME</span> mysqldump -u <span class=nv>$DB_USER</span> --password<span class=o>=</span><span class=nv>$DB_PASSWORD</span> <span class=nv>$DB_NAME</span> &gt; <span class=nv>$BACKUP_DIR</span>/<span class=nv>$BACKUP_FILE</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1># 检查备份是否成功</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>[</span> <span class=nv>$?</span> -eq <span class=m>0</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;数据库 </span><span class=nv>$DB_NAME</span><span class=s2> 备份成功: </span><span class=nv>$BACKUP_FILE</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;数据库 </span><span class=nv>$DB_NAME</span><span class=s2> 备份失败&#34;</span>
</span></span><span class=line><span class=cl>  <span class=k>fi</span>
</span></span><span class=line><span class=cl><span class=k>done</span>
</span></span></code></pre></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://blog.chensoul.cc/tags/hugo/>Hugo</a></li><li><a href=https://blog.chensoul.cc/tags/docker/>Docker</a></li><li><a href=https://blog.chensoul.cc/tags/rsshub/>Rsshub</a></li><li><a href=https://blog.chensoul.cc/tags/memos/>Memos</a></li><li><a href=https://blog.chensoul.cc/tags/n8n/>N8n</a></li><li><a href=https://blog.chensoul.cc/tags/vps/>Vps</a></li><li><a href=https://blog.chensoul.cc/tags/nginx/>Nginx</a></li></ul><nav class=paginav><a class=prev href=https://blog.chensoul.cc/posts/2023/01/30/weekly_review_4/><span class=title>« Prev</span><br><span>周报-4｜过年、向上管理、工作周总结</span>
</a><a class=next href=https://blog.chensoul.cc/posts/2023/01/25/weekly_review_3/><span class=title>Next »</span><br><span>周报-3｜博客定制、VPS部署服务</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share 我的VPS服务部署记录 on x" href="https://x.com/intent/tweet/?text=%e6%88%91%e7%9a%84VPS%e6%9c%8d%e5%8a%a1%e9%83%a8%e7%bd%b2%e8%ae%b0%e5%bd%95&amp;url=https%3a%2f%2fblog.chensoul.cc%2fposts%2f2023%2f01%2f25%2fnotes-about-deploy-services-in-vps%2f&amp;hashtags=hugo%2cdocker%2crsshub%2cmemos%2cn8n%2cvps%2cnginx"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 我的VPS服务部署记录 on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fblog.chensoul.cc%2fposts%2f2023%2f01%2f25%2fnotes-about-deploy-services-in-vps%2f&amp;title=%e6%88%91%e7%9a%84VPS%e6%9c%8d%e5%8a%a1%e9%83%a8%e7%bd%b2%e8%ae%b0%e5%bd%95&amp;summary=%e6%88%91%e7%9a%84VPS%e6%9c%8d%e5%8a%a1%e9%83%a8%e7%bd%b2%e8%ae%b0%e5%bd%95&amp;source=https%3a%2f%2fblog.chensoul.cc%2fposts%2f2023%2f01%2f25%2fnotes-about-deploy-services-in-vps%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 我的VPS服务部署记录 on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fblog.chensoul.cc%2fposts%2f2023%2f01%2f25%2fnotes-about-deploy-services-in-vps%2f&title=%e6%88%91%e7%9a%84VPS%e6%9c%8d%e5%8a%a1%e9%83%a8%e7%bd%b2%e8%ae%b0%e5%bd%95"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 我的VPS服务部署记录 on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fblog.chensoul.cc%2fposts%2f2023%2f01%2f25%2fnotes-about-deploy-services-in-vps%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 我的VPS服务部署记录 on whatsapp" href="https://api.whatsapp.com/send?text=%e6%88%91%e7%9a%84VPS%e6%9c%8d%e5%8a%a1%e9%83%a8%e7%bd%b2%e8%ae%b0%e5%bd%95%20-%20https%3a%2f%2fblog.chensoul.cc%2fposts%2f2023%2f01%2f25%2fnotes-about-deploy-services-in-vps%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 我的VPS服务部署记录 on telegram" href="https://telegram.me/share/url?text=%e6%88%91%e7%9a%84VPS%e6%9c%8d%e5%8a%a1%e9%83%a8%e7%bd%b2%e8%ae%b0%e5%bd%95&amp;url=https%3a%2f%2fblog.chensoul.cc%2fposts%2f2023%2f01%2f25%2fnotes-about-deploy-services-in-vps%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 我的VPS服务部署记录 on ycombinator" href="https://news.ycombinator.com/submitlink?t=%e6%88%91%e7%9a%84VPS%e6%9c%8d%e5%8a%a1%e9%83%a8%e7%bd%b2%e8%ae%b0%e5%bd%95&u=https%3a%2f%2fblog.chensoul.cc%2fposts%2f2023%2f01%2f25%2fnotes-about-deploy-services-in-vps%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://blog.chensoul.cc/>ChenSoul</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script async src=https://umami.chensoul.cc/random-string.js data-website-id=821c25f8-a31a-4607-92d7-91ee76843d00></script><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>