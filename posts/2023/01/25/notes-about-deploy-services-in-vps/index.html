<!doctype html><html lang=en-US prefix="og: http://ogp.me/ns#"><head><meta charset=utf-8><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="我的 VPS 使用的是 centos 服务器，所以以下操作都是基于 centos 系统。"><title>我的VPS服务部署记录 | ChenSoul</title>
<link rel=canonical href=https://blog.chensoul.cc/posts/2023/01/25/notes-about-deploy-services-in-vps/><link rel=preconnect href=https://fonts.font.im><link rel=preconnect href=https://fonts.loli.net crossorigin><link href="https://fonts.loli.net/css2?family=Roboto+Slab:wght@400;500;700&display=swap" rel=stylesheet><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://blog.chensoul.cc/raw-images/favicon.jpg"><meta name=twitter:title content="我的VPS服务部署记录"><meta name=twitter:description content="我的 VPS 使用的是 centos 服务器，所以以下操作都是基于 centos 系统。"><meta property="og:locale" content="en_US"><meta property="og:site_name" content="chensoul"><meta property="og:url" content="https://blog.chensoul.cc/posts/2023/01/25/notes-about-deploy-services-in-vps/"><meta property="og:site_name" content="ChenSoul"><meta property="og:title" content="我的VPS服务部署记录"><meta property="og:description" content="我的 VPS 使用的是 centos 服务器，所以以下操作都是基于 centos 系统。"><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-01-25T00:00:00+00:00"><meta property="article:modified_time" content="2023-01-25T00:00:00+00:00"><meta property="article:tag" content="Vps"><meta property="og:image" content="https://blog.chensoul.cc/raw-images/favicon.jpg"><meta itemprop=name content="我的VPS服务部署记录"><meta itemprop=description content="我的 VPS 使用的是 centos 服务器，所以以下操作都是基于 centos 系统。"><meta itemprop=datePublished content="2023-01-25T00:00:00+00:00"><meta itemprop=dateModified content="2023-01-25T00:00:00+00:00"><meta itemprop=wordCount content="1331"><meta itemprop=image content="https://blog.chensoul.cc/raw-images/favicon.jpg"><meta itemprop=keywords content="Vps"><link rel=stylesheet href=https://cdnjs.loli.net/ajax/libs/font-awesome/6.4.0/css/all.min.css media=all><link rel=stylesheet href=/main.min.css type=text/css media=all><link rel="shortcut icon" href=/favicon.ico type=image/x-icon><script type=application/ld+json>{"@context":"https://schema.org","@graph":[{"@type":"TechArticle","name":"我的VPS服务部署记录","headline":"我的VPS服务部署记录","inLanguage":"en-US","url":"https://blog.chensoul.cc/posts/2023/01/25/notes-about-deploy-services-in-vps/","description":"\u003cp\u003e我的 VPS 使用的是 centos 服务器，所以以下操作都是基于 centos 系统。\u003c/p\u003e","wordCount":"1331","keywords":["vps"],"datePublished":"2023-01-25T00:00:00Z","dateModified":"2023-01-25T00:00:00Z","author":{"@type":"Person","name":"chensoul"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.chensoul.cc/posts/2023/01/25/notes-about-deploy-services-in-vps/"},"publisher":{"@type":"Organization","name":"chensoul","url":"https://blog.chensoul.cc/posts/2023/01/25/notes-about-deploy-services-in-vps/"}},{"@context":"https://schema.org","@type":"Organization","name":"chensoul","url":"https://blog.chensoul.cc/","sameAs":["https://twitter.com/","https://github.com/chensoul","https://www.linkedin.com/in/"]}]}</script></head><body class="home blog post-layout-one-column"><button onclick=topFunction() id=scrollTopBtn title="Go to top">
<i class="fa-solid fa-arrow-up"></i></button><div id=header-top class=header-bar-wrap></div><div id=page class=site><a class="skip-link screen-reader-text" href=#content>Skip to content</a><header id=masthead class="site-header clearfix" role=banner><div class="header-main container clearfix"><div id=logo class="site-branding clearfix"><h1 class=site-title><a href=/ title=ChenSoul rel=home>ChenSoul</a></h1><p class=site-description>Java, Spring Boot, Microservice, Cloud, Architecture and DevOps Tutorials</p></div><div class="header-widgets clearfix"><aside id=search-2 class="header-widget widget_search"><form role=search method=get class=search-form onsubmit="return searchSite(event)"><label><span class=screen-reader-text>Search for:</span>
<input type=search class=search-field placeholder="Enter search keyword" name=query id=query title="Enter search keyword">
</label><button type=submit class=search-submit title=Search> <span class=genericon-search></span>
<span class=screen-reader-text>Search</span></button></form></aside></div></div><div id=main-navigation-wrap class=primary-navigation-wrap><nav id=main-navigation class="primary-navigation navigation container clearfix" role=navigation><ul id=menu-home class=main-navigation-menu><li class="menu-item menu-item-type-custom menu-item-object-custom
current-menu-item current_page_item menu-item-home"><a href=/>Home</a></li><li class="menu-item menu-item-type-taxonomy menu-item-object-category"><a href=/categories/spring-boot/>Spring Boot</a></li><li class="menu-item menu-item-type-taxonomy menu-item-object-category"><a href=/categories/architecture/>Architecture</a></li><li class="menu-item menu-item-type-taxonomy menu-item-object-category"><a href=/categories/microservice/>Microservice</a></li><li class="menu-item menu-item-type-taxonomy menu-item-object-category"><a href=/categories/kubernetes/>Kubernetes</a></li><li class="menu-item menu-item-type-taxonomy menu-item-object-category
menu-item-has-children"><a href=/tutorials/>Tutorials</a><ul class=sub-menu><li class="menu-item menu-item-type-taxonomy menu-item-object-category"><a href=/spring-boot-tutorials/>Spring Boot Tutorials</a></li><li class="menu-item menu-item-type-taxonomy menu-item-object-category"><a href=/microservice-tutorials/>Microservice Tutorials</a></li><li class="menu-item menu-item-type-taxonomy menu-item-object-category"><a href=/kubernetes-tutorials/>Kubernetes Tutorials</a></li></ul></li><li class="menu-item menu-item-type-post_type menu-item-object-page"><a href=https://github.com/chensoul target=_blank>About Me</a></li></ul></nav></div></header><div id=content class="site-content container clearfix"><section id=primary class="content-archive content-area post-content-area"><main id=main class=site-main role=main><article class="post type-post"><div class=post-inner-content><header class=entry-header><h2 class=entry-title><a href=https://blog.chensoul.cc/posts/2023/01/25/notes-about-deploy-services-in-vps/ rel=bookmark title=我的VPS服务部署记录>我的VPS服务部署记录</a></h2><hr><div class=entry-meta><span class=meta-date><time class="entry-date published" datetime=2023-01-25T00:00:00>2023-01-25
</time></span><span class=meta-author><span class="author vcard">chensoul</span>
</span><span class="tagcloud post-tags"><i class="fa fa-tags"></i>&nbsp;
<a class="tag-cloud-link widget__link widget__link--taglist" href=/tags/vps/ title=vps>vps</a></span></div></header><div class=entry-content><p>我的 VPS 使用的是 centos 服务器，所以以下操作都是基于 centos 系统。</p><h2 id=服务器设置>服务器设置</h2><p>更新 yum 源：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>yum update
</span></span></code></pre></div><p>安装常用软件：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>yum install wget curl git vim -y
</span></span></code></pre></div><p>设置时区为</p><p><strong>[可选] 设置系统 Swap 交换分区</strong></p><p>因为 vps 服务器的运行内存很小，所以这里先设置下 Swap</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 1GB RAM with 2GB Swap</span>
</span></span><span style=display:flex><span>sudo fallocate -l 2G /swapfile <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>sudo dd <span style=color:#66d9ef>if</span><span style=color:#f92672>=</span>/dev/zero of<span style=color:#f92672>=</span>/swapfile bs<span style=color:#f92672>=</span><span style=color:#ae81ff>1024</span> count<span style=color:#f92672>=</span><span style=color:#ae81ff>2097152</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>sudo chmod <span style=color:#ae81ff>600</span> /swapfile <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>sudo mkswap /swapfile <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>sudo swapon /swapfile <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>echo <span style=color:#e6db74>&#34;/swapfile swap swap defaults 0 0&#34;</span> | sudo tee -a /etc/fstab <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>sudo swapon --show <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>sudo free -h
</span></span></code></pre></div><h2 id=安装-nginx>安装 Nginx</h2><p>参考 <a href=https://qizhanming.com/blog/2018/08/06/how-to-install-nginx-on-centos-7 target=_blank>CentOS 7 下 yum 安装和配置 Nginx</a> ，使用 yum 安装：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>rpm -ivh http://nginx.org/packages/centos/7/noarch/RPMS/nginx-release-centos-7-0.el7.ngx.noarch.rpm
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>yum install nginx -y
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>systemctl enable nginx
</span></span></code></pre></div><p>打开防火墙端口</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>yum install firewalld -y
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>firewall-cmd --zone<span style=color:#f92672>=</span>public --permanent --add-service<span style=color:#f92672>=</span>http
</span></span><span style=display:flex><span>firewall-cmd --reload
</span></span></code></pre></div><p>使用反向代理需要打开网络访问权限</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>setsebool -P httpd_can_network_connect on
</span></span></code></pre></div><h2 id=安装并生成证书>安装并生成证书</h2><p>域名托管在 CloudFlare，可以参考 <a href=https://github.com/acmesh-official/acme.sh/wiki/dnsapi#dns_cf target=_blank>文章</a></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl https://get.acme.sh | sh -s email<span style=color:#f92672>=</span>ichensoul@gmail.com
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>export CF_Key<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;XXXXXXXXXXXXXXXXXX&#34;</span>
</span></span><span style=display:flex><span>export CF_Email<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;ichensoul@gmail.com&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>.acme.sh/acme.sh --issue --server letsencrypt --dns dns_cf -d chensoul.cc -d <span style=color:#e6db74>&#39;*.chensoul.cc&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>cp .acme.sh/chensoul.cc_ecc/<span style=color:#f92672>{</span>chensoul.cc.cer,chensoul.cc.key,fullchain.cer,ca.cer<span style=color:#f92672>}</span> /etc/nginx/ssl/
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>.acme.sh/acme.sh --installcert -d chensoul.cc -d *.chensoul.cc --cert-file /etc/nginx/ssl/chensoul.cc.cer --key-file /etc/nginx/ssl/chensoul.cc.key --fullchain-file /etc/nginx/ssl/fullchain.cer --ca-file /etc/nginx/ssl/ca.cer --reloadcmd <span style=color:#e6db74>&#34;sudo nginx -s reload&#34;</span>
</span></span></code></pre></div><h2 id=docker-安装和配置>Docker 安装和配置</h2><p>Docker 安装</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -fsSL https://get.docker.com -o get-docker.sh
</span></span><span style=display:flex><span>sh get-docker.sh
</span></span></code></pre></div><p>启动 docker：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl enable docker
</span></span><span style=display:flex><span>systemctl start docker
</span></span></code></pre></div><p>设置 iptables 允许流量转发：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>iptables -P FORWARD ACCEPT
</span></span></code></pre></div><p>安装 Compose</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -L <span style=color:#e6db74>&#34;https://github.com/docker/compose/releases/download/v2.23.3/docker-compose-</span><span style=color:#66d9ef>$(</span>uname -s<span style=color:#66d9ef>)</span><span style=color:#e6db74>-</span><span style=color:#66d9ef>$(</span>uname -m<span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span> -o /usr/local/bin/docker-compose
</span></span></code></pre></div><p>设置执行权限：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>chmod +x /usr/local/bin/docker-compose
</span></span></code></pre></div><p>参考 <a href=https://nginxproxymanager.com/advanced-config/#best-practice-use-a-docker-network target=_blank>Best Practice: Use a Docker network </a>，创建一个自定义的网络：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker network create custom
</span></span></code></pre></div><p>查看 docker 网络：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker network ls
</span></span><span style=display:flex><span>NETWORK ID     NAME            DRIVER    SCOPE
</span></span><span style=display:flex><span>68f4aeaa57bd   bridge          bridge    local
</span></span><span style=display:flex><span>6a96b9d8617e   custom          bridge    local
</span></span><span style=display:flex><span>4a8679e35f4d   host            host      local
</span></span><span style=display:flex><span>ba21bef23b04   none            null      local
</span></span></code></pre></div><blockquote><p>注意：bridge、host、none 是内部预先创建的网络。</p></blockquote><p>然后，在其他服务的 docker-compose.yml 文件添加：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>networks</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>custom</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>networks</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>custom</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>external</span>: <span style=color:#66d9ef>true</span>
</span></span></code></pre></div><h2 id=服务部署>服务部署</h2><h3 id=mysql>MySQL</h3><p>1、使用 docker-compose 安装</p><p>mysql.yaml</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>version</span>: <span style=color:#e6db74>&#34;3&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>services</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>mysql</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>mysql:8</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>container_name</span>: <span style=color:#ae81ff>mysql</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>platform</span>: <span style=color:#ae81ff>linux/amd64</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>restart</span>: <span style=color:#ae81ff>unless-stopped</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>/data/volumes/mysql/:/var/lib/mysql/</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>environment</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>MYSQL_ROOT_HOST=%</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>MYSQL_ROOT_PASSWORD=admin@mysql!</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>TZ=Asia/Shanghai</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;3306:3306&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>command</span>: --<span style=color:#ae81ff>default-authentication-plugin=mysql_native_password --explicit_defaults_for_timestamp=true --lower_case_table_names=1 --tls-version=&#39;&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>healthcheck</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>test</span>: <span style=color:#e6db74>&#34;/usr/bin/mysql -e &#39;SHOW DATABASES;&#39;&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>interval</span>: <span style=color:#ae81ff>5s</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>timeout</span>: <span style=color:#ae81ff>2s</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>retries</span>: <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>networks</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>custom</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>networks</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>custom</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>external</span>: <span style=color:#66d9ef>true</span>
</span></span></code></pre></div><blockquote><p>注意：<a href=https://www.cnblogs.com/atuotuo/p/9402132.html target=_blank>修改 Docker-MySQL 容器的 默认用户加密规则</a></p></blockquote><p>2、启动</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker-compose -f mysql.yaml up -d
</span></span></code></pre></div><p>3、进入容器：</p><pre tabindex=0><code class=language-bahs data-lang=bahs>docker exec -it mysql bash
</code></pre><h3 id=rsshub>Rsshub</h3><p>直接通过 Docker 安装运行：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker run -d --name rsshub -p 1200:1200 diygod/rsshub
</span></span></code></pre></div><p>配置 nginx ：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=display:flex><span><span style=color:#66d9ef>server</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>listen</span> <span style=color:#ae81ff>80</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>listen</span> <span style=color:#e6db74>[::]:80</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>server_name</span> <span style=color:#e6db74>rsshub.chensoul.cc</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>return</span> <span style=color:#ae81ff>301</span> <span style=color:#e6db74>https://</span>$host$request_uri;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>server</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>listen</span>          <span style=color:#ae81ff>443</span> <span style=color:#e6db74>ssl</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>server_name</span>     <span style=color:#e6db74>rsshub.chensoul.cc</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ssl_certificate</span>      <span style=color:#e6db74>/etc/nginx/ssl/fullchain.cer</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>ssl_certificate_key</span>  <span style=color:#e6db74>/etc/nginx/ssl/chensoul.cc.key</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ssl_session_cache</span>    <span style=color:#e6db74>shared:SSL:1m</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>ssl_session_timeout</span>  <span style=color:#ae81ff>5m</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ssl_ciphers</span>  <span style=color:#e6db74>HIGH:!aNULL:!MD5</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>ssl_prefer_server_ciphers</span>  <span style=color:#66d9ef>on</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>location</span> <span style=color:#e6db74>/</span> {
</span></span><span style=display:flex><span>        <span style=color:#f92672>proxy_pass</span> <span style=color:#e6db74>http://127.0.0.1:1200</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=uptime-kuma>Uptime Kuma</h3><p>参考 <a href=https://uptime.kuma.pet/ target=_blank>kuma</a>，使用 docker compose 部署，创建 uptime.yaml：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>version</span>: <span style=color:#e6db74>&#34;3.3&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>services</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>uptime-kuma</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>louislam/uptime-kuma:1</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>container_name</span>: <span style=color:#ae81ff>uptime-kuma</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>~/.uptime-kuma:/app/data</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>3001</span>:<span style=color:#ae81ff>3001</span> <span style=color:#75715e># &lt;Host Port&gt;:&lt;Container Port&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>restart</span>: <span style=color:#ae81ff>always</span>
</span></span></code></pre></div><p>启动：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker-compose -f uptime.yaml up -d
</span></span></code></pre></div><p>配置 nginx 配置文件 /etc/nginx/conf.d/uptime.conf ：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=display:flex><span><span style=color:#66d9ef>server</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>listen</span> <span style=color:#ae81ff>80</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>listen</span> <span style=color:#e6db74>[::]:80</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>server_name</span> <span style=color:#e6db74>uptime.chensoul.cc</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>return</span> <span style=color:#ae81ff>301</span> <span style=color:#e6db74>https://</span>$host$request_uri;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>server</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>listen</span>          <span style=color:#ae81ff>443</span> <span style=color:#e6db74>ssl</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>server_name</span>     <span style=color:#e6db74>uptime.chensoul.cc</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ssl_certificate</span>      <span style=color:#e6db74>/etc/nginx/ssl/fullchain.cer</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>ssl_certificate_key</span>  <span style=color:#e6db74>/etc/nginx/ssl/chensoul.cc.key</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ssl_session_cache</span>    <span style=color:#e6db74>shared:SSL:1m</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>ssl_session_timeout</span>  <span style=color:#ae81ff>5m</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ssl_ciphers</span>  <span style=color:#e6db74>HIGH:!aNULL:!MD5</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>ssl_prefer_server_ciphers</span>  <span style=color:#66d9ef>on</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>location</span> <span style=color:#e6db74>/</span> {
</span></span><span style=display:flex><span>        <span style=color:#f92672>proxy_pass</span> <span style=color:#e6db74>http://127.0.0.1:3001</span>;
</span></span><span style=display:flex><span>	      <span style=color:#f92672>proxy_set_header</span>   <span style=color:#e6db74>X-Real-IP</span> $remote_addr;
</span></span><span style=display:flex><span>        <span style=color:#f92672>proxy_set_header</span>   <span style=color:#e6db74>X-Forwarded-For</span> $proxy_add_x_forwarded_for;
</span></span><span style=display:flex><span>        <span style=color:#f92672>proxy_set_header</span>   <span style=color:#e6db74>Host</span> $host;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>proxy_http_version</span> <span style=color:#ae81ff>1</span><span style=color:#e6db74>.1</span>;
</span></span><span style=display:flex><span>        <span style=color:#f92672>proxy_set_header</span>   <span style=color:#e6db74>Upgrade</span> $http_upgrade;
</span></span><span style=display:flex><span>        <span style=color:#f92672>proxy_set_header</span>   <span style=color:#e6db74>Connection</span> <span style=color:#e6db74>&#34;upgrade&#34;</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>升级</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker compose -f uptime.yaml down
</span></span><span style=display:flex><span>docker pull louislam/uptime-kuma:1
</span></span><span style=display:flex><span>docker-compose -f uptime.yaml up -d
</span></span></code></pre></div><h3 id=umami>Umami</h3><p>1、在 mysql 容器创建 umami 数据库和用户：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker exec -it mysql bash
</span></span><span style=display:flex><span>mysql -uroot -padmin@mysql!
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>CREATE USER <span style=color:#e6db74>&#39;umami&#39;</span>@<span style=color:#e6db74>&#39;%&#39;</span> IDENTIFIED BY <span style=color:#e6db74>&#39;umami@mysql!&#39;</span>;
</span></span><span style=display:flex><span>CREATE DATABASE umami;
</span></span><span style=display:flex><span>GRANT ALL ON umami.* TO <span style=color:#e6db74>&#39;umami&#39;</span>@<span style=color:#e6db74>&#39;%&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ALTER USER <span style=color:#e6db74>&#39;umami&#39;</span> IDENTIFIED WITH caching_sha2_password BY <span style=color:#e6db74>&#39;umami@mysql!&#39;</span>;
</span></span></code></pre></div><blockquote><p>参考：<a href="https://support.hcltechsw.com/csm?id=kb_article&amp;sysparm_article=KB0102948" target=_blank>HCL SafeLinx Server with MySQL 8.0 causes &ldquo;Authentication plugin &lsquo;caching_sha2_password&rsquo; reported error: Authentication requires secure connection.&rdquo;</a></p></blockquote><p>2、通过 docker-compose 安装，创建 umami.yaml：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>version</span>: <span style=color:#e6db74>&#34;3&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>services</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>umami</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>ghcr.io/umami-software/umami:mysql-latest</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>container_name</span>: <span style=color:#ae81ff>umami</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;3000:3000&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>environment</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>DATABASE_URL</span>: <span style=color:#ae81ff>mysql://umami:umami@mysql!@mysql:3306/umami</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>DATABASE_TYPE</span>: <span style=color:#ae81ff>mysql</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>HASH_SALT</span>: <span style=color:#ae81ff>vps@2023</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>TRACKER_SCRIPT_NAME</span>: <span style=color:#ae81ff>random-string.js</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>networks</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>custom</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>restart</span>: <span style=color:#ae81ff>always</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>networks</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>custom</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>external</span>: <span style=color:#66d9ef>true</span>
</span></span></code></pre></div><p>参考 <a href=https://eallion.com/umami/ target=_blank>https://eallion.com/umami/</a>，Umami 的默认跟踪代码是被大多数的广告插件屏蔽的，被屏蔽了你就统计不到访客信息了。如果需要反屏蔽，需要在 docker-compose.yml 文件中添加环境变量：TRACKER_SCRIPT_NAME，如：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>    environment:
</span></span><span style=display:flex><span>      TRACKER_SCRIPT_NAME: random-string.js
</span></span></code></pre></div><p>然后获取到的跟踪代码的 src 会变成：</p><pre tabindex=0><code>srcipt.js =&gt; random-string.js
</code></pre><p>启动：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker-compose -f umami.yaml up -d
</span></span></code></pre></div><p>3、设置自定义域名</p><p>umami.chensoul.cc</p><p>4、配置 nginx 配置文件 /etc/nginx/conf.d/umami.conf</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=display:flex><span><span style=color:#66d9ef>server</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>listen</span> <span style=color:#ae81ff>80</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>listen</span> <span style=color:#e6db74>[::]:80</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>server_name</span> <span style=color:#e6db74>umami.chensoul.cc</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>return</span> <span style=color:#ae81ff>301</span> <span style=color:#e6db74>https://</span>$host$request_uri;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>server</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>listen</span>          <span style=color:#ae81ff>443</span> <span style=color:#e6db74>ssl</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>server_name</span>     <span style=color:#e6db74>umami.chensoul.cc</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ssl_certificate</span>      <span style=color:#e6db74>/etc/nginx/ssl/fullchain.cer</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>ssl_certificate_key</span>  <span style=color:#e6db74>/etc/nginx/ssl/chensoul.cc.key</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ssl_session_cache</span>    <span style=color:#e6db74>shared:SSL:1m</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>ssl_session_timeout</span>  <span style=color:#ae81ff>5m</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ssl_ciphers</span>  <span style=color:#e6db74>HIGH:!aNULL:!MD5</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>ssl_prefer_server_ciphers</span>  <span style=color:#66d9ef>on</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>location</span> <span style=color:#e6db74>/</span> {
</span></span><span style=display:flex><span>        <span style=color:#f92672>proxy_pass</span> <span style=color:#e6db74>http://127.0.0.1:3000</span>;
</span></span><span style=display:flex><span>        <span style=color:#f92672>proxy_set_header</span> <span style=color:#e6db74>Host</span> $host;
</span></span><span style=display:flex><span>        <span style=color:#f92672>proxy_set_header</span> <span style=color:#e6db74>X-Real-IP</span> $remote_addr;
</span></span><span style=display:flex><span>        <span style=color:#f92672>proxy_set_header</span> <span style=color:#e6db74>X-Forwarded-For</span> $proxy_add_x_forwarded_for;
</span></span><span style=display:flex><span>        <span style=color:#f92672>proxy_set_header</span> <span style=color:#e6db74>X-Forwarded-Proto</span> $scheme;
</span></span><span style=display:flex><span>        <span style=color:#f92672>proxy_set_header</span> <span style=color:#e6db74>REMOTE-HOST</span> $remote_addr;
</span></span><span style=display:flex><span>        <span style=color:#f92672>add_header</span> <span style=color:#e6db74>X-Cache</span> $upstream_cache_status;
</span></span><span style=display:flex><span>        <span style=color:#75715e># 缓存
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#f92672>add_header</span> <span style=color:#e6db74>Cache-Control</span> <span style=color:#e6db74>no-cache</span>;
</span></span><span style=display:flex><span>        <span style=color:#f92672>expires</span> <span style=color:#e6db74>12h</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>5、添加网站</p><p>访问 <a href=https://umami.chensoul.cc/ target=_blank>https://umami.chensoul.cc/</a>，默认用户名和密码为 admin/umami。登陆之后，修改密码，并添加网站。</p><p>6、升级</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker compose -f umami.yaml down
</span></span><span style=display:flex><span>docker pull ghcr.io/umami-software/umami:mysql-latest
</span></span><span style=display:flex><span>docker-compose -f umami.yaml up -d
</span></span></code></pre></div><h3 id=cusdis>Cusdis</h3><blockquote><p>VPS IP 可能被墙，所以可以使用三方云服务部署，具体参考<a href=https://www.pseudoyu.com/zh/2022/05/24/free_and_lightweight_blog_comment_system_using_cusdis_and_railway/ target=_blank>轻量级开源免费博客评论系统解决方案 （Cusdis + Railway）</a></p></blockquote><p>1、在 mysql 容器创建 cusdis 数据库和用户：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker exec -it mysql bash
</span></span><span style=display:flex><span>mysql -uroot -p
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>CREATE USER <span style=color:#e6db74>&#39;cusdis&#39;</span>@<span style=color:#e6db74>&#39;%&#39;</span> IDENTIFIED BY <span style=color:#e6db74>&#39;cusdis@mysql!&#39;</span>;
</span></span><span style=display:flex><span>CREATE DATABASE cusdis;
</span></span><span style=display:flex><span>GRANT ALL ON cusdis.* TO <span style=color:#e6db74>&#39;cusdis&#39;</span>@<span style=color:#e6db74>&#39;%&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ALTER USER <span style=color:#e6db74>&#39;cusdis&#39;</span> IDENTIFIED WITH caching_sha2_password BY <span style=color:#e6db74>&#39;cusdis@mysql!&#39;</span>;
</span></span></code></pre></div><p>2、通过 docker-compose 安装，创建 cusdis.yaml：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>version</span>: <span style=color:#e6db74>&#34;3&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>services</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>cusdis</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>djyde/cusdis:latest</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>container_name</span>: <span style=color:#ae81ff>cusdis</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;3010:3000&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>environment</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>USERNAME=admin</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>PASSWORD=cusdis</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>JWT_SECRET=vps@2023</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>NEXTAUTH_URL=https://cusdis.chensoul.cc</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>HOST=https://cusdis.chensoul.cc</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>DB_TYPE=mysql</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>DB_URL=mysql://cusdis:cusdis@mysql!@mysql:3306/cusdis</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>networks</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>custom</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>restart</span>: <span style=color:#ae81ff>always</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>networks</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>custom</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>external</span>: <span style=color:#66d9ef>true</span>
</span></span></code></pre></div><p>以下配置为 EMAIL 配置可选，下面是使用 <a href="https://cusdis.com/doc#/features/notification?id=gmail" target=_blank>Gmail</a>
进行配置，需要首先开启两阶段验证并创建一个应用密码：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-properties data-lang=properties><span style=display:flex><span><span style=color:#a6e22e>SMTP_HOST</span><span style=color:#f92672>=</span><span style=color:#e6db74>smtp.gmail.com</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>SMTP_PORT</span><span style=color:#f92672>=</span><span style=color:#e6db74>465</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>SMTP_SECURE</span><span style=color:#f92672>=</span><span style=color:#e6db74>true</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>SMTP_USER</span><span style=color:#f92672>=</span><span style=color:#e6db74>your gmail email</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>SMTP_PASSWORD</span><span style=color:#f92672>=</span><span style=color:#e6db74>&lt;app password&gt;</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>SMTP_SENDER</span><span style=color:#f92672>=</span><span style=color:#e6db74>your gmail email</span>
</span></span></code></pre></div><p>3、启动</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker-compose -f cusdis.yaml up -d
</span></span></code></pre></div><p>4、配置 nginx</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=display:flex><span><span style=color:#66d9ef>server</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>listen</span> <span style=color:#ae81ff>80</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>listen</span> <span style=color:#e6db74>[::]:80</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>server_name</span> <span style=color:#e6db74>cusdis.chensoul.cc</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>return</span> <span style=color:#ae81ff>301</span> <span style=color:#e6db74>https://</span>$host$request_uri;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>server</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>listen</span>          <span style=color:#ae81ff>443</span> <span style=color:#e6db74>ssl</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>server_name</span>     <span style=color:#e6db74>cusdis.chensoul.cc</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ssl_certificate</span>      <span style=color:#e6db74>/etc/nginx/ssl/fullchain.cer</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>ssl_certificate_key</span>  <span style=color:#e6db74>/etc/nginx/ssl/chensoul.cc.key</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ssl_session_cache</span>    <span style=color:#e6db74>shared:SSL:1m</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>ssl_session_timeout</span>  <span style=color:#ae81ff>5m</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ssl_ciphers</span>  <span style=color:#e6db74>HIGH:!aNULL:!MD5</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>ssl_prefer_server_ciphers</span>  <span style=color:#66d9ef>on</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>location</span> <span style=color:#e6db74>/</span> {
</span></span><span style=display:flex><span>        <span style=color:#f92672>proxy_pass</span> <span style=color:#e6db74>http://127.0.0.1:3010</span>;
</span></span><span style=display:flex><span>	      <span style=color:#f92672>proxy_pass_header</span> <span style=color:#e6db74>Authorization</span>;
</span></span><span style=display:flex><span>	      <span style=color:#f92672>proxy_pass_header</span> <span style=color:#e6db74>WWW-Authenticate</span>;
</span></span><span style=display:flex><span>        <span style=color:#f92672>proxy_set_header</span> <span style=color:#e6db74>Host</span> $host;
</span></span><span style=display:flex><span>        <span style=color:#f92672>proxy_set_header</span> <span style=color:#e6db74>X-Real-IP</span> $remote_addr;
</span></span><span style=display:flex><span>        <span style=color:#f92672>proxy_set_header</span> <span style=color:#e6db74>X-Forwarded-For</span> $proxy_add_x_forwarded_for;
</span></span><span style=display:flex><span>	<span style=color:#f92672>if</span> <span style=color:#e6db74>(</span>$uri = <span style=color:#e6db74>&#39;/js/iframe.umd.js&#39;)</span> {
</span></span><span style=display:flex><span>        	<span style=color:#f92672>add_header</span> <span style=color:#e6db74>&#39;Access-Control-Allow-Origin&#39;</span> <span style=color:#e6db74>&#39;*&#39;</span>;
</span></span><span style=display:flex><span>        	<span style=color:#75715e>#add_header &#39;Access-Control-Allow-Origin&#39; &#39;http://localhost:1313&#39;;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    	}
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>5、部署一个 Telegram 机器人，参考 <a href="https://cusdis.chensoul.cc/doc#/advanced/webhook?id=official-telegram-bot" target=_blank>Official Telegram bot</a>。</p><p>6、升级</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker compose -f cusdis.yaml down
</span></span><span style=display:flex><span>docker pull djyde/cusdis:latest
</span></span><span style=display:flex><span>docker-compose -f cusdis.yaml up -d
</span></span></code></pre></div><h3 id=memos>memos</h3><p>1、在 mysql 容器创建 n8n 数据库和用户：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker exec -it mysql bash
</span></span><span style=display:flex><span>mysql -uroot -p
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>CREATE USER <span style=color:#e6db74>&#39;memos&#39;</span>@<span style=color:#e6db74>&#39;%&#39;</span> IDENTIFIED BY <span style=color:#e6db74>&#39;memos@mysql!&#39;</span>;
</span></span><span style=display:flex><span>CREATE DATABASE memos;
</span></span><span style=display:flex><span>GRANT ALL ON memos.* TO <span style=color:#e6db74>&#39;memos&#39;</span>@<span style=color:#e6db74>&#39;%&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ALTER USER <span style=color:#e6db74>&#39;memos&#39;</span> IDENTIFIED WITH caching_sha2_password BY <span style=color:#e6db74>&#39;memos@mysql!&#39;</span>;
</span></span></code></pre></div><p>2、通过 docker-compose 安装，创建 memos.yaml：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>version</span>: <span style=color:#e6db74>&#34;3.0&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>services</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>memos</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>neosmemo/memos:latest</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>container_name</span>: <span style=color:#ae81ff>memos</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>environment</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>MEMOS_DRIVER=mysql</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>MEMOS_DSN=memos:memos@mysql!@tcp(mysql)/memos</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>~/.memos/:/var/opt/memos</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>5230</span>:<span style=color:#ae81ff>5230</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>networks</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>custom</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>networks</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>custom</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>external</span>: <span style=color:#66d9ef>true</span>
</span></span></code></pre></div><p>启动</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker-compose -f memos.yaml up -d
</span></span></code></pre></div><p>配置 nginx 配置文件 /etc/nginx/conf.d/memos.conf</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=display:flex><span><span style=color:#66d9ef>server</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>listen</span> <span style=color:#ae81ff>80</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>listen</span> <span style=color:#e6db74>[::]:80</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>server_name</span> <span style=color:#e6db74>memos.chensoul.cc</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>return</span> <span style=color:#ae81ff>301</span> <span style=color:#e6db74>https://</span>$host$request_uri;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>server</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>listen</span>          <span style=color:#ae81ff>443</span> <span style=color:#e6db74>ssl</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>server_name</span>     <span style=color:#e6db74>memos.chensoul.cc</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ssl_certificate</span>      <span style=color:#e6db74>/etc/nginx/ssl/fullchain.cer</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>ssl_certificate_key</span>  <span style=color:#e6db74>/etc/nginx/ssl/chensoul.cc.key</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ssl_session_cache</span>    <span style=color:#e6db74>shared:SSL:1m</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>ssl_session_timeout</span>  <span style=color:#ae81ff>5m</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ssl_ciphers</span>  <span style=color:#e6db74>HIGH:!aNULL:!MD5</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>ssl_prefer_server_ciphers</span>  <span style=color:#66d9ef>on</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>location</span> <span style=color:#e6db74>/</span> {
</span></span><span style=display:flex><span>        <span style=color:#f92672>proxy_pass</span> <span style=color:#e6db74>http://127.0.0.1:5230</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>升级</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker compose -f memos.yaml down
</span></span><span style=display:flex><span>docker pull neosmemo/memos:latest
</span></span><span style=display:flex><span>docker-compose -f memos.yaml up -d
</span></span></code></pre></div><h3 id=n8n>n8n</h3><p>1、在 mysql 容器创建 n8n 数据库和用户：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker exec -it mysql bash
</span></span><span style=display:flex><span>mysql -uroot -p
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>CREATE USER <span style=color:#e6db74>&#39;n8n&#39;</span>@<span style=color:#e6db74>&#39;%&#39;</span> IDENTIFIED BY <span style=color:#e6db74>&#39;n8n@mysql!&#39;</span>;
</span></span><span style=display:flex><span>CREATE DATABASE n8n;
</span></span><span style=display:flex><span>GRANT ALL ON n8n.* TO <span style=color:#e6db74>&#39;n8n&#39;</span>@<span style=color:#e6db74>&#39;%&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ALTER USER <span style=color:#e6db74>&#39;n8n&#39;</span> IDENTIFIED WITH caching_sha2_password BY <span style=color:#e6db74>&#39;n8n@mysql!&#39;</span>;
</span></span></code></pre></div><p>2、通过 docker-compose 安装，创建 n8n.yaml：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>version</span>: <span style=color:#e6db74>&#34;3.8&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>services</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>n8n</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>n8nio/n8n</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>container_name</span>: <span style=color:#ae81ff>n8n</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>restart</span>: <span style=color:#ae81ff>always</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>environment</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>DB_TYPE=mysqldb</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>DB_MYSQLDB_HOST=mysql</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>DB_MYSQLDB_PORT=3306</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>DB_MYSQLDB_DATABASE=n8n</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>DB_MYSQLDB_USER=n8n</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>DB_MYSQLDB_PASSWORD=n8n@mysql!</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>TZ=&#34;Asia/Shanghai&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>GENERIC_TIMEZONE=&#34;Asia/Shanghai&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>WEBHOOK_URL=https://n8n.chensoul.cc/</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>5678</span>:<span style=color:#ae81ff>5678</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>~/.n8n:/home/node/.n8n</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>networks</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>custom</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>networks</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>custom</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>external</span>: <span style=color:#66d9ef>true</span>
</span></span></code></pre></div><p>3、启动</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker-compose -f n8n.yaml up -d
</span></span></code></pre></div><p>4、配置 nginx 配置文件 /etc/nginx/conf.d/n8n.conf</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=display:flex><span><span style=color:#66d9ef>server</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>listen</span> <span style=color:#ae81ff>80</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>listen</span> <span style=color:#e6db74>[::]:80</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>server_name</span> <span style=color:#e6db74>n8n.chensoul.cc</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>return</span> <span style=color:#ae81ff>301</span> <span style=color:#e6db74>https://</span>$host$request_uri;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>server</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>listen</span>          <span style=color:#ae81ff>443</span> <span style=color:#e6db74>ssl</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>server_name</span>     <span style=color:#e6db74>n8n.chensoul.cc</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ssl_certificate</span>      <span style=color:#e6db74>/etc/nginx/ssl/fullchain.cer</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>ssl_certificate_key</span>  <span style=color:#e6db74>/etc/nginx/ssl/chensoul.cc.key</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ssl_session_cache</span>    <span style=color:#e6db74>shared:SSL:1m</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>ssl_session_timeout</span>  <span style=color:#ae81ff>5m</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ssl_ciphers</span>  <span style=color:#e6db74>HIGH:!aNULL:!MD5</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>ssl_prefer_server_ciphers</span>  <span style=color:#66d9ef>on</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>location</span> <span style=color:#e6db74>/</span> {
</span></span><span style=display:flex><span>        <span style=color:#f92672>proxy_pass</span> <span style=color:#e6db74>http://127.0.0.1:5678</span>;
</span></span><span style=display:flex><span>        <span style=color:#f92672>chunked_transfer_encoding</span> <span style=color:#66d9ef>off</span>;
</span></span><span style=display:flex><span>        <span style=color:#f92672>proxy_buffering</span> <span style=color:#66d9ef>off</span>;
</span></span><span style=display:flex><span>        <span style=color:#f92672>proxy_cache</span> <span style=color:#66d9ef>off</span>;
</span></span><span style=display:flex><span>				<span style=color:#f92672>access_log</span> <span style=color:#e6db74>/var/log/nginx/n8n.log</span> <span style=color:#e6db74>combined</span> <span style=color:#e6db74>buffer=128k</span> <span style=color:#e6db74>flush=5s</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>				<span style=color:#f92672>proxy_http_version</span> <span style=color:#ae81ff>1</span><span style=color:#e6db74>.1</span>;
</span></span><span style=display:flex><span>    		<span style=color:#f92672>proxy_set_header</span> <span style=color:#e6db74>Upgrade</span> $http_upgrade;
</span></span><span style=display:flex><span>    		<span style=color:#f92672>proxy_set_header</span> <span style=color:#e6db74>Connection</span> <span style=color:#e6db74>&#34;Upgrade&#34;</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>这里面的转发配置不对的话，会导致直接访问 5678 端口正常，但是访问 nginx 的话，workflow 会一直处于执行。</p><p>5、添加 workflow</p><p>参考这篇文章 <a href=http://stiles.cc/archives/237/ target=_blank>http://stiles.cc/archives/237/</a> ，目前我配置了以下 workflows，实现了 github、douban、rss、memos 同步到 Telegram。</p><p><img src=/images/my-n8n-workflows.webp alt=my-n8n-workflows></p><p>workflows 参考：</p><ul><li><a href=https://reorx.com/blog/sharing-my-footprints-automation/ target=_blank>Reorx</a></li><li><a href=https://www.pseudoyu.com/zh/2022/09/19/weekly_review_20220919/ target=_blank>Pseudoyu</a></li><li><a href=https://raye.xlog.app/gou-jian-ge-xing-hua-de-shu-zi-ri-ji--zi-dong-hua-gong-zuo-liu-shi-xian-xin-xi-ju-he target=_blank>raye</a></li><li><a href=https://zeabur.com/docs/marketplace/n8n target=_blank>Zeabur</a></li></ul><p>6、升级</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker compose -f n8n.yaml down
</span></span><span style=display:flex><span>docker pull n8nio/n8n
</span></span><span style=display:flex><span>docker-compose -f n8n.yaml up -d
</span></span></code></pre></div><p>7、备份</p><p>安装 jq</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>yum install epel-release -y
</span></span><span style=display:flex><span>yum install jq -y
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>DATE<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>date +%Y%m%d_%H%M%S<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>BACKUP_DIR<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/opt/backup/n8n&#34;</span>
</span></span><span style=display:flex><span>mkdir -p $BACKUP_DIR
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>EXPORT_DIR<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;workflow-</span><span style=color:#e6db74>${</span>DATE<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>docker exec -u node -it n8n n8n export:workflow --backup --output<span style=color:#f92672>=</span>./$EXPORT_DIR/
</span></span><span style=display:flex><span>docker cp n8n:/home/node/$EXPORT_DIR <span style=color:#e6db74>${</span>BACKUP_DIR<span style=color:#e6db74>}</span>/$EXPORT_DIR
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#docker exec -u node -it n8n n8n export:credentials --all --output=./credentials.json</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#docker cp n8n:/home/node/credentials.json .</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>cd $BACKUP_DIR/$EXPORT_DIR
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> file in *; <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>    filename<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>cat <span style=color:#e6db74>&#34;</span>$file<span style=color:#e6db74>&#34;</span> | jq -r <span style=color:#e6db74>&#39;.name&#39;</span><span style=color:#66d9ef>)</span>  <span style=color:#75715e># 使用-r选项以纯文本形式输出字段值</span>
</span></span><span style=display:flex><span>    echo <span style=color:#e6db74>&#34;</span>$filename<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    mv <span style=color:#e6db74>&#34;</span>$file<span style=color:#e6db74>&#34;</span> <span style=color:#e6db74>&#34;</span>$filename<span style=color:#e6db74>&#34;</span>.json
</span></span><span style=display:flex><span><span style=color:#66d9ef>done</span>
</span></span></code></pre></div><h2 id=数据库备份>数据库备份</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e># 容器名称</span>
</span></span><span style=display:flex><span>CONTAINER_NAME<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;mysql&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 备份目录</span>
</span></span><span style=display:flex><span>BACKUP_DIR<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/opt/backup/mysql&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 日期时间</span>
</span></span><span style=display:flex><span>DATE<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>date +%Y%m%d_%H%M%S<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 备份文件名后缀</span>
</span></span><span style=display:flex><span>BACKUP_POSTFIX<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;backup_</span><span style=color:#e6db74>${</span>DATE<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># MySQL连接参数</span>
</span></span><span style=display:flex><span>DB_USER<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;root&#34;</span>
</span></span><span style=display:flex><span>DB_PASSWORD<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;admin@mysql!&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 要备份的数据库列表</span>
</span></span><span style=display:flex><span>DATABASES<span style=color:#f92672>=(</span><span style=color:#e6db74>&#34;memos&#34;</span> <span style=color:#e6db74>&#34;n8n&#34;</span> <span style=color:#e6db74>&#34;umami&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 创建备份目录</span>
</span></span><span style=display:flex><span>mkdir -p $BACKUP_DIR
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 遍历数据库列表进行备份</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> DB_NAME in <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>DATABASES[@]<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># 备份文件名</span>
</span></span><span style=display:flex><span>  BACKUP_FILE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>DB_NAME<span style=color:#e6db74>}</span><span style=color:#e6db74>_</span><span style=color:#e6db74>${</span>BACKUP_POSTFIX<span style=color:#e6db74>}</span><span style=color:#e6db74>.sql&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># 执行备份</span>
</span></span><span style=display:flex><span>  docker exec $CONTAINER_NAME mysqldump -u $DB_USER --password<span style=color:#f92672>=</span>$DB_PASSWORD $DB_NAME &gt; $BACKUP_DIR/$BACKUP_FILE
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># 检查备份是否成功</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> $? -eq <span style=color:#ae81ff>0</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>    echo <span style=color:#e6db74>&#34;数据库 </span>$DB_NAME<span style=color:#e6db74> 备份成功: </span>$BACKUP_FILE<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>    echo <span style=color:#e6db74>&#34;数据库 </span>$DB_NAME<span style=color:#e6db74> 备份失败&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>done</span>
</span></span></code></pre></div></div><div><div style=font-weight:700>Share this post:</div><a class=social-link-item href="https://twitter.com/intent/tweet?text=%e6%88%91%e7%9a%84VPS%e6%9c%8d%e5%8a%a1%e9%83%a8%e7%bd%b2%e8%ae%b0%e5%bd%95 https%3a%2f%2fblog.chensoul.cc%2fposts%2f2023%2f01%2f25%2fnotes-about-deploy-services-in-vps%2f" target=_blank rel="noopener noreferrer" title="Click to share on Twitter"><i class="fa-brands fa-square-twitter fa-2xl" style=color:#55acee></i>
</a><a class=social-link-item href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fblog.chensoul.cc%2fposts%2f2023%2f01%2f25%2fnotes-about-deploy-services-in-vps%2f&title=%e6%88%91%e7%9a%84VPS%e6%9c%8d%e5%8a%a1%e9%83%a8%e7%bd%b2%e8%ae%b0%e5%bd%95" target=_blank rel="noopener noreferrer" title="Click to share on LinkedIn"><i class="fa-brands fa-linkedin fa-2xl" style=color:#007bb5></i>
</a><a class=social-link-item href="https://telegram.me/share/url?text=%e6%88%91%e7%9a%84VPS%e6%9c%8d%e5%8a%a1%e9%83%a8%e7%bd%b2%e8%ae%b0%e5%bd%95&amp;url=https%3a%2f%2fblog.chensoul.cc%2fposts%2f2023%2f01%2f25%2fnotes-about-deploy-services-in-vps%2f" target=_blank rel="noopener noreferrer" title="Click to share on telegram"><i class="fa-brands fa-telegram fa-2xl" style=color:#007bb5></i>
</a><a class=social-link-item href="https://reddit.com/submit?url=https%3a%2f%2fblog.chensoul.cc%2fposts%2f2023%2f01%2f25%2fnotes-about-deploy-services-in-vps%2f&title=%e6%88%91%e7%9a%84VPS%e6%9c%8d%e5%8a%a1%e9%83%a8%e7%bd%b2%e8%ae%b0%e5%bd%95" target=_blank rel="noopener noreferrer" title="Click to share on reddit"><i class="fa-brands fa-reddit fa-2xl" style=color:#007bb5></i>
</a><a class=social-link-item href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fblog.chensoul.cc%2fposts%2f2023%2f01%2f25%2fnotes-about-deploy-services-in-vps%2f" target=_blank rel="noopener noreferrer" title="Click to share on facebook"><i class="fa-brands fa-facebook fa-2xl" style=color:#007bb5></i>
</a><a class=social-link-item href="https://api.whatsapp.com/send?text=%e6%88%91%e7%9a%84VPS%e6%9c%8d%e5%8a%a1%e9%83%a8%e7%bd%b2%e8%ae%b0%e5%bd%95%20-%20https%3a%2f%2fblog.chensoul.cc%2fposts%2f2023%2f01%2f25%2fnotes-about-deploy-services-in-vps%2f" target=_blank rel="noopener noreferrer" title="Click to share on whatsapp"><i class="fa-brands fa-whatsapp fa-2xl" style=color:#007bb5></i></a></div></div></article><nav class="navigation post-navigation" role=navigation><h2 class=screen-reader-text>Post navigation</h2><div class=nav-links><div class=nav-previous><a href=/posts/2023/01/25/weekly_review_3/ rel=next><span class=post-title>周报-3｜博客定制、VPS部署服务</span></a></div><div class=nav-next><a href=/posts/2023/01/15/weekly_review_2/ rel=prev><span class=post-title>周报-2｜博客重构</span></a></div></div></nav><h2>Related content</h2><ul><li><a href=/posts/2023/10/12/git-interview-questions/>[译]DevOps 和测试人员的 Git 面试问题</a></li><li><a href=/posts/2023/10/12/http-in-depth/>[译]关于 HTTP 您需要了解的一切</a></li><li><a href=/posts/2023/05/11/git-flow-model-and-usage/>Git Flow分支模型和使用</a></li><li><a href=/posts/2024/10/17/kafka-fundamental/>Kafka 基础知识</a></li><li><a href=/posts/2024/07/19/gitlab-runner-install/>GitLab Runner安装和部署</a></li><li><a href=/posts/2024/07/15/install-gitlab-using-yum/>Gitlab安装和部署-使用yum源</a></li><li><a href=/posts/2024/07/15/git/>Git介绍</a></li><li><a href=/posts/2024/07/15/git/>Git使用</a></li><li><a href=/posts/2024/07/09/install-docker/>Docker安装和配置</a></li><li><a href=/posts/2024/07/09/docker-for-spring-boot/>使用 Docker 容器化并运行 Spring Boot 应用程序</a></li></ul></main></section></div><div id=footer class=footer-wrap><footer id=colophon class="site-footer container clearfix" role=contentinfo><div id=footer-text class=site-info><span class=credit-link><a href=/ target=_blank rel="noopener noreferrer">ChenSoul</a>
Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreferrer">Hugo</a>
<a style=margin-left:20px href=/privacy_policy/ target=_blank rel="noopener noreferrer">Privacy Policy</a></span></div></footer></div></div><script type=text/javascript src=/main.min.js></script></body></html>