<!doctype html><html lang=en-US prefix="og: http://ogp.me/ns#"><head><meta charset=utf-8><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="JSR ä»‹ç»
JSRï¼Œå…¨ç§° Java Specification Requestsï¼Œ å³ Java è§„èŒƒææ¡ˆï¼Œ ä¸»è¦æ˜¯ç”¨äºå‘ JCP(Java Community Process) æå‡ºæ–°å¢æ ‡å‡†åŒ–æŠ€æœ¯è§„èŒƒçš„æ­£å¼è¯·æ±‚ã€‚æ¯æ¬¡ JAVA ç‰ˆæœ¬æ›´æ–°éƒ½ä¼šæœ‰å¯¹åº”çš„ JSR æ›´æ–°ï¼Œæ¯”å¦‚åœ¨ Java 8 ç‰ˆæœ¬ä¸­ï¼Œå…¶æ–°ç‰¹æ€§ Lambda è¡¨è¾¾å¼å¯¹åº”çš„æ˜¯ JSR 335ï¼Œæ–°çš„æ—¥æœŸå’Œæ—¶é—´ API å¯¹åº”çš„æ˜¯ JSR 310ã€‚"><title>JSR 166è§„èŒƒ | ChenSoul</title>
<link rel=canonical href=https://blog.chensoul.cc/posts/2023/05/18/jsr-166/><link rel=preconnect href=https://fonts.font.im><link rel=preconnect href=https://fonts.loli.net crossorigin><link href="https://fonts.loli.net/css2?family=Roboto+Slab:wght@400;500;700&display=swap" rel=stylesheet><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://blog.chensoul.cc/images/favicon.webp"><meta name=twitter:title content="JSR 166è§„èŒƒ"><meta name=twitter:description content="JSR ä»‹ç» JSRï¼Œå…¨ç§° Java Specification Requestsï¼Œ å³ Java è§„èŒƒææ¡ˆï¼Œ ä¸»è¦æ˜¯ç”¨äºå‘ JCP(Java Community Process) æå‡ºæ–°å¢æ ‡å‡†åŒ–æŠ€æœ¯è§„èŒƒçš„æ­£å¼è¯·æ±‚ã€‚æ¯æ¬¡ JAVA ç‰ˆæœ¬æ›´æ–°éƒ½ä¼šæœ‰å¯¹åº”çš„ JSR æ›´æ–°ï¼Œæ¯”å¦‚åœ¨ Java 8 ç‰ˆæœ¬ä¸­ï¼Œå…¶æ–°ç‰¹æ€§ Lambda è¡¨è¾¾å¼å¯¹åº”çš„æ˜¯ JSR 335ï¼Œæ–°çš„æ—¥æœŸå’Œæ—¶é—´ API å¯¹åº”çš„æ˜¯ JSR 310ã€‚"><meta name=twitter:creator content="@ichensoul"><meta property="og:locale" content="en_US"><meta property="og:site_name" content="chensoul"><meta property="og:url" content="https://blog.chensoul.cc/posts/2023/05/18/jsr-166/"><meta property="og:site_name" content="ChenSoul"><meta property="og:title" content="JSR 166è§„èŒƒ"><meta property="og:description" content="JSR ä»‹ç» JSRï¼Œå…¨ç§° Java Specification Requestsï¼Œ å³ Java è§„èŒƒææ¡ˆï¼Œ ä¸»è¦æ˜¯ç”¨äºå‘ JCP(Java Community Process) æå‡ºæ–°å¢æ ‡å‡†åŒ–æŠ€æœ¯è§„èŒƒçš„æ­£å¼è¯·æ±‚ã€‚æ¯æ¬¡ JAVA ç‰ˆæœ¬æ›´æ–°éƒ½ä¼šæœ‰å¯¹åº”çš„ JSR æ›´æ–°ï¼Œæ¯”å¦‚åœ¨ Java 8 ç‰ˆæœ¬ä¸­ï¼Œå…¶æ–°ç‰¹æ€§ Lambda è¡¨è¾¾å¼å¯¹åº”çš„æ˜¯ JSR 335ï¼Œæ–°çš„æ—¥æœŸå’Œæ—¶é—´ API å¯¹åº”çš„æ˜¯ JSR 310ã€‚"><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-05-18T00:00:00+00:00"><meta property="article:modified_time" content="2023-05-18T00:00:00+00:00"><meta property="article:tag" content="Java"><meta property="og:image" content="https://blog.chensoul.cc/images/favicon.webp"><meta itemprop=name content="JSR 166è§„èŒƒ"><meta itemprop=description content="JSR ä»‹ç» JSRï¼Œå…¨ç§° Java Specification Requestsï¼Œ å³ Java è§„èŒƒææ¡ˆï¼Œ ä¸»è¦æ˜¯ç”¨äºå‘ JCP(Java Community Process) æå‡ºæ–°å¢æ ‡å‡†åŒ–æŠ€æœ¯è§„èŒƒçš„æ­£å¼è¯·æ±‚ã€‚æ¯æ¬¡ JAVA ç‰ˆæœ¬æ›´æ–°éƒ½ä¼šæœ‰å¯¹åº”çš„ JSR æ›´æ–°ï¼Œæ¯”å¦‚åœ¨ Java 8 ç‰ˆæœ¬ä¸­ï¼Œå…¶æ–°ç‰¹æ€§ Lambda è¡¨è¾¾å¼å¯¹åº”çš„æ˜¯ JSR 335ï¼Œæ–°çš„æ—¥æœŸå’Œæ—¶é—´ API å¯¹åº”çš„æ˜¯ JSR 310ã€‚"><meta itemprop=datePublished content="2023-05-18T00:00:00+00:00"><meta itemprop=dateModified content="2023-05-18T00:00:00+00:00"><meta itemprop=wordCount content="664"><meta itemprop=image content="https://blog.chensoul.cc/images/favicon.webp"><meta itemprop=keywords content="Java"><link rel=stylesheet href=https://cdnjs.loli.net/ajax/libs/font-awesome/6.4.0/css/all.min.css media=all><link rel=stylesheet href=/main.min.css type=text/css media=all><link rel="shortcut icon" href=/favicon.ico type=image/x-icon><script type=application/ld+json>{"@context":"https://schema.org","@graph":[{"@type":"TechArticle","name":"JSR 166è§„èŒƒ","headline":"JSR 166è§„èŒƒ","inLanguage":"en-US","url":"https://blog.chensoul.cc/posts/2023/05/18/jsr-166/","description":"\u003ch2 id=\"jsr-ä»‹ç»\"\u003eJSR ä»‹ç»\u003c/h2\u003e\n\u003cp\u003eJSRï¼Œå…¨ç§° Java Specification Requestsï¼Œ å³ Java è§„èŒƒææ¡ˆï¼Œ ä¸»è¦æ˜¯ç”¨äºå‘ JCP(Java Community Process) æå‡ºæ–°å¢æ ‡å‡†åŒ–æŠ€æœ¯è§„èŒƒçš„æ­£å¼è¯·æ±‚ã€‚æ¯æ¬¡ JAVA ç‰ˆæœ¬æ›´æ–°éƒ½ä¼šæœ‰å¯¹åº”çš„ JSR æ›´æ–°ï¼Œæ¯”å¦‚åœ¨ Java 8 ç‰ˆæœ¬ä¸­ï¼Œå…¶æ–°ç‰¹æ€§ Lambda è¡¨è¾¾å¼å¯¹åº”çš„æ˜¯ \u003ca href=\"http://jcp.org/en/jsr/detail?id=335\" target=\"_blank\"\u003eJSR 335\u003c/a\u003eï¼Œæ–°çš„æ—¥æœŸå’Œæ—¶é—´ API å¯¹åº”çš„æ˜¯ \u003ca href=\"http://jcp.org/en/jsr/detail?id=310\" target=\"_blank\"\u003eJSR 310\u003c/a\u003eã€‚\u003c/p\u003e","wordCount":"664","keywords":["java"],"datePublished":"2023-05-18T00:00:00Z","dateModified":"2023-05-18T00:00:00Z","author":{"@type":"Person","name":"chensoul"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.chensoul.cc/posts/2023/05/18/jsr-166/"},"publisher":{"@type":"Organization","name":"chensoul","url":"https://blog.chensoul.cc/posts/2023/05/18/jsr-166/"}},{"@context":"https://schema.org","@type":"Organization","name":"chensoul","url":"https://blog.chensoul.cc/","sameAs":["https://x.com/ichensoul","https://github.com/chensoul","https://www.linkedin.com/in/","https://www.youtube.com/@chensoul","https://t.me/chensouls"]}]}</script><script defer src=https://umami.chensoul.cc/random-string.js data-website-id=821c25f8-a31a-4607-92d7-91ee76843d00></script></head><body class="home blog post-layout-one-column"><button onclick=topFunction() id=scrollTopBtn title="Go to top">
<i class="fa-solid fa-arrow-up"></i></button><div id=header-top class=header-bar-wrap></div><div id=page class=site><a class="skip-link screen-reader-text" href=#content>Skip to content</a><header id=masthead class="site-header clearfix" role=banner><div class="header-main container clearfix"><div id=logo class="site-branding clearfix"><h1 class=site-title><a href=/ title=ChenSoul rel=home>ChenSoul</a></h1><p class=site-description>Java, Spring Boot, Microservice, Cloud, Architecture and DevOps Tutorials</p></div><div class="header-widgets clearfix"><aside id=search-2 class="header-widget widget_search"><form role=search method=get class=search-form onsubmit="return searchSite(event)"><label><span class=screen-reader-text>Search for:</span>
<input type=search class=search-field placeholder="Enter search keyword" name=query id=query title="Enter search keyword">
</label><button type=submit class=search-submit title=Search> <span class=genericon-search></span>
<span class=screen-reader-text>Search</span></button></form></aside></div></div><div id=main-navigation-wrap class=primary-navigation-wrap><nav id=main-navigation class="primary-navigation navigation container clearfix" role=navigation><ul id=menu-home class=main-navigation-menu><li class="menu-item menu-item-type-custom menu-item-object-custom
current-menu-item current_page_item menu-item-home"><a href=/>Home</a></li><li class="menu-item menu-item-type-taxonomy menu-item-object-category"><a href=/categories/spring-boot/>Spring Boot</a></li><li class="menu-item menu-item-type-taxonomy menu-item-object-category"><a href=/categories/architecture/>Architecture</a></li><li class="menu-item menu-item-type-taxonomy menu-item-object-category"><a href=/categories/microservice/>Microservice</a></li><li class="menu-item menu-item-type-taxonomy menu-item-object-category"><a href=/categories/kubernetes/>Kubernetes</a></li><li class="menu-item menu-item-type-taxonomy menu-item-object-category
menu-item-has-children"><a href=/tutorials/>Tutorials</a><ul class=sub-menu><li class="menu-item menu-item-type-taxonomy menu-item-object-category"><a href=/spring-boot-tutorials/>Spring Boot Tutorials</a></li><li class="menu-item menu-item-type-taxonomy menu-item-object-category"><a href=/microservice-tutorials/>Microservice Tutorials</a></li><li class="menu-item menu-item-type-taxonomy menu-item-object-category"><a href=/kubernetes-tutorials/>Kubernetes Tutorials</a></li></ul></li><li class="menu-item menu-item-type-post_type menu-item-object-page"><a href=https://github.com/chensoul target=_blank>About Me</a></li></ul></nav></div></header><div id=content class="site-content container clearfix"><section id=primary class="content-archive content-area post-content-area"><main id=main class=site-main role=main><article class="post type-post"><div class=post-inner-content><header class=entry-header><h2 class=entry-title><a href=https://blog.chensoul.cc/posts/2023/05/18/jsr-166/ rel=bookmark title="JSR 166è§„èŒƒ">JSR 166è§„èŒƒ</a></h2><div class=entry-meta><span class=meta-date><time class="entry-date published" datetime=2023-05-18T00:00:00>2023-05-18
</time></span><span class=meta-author><span class="author vcard">chensoul</span>
</span><span class="tagcloud post-tags"><i class="fa fa-tags"></i>&nbsp;
<a class="tag-cloud-link widget__link widget__link--taglist" href=/tags/java/ title=java>java</a></span></div></header><div class=entry-content><h2 id=jsr-ä»‹ç»>JSR ä»‹ç»</h2><p>JSRï¼Œå…¨ç§° Java Specification Requestsï¼Œ å³ Java è§„èŒƒææ¡ˆï¼Œ ä¸»è¦æ˜¯ç”¨äºå‘ JCP(Java Community Process) æå‡ºæ–°å¢æ ‡å‡†åŒ–æŠ€æœ¯è§„èŒƒçš„æ­£å¼è¯·æ±‚ã€‚æ¯æ¬¡ JAVA ç‰ˆæœ¬æ›´æ–°éƒ½ä¼šæœ‰å¯¹åº”çš„ JSR æ›´æ–°ï¼Œæ¯”å¦‚åœ¨ Java 8 ç‰ˆæœ¬ä¸­ï¼Œå…¶æ–°ç‰¹æ€§ Lambda è¡¨è¾¾å¼å¯¹åº”çš„æ˜¯ <a href="http://jcp.org/en/jsr/detail?id=335" target=_blank>JSR 335</a>ï¼Œæ–°çš„æ—¥æœŸå’Œæ—¶é—´ API å¯¹åº”çš„æ˜¯ <a href="http://jcp.org/en/jsr/detail?id=310" target=_blank>JSR 310</a>ã€‚</p><p><a href="https://jcp.org/en/jsr/detail?id=166" target=_blank>JSR 166</a> æ˜¯ Doug Lea æå‡ºçš„ä¸€ä¸ªå…³äº Java å¹¶å‘ç¼–ç¨‹çš„è§„èŒƒææ¡ˆã€‚JDK1.5 ä¹‹å‰ï¼Œæˆ‘ä»¬æ§åˆ¶ç¨‹åºå¹¶å‘è®¿é—®åŒæ­¥ä»£ç åªèƒ½ä½¿ç”¨ synchronizedï¼Œé‚£ä¸ªæ—¶å€™ synchronized çš„æ€§èƒ½è¿˜æ²¡ä¼˜åŒ–å¥½ï¼Œæ€§èƒ½å¹¶ä¸å¥½ï¼Œæ§åˆ¶çº¿ç¨‹ä¹Ÿåªèƒ½ä½¿ç”¨ Object çš„ wait å’Œ notify æ–¹æ³•ã€‚è¿™ä¸ªæ—¶å€™ Doug Lea ç»™ JCP æäº¤äº† JSR-166 çš„ææ¡ˆï¼Œåœ¨æäº¤ JSR-166 ä¹‹å‰ï¼ŒDoug Lea å·²ç»ä½¿ç”¨äº†ç±»ä¼¼ J.U.C åŒ…åŠŸèƒ½çš„ä»£ç å·²ç»ä¸‰å¹´å¤šäº†ï¼Œè¿™äº›ä»£ç å°±æ˜¯ J.U.C çš„åŸå‹ã€‚</p><p>J.U.Cï¼Œå³ <code>java.util.concurrent</code> çš„ç¼©å†™ï¼Œè¯¥åŒ…å‚è€ƒè‡ª EDU.oswego.cs.dl.util.concurrentï¼Œæ˜¯ JSR 166 æ ‡å‡†è§„èŒƒçš„ä¸€ä¸ªå®ç°ã€‚</p><ul><li>Doug Lea ä¸»é¡µï¼š<a href=https://gee.cs.oswego.edu/ target=_blank>Doug Lea&rsquo;s Home Page</a></li><li>JSR-166ï¼š<a href=https://gee.cs.oswego.edu/dl/concurrency-interest/index.html target=_blank>Concurrency JSR-166 Interest Site</a></li><li>JSR 166 Sliderï¼š<a href=https://gee.cs.oswego.edu/dl/concurrency-interest/jsr166-slides.pdf target=_blank>JSR-166: Concurrency Utilities</a></li><li>java.util.concurrent JavaDoc: <a href=https://docs.oracle.com/javase/1.5.0/docs/api/java/util/concurrent/package-summary.html target=_blank>JDK 1.5 </a>ã€ <a href=https://docs.oracle.com/javase/7/docs/api/java/util/concurrent/package-summary.html target=_blank>JDK 7 </a>ã€ <a href=https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/package-summary.html target=_blank>JDK 8 </a>ã€ <a href=https://docs.oracle.com/javase/9/docs/api/java/util/concurrent/package-summary.html target=_blank>JDK 9</a></li></ul><p><img src=/images/jsr-166-concurrency-utilities.webp alt=jsr-166-concurrency-utilities></p><p>JSR-166 åŒ…æ‹¬å¤šä¸ªè§„èŒƒï¼Œæ¯ä¸ªè§„èŒƒéƒ½å¼•å…¥äº†ä¸€äº›æ–°çš„æ¥å£å’Œç±»ï¼Œä»¥ä¸‹æ˜¯è¯¦ç»†æè¿°ï¼š</p><ol><li><code>JSR-166ï¼ˆJava SE 5ï¼‰</code>ï¼šå®šä¹‰äº† Java å¹¶å‘åŒ…çš„æ ¸å¿ƒæ¥å£å’Œç±»ï¼ŒåŒ…æ‹¬ Executors æ¡†æ¶ã€Queuesã€Timingã€Synchronizersã€Concurrent Collectionsã€Memory Consistency Propertiesã€Atomicã€Locks ç­‰ã€‚è¿™äº›æ¥å£å’Œç±»æä¾›äº†ä¸€ç§æ–¹ä¾¿ã€é«˜æ•ˆã€å¯æ‰©å±•çš„æ–¹å¼æ¥å¤„ç†å¼‚æ­¥ä»»åŠ¡å’Œå¹¶å‘ç¼–ç¨‹ã€‚</li><li><code>JSR-166xï¼ˆJava SE 7ï¼‰</code>ï¼šå®šä¹‰äº† Java å¹¶å‘åŒ…ä¸­çš„ä¸€äº›æ–°ç‰¹æ€§ï¼ŒåŒ…æ‹¬ Phaserã€TransferQueueã€Exchangerã€LinkedTransferQueue ç­‰æ¥å£å’Œç±»ã€‚å…¶ä¸­ Phaser æ”¯æŒåˆ†é˜¶æ®µæ‰§è¡Œä»»åŠ¡ï¼ŒTransferQueue å’Œ LinkedTransferQueue å®ç°äº†é«˜æ•ˆçš„ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼ï¼ŒExchanger æ”¯æŒä¸¤ä¸ªçº¿ç¨‹ä¹‹é—´äº¤æ¢æ•°æ®ã€‚</li><li><code>JSR-166yï¼ˆJava SE 8ï¼‰</code>ï¼šå®šä¹‰äº† Java å¹¶å‘åŒ…ä¸­çš„ä¸€äº›æ–°ç‰¹æ€§ï¼ŒåŒ…æ‹¬ StampedLockã€CompletableFutureã€LongAdder ç­‰æ¥å£å’Œç±»ã€‚å…¶ä¸­ StampedLock æ˜¯ä¸€ç§ä¹è§‚é”ï¼Œæ”¯æŒè¯»å†™åˆ†ç¦»ï¼ŒCompletableFuture æ”¯æŒå¼‚æ­¥ä»»åŠ¡æ‰§è¡Œå’Œç»“æœå¤„ç†ï¼ŒLongAdder æ˜¯ä¸€ç§é«˜æ•ˆçš„è®¡æ•°å™¨ã€‚</li><li><code>JSR-166zï¼ˆJava SE 9ï¼‰</code>ï¼šå®šä¹‰äº† Java å¹¶å‘åŒ…ä¸­çš„ä¸€äº›æ–°ç‰¹æ€§ï¼ŒåŒ…æ‹¬ VarHandleã€Fences ç­‰æ¥å£å’Œç±»ã€‚å…¶ä¸­ VarHandle æä¾›äº†ä¸€ç§æ›´åŠ çµæ´»çš„åŸå­æ“ä½œæ–¹å¼ï¼ŒFences æä¾›äº†ä¸€äº›æ–¹æ³•ç”¨äºæ§åˆ¶å†…å­˜å±éšœã€‚</li></ol><h2 id=juc>JUC</h2><p>java.util.concurrent åŒ…ä¸‹çš„ç±»ä»¥åŠå¼•å…¥ç‰ˆæœ¬ï¼ˆæ²¡æœ‰æ ‡æ³¨ç‰ˆæœ¬å·çš„ä¸º <code>1.5</code> ï¼‰ï¼š</p><ul><li>java.util.concurrent<ul><li>java.util.concurrent.locks<ul><li>AbstractOwnableSynchronizer <code>1.6</code></li><li>AbstractQueuedLongSynchronizer <code>1.6</code></li><li>AbstractQueuedSynchronizer</li><li>Condition</li><li>Lock</li><li>LockSupport</li><li>ReadWriteLock</li><li>ReentrantLock</li><li>ReentrantReadWriteLock</li><li>StampedLock <code>1.8</code></li></ul></li><li>java.util.concurrent.atomic<ul><li>AtomicBoolean</li><li>AtomicInteger</li><li>AtomicIntegerArray</li><li>AtomicIntegerFieldUpdater</li><li>AtomicLong</li><li>AtomicLongArray</li><li>AtomicLongFieldUpdater</li><li>AtomicMarkableReference</li><li>AtomicReference</li><li>AtomicReferenceArray</li><li>AtomicReferenceFieldUpdater</li><li>AtomicStampedReference</li><li>DoubleAccumulator <code>1.8</code></li><li>DoubleAdder <code>1.8</code></li><li>LongAccumulator <code>1.8</code></li><li>LongAdder <code>1.8</code></li></ul></li><li>AbstractExecutorService</li><li>ArrayBlockingQueue</li><li>BlockingDeque <code>1.6</code></li><li>BlockingQueue</li><li>BrokenBarrierException</li><li>Callable</li><li>CancellationException</li><li>CompletableFuture <code>1.8</code></li><li>CompletionException <code>1.8</code></li><li>CompletionService</li><li>CompletionStage <code>1.8</code></li><li>ConcurrentHashMap</li><li>ConcurrentLinkedDeque <code>1.7</code></li><li>ConcurrentLinkedQueue</li><li>ConcurrentMap</li><li>ConcurrentNavigableMap <code>1.6</code></li><li>ConcurrentSkipListMap <code>1.6</code></li><li>ConcurrentSkipListSet <code>1.6</code></li><li>CopyOnWriteArrayList</li><li>CopyOnWriteArraySet</li><li>CountDownLatch</li><li>CountedCompleter <code>1.8</code></li><li>CyclicBarrier</li><li>Delayed</li><li>DelayQueue</li><li>Exchanger</li><li>ExecutionException</li><li>Executor</li><li>ExecutorCompletionService</li><li>Executors</li><li>ExecutorService</li><li>Flow <code>1.9</code></li><li>ForkJoinPool <code>1.7</code></li><li>ForkJoinTask <code>1.7</code></li><li>ForkJoinWorkerThread <code>1.7</code></li><li>Future</li><li>FutureTask</li><li>LinkedBlockingDeque <code>1.6</code></li><li>LinkedBlockingQueue</li><li>LinkedTransferQueue <code>1.7</code></li><li>Phaser <code>1.7</code></li><li>PriorityBlockingQueue</li><li>RecursiveAction <code>1.7</code></li><li>RecursiveTask <code>1.7</code></li><li>RejectedExecutionException</li><li>RejectedExecutionHandler</li><li>RunnableFuture</li><li>RunnableScheduledFuture</li><li>ScheduledExecutorService</li><li>ScheduledFuture</li><li>ScheduledThreadPoolExecutor</li><li>Semaphore</li><li>SubmissionPublisher <code>1.9</code></li><li>SynchronousQueue</li><li>ThreadFactory</li><li>ThreadLocalRandom <code>1.7</code></li><li>ThreadPoolExecutor</li><li>TimeoutException</li><li>TimeUnit</li><li>TransferQueue <code>1.7</code></li></ul></li></ul><p>å¤§è‡´å¯ä»¥åˆ†ä¸ºä»¥ä¸‹å‡ ç±»ï¼š</p><ul><li>åŸå­æ›´æ–°</li><li>é”å’Œæ¡ä»¶</li><li>çº¿ç¨‹æ± </li><li>å¹¶å‘å®¹å™¨</li><li>åŒæ­¥å™¨</li></ul><p>åœ¨å­¦ä¹  <code>JUC</code> ä¹‹å‰æˆ‘ä»¬éœ€è¦äº†è§£ <code>CAS</code>ï¼Œ<code>AQS</code> å’Œ <code>Unsafe</code>ã€‚</p><ul><li>CASï¼š</li><li>AQSï¼š</li><li>Unsafeï¼š</li></ul><h2 id=cas>CAS</h2><p>CASï¼ˆ<code>Compare and Swap</code>ï¼‰æ˜¯ä¸€ç§åŸºäºåŸå­æ€§æ“ä½œçš„å¹¶å‘ç¼–ç¨‹æŠ€æœ¯ï¼Œå¸¸ç”¨äºå®ç°çº¿ç¨‹å®‰å…¨çš„æ•°æ®ç»“æ„å’Œç®—æ³•ã€‚CAS æ“ä½œç”±ä¸‰ä¸ªå‚æ•°ç»„æˆï¼šå†…å­˜ä½ç½® Vã€æœŸæœ›å€¼ Aã€æ–°å€¼ Bã€‚å½“ä¸”ä»…å½“ V çš„å€¼ç­‰äº A æ—¶ï¼ŒCAS æ“ä½œæ‰ä¼šå°† V çš„å€¼è®¾ç½®ä¸º Bï¼Œå¦åˆ™ä¸åšä»»ä½•æ“ä½œã€‚å®ƒçš„å®ç°åŸç†å¯ä»¥ç®€å•æ¦‚æ‹¬ä¸ºä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š</p><ol><li>è¯»å–å†…å­˜ä½ç½® V çš„å€¼ï¼ŒåŒæ—¶è®°å½•ä¸‹è¯¥å€¼çš„ç‰ˆæœ¬å·æˆ–æ ‡è®°ä½ã€‚</li><li>æ£€æŸ¥å†…å­˜ä½ç½® V çš„å€¼æ˜¯å¦ç­‰äºæœŸæœ›å€¼ Aã€‚å¦‚æœç›¸ç­‰ï¼Œåˆ™æ‰§è¡Œç¬¬ 3 æ­¥ï¼›å¦åˆ™ï¼Œæ“ä½œå¤±è´¥ã€‚</li><li>å°†æ–°å€¼ B å†™å…¥å†…å­˜ä½ç½® Vï¼Œå¹¶æ›´æ–°å…¶ç‰ˆæœ¬å·æˆ–æ ‡è®°ä½ã€‚</li><li>è¿”å›æ“ä½œç»“æœã€‚</li></ol><p>CAS æ“ä½œæ˜¯ä¸€ç§<code>ä¹è§‚é”</code>æœºåˆ¶ï¼Œå®ƒä¸éœ€è¦é”å®šæ•´ä¸ªå…±äº«èµ„æºï¼Œè€Œæ˜¯åªé’ˆå¯¹éœ€è¦ä¿®æ”¹çš„å€¼è¿›è¡ŒåŸå­æ€§æ“ä½œï¼Œä»è€Œé¿å…äº†é”çš„ç«äº‰å’Œå¼€é”€ã€‚åœ¨æ‰§è¡Œ CAS æ“ä½œæ—¶ï¼Œçº¿ç¨‹ä¼šå¯¹å†…å­˜ä½ç½®è¿›è¡Œè¯»å–å’Œå†™å…¥ï¼Œä½†åŒæ—¶ä¹Ÿä¼šæ£€æŸ¥å†…å­˜ä½ç½®çš„ç‰ˆæœ¬å·æˆ–æ ‡è®°ä½ï¼Œä»¥ä¿è¯æ“ä½œçš„åŸå­æ€§å’Œä¸€è‡´æ€§ã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœå¤šä¸ªçº¿ç¨‹åŒæ—¶æ‰§è¡Œ CAS æ“ä½œï¼Œå¯èƒ½ä¼šå‡ºç° ABA é—®é¢˜ã€‚ä¾‹å¦‚ï¼Œçº¿ç¨‹ A è¯»å–å†…å­˜ä½ç½® V çš„å€¼ä¸º Aï¼Œç„¶åçº¿ç¨‹ B å°† V çš„å€¼ä¿®æ”¹ä¸º Bï¼Œæœ€åçº¿ç¨‹ B åˆå°† V çš„å€¼ä¿®æ”¹ä¸º Aã€‚æ­¤æ—¶ï¼Œçº¿ç¨‹ A æ‰§è¡Œ CAS æ“ä½œæ—¶ï¼Œä¼šå‘ç°å†…å­˜ä½ç½® V çš„å€¼è¿˜æ˜¯ Aï¼Œè™½ç„¶è¿™ä¸ª A çš„ç‰ˆæœ¬å·æˆ–æ ‡è®°ä½ä¸ä¹‹å‰ä¸åŒï¼Œä½†çº¿ç¨‹ A å¹¶ä¸çŸ¥é“ V çš„å€¼æ›¾ç»è¢«ä¿®æ”¹è¿‡ï¼Œå› æ­¤ä¼šå°†æ–°å€¼å†™å…¥å†…å­˜ä½ç½® Vï¼Œä»è€Œå¯¼è‡´æ•°æ®ä¸ä¸€è‡´ã€‚ä¸ºäº†è§£å†³ ABA é—®é¢˜ï¼Œå¯ä»¥ä½¿ç”¨å¸¦æœ‰ç‰ˆæœ¬å·æˆ–æ ‡è®°ä½çš„ CAS æ“ä½œï¼Œæˆ–è€…ä½¿ç”¨å…¶ä»–çš„å¹¶å‘ç¼–ç¨‹æŠ€æœ¯ï¼Œä¾‹å¦‚é”æˆ–è¯»å†™é”ã€‚</p><p>Java ä¸­çš„<code>AtomicXXX</code>ç±»å®ç°äº† CAS æ“ä½œï¼Œä¾‹å¦‚ AtomicIntegerã€AtomicLong ç­‰ã€‚è¿™äº›ç±»æä¾›äº†ä¸€ç»„åŸå­æ€§æ“ä½œæ–¹æ³•ï¼Œä¾‹å¦‚ get()ã€set()ã€addAndGet()ã€compareAndSet()ç­‰ï¼Œå®ƒä»¬å¯ä»¥è¢«å¤šä¸ªçº¿ç¨‹å®‰å…¨åœ°ä½¿ç”¨ã€‚</p><p>CAS æ“ä½œè™½ç„¶å…å»äº†é”çš„å¼€é”€ï¼Œä½†ä¹Ÿå­˜åœ¨ä¸€äº›é—®é¢˜ã€‚é¦–å…ˆï¼ŒCAS æ“ä½œéœ€è¦è¿›è¡Œå¤šæ¬¡å°è¯•ï¼Œç›´åˆ°æˆåŠŸä¸ºæ­¢ã€‚å¦‚æœå¹¶å‘ç¨‹åº¦è¾ƒé«˜ï¼Œå¤šä¸ªçº¿ç¨‹åŒæ—¶è¿›è¡Œ CAS æ“ä½œï¼Œå¯èƒ½ä¼šå¯¼è‡´å¤§é‡çš„ CAS æ“ä½œå¤±è´¥ï¼Œä»è€Œé™ä½æ€§èƒ½ã€‚å…¶æ¬¡ï¼ŒCAS æ“ä½œåªèƒ½ä¿è¯å•ä¸ªå˜é‡çš„åŸå­æ€§æ“ä½œï¼Œæ— æ³•ä¿è¯å¤šä¸ªå˜é‡ä¹‹é—´çš„æ“ä½œçš„åŸå­æ€§ï¼Œå› æ­¤éœ€è¦é¢å¤–çš„æªæ–½æ¥ä¿è¯å¤šä¸ªå˜é‡ä¹‹é—´çš„ä¸€è‡´æ€§ã€‚</p><p>ä¸‹é¢æ˜¯ä¸€ä¸ªä½¿ç”¨ AtomicInteger å®ç°ç®€å•è®¡æ•°å™¨çš„ä¾‹å­ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>import</span> java.util.concurrent.atomic.AtomicInteger;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Counter</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> AtomicInteger value <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> AtomicInteger(0);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>increment</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> oldValue, newValue;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>do</span> {
</span></span><span style=display:flex><span>            oldValue <span style=color:#f92672>=</span> value.<span style=color:#a6e22e>get</span>();
</span></span><span style=display:flex><span>            newValue <span style=color:#f92672>=</span> oldValue <span style=color:#f92672>+</span> 1;
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>while</span> (<span style=color:#f92672>!</span>value.<span style=color:#a6e22e>compareAndSet</span>(oldValue, newValue));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>getValue</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> value.<span style=color:#a6e22e>get</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œ<code>increment()</code> æ–¹æ³•ä½¿ç”¨ do-while å¾ªç¯å’Œ<code>compareAndSet()</code>æ–¹æ³•æ‰§è¡Œ CAS æ“ä½œæ¥å¢åŠ è®¡æ•°å™¨çš„å€¼ã€‚è¯¥æ–¹æ³•é‡å¤ä½¿ç”¨<code>get()</code>æ–¹æ³•è¯»å–è®¡æ•°å™¨çš„å½“å‰å€¼ï¼Œè®¡ç®—æ–°å€¼ï¼Œç„¶åå°è¯•ä½¿ç”¨<code>compareAndSet()</code>æ–¹æ³•æ›´æ–°è®¡æ•°å™¨ã€‚å¾ªç¯å°†ç»§ç»­ï¼Œç›´åˆ° CAS æ“ä½œæˆåŠŸå¹¶ä¸”è®¡æ•°å™¨æˆåŠŸæ›´æ–°ã€‚</p><p><code>getValue()</code> æ–¹æ³•ä½¿ç”¨<code>get()</code>æ–¹æ³•ç®€å•åœ°è¿”å›è®¡æ•°å™¨çš„å½“å‰å€¼ã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨ä½¿ç”¨ CAS æ“ä½œæ—¶ï¼Œéœ€è¦å°å¿ƒå¤„ç†æ½œåœ¨çš„ ABA é—®é¢˜ï¼Œå…¶ä¸­å…±äº«å˜é‡çš„å€¼å¯èƒ½åœ¨åˆå§‹è¯»å–å’Œæ›´æ–°å°è¯•ä¹‹é—´å¤šæ¬¡æ›´æ”¹ã€‚ä¸€ç§å¤„ç†æ–¹æ³•æ˜¯åœ¨å…±äº«å˜é‡ä¸­ä½¿ç”¨ç‰ˆæœ¬å·æˆ–æ—¶é—´æˆ³ï¼Œä»¥ç¡®ä¿æ›´æ–°ä»…åœ¨å€¼æœªæ›´æ”¹çš„æƒ…å†µä¸‹æˆåŠŸã€‚</p><p>ABA é—®é¢˜æ˜¯åœ¨ä½¿ç”¨ CASï¼ˆ<code>Compare-and-Swap</code>ï¼‰æ“ä½œè¿›è¡Œå¹¶å‘ç¼–ç¨‹æ—¶ç»å¸¸é‡åˆ°çš„ä¸€ä¸ªé—®é¢˜ã€‚å®ƒå‘ç”Ÿåœ¨ä¸€ä¸ªçº¿ç¨‹ä»å…±äº«å†…å­˜ä½ç½®è¯»å–ä¸€ä¸ªå€¼ï¼Œç„¶åå¦ä¸€ä¸ªçº¿ç¨‹å°†è¯¥å€¼æ›´æ”¹ä¸ºå¦ä¸€ä¸ªå€¼ï¼Œæœ€ååˆå°†å…¶æ›´æ”¹å›åŸå§‹å€¼ï¼Œä»è€Œä½¿ç¬¬ä¸€ä¸ªçº¿ç¨‹çš„æ“ä½œæ„å¤–æˆåŠŸã€‚</p><p>ä¸ºäº†å¤„ç† ABA é—®é¢˜ï¼Œå¸¸ç”¨çš„æ–¹æ³•æ˜¯åœ¨å…±äº«å†…å­˜ä½ç½®ä¸­æ·»åŠ ä¸€ä¸ªç‰ˆæœ¬å·æˆ–æ—¶é—´æˆ³ã€‚ç‰ˆæœ¬å·æˆ–æ—¶é—´æˆ³å¯ä»¥åœ¨æ¯æ¬¡ä¿®æ”¹å†…å­˜ä½ç½®æ—¶è¿›è¡Œé€’å¢æˆ–æ›´æ–°ã€‚è¿™å¯ä»¥ç¡®ä¿ CAS æ“ä½œä¸ä»…æ£€æŸ¥å€¼ï¼Œè¿˜æ£€æŸ¥å†…å­˜ä½ç½®çš„ç‰ˆæœ¬å·æˆ–æ—¶é—´æˆ³ã€‚</p><p>ä»¥ä¸‹æ˜¯ä½¿ç”¨ç‰ˆæœ¬å·å¤„ç† ABA é—®é¢˜çš„ç¤ºä¾‹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>import</span> java.util.concurrent.atomic.AtomicStampedReference;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ConcurrentStack</span><span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> AtomicStampedReference<span style=color:#f92672>&lt;</span>Node<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;&gt;</span> top <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> AtomicStampedReference<span style=color:#f92672>&lt;&gt;</span>(<span style=color:#66d9ef>null</span>, 0);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>push</span>(T value) {
</span></span><span style=display:flex><span>        Node<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> newHead <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Node<span style=color:#f92672>&lt;&gt;</span>(value);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span><span style=color:#f92672>[]</span> stampHolder <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#66d9ef>int</span><span style=color:#f92672>[</span>1<span style=color:#f92672>]</span>;
</span></span><span style=display:flex><span>        Node<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> oldHead;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>do</span> {
</span></span><span style=display:flex><span>            oldHead <span style=color:#f92672>=</span> top.<span style=color:#a6e22e>get</span>(stampHolder);
</span></span><span style=display:flex><span>            newHead.<span style=color:#a6e22e>next</span> <span style=color:#f92672>=</span> oldHead;
</span></span><span style=display:flex><span>            stampHolder<span style=color:#f92672>[</span>0<span style=color:#f92672>]++</span>;
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>while</span> (<span style=color:#f92672>!</span>top.<span style=color:#a6e22e>compareAndSet</span>(oldHead, newHead, stampHolder<span style=color:#f92672>[</span>0<span style=color:#f92672>]</span> <span style=color:#f92672>-</span> 1, stampHolder<span style=color:#f92672>[</span>0<span style=color:#f92672>]</span>));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> T <span style=color:#a6e22e>pop</span>() {
</span></span><span style=display:flex><span>        Node<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> oldHead;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span><span style=color:#f92672>[]</span> stampHolder <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#66d9ef>int</span><span style=color:#f92672>[</span>1<span style=color:#f92672>]</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>do</span> {
</span></span><span style=display:flex><span>            oldHead <span style=color:#f92672>=</span> top.<span style=color:#a6e22e>get</span>(stampHolder);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (oldHead <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>while</span> (<span style=color:#f92672>!</span>top.<span style=color:#a6e22e>compareAndSet</span>(oldHead, oldHead.<span style=color:#a6e22e>next</span>, stampHolder<span style=color:#f92672>[</span>0<span style=color:#f92672>]</span>, stampHolder<span style=color:#f92672>[</span>0<span style=color:#f92672>]</span> <span style=color:#f92672>+</span> 1));
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> oldHead.<span style=color:#a6e22e>value</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Node</span><span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> T value;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>private</span> Node<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> next;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>Node</span>(T value) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>value</span> <span style=color:#f92672>=</span> value;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œ<code>ConcurrentStack</code> ç±»ä½¿ç”¨ <code>AtomicStampedReference</code> å­˜å‚¨æ ˆé¡¶èŠ‚ç‚¹ã€‚<code>AtomicStampedReference</code> ç±»å­˜å‚¨å€¼çš„å¼•ç”¨å’Œç‰ˆæœ¬å·ï¼Œç‰ˆæœ¬å·åœ¨å¼•ç”¨æ›´æ”¹æ—¶è¿›è¡Œæ›´æ–°ã€‚</p><p><code>push()</code> æ–¹æ³•ä½¿ç”¨æ–°å€¼åˆ›å»ºä¸€ä¸ªæ–°çš„ <code>Node</code>ï¼Œç„¶åå°è¯•ä½¿ç”¨ CAS æ“ä½œå°†å…¶æ¨å…¥æ ˆä¸­ã€‚å¾ªç¯å°†ç»§ç»­ï¼Œç›´åˆ° CAS æ“ä½œæˆåŠŸï¼ŒèŠ‚ç‚¹æˆåŠŸæ¨å…¥æ ˆä¸­ã€‚</p><p><code>pop()</code> æ–¹æ³•å°è¯•ä½¿ç”¨ CAS æ“ä½œä»æ ˆä¸­å¼¹å‡ºé¡¶éƒ¨èŠ‚ç‚¹ã€‚å¾ªç¯å°†ç»§ç»­ï¼Œç›´åˆ°é¡¶éƒ¨èŠ‚ç‚¹æˆåŠŸå¼¹å‡ºæˆ–æ ˆä¸ºç©ºä¸ºæ­¢ã€‚</p><p>é€šè¿‡ä½¿ç”¨å…·æœ‰ç‰ˆæœ¬å·çš„ <code>AtomicStampedReference</code>ï¼Œ<code>ConcurrentStack</code> ç±»å¯ä»¥å¤„ç†åœ¨å¹¶å‘æ“ä½œä¸­å¯èƒ½å‘ç”Ÿçš„ ABA é—®é¢˜ã€‚</p><h2 id=aqs>AQS</h2><p>AQSï¼ˆ<code>AbstractQueuedSynchronizer</code>ï¼‰æ˜¯ Java ä¸­ç”¨äºå®ç°åŒæ­¥å™¨ï¼ˆå¦‚é”ï¼Œä¿¡å·é‡ç­‰ï¼‰çš„æ¡†æ¶ï¼Œå®ƒæä¾›äº†ä¸€äº›åŸºæœ¬çš„åŒæ­¥æ“ä½œï¼Œä¾‹å¦‚<code>è·å–é”</code>ã€<code>é‡Šæ”¾é”</code>ã€<code>ç­‰å¾…æ¡ä»¶</code>ã€<code>å”¤é†’çº¿ç¨‹</code>ç­‰ã€‚</p><p>AQS çš„å®ç°åŸç†åŸºäºä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œç”¨äºç»´æŠ¤ç­‰å¾…çº¿ç¨‹çš„é˜Ÿåˆ—ã€‚å½“ä¸€ä¸ªçº¿ç¨‹éœ€è¦è·å–åŒæ­¥å™¨æ—¶ï¼Œå®ƒä¼šé¦–å…ˆå°è¯•ä½¿ç”¨ CAS æ“ä½œæ¥è·å–åŒæ­¥å™¨ï¼Œå¦‚æœè·å–æˆåŠŸï¼Œåˆ™ç»§ç»­æ‰§è¡Œï¼›å¦‚æœè·å–å¤±è´¥ï¼Œåˆ™å°†çº¿ç¨‹åŠ å…¥ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œå¹¶å°†å…¶æŒ‚èµ·ã€‚å½“åŒæ­¥å™¨é‡Šæ”¾æ—¶ï¼Œå®ƒä¼šå”¤é†’ç­‰å¾…é˜Ÿåˆ—ä¸­çš„ä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹ï¼Œå¹¶å°†å®ƒä»¬ä»ç­‰å¾…é˜Ÿåˆ—ä¸­ç§»é™¤ï¼Œä½¿å®ƒä»¬å¯ä»¥ç»§ç»­æ‰§è¡Œã€‚</p><p>AQS çš„ç­‰å¾…é˜Ÿåˆ—æ˜¯é€šè¿‡ä¸€ä¸ªåŒå‘é“¾è¡¨æ¥å®ç°çš„ï¼Œæ¯ä¸ªèŠ‚ç‚¹ä»£è¡¨ä¸€ä¸ªç­‰å¾…çº¿ç¨‹ï¼ŒèŠ‚ç‚¹ä¸­åŒ…å«äº†çº¿ç¨‹çš„çŠ¶æ€ä»¥åŠç­‰å¾…æ¡ä»¶ç­‰ä¿¡æ¯ã€‚ç­‰å¾…é˜Ÿåˆ—ä¸­çš„èŠ‚ç‚¹æ˜¯æŒ‰ç…§ç­‰å¾…æ—¶é—´çš„å…ˆåé¡ºåºæ’åˆ—çš„ï¼Œå…ˆç­‰å¾…çš„çº¿ç¨‹æ’åœ¨å‰é¢ï¼Œåç­‰å¾…çš„çº¿ç¨‹æ’åœ¨åé¢ã€‚å½“ä¸€ä¸ªçº¿ç¨‹è¢«å”¤é†’æ—¶ï¼Œå®ƒä¼šé‡æ–°å°è¯•è·å–åŒæ­¥å™¨ï¼Œå¦‚æœè·å–æˆåŠŸï¼Œåˆ™ç»§ç»­æ‰§è¡Œï¼›å¦‚æœè·å–å¤±è´¥ï¼Œåˆ™å®ƒä¼šå†æ¬¡åŠ å…¥ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œå¹¶å°†è‡ªå·±æŒ‚èµ·ã€‚</p><p>AQS çš„å…·ä½“å®ç°æ˜¯é€šè¿‡é‡å†™å…¶å†…éƒ¨çš„ä¸€äº›æ–¹æ³•æ¥å®ç°çš„ã€‚ä¾‹å¦‚ï¼Œ<code>tryAcquire()</code> æ–¹æ³•ç”¨äºå®ç°è·å–åŒæ­¥å™¨çš„é€»è¾‘ï¼Œå®ƒä¼šé¦–å…ˆå°è¯•ä½¿ç”¨ CAS æ“ä½œæ¥è·å–åŒæ­¥å™¨ï¼Œå¦‚æœè·å–æˆåŠŸï¼Œåˆ™è¿”å› trueï¼›å¦åˆ™è¿”å› falseã€‚<code>tryRelease()</code> æ–¹æ³•ç”¨äºå®ç°é‡Šæ”¾åŒæ­¥å™¨çš„é€»è¾‘ï¼Œå®ƒä¼šé‡Šæ”¾åŒæ­¥å™¨ï¼Œå¹¶å”¤é†’ç­‰å¾…é˜Ÿåˆ—ä¸­çš„ä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹ã€‚<code>tryAcquireShared()</code> å’Œ <code>tryReleaseShared()</code> æ–¹æ³•åˆ™ç”¨äºå®ç°å…±äº«å¼åŒæ­¥å™¨çš„é€»è¾‘ï¼Œå®ƒä»¬ç±»ä¼¼äº <code>tryAcquire()</code> å’Œ <code>tryRelease()</code> æ–¹æ³•ï¼Œä½†æ˜¯å¯ä»¥æ”¯æŒå¤šä¸ªçº¿ç¨‹åŒæ—¶è·å–æˆ–é‡Šæ”¾åŒæ­¥å™¨ã€‚</p><h2 id=unsafe>Unsafe</h2><p>Unsafe ç±»æ˜¯ Java ä¸­ä¸€ä¸ªéå¸¸ç‰¹æ®Šä¸”å¼ºå¤§çš„ç±»ï¼Œå®ƒæä¾›äº†ä¸€äº›ä¸å®‰å…¨çš„æ“ä½œï¼Œä¾‹å¦‚ç›´æ¥æ“ä½œå†…å­˜ã€çº¿ç¨‹æŒ‚èµ·å’Œæ¢å¤ç­‰ã€‚Unsafe ç±»æ˜¯ Java ä¸­å°‘æ•°å‡ ä¸ªä¸è¢«å…¬å¼€æ”¯æŒçš„ç±»ä¹‹ä¸€ï¼Œå®ƒä¸»è¦è¢«ç”¨äº Java æ ¸å¿ƒåº“å’Œå…¶ä»–ä¸€äº›é«˜çº§æ¡†æ¶ä¸­ï¼Œå¦‚ Nettyã€Hadoop å’Œ Kafka ç­‰ã€‚</p><p>ç”±äº Unsafe ç±»æä¾›äº†ä¸€äº›ä¸å®‰å…¨çš„æ“ä½œï¼Œå› æ­¤å®ƒçš„ä½¿ç”¨éœ€è¦éå¸¸å°å¿ƒã€‚å¦‚æœä¸æ­£ç¡®åœ°ä½¿ç”¨ Unsafe ç±»ï¼Œå¯èƒ½ä¼šå¯¼è‡´ç¨‹åºå´©æºƒæˆ–å®‰å…¨æ¼æ´ã€‚å› æ­¤ï¼ŒJava å®˜æ–¹å¹¶ä¸å»ºè®®å¼€å‘äººå‘˜ä½¿ç”¨ Unsafe ç±»ï¼Œè€Œæ˜¯å»ºè®®å¼€å‘äººå‘˜ä½¿ç”¨æ›´åŠ å®‰å…¨å’Œæ ‡å‡†çš„ Java APIã€‚</p><p>Unsafe ç±»ä¸­ä¸€äº›å¸¸ç”¨çš„æ–¹æ³•åŒ…æ‹¬ï¼š</p><ol><li><code>allocateMemory(long size)</code>ï¼šåˆ†é…ä¸€æ®µæŒ‡å®šå¤§å°çš„å†…å­˜ç©ºé—´ã€‚</li><li><code>freeMemory(long address)</code>ï¼šé‡Šæ”¾æŒ‡å®šåœ°å€çš„å†…å­˜ç©ºé—´ã€‚</li><li><code>putXXX(Object target, long offset, XXX value)</code>ï¼šå°†æŒ‡å®šç±»å‹çš„å€¼å†™å…¥ç›®æ ‡å¯¹è±¡çš„æŒ‡å®šåç§»é‡å¤„ã€‚</li><li><code>getXXX(Object target, long offset)</code>ï¼šä»ç›®æ ‡å¯¹è±¡çš„æŒ‡å®šåç§»é‡å¤„è¯»å–æŒ‡å®šç±»å‹çš„å€¼ã€‚</li><li><code>park(boolean isAbsolute, long time)</code>ï¼šæŒ‚èµ·å½“å‰çº¿ç¨‹ï¼Œç›´åˆ°è¢«å…¶ä»–çº¿ç¨‹å”¤é†’æˆ–æŒ‡å®šçš„æ—¶é—´åˆ°æœŸã€‚</li><li><code>unpark(Thread thread)</code>ï¼šæ¢å¤æŒ‡å®šçº¿ç¨‹çš„è¿è¡Œã€‚</li></ol><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒUnsafe ç±»ä¸­çš„å¤§éƒ¨åˆ†æ–¹æ³•éƒ½æ˜¯ native æ–¹æ³•ï¼Œå®ç°æ–¹å¼ä¾èµ–äºåº•å±‚æ“ä½œç³»ç»Ÿå’Œç¡¬ä»¶å¹³å°ã€‚è¿™æ„å‘³ç€ Unsafe ç±»ä¸­çš„æ–¹æ³•åœ¨ä¸åŒçš„å¹³å°ä¸Šå¯èƒ½ä¼šæœ‰ä¸åŒçš„è¡Œä¸ºï¼Œå› æ­¤éœ€è¦é’ˆå¯¹ä¸åŒçš„å¹³å°è¿›è¡Œæµ‹è¯•å’ŒéªŒè¯ã€‚</p><p>Java 9 ä¸­å®˜æ–¹æå‡ºäº†ç§»é™¤ Sun.misc.Unsafe ç±»ï¼Œå¹¶åœ¨è¯¥ç‰ˆæœ¬ä¸­å°†è¯¥ç±»æ ‡è®°ä¸ºä¸æ¨èä½¿ç”¨ã€‚ç„¶è€Œï¼Œç”±äº Unsafe ç±»åœ¨ Java è¯­è¨€ç”Ÿæ€ä¸­çš„åº”ç”¨éå¸¸å¹¿æ³›ï¼Œè®¸å¤šæ¡†æ¶å’Œåº“éƒ½ä¾èµ–äº Unsafe ç±»æ¥å®ç°é«˜æ€§èƒ½å’Œä½å±‚æ¬¡çš„æ“ä½œã€‚å› æ­¤ï¼Œåœ¨ Java 9 ä¸­ï¼Œå®˜æ–¹å¼•å…¥äº† jdk.internal.misc.Unsafe ç±»æ¥æ›¿ä»£ Sun.misc.Unsafe ç±»çš„åŠŸèƒ½ï¼Œä»¥ä¿æŒå¯¹ Java ç”Ÿæ€ä¸­ä½¿ç”¨ Unsafe ç±»çš„æ”¯æŒã€‚</p></div><div><div style=font-weight:700>Share this post:</div><a class=social-link-item href="https://twitter.com/intent/tweet?text=JSR%20166%e8%a7%84%e8%8c%83 https%3a%2f%2fblog.chensoul.cc%2fposts%2f2023%2f05%2f18%2fjsr-166%2f" target=_blank rel="noopener noreferrer" title="Click to share on Twitter"><i class="fa-brands fa-square-twitter fa-2xl" style=color:#55acee></i>
</a><a class=social-link-item href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fblog.chensoul.cc%2fposts%2f2023%2f05%2f18%2fjsr-166%2f&title=JSR%20166%e8%a7%84%e8%8c%83" target=_blank rel="noopener noreferrer" title="Click to share on LinkedIn"><i class="fa-brands fa-linkedin fa-2xl" style=color:#007bb5></i>
</a><a class=social-link-item href="https://telegram.me/share/url?text=JSR%20166%e8%a7%84%e8%8c%83&amp;url=https%3a%2f%2fblog.chensoul.cc%2fposts%2f2023%2f05%2f18%2fjsr-166%2f" target=_blank rel="noopener noreferrer" title="Click to share on telegram"><i class="fa-brands fa-telegram fa-2xl" style=color:#007bb5></i>
</a><a class=social-link-item href="https://reddit.com/submit?url=https%3a%2f%2fblog.chensoul.cc%2fposts%2f2023%2f05%2f18%2fjsr-166%2f&title=JSR%20166%e8%a7%84%e8%8c%83" target=_blank rel="noopener noreferrer" title="Click to share on reddit"><i class="fa-brands fa-reddit fa-2xl" style=color:#007bb5></i>
</a><a class=social-link-item href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fblog.chensoul.cc%2fposts%2f2023%2f05%2f18%2fjsr-166%2f" target=_blank rel="noopener noreferrer" title="Click to share on facebook"><i class="fa-brands fa-facebook fa-2xl" style=color:#007bb5></i>
</a><a class=social-link-item href="https://api.whatsapp.com/send?text=JSR%20166%e8%a7%84%e8%8c%83%20-%20https%3a%2f%2fblog.chensoul.cc%2fposts%2f2023%2f05%2f18%2fjsr-166%2f" target=_blank rel="noopener noreferrer" title="Click to share on whatsapp"><i class="fa-brands fa-whatsapp fa-2xl" style=color:#007bb5></i></a></div></div></article><nav class="navigation post-navigation" role=navigation><h2 class=screen-reader-text>Post navigation</h2><div class=nav-links><div class=nav-previous><a href=/posts/2023/05/22/docker-continuous-integration/ rel=next><span class=post-title>[è¯‘]Build Robust Continuous Integration With Docker and Friends</span></a></div><div class=nav-next><a href=/posts/2023/05/18/weekly_review_19/ rel=prev><span class=post-title>å‘¨æŠ¥-19ï½œæ­¦åŠŸå±±çœ‹æ—¥å‡ºã€Pythonåˆå­¦å»ºè®®</span></a></div></div></nav><h2>Related content</h2><ul><li><a href=/posts/2023/12/14/all-things-about-microprofile/>All things about MicroProfile</a></li><li><a href=/posts/2023/11/02/jhipster-intro/>JHipsterå®‰è£…å’Œä»‹ç»</a></li><li><a href=/posts/2024/11/14/quarkus-quick-start/>2024-11-14-Quarkus å¿«é€Ÿå…¥é—¨</a></li><li><a href=/posts/2024/11/07/junit-5-migration/>[è¯‘]ä»JUnit4è¿ç§»åˆ°JUnit5ï¼šæƒå¨æŒ‡å—</a></li><li><a href=/tutorials/>Tutorials</a></li><li><a href=/posts/2024/08/27/activemq-source-code-broker-service/>ActiveMQæºç -BrokerServiceå’ŒPersistenceAdapter</a></li><li><a href=/posts/2024/08/27/thingsboard-code-source-compile/>ThingsBoardæºç ç¼–è¯‘å’ŒIdeaè¿è¡Œ</a></li><li><a href=/posts/2024/08/09/debug-activemq-source-code/>ActiveMQæºç æœ¬åœ°è°ƒè¯•è¿è¡Œ</a></li><li><a href=/posts/2024/08/01/publishing-a-jar-to-maven-repository-with-github-action/>Github Action å‘å¸ƒ Jar åˆ° Maven ä¸­å¤®ä»“åº“</a></li><li><a href=/posts/2024/07/24/what-is-new-in-jms-2-0/>[è¯‘]JMS 2.0 ä¸­çš„æ–°å¢åŠŸèƒ½</a></li></ul></main></section></div><div id=footer class=footer-wrap><footer id=colophon class="site-footer container clearfix" role=contentinfo><div id=footer-text class=site-info><span class=credit-link>Made with ğŸ©·
by <a href=/ target=_blank rel="noopener noreferrer">ChenSoul</a></span></div></footer></div></div><script type=text/javascript src=/main.min.js></script></body></html>