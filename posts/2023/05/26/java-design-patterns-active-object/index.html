<!doctype html><html lang=en-US prefix="og: http://ogp.me/ns#"><head><meta charset=utf-8><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="本文主要介绍 Active Object 模式，在 Java Design Patterns 网站上有对该模式进行介绍。这里主要是做个笔记，并添加一些扩展，以加深对该设计模式的理解。"><title>Java设计模式：Active Object | ChenSoul</title>
<link rel=canonical href=https://blog.chensoul.cc/posts/2023/05/26/java-design-patterns-active-object/><link rel=preconnect href=https://fonts.font.im><link rel=preconnect href=https://fonts.loli.net crossorigin><link href="https://fonts.loli.net/css2?family=Roboto+Slab:wght@400;500;700&display=swap" rel=stylesheet><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://blog.chensoul.cc/raw-images/favicon.jpg"><meta name=twitter:title content="Java设计模式：Active Object"><meta name=twitter:description content="本文主要介绍 Active Object 模式，在 Java Design Patterns 网站上有对该模式进行介绍。这里主要是做个笔记，并添加一些扩展，以加深对该设计模式的理解。"><meta property="og:locale" content="en_US"><meta property="og:site_name" content="chensoul"><meta property="og:url" content="https://blog.chensoul.cc/posts/2023/05/26/java-design-patterns-active-object/"><meta property="og:site_name" content="ChenSoul"><meta property="og:title" content="Java设计模式：Active Object"><meta property="og:description" content="本文主要介绍 Active Object 模式，在 Java Design Patterns 网站上有对该模式进行介绍。这里主要是做个笔记，并添加一些扩展，以加深对该设计模式的理解。"><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-05-26T00:00:00+00:00"><meta property="article:modified_time" content="2023-05-26T00:00:00+00:00"><meta property="article:tag" content="Java"><meta property="og:image" content="https://blog.chensoul.cc/raw-images/favicon.jpg"><meta itemprop=name content="Java设计模式：Active Object"><meta itemprop=description content="本文主要介绍 Active Object 模式，在 Java Design Patterns 网站上有对该模式进行介绍。这里主要是做个笔记，并添加一些扩展，以加深对该设计模式的理解。"><meta itemprop=datePublished content="2023-05-26T00:00:00+00:00"><meta itemprop=dateModified content="2023-05-26T00:00:00+00:00"><meta itemprop=wordCount content="2235"><meta itemprop=image content="https://blog.chensoul.cc/raw-images/favicon.jpg"><meta itemprop=keywords content="Java"><link rel=stylesheet href=https://cdnjs.loli.net/ajax/libs/font-awesome/6.4.0/css/all.min.css media=all><link rel=stylesheet href=/main.min.css type=text/css media=all><link rel="shortcut icon" href=/favicon.ico type=image/x-icon><script type=application/ld+json>{"@context":"https://schema.org","@graph":[{"@type":"TechArticle","name":"Java设计模式：Active Object","headline":"Java设计模式：Active Object","inLanguage":"en-US","url":"https://blog.chensoul.cc/posts/2023/05/26/java-design-patterns-active-object/","description":"\u003cp\u003e本文主要介绍 Active Object 模式，在 \u003ca href=\"https://java-design-patterns.com/\" target=\"_blank\"\u003eJava Design Patterns\u003c/a\u003e 网站上有对该模式进行介绍。这里主要是做个笔记，并添加一些扩展，以加深对该设计模式的理解。\u003c/p\u003e","wordCount":"2235","keywords":["java"],"datePublished":"2023-05-26T00:00:00Z","dateModified":"2023-05-26T00:00:00Z","author":{"@type":"Person","name":"chensoul"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.chensoul.cc/posts/2023/05/26/java-design-patterns-active-object/"},"publisher":{"@type":"Organization","name":"chensoul","url":"https://blog.chensoul.cc/posts/2023/05/26/java-design-patterns-active-object/"}},{"@context":"https://schema.org","@type":"Organization","name":"chensoul","url":"https://blog.chensoul.cc/","sameAs":["https://twitter.com/","https://github.com/chensoul","https://www.linkedin.com/in/"]}]}</script></head><body class="home blog post-layout-one-column"><button onclick=topFunction() id=scrollTopBtn title="Go to top">
<i class="fa-solid fa-arrow-up"></i></button><div id=header-top class=header-bar-wrap></div><div id=page class=site><a class="skip-link screen-reader-text" href=#content>Skip to content</a><header id=masthead class="site-header clearfix" role=banner><div class="header-main container clearfix"><div id=logo class="site-branding clearfix"><h1 class=site-title><a href=/ title=ChenSoul rel=home>ChenSoul</a></h1><p class=site-description>Java, Spring Boot, Microservice, Cloud, Architecture and DevOps Tutorials</p></div><div class="header-widgets clearfix"><aside id=search-2 class="header-widget widget_search"><form role=search method=get class=search-form onsubmit="return searchSite(event)"><label><span class=screen-reader-text>Search for:</span>
<input type=search class=search-field placeholder="Enter search keyword" name=query id=query title="Enter search keyword">
</label><button type=submit class=search-submit title=Search> <span class=genericon-search></span>
<span class=screen-reader-text>Search</span></button></form></aside></div></div><div id=main-navigation-wrap class=primary-navigation-wrap><nav id=main-navigation class="primary-navigation navigation container clearfix" role=navigation><ul id=menu-home class=main-navigation-menu><li class="menu-item menu-item-type-custom menu-item-object-custom
current-menu-item current_page_item menu-item-home"><a href=/>Home</a></li><li class="menu-item menu-item-type-taxonomy menu-item-object-category"><a href=/categories/spring-boot/>Spring Boot</a></li><li class="menu-item menu-item-type-taxonomy menu-item-object-category"><a href=/categories/architecture/>Architecture</a></li><li class="menu-item menu-item-type-taxonomy menu-item-object-category"><a href=/categories/microservice/>Microservice</a></li><li class="menu-item menu-item-type-taxonomy menu-item-object-category"><a href=/categories/kubernetes/>Kubernetes</a></li><li class="menu-item menu-item-type-taxonomy menu-item-object-category
menu-item-has-children"><a href=/tutorials/>Tutorials</a><ul class=sub-menu><li class="menu-item menu-item-type-taxonomy menu-item-object-category"><a href=/spring-boot-tutorials/>Spring Boot Tutorials</a></li><li class="menu-item menu-item-type-taxonomy menu-item-object-category"><a href=/microservice-tutorials/>Microservice Tutorials</a></li><li class="menu-item menu-item-type-taxonomy menu-item-object-category"><a href=/kubernetes-tutorials/>Kubernetes Tutorials</a></li></ul></li><li class="menu-item menu-item-type-post_type menu-item-object-page"><a href=https://github.com/chensoul target=_blank>About Me</a></li></ul></nav></div></header><div id=content class="site-content container clearfix"><section id=primary class="content-archive content-area post-content-area"><main id=main class=site-main role=main><article class="post type-post"><div class=post-inner-content><header class=entry-header><h2 class=entry-title><a href=https://blog.chensoul.cc/posts/2023/05/26/java-design-patterns-active-object/ rel=bookmark title="Java设计模式：Active Object">Java设计模式：Active Object</a></h2><hr><div class=entry-meta><span class=meta-date><time class="entry-date published" datetime=2023-05-26T00:00:00>2023-05-26
</time></span><span class=meta-author><span class="author vcard">chensoul</span>
</span><span class="tagcloud post-tags"><i class="fa fa-tags"></i>&nbsp;
<a class="tag-cloud-link widget__link widget__link--taglist" href=/tags/java/ title=java>java</a></span></div></header><div class=entry-content><p>本文主要介绍 Active Object 模式，在 <a href=https://java-design-patterns.com/ target=_blank>Java Design Patterns</a> 网站上有对该模式进行介绍。这里主要是做个笔记，并添加一些扩展，以加深对该设计模式的理解。</p><blockquote><p><a href=https://java-design-patterns.com/ target=_blank>Java Design Patterns</a> 提供了各种 Java 设计模式的介绍、示例代码和用例说明。该网站旨在帮助 Java 开发人员了解和应用各种常见的设计模式，以提高代码的可读性、可维护性和可扩展性。</p><p>Java Design Patterns 网站提供了多种设计模式分类方式，包括创建型模式（Creational Patterns）、结构型模式（Structural Patterns）和行为型模式（Behavioral Patterns），以及其他一些常见的模式。</p><p>对于每个设计模式，该网站提供了详细的介绍、示例代码和用例说明，并且提供了一些常见的使用场景和注意事项。开发人员可以根据自己的需求选择适合自己的设计模式，并且可以参考示例代码和用例说明来理解和应用该模式。</p><p>此外，Java Design Patterns 网站还提供了一些其他资源，如设计模式的 UML 图、设计模式的优缺点、设计模式的比较等。这些资源可以帮助开发人员更好地理解和应用设计模式。</p><p>中文网站：<a href=https://java-design-patterns.com/zh/ target=_blank>https://java-design-patterns.com/zh/</a></p><p>Github 上源码仓库（非官方）：<a href=https://github.com/iluwatar/java-design-patterns target=_blank>https://github.com/iluwatar/java-design-patterns</a></p></blockquote><h2 id=目的>目的</h2><p>活动对象（Active Object）是一种设计模式，其主要目的是将并发和异步处理的问题从客户端代码中分离出来，从而提高系统的性能、可靠性和可维护性。活动对象模式是一种能够帮助开发人员处理多线程、异步和并发问题的设计模式。</p><p>在传统的并发编程模型中，客户端代码需要直接管理线程和锁等细节，这样会导致代码复杂度和维护成本的增加，同时也容易出现各种问题，如死锁、竞态条件等。活动对象模式通过引入活动对象来解决这些问题，活动对象将客户端代码发送的消息添加到内部的消息队列中，并使用单独的线程异步处理这些消息。这种模式可以提高系统的性能和可扩展性，同时使得客户端代码更加简单和易于维护。</p><p>活动对象模式的目的包括：</p><ol><li>将并发和异步处理的问题从客户端代码中分离出来，从而使得客户端代码更加简单和易于维护。客户端代码只需要发送消息即可，不需要关心异步处理的细节，活动对象将并发和异步处理的问题封装起来，提供简单的接口供客户端使用。</li><li>提高系统的性能和可扩展性。活动对象使用单独的线程池异步处理消息，可以更好地利用系统资源，提高系统的性能和可扩展性。</li><li>提高系统的可靠性和健壮性。活动对象将消息添加到内部的消息队列中，避免了竞态条件和死锁等问题，从而提高了系统的可靠性和健壮性。</li><li>将多线程和异步处理的细节封装起来，使得客户端代码更加抽象和通用。客户端代码可以使用相同的接口来访问不同的服务，从而提高代码的复用性和可维护性。</li></ol><h2 id=解释>解释</h2><p>活动对象模式的核心思想是将并发和异步处理的问题从客户端代码中分离出来。具体来说，活动对象模式包含以下几个关键组件：</p><ol><li>活动对象（Active Object）：活动对象是一个封装了某种服务的对象，它将客户端代码发送的消息添加到内部的消息队列中，并使用单独的线程异步处理这些消息。活动对象通常包含一个消息队列和一个线程池，用于异步处理消息。</li><li>方法调用请求（Method Invocation Request）：客户端代码向活动对象发送方法调用请求，包括方法名和参数列表等信息。活动对象将方法调用请求封装为一个消息对象，并添加到内部的消息队列中。</li><li>消息队列（Message Queue）：消息队列是活动对象内部用于存储方法调用请求的队列。活动对象将客户端代码发送的消息添加到消息队列中，并使用单独的线程异步处理这些消息。</li><li>线程池（Thread Pool）：线程池是活动对象用于异步处理消息的线程池。活动对象从消息队列中取出消息，并使用线程池中的线程异步处理这些消息。</li></ol><p><strong>程序示例</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>abstract</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ActiveCreature</span>{
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> Logger logger <span style=color:#f92672>=</span> LoggerFactory.<span style=color:#a6e22e>getLogger</span>(ActiveCreature.<span style=color:#a6e22e>class</span>.<span style=color:#a6e22e>getName</span>());
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> BlockingQueue<span style=color:#f92672>&lt;</span>Runnable<span style=color:#f92672>&gt;</span> requests;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> String name;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> Thread thread;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>ActiveCreature</span>(String name) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>name</span> <span style=color:#f92672>=</span> name;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>requests</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> LinkedBlockingQueue<span style=color:#f92672>&lt;</span>Runnable<span style=color:#f92672>&gt;</span>();
</span></span><span style=display:flex><span>    thread <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Thread(<span style=color:#66d9ef>new</span> Runnable() {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>run</span>() {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>while</span> (<span style=color:#66d9ef>true</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>              requests.<span style=color:#a6e22e>take</span>().<span style=color:#a6e22e>run</span>();
</span></span><span style=display:flex><span>            } <span style=color:#66d9ef>catch</span> (InterruptedException e) {
</span></span><span style=display:flex><span>              logger.<span style=color:#a6e22e>error</span>(e.<span style=color:#a6e22e>getMessage</span>());
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>    thread.<span style=color:#a6e22e>start</span>();
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>eat</span>() <span style=color:#66d9ef>throws</span> InterruptedException {
</span></span><span style=display:flex><span>    requests.<span style=color:#a6e22e>put</span>(<span style=color:#66d9ef>new</span> Runnable() {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>run</span>() {
</span></span><span style=display:flex><span>          logger.<span style=color:#a6e22e>info</span>(<span style=color:#e6db74>&#34;{} is eating!&#34;</span>,name());
</span></span><span style=display:flex><span>          logger.<span style=color:#a6e22e>info</span>(<span style=color:#e6db74>&#34;{} has finished eating!&#34;</span>,name());
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>roam</span>() <span style=color:#66d9ef>throws</span> InterruptedException {
</span></span><span style=display:flex><span>    requests.<span style=color:#a6e22e>put</span>(<span style=color:#66d9ef>new</span> Runnable() {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>run</span>() {
</span></span><span style=display:flex><span>          logger.<span style=color:#a6e22e>info</span>(<span style=color:#e6db74>&#34;{} has started to roam and the wastelands.&#34;</span>,name());
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>name</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>name</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>在该示例代码中，<code>ActiveCreature</code> 类封装了一个消息队列，用于异步处理客户端代码发送的消息。具体来说，该示例代码包含以下几个关键组件：</p><ol><li><code>BlockingQueue&lt;Runnable></code> 类型的 <code>requests</code> 属性：该属性表示消息队列，用于存储客户端代码发送的消息。客户端代码可以通过 <code>eat()</code> 和 <code>roam()</code> 方法向消息队列中添加消息。</li><li><code>Thread</code> 类型的 <code>thread</code> 属性：该属性表示活动对象的线程，用于异步处理消息队列中的消息。</li><li><code>String</code> 类型的 <code>name</code> 属性：该属性表示活动对象的名称。</li><li><code>ActiveCreature(String name)</code> 构造方法：该方法用于创建一个活动对象，初始化消息队列和线程等属性。在该方法中，我们创建了一个新的线程，并使用 <code>requests.take().run()</code> 从消息队列中取出消息并异步处理。</li><li><code>eat()</code> 和 <code>roam()</code> 方法：这两个方法用于向消息队列中添加消息，表示活动对象正在吃和漫游。在这两个方法中，我们将一个 <code>Runnable</code> 对象添加到消息队列中，并在其 <code>run()</code> 方法中执行相应的操作，如输出日志等。</li><li><code>name()</code> 方法：该方法用于获取活动对象的名称。</li></ol><p>在总体上，该示例代码实现了活动对象模式的基本功能，将并发和异步处理的问题从客户端代码中分离出来，并提供了简单的接口供客户端调用。客户端代码只需要调用 <code>eat()</code> 和 <code>roam()</code> 方法即可，不需要关心异步处理的细节，活动对象将并发和异步处理的问题封装起来，提供简单的接口供客户端使用。</p><p>需要注意的是，在该示例代码中，我们使用了阻塞队列 <code>BlockingQueue&lt;Runnable></code> 来实现消息队列，该队列提供了线程安全的添加和移除操作，保证了消息的有序性和正确性。同时，在活动对象的线程中使用了 <code>requests.take().run()</code> 操作来从消息队列中取出消息并异步处理，这种方式可以保证消息的有序性和正确性，并避免了竞态条件和死锁等问题。</p><p>我们可以看到，任何将扩展 ActiveCreature 的类都将具有自己的控制线程来执行和调用方法。</p><p>例如，兽人类：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Orc</span> <span style=color:#66d9ef>extends</span> ActiveCreature {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>Orc</span>(String name) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>super</span>(name);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>现在，我们可以创建多个生物，例如兽人，告诉他们吃东西和散步，然后他们将在自己的控制线程上执行它：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span>(String<span style=color:#f92672>[]</span> args) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> app <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> App();
</span></span><span style=display:flex><span>    app.<span style=color:#a6e22e>run</span>();
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>run</span>() {
</span></span><span style=display:flex><span>    ActiveCreature creature;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0;i <span style=color:#f92672>&lt;</span> creatures;i<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>        creature <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Orc(Orc.<span style=color:#a6e22e>class</span>.<span style=color:#a6e22e>getSimpleName</span>().<span style=color:#a6e22e>toString</span>() <span style=color:#f92672>+</span> i);
</span></span><span style=display:flex><span>        creature.<span style=color:#a6e22e>eat</span>();
</span></span><span style=display:flex><span>        creature.<span style=color:#a6e22e>roam</span>();
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      Thread.<span style=color:#a6e22e>sleep</span>(1000);
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>catch</span> (InterruptedException e) {
</span></span><span style=display:flex><span>      logger.<span style=color:#a6e22e>error</span>(e.<span style=color:#a6e22e>getMessage</span>());
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    Runtime.<span style=color:#a6e22e>getRuntime</span>().<span style=color:#a6e22e>exit</span>(1);
</span></span><span style=display:flex><span>  }
</span></span></code></pre></div><h2 id=类图>类图</h2><p><img src=https://java-design-patterns.com/assets/active-object.urm-0bce814e.png alt="alt text"></p><h2 id=举例>举例</h2><p>以下是一个简单的活动对象示例代码：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>import</span> java.util.concurrent.ExecutorService;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.util.concurrent.Executors;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.util.concurrent.Future;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ActiveObject</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> ExecutorService executor <span style=color:#f92672>=</span> Executors.<span style=color:#a6e22e>newSingleThreadExecutor</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Future<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>process</span>(String message) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 创建一个异步任务，并将其提交到线程池中</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> executor.<span style=color:#a6e22e>submit</span>(() <span style=color:#f92672>-&gt;</span> {
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 模拟复杂的处理逻辑</span>
</span></span><span style=display:flex><span>            Thread.<span style=color:#a6e22e>sleep</span>(1000);
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 返回处理结果</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;Processed message: &#34;</span> <span style=color:#f92672>+</span> message;
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>shutdown</span>() {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 关闭线程池</span>
</span></span><span style=display:flex><span>        executor.<span style=color:#a6e22e>shutdown</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>在上面的示例代码中，<code>ActiveObject</code> 类封装了一个异步处理服务，客户端代码可以使用该服务异步处理消息。<code>ActiveObject</code> 类中的 <code>process()</code> 方法接收一个消息，并将其封装为一个异步任务，然后提交到线程池中异步处理。<code>process()</code> 方法返回一个 <code>Future</code> 对象，可以用于获取异步处理的结果。在该示例代码中，异步任务只是简单地模拟了处理逻辑，实际上可以根据需要编写更加复杂的异步处理逻辑。</p><p>下面是一个使用 <code>ActiveObject</code> 类的示例代码：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>import</span> java.util.concurrent.ExecutionException;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.util.concurrent.Future;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Client</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span>(String<span style=color:#f92672>[]</span> args) <span style=color:#66d9ef>throws</span> InterruptedException, ExecutionException {
</span></span><span style=display:flex><span>        ActiveObject activeObject <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ActiveObject();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 发送消息到活动对象</span>
</span></span><span style=display:flex><span>        Future<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span> future <span style=color:#f92672>=</span> activeObject.<span style=color:#a6e22e>process</span>(<span style=color:#e6db74>&#34;Hello, world!&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 等待异步处理完成，并获取处理结果</span>
</span></span><span style=display:flex><span>        String result <span style=color:#f92672>=</span> future.<span style=color:#a6e22e>get</span>();
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(result);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 关闭活动对象</span>
</span></span><span style=display:flex><span>        activeObject.<span style=color:#a6e22e>shutdown</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>在上面的示例代码中，客户端代码使用 <code>ActiveObject</code> 类异步处理了一条消息，并等待异步处理完成后获取处理结果。需要注意的是，在使用 <code>ActiveObject</code> 类时，客户端代码只需要发送消息即可，不需要关心异步处理的细节，从而使得客户端代码更加简单和易于维护。</p><p>下面是一个复杂的活动对象示例代码，该代码模拟了一个银行账户系统，支持存款、取款和查询余额等操作。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>import</span> java.util.concurrent.CompletableFuture;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.util.concurrent.ExecutorService;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.util.concurrent.Executors;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>BankAccount</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> ExecutorService executor <span style=color:#f92672>=</span> Executors.<span style=color:#a6e22e>newSingleThreadExecutor</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>double</span> balance;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>BankAccount</span>(<span style=color:#66d9ef>double</span> initialBalance) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>balance</span> <span style=color:#f92672>=</span> initialBalance;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> CompletableFuture<span style=color:#f92672>&lt;</span>Double<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>deposit</span>(<span style=color:#66d9ef>double</span> amount) {
</span></span><span style=display:flex><span>        CompletableFuture<span style=color:#f92672>&lt;</span>Double<span style=color:#f92672>&gt;</span> future <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> CompletableFuture<span style=color:#f92672>&lt;&gt;</span>();
</span></span><span style=display:flex><span>        executor.<span style=color:#a6e22e>submit</span>(() <span style=color:#f92672>-&gt;</span> {
</span></span><span style=display:flex><span>            balance <span style=color:#f92672>+=</span> amount;
</span></span><span style=display:flex><span>            future.<span style=color:#a6e22e>complete</span>(balance);
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> future;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> CompletableFuture<span style=color:#f92672>&lt;</span>Double<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>withdraw</span>(<span style=color:#66d9ef>double</span> amount) {
</span></span><span style=display:flex><span>        CompletableFuture<span style=color:#f92672>&lt;</span>Double<span style=color:#f92672>&gt;</span> future <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> CompletableFuture<span style=color:#f92672>&lt;&gt;</span>();
</span></span><span style=display:flex><span>        executor.<span style=color:#a6e22e>submit</span>(() <span style=color:#f92672>-&gt;</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (balance <span style=color:#f92672>&gt;=</span> amount) {
</span></span><span style=display:flex><span>                balance <span style=color:#f92672>-=</span> amount;
</span></span><span style=display:flex><span>                future.<span style=color:#a6e22e>complete</span>(balance);
</span></span><span style=display:flex><span>            } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>                future.<span style=color:#a6e22e>completeExceptionally</span>(<span style=color:#66d9ef>new</span> InsufficientFundsException(<span style=color:#e6db74>&#34;Insufficient funds&#34;</span>));
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> future;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> CompletableFuture<span style=color:#f92672>&lt;</span>Double<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>getBalance</span>() {
</span></span><span style=display:flex><span>        CompletableFuture<span style=color:#f92672>&lt;</span>Double<span style=color:#f92672>&gt;</span> future <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> CompletableFuture<span style=color:#f92672>&lt;&gt;</span>();
</span></span><span style=display:flex><span>        executor.<span style=color:#a6e22e>submit</span>(() <span style=color:#f92672>-&gt;</span> {
</span></span><span style=display:flex><span>            future.<span style=color:#a6e22e>complete</span>(balance);
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> future;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>shutdown</span>() {
</span></span><span style=display:flex><span>        executor.<span style=color:#a6e22e>shutdown</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>InsufficientFundsException</span> <span style=color:#66d9ef>extends</span> RuntimeException {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>InsufficientFundsException</span>(String message) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>super</span>(message);
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=缺点>缺点</h2><p>虽然活动对象模式具有许多优点，但也存在一些缺点，如下所述：</p><ol><li>复杂性：活动对象模式需要使用异步处理和事件驱动机制，这增加了系统的复杂性。在设计、实现和测试时，需要考虑许多因素，如并发控制、锁定、死锁、线程池大小、任务队列大小等。</li><li>性能下降：在处理大量请求时，活动对象模式可能会导致性能下降。这是因为活动对象模式需要创建许多线程和任务，这会增加系统的负载和开销。此外，如果任务队列或线程池过大，会导致内存和 CPU 资源的浪费。</li><li>调试难度：由于活动对象模式使用异步处理和事件驱动机制，因此在调试时可能会出现难以预测的行为。例如，多个线程可能会同时访问共享资源，导致死锁或竞态条件，从而导致应用程序崩溃或出现其他问题。</li><li>状态管理：由于活动对象模式使用异步处理和事件驱动机制，因此在处理请求时需要管理对象的状态。这可能会导致状态同步和状态不一致的问题，从而影响系统的正确性和可靠性。</li><li>缺乏标准化：活动对象模式没有标准化的实现方式，因此在不同的应用程序和框架中可能会有不同的实现方式和限制。这使得活动对象模式在不同的环境中难以移植和重用。</li></ol><p>总的来说，活动对象模式是一种强大的设计模式，可以用于实现异步处理、事件驱动、高性能、可伸缩和可靠的应用程序。但是，它也存在一些缺点，需要仔细考虑和权衡。在使用活动对象模式时，需要关注系统的复杂性、性能、调试难度、状态管理和标准化等问题。</p><h2 id=应用>应用</h2><h3 id=在开源框架中的应用>在开源框架中的应用</h3><p>活动对象设计模式在许多开源框架中都得到了广泛应用，以下是几个常见的例子：</p><ol><li>Akka 框架：Akka 是一个轻量级的 Actor 模型框架，通过将并发和异步处理的问题从客户端代码中分离出来，提高了系统的性能、可靠性和可维护性。在 Akka 中，每个 Actor 都是一个活动对象，通过消息传递的方式进行通信和协作。Akka 提供了丰富的 API 和工具，可以方便地创建和管理 Actor，实现高性能和可扩展的系统。</li><li>Vert.x 框架：Vert.x 是一个基于事件驱动的异步框架，提供了多种语言的 API 和工具，支持构建高性能和可扩展的应用程序。在 Vert.x 中，每个组件都是一个活动对象，可以通过 Vert.x 的事件总线进行通信和协作。Vert.x 提供了丰富的异步 API 和工具，可以方便地处理并发和异步问题。</li><li>RxJava 框架：RxJava 是一个基于响应式编程的异步框架，提供了丰富的操作符和工具，支持构建高性能和可维护的应用程序。在 RxJava 中，每个 Observable 都是一个活动对象，可以通过异步流的方式进行通信和协作。RxJava 提供了丰富的操作符和工具，可以方便地处理并发和异步问题，并支持响应式编程的多种特性，如响应式流、背压控制等。</li><li>Netty 框架：Netty 是一个基于事件驱动的异步网络通信框架，提供了丰富的 API 和工具，支持构建高性能和可扩展的网络应用程序。在 Netty 中，每个 Channel 都是一个活动对象，可以通过事件的方式进行通信和协作。Netty 提供了丰富的异步 API 和工具，可以方便地处理网络通信和异步问题，并支持多种协议和编解码器。</li><li>Spring 框架：Spring 是一个广泛使用的企业级 Java 框架，提供了丰富的 API 和工具，支持构建高性能和可维护的应用程序。在 Spring 中，可以使用异步处理、响应式编程和事件驱动等方式实现活动对象模式。Spring 提供了丰富的异步 API 和工具，可以方便地处理异步和并发问题。</li><li>JMS 框架：JMS 是 Java 消息服务的标准，提供了异步消息传递的方式，支持构建可靠、高性能和可扩展的消息系统。在 JMS 中，可以使用活动对象模式实现异步消息的处理和分发。JMS 提供了丰富的 API 和工具，可以方便地处理异步消息的生产和消费。</li><li>Apache Camel 框架：Apache Camel 是一个基于企业级集成模式的开源框架，提供了丰富的组件和工具，支持构建可扩展、高性能和可靠的应用程序。在 Camel 中，可以使用活动对象模式实现异步消息的处理和路由。Camel 提供了丰富的组件和工具，可以方便地处理异步消息的路由和转换。</li></ol><p>下面是一个使用 Spring 异步处理和事件驱动机制实现活动对象模式的示例代码，该示例代码使用了 Spring Boot 框架和 Spring Reactor 库：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.beans.factory.annotation.Autowired;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.context.annotation.Bean;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.context.annotation.Configuration;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.stereotype.Component;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> reactor.core.publisher.Flux;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> reactor.core.publisher.Mono;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> reactor.core.scheduler.Schedulers;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Configuration</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>AppConfig</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> MessageHandler <span style=color:#a6e22e>messageHandler</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> MessageHandler();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Component</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MessageHandler</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> MessageRepository messageRepository;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Mono<span style=color:#f92672>&lt;</span>Void<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>handleMessage</span>(String message) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> Mono.<span style=color:#a6e22e>fromCallable</span>(() <span style=color:#f92672>-&gt;</span> {
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 处理消息</span>
</span></span><span style=display:flex><span>            System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;Received message: &#34;</span> <span style=color:#f92672>+</span> message);
</span></span><span style=display:flex><span>            messageRepository.<span style=color:#a6e22e>save</span>(<span style=color:#66d9ef>new</span> Message(message));
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>        }).<span style=color:#a6e22e>subscribeOn</span>(Schedulers.<span style=color:#a6e22e>boundedElastic</span>());
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Flux<span style=color:#f92672>&lt;</span>Message<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>getAllMessages</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> Flux.<span style=color:#a6e22e>defer</span>(() <span style=color:#f92672>-&gt;</span> Flux.<span style=color:#a6e22e>fromIterable</span>(messageRepository.<span style=color:#a6e22e>findAll</span>()))
</span></span><span style=display:flex><span>                .<span style=color:#a6e22e>subscribeOn</span>(Schedulers.<span style=color:#a6e22e>boundedElastic</span>());
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Entity</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Message</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Id</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@GeneratedValue</span>(strategy <span style=color:#f92672>=</span> GenerationType.<span style=color:#a6e22e>IDENTITY</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Long id;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String content;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>Message</span>() {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>Message</span>(String content) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>content</span> <span style=color:#f92672>=</span> content;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Long <span style=color:#a6e22e>getId</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> id;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>在上述示例代码中，我们定义了一个 <code>MessageHandler</code> 类作为活动对象，用于异步处理消息的接收和存储。该类使用了 Spring 异步处理和事件驱动机制来实现活动对象模式，客户端代码只需要调用相应的方法即可，不需要关心异步处理的细节。</p><p>具体来说，该示例代码包含以下几个部分：</p><ol><li><p><code>AppConfig</code> 配置类：该类用于配置 Spring Bean，定义了一个 <code>messageHandler()</code> 方法，返回一个 <code>MessageHandler</code> 对象。</p></li><li><p><code>MessageHandler</code> 活动对象类：该类包含了两个方法：<code>handleMessage()</code> 和 <code>getAllMessages()</code>。<code>handleMessage()</code> 方法用于处理消息，将消息存储到数据库中；<code>getAllMessages()</code> 方法用于获取所有的消息。这两个方法都使用了 Spring 的异步处理机制和事件驱动机制，使用了 Reactor 库中的 <code>Mono</code> 和 <code>Flux</code> 类。</p></li><li><p><code>Message</code> JPA 实体类：该类用于表示消息对象，使用了 JPA 注解。</p></li></ol><p>在 <code>handleMessage()</code> 方法中，我们使用了 <code>Mono.fromCallable()</code> 方法来异步处理消息的接收和存储，将处理操作提交到线程池中执行，然后返回 <code>Mono&lt;Void></code> 对象，以便客户端代码可以等待处理操作完成。我们还使用了 <code>subscribeOn()</code> 方法来指定异步处理的线程池，以提高系统的性能和可伸缩性。</p><p>在 <code>getAllMessages()</code> 方法中，我们使用了 <code>Flux.defer()</code> 方法来异步获取所有的消息，将获取操作提交到线程池中执行，然后返回 <code>Flux&lt;Message></code> 对象，以便客户端代码可以异步获取消息。我们同样使用了 <code>subscribeOn()</code> 方法来指定异步处理的线程池。</p><p>通过使用 Spring 异步处理和事件驱动机制，我们可以实现高性能、可靠和可扩展的活动对象模式，提高系统的性能和可维护性。</p><p>下面是一个使用活动对象模式实现异步消息处理和分发的 JMS 示例代码，该示例代码使用了 ActiveMQ 作为 JMS 消息中间件：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>import</span> javax.jms.*;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.apache.activemq.ActiveMQConnectionFactory;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.util.concurrent.CompletableFuture;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.util.concurrent.ExecutorService;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.util.concurrent.Executors;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>JMSMessageHandler</span> <span style=color:#66d9ef>implements</span> MessageListener {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> ExecutorService executor <span style=color:#f92672>=</span> Executors.<span style=color:#a6e22e>newSingleThreadExecutor</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Connection connection;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Session session;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Destination destination;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>JMSMessageHandler</span>(String brokerUrl, String destinationName) <span style=color:#66d9ef>throws</span> JMSException {
</span></span><span style=display:flex><span>        ConnectionFactory connectionFactory <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ActiveMQConnectionFactory(brokerUrl);
</span></span><span style=display:flex><span>        connection <span style=color:#f92672>=</span> connectionFactory.<span style=color:#a6e22e>createConnection</span>();
</span></span><span style=display:flex><span>        connection.<span style=color:#a6e22e>start</span>();
</span></span><span style=display:flex><span>        session <span style=color:#f92672>=</span> connection.<span style=color:#a6e22e>createSession</span>(<span style=color:#66d9ef>false</span>, Session.<span style=color:#a6e22e>AUTO_ACKNOWLEDGE</span>);
</span></span><span style=display:flex><span>        destination <span style=color:#f92672>=</span> session.<span style=color:#a6e22e>createQueue</span>(destinationName);
</span></span><span style=display:flex><span>        MessageConsumer consumer <span style=color:#f92672>=</span> session.<span style=color:#a6e22e>createConsumer</span>(destination);
</span></span><span style=display:flex><span>        consumer.<span style=color:#a6e22e>setMessageListener</span>(<span style=color:#66d9ef>this</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> CompletableFuture<span style=color:#f92672>&lt;</span>Void<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>send</span>(String message) {
</span></span><span style=display:flex><span>        CompletableFuture<span style=color:#f92672>&lt;</span>Void<span style=color:#f92672>&gt;</span> future <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> CompletableFuture<span style=color:#f92672>&lt;&gt;</span>();
</span></span><span style=display:flex><span>        executor.<span style=color:#a6e22e>submit</span>(() <span style=color:#f92672>-&gt;</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>                TextMessage textMessage <span style=color:#f92672>=</span> session.<span style=color:#a6e22e>createTextMessage</span>(message);
</span></span><span style=display:flex><span>                MessageProducer producer <span style=color:#f92672>=</span> session.<span style=color:#a6e22e>createProducer</span>(destination);
</span></span><span style=display:flex><span>                producer.<span style=color:#a6e22e>send</span>(textMessage);
</span></span><span style=display:flex><span>                future.<span style=color:#a6e22e>complete</span>(<span style=color:#66d9ef>null</span>);
</span></span><span style=display:flex><span>            } <span style=color:#66d9ef>catch</span> (JMSException e) {
</span></span><span style=display:flex><span>                future.<span style=color:#a6e22e>completeExceptionally</span>(e);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> future;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onMessage</span>(Messagemessage) {
</span></span><span style=display:flex><span>        CompletableFuture.<span style=color:#a6e22e>runAsync</span>(() <span style=color:#f92672>-&gt;</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> (message <span style=color:#66d9ef>instanceof</span> TextMessage) {
</span></span><span style=display:flex><span>                    TextMessage textMessage <span style=color:#f92672>=</span> (TextMessage) message;
</span></span><span style=display:flex><span>                    String text <span style=color:#f92672>=</span> textMessage.<span style=color:#a6e22e>getText</span>();
</span></span><span style=display:flex><span>                    <span style=color:#75715e>// 处理消息</span>
</span></span><span style=display:flex><span>                    System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;Received message: &#34;</span> <span style=color:#f92672>+</span> text);
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            } <span style=color:#66d9ef>catch</span> (JMSException e) {
</span></span><span style=display:flex><span>                e.<span style=color:#a6e22e>printStackTrace</span>();
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>close</span>() <span style=color:#66d9ef>throws</span> JMSException {
</span></span><span style=display:flex><span>        connection.<span style=color:#a6e22e>close</span>();
</span></span><span style=display:flex><span>        executor.<span style=color:#a6e22e>shutdown</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>在上述示例代码中，<code>JMSMessageHandler</code> 类表示一个 JMS 消息处理器，可以异步处理来自 JMS 队列的消息，并将处理结果发送回 JMS 队列。该类使用了活动对象模式来实现异步消息的处理和分发，客户端代码只需要发送消息即可，不需要关心异步处理的细节。</p><p>具体来说，该类包含以下几个方法：</p><ol><li><p><code>JMSMessageHandler(String brokerUrl, String destinationName)</code> 构造方法：该方法用于创建一个 JMS 消息处理器对象，连接到指定的 JMS 消息中间件并订阅指定的队列。</p></li><li><p><code>send(String message)</code> 方法：该方法用于发送消息到 JMS 队列中，客户端代码可以调用该方法将消息发送到指定的队列。</p></li><li><p><code>onMessage(Message message)</code> 方法：该方法是 <code>MessageListener</code> 接口的回调方法，用于异步处理队列中的消息，并将处理结果发送回 JMS 队列。</p></li><li><p><code>close()</code> 方法：该方法用于关闭 JMS 连接和线程池，释放资源。</p></li></ol><p>在 <code>send()</code> 方法中，我们使用了 <code>CompletableFuture</code> 对象来异步处理消息的发送，将发送操作提交到线程池中执行，然后返回 <code>CompletableFuture</code> 对象，以便客户端代码可以等待发送操作完成。</p><p>在 <code>onMessage()</code> 方法中，我们使用了 <code>CompletableFuture.runAsync()</code> 方法来异步处理消息的处理，将处理操作提交到线程池中执行，然后返回 <code>CompletableFuture</code> 对象，以便客户端代码可以等待处理操作完成。</p><p>通过使用活动对象模式和异步处理技术，我们可以实现高性能、可靠和可扩展的 JMS 消息处理器，提高系统的性能和可维护性。</p><h3 id=在项目中的使用>在项目中的使用</h3><p>在公司的项目中，用到过活动对象这个设计模式，只是之前并不清楚这个模式。使用场景是，发送飞书通知和拨打语音电话时，将请求添加到一个内部阻塞队列，然后单独启动一个线程去消费这个队列。</p><p>以下是拨打语音电话的代码：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Tencent Cloud Vms SendTtsVoice
</span></span></span><span style=display:flex><span><span style=color:#75715e> * https://cloud.tencent.com/document/product/1128/51558
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Slf4j</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@AllArgsConstructor</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>VmsServiceImpl</span> <span style=color:#66d9ef>implements</span> VmsService {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String PREFIX_PHONE <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;86&#34;</span>;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> BlockingQueue<span style=color:#f92672>&lt;</span>VoiceSenderRequest<span style=color:#f92672>&gt;</span> queue <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> LinkedBlockingQueue<span style=color:#f92672>&lt;&gt;</span>();
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> TtsVoiceSender ttsVoiceSender;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> AsyncVmsThread asyncVmsThread <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> AsyncVmsThread();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@PostConstruct</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>init</span>() {
</span></span><span style=display:flex><span>		asyncVmsThread.<span style=color:#a6e22e>start</span>();
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@PreDestroy</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>destroy</span>() {
</span></span><span style=display:flex><span>		asyncVmsThread.<span style=color:#a6e22e>shutdown</span>();
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>sendAsync</span>(Collection<span style=color:#f92672>&lt;</span>NoticeTarget<span style=color:#f92672>&gt;</span> noticeUsers, Integer templateId, String<span style=color:#f92672>[]</span> params) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> (templateId <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>||</span> CollectionUtils.<span style=color:#a6e22e>isEmpty</span>(noticeUsers)) {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>for</span> (NoticeTarget noticeUser : noticeUsers) {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>noticeUser.<span style=color:#a6e22e>getType</span>().<span style=color:#a6e22e>equals</span>(NoticeTargetTypeEnum.<span style=color:#a6e22e>PHONE</span>)) {
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>continue</span>;
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>				queue.<span style=color:#a6e22e>put</span>(<span style=color:#66d9ef>new</span> VoiceSenderRequest().<span style=color:#a6e22e>setNoticeUser</span>(noticeUser).<span style=color:#a6e22e>setTemplateId</span>(templateId).<span style=color:#a6e22e>setParams</span>(params));
</span></span><span style=display:flex><span>			} <span style=color:#66d9ef>catch</span> (InterruptedException e) {
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> BusinessException(<span style=color:#e6db74>&#34;线程被中断&#34;</span>);
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> Boolean <span style=color:#a6e22e>send</span>(String phone, Integer templateId, String<span style=color:#f92672>[]</span> params) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> (templateId <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>||</span> StringUtils.<span style=color:#a6e22e>isBlank</span>(phone)) {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> BusinessException(<span style=color:#e6db74>&#34;参数不能为空&#34;</span>);
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		TtsVoiceSenderResult ttsVoiceSenderResult <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>			ttsVoiceSenderResult <span style=color:#f92672>=</span> ttsVoiceSender.<span style=color:#a6e22e>send</span>(PREFIX_PHONE, phone, templateId, params, 2, <span style=color:#e6db74>&#34;&#34;</span>);
</span></span><span style=display:flex><span>		} <span style=color:#66d9ef>catch</span> (Exception e) {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RuntimeException(e);
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> (ttsVoiceSenderResult.<span style=color:#a6e22e>result</span> <span style=color:#f92672>!=</span> 0) {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> BusinessException(ttsVoiceSenderResult.<span style=color:#a6e22e>errMsg</span>);
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> ttsVoiceSenderResult.<span style=color:#a6e22e>result</span> <span style=color:#f92672>==</span> 0;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>AsyncVmsThread</span> <span style=color:#66d9ef>extends</span> Thread {
</span></span><span style=display:flex><span>		AtomicBoolean isRunning <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> AtomicBoolean(<span style=color:#66d9ef>true</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>public</span> <span style=color:#a6e22e>AsyncVmsThread</span>() {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>super</span>(<span style=color:#e6db74>&#34;vmsSender&#34;</span>);
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>run</span>() {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>while</span> (isRunning.<span style=color:#a6e22e>get</span>()) {
</span></span><span style=display:flex><span>				ThreadUtil.<span style=color:#a6e22e>sleep</span>(2000L);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>				VoiceSenderRequest voiceSenderRequest <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>					voiceSenderRequest <span style=color:#f92672>=</span> queue.<span style=color:#a6e22e>take</span>();
</span></span><span style=display:flex><span>					send(voiceSenderRequest.<span style=color:#a6e22e>getNoticeUser</span>().<span style=color:#a6e22e>getId</span>(), voiceSenderRequest.<span style=color:#a6e22e>getTemplateId</span>(), voiceSenderRequest.<span style=color:#a6e22e>getParams</span>());
</span></span><span style=display:flex><span>				} <span style=color:#66d9ef>catch</span> (Exception e) {
</span></span><span style=display:flex><span>					log.<span style=color:#a6e22e>warn</span>(<span style=color:#e6db74>&#34;{}&#34;</span>, String.<span style=color:#a6e22e>format</span>(<span style=color:#e6db74>&#34;发送语音电话给[%s]出现异常: %s&#34;</span>, voiceSenderRequest.<span style=color:#a6e22e>getNoticeUser</span>(), e.<span style=color:#a6e22e>getMessage</span>()), e);
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>shutdown</span>() {
</span></span><span style=display:flex><span>			isRunning.<span style=color:#a6e22e>set</span>(<span style=color:#66d9ef>false</span>);
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Data</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Accessors</span>(chain <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>VoiceSenderRequest</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>private</span> NoticeTarget noticeUser;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>private</span> Integer templateId;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>private</span> String<span style=color:#f92672>[]</span> params;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>优化之后的代码：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Slf4j</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>abstract</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ActiveObject</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> BlockingQueue<span style=color:#f92672>&lt;</span>Runnable<span style=color:#f92672>&gt;</span> requests;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> String name;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> Thread thread;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> <span style=color:#66d9ef>volatile</span> <span style=color:#66d9ef>boolean</span> isAcceptingRequests <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> <span style=color:#66d9ef>volatile</span> <span style=color:#66d9ef>boolean</span> isProcessingRequests <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> <span style=color:#a6e22e>ActiveObject</span>(String name) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>this</span>(name, 16, <span style=color:#66d9ef>null</span>);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> <span style=color:#a6e22e>ActiveObject</span>(String name, <span style=color:#66d9ef>int</span> queueSize, Long sleepMillis) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>name</span> <span style=color:#f92672>=</span> name;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>requests</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> LinkedBlockingQueue<span style=color:#f92672>&lt;&gt;</span>(queueSize);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		thread <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Thread(() <span style=color:#f92672>-&gt;</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>while</span> (isProcessingRequests) {
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>					processRequest(requests.<span style=color:#a6e22e>take</span>());
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>if</span> (sleepMillis <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>						Thread.<span style=color:#a6e22e>sleep</span>(sleepMillis);
</span></span><span style=display:flex><span>					}
</span></span><span style=display:flex><span>				} <span style=color:#66d9ef>catch</span> (InterruptedException e) {
</span></span><span style=display:flex><span>					log.<span style=color:#a6e22e>warn</span>(<span style=color:#e6db74>&#34;Active Object thread interrupted, reason: {}&#34;</span>, e.<span style=color:#a6e22e>getMessage</span>());
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}, name);
</span></span><span style=display:flex><span>		thread.<span style=color:#a6e22e>start</span>();
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>processRequest</span>(Runnable task) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>			task.<span style=color:#a6e22e>run</span>();
</span></span><span style=display:flex><span>		} <span style=color:#66d9ef>catch</span> (Exception e) {
</span></span><span style=display:flex><span>			log.<span style=color:#a6e22e>error</span>(<span style=color:#e6db74>&#34;Error processing request: {}&#34;</span>, e.<span style=color:#a6e22e>getMessage</span>());
</span></span><span style=display:flex><span>			<span style=color:#75715e>// 发送告警信息</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>shutdown</span>() {
</span></span><span style=display:flex><span>		isAcceptingRequests <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>while</span> (<span style=color:#f92672>!</span>requests.<span style=color:#a6e22e>isEmpty</span>()) {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>				Thread.<span style=color:#a6e22e>sleep</span>(100);
</span></span><span style=display:flex><span>			} <span style=color:#66d9ef>catch</span> (InterruptedException e) {
</span></span><span style=display:flex><span>				<span style=color:#75715e>// Ignore exception</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		isProcessingRequests <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>		thread.<span style=color:#a6e22e>interrupt</span>();
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>run</span>(Runnable runnable) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> (isAcceptingRequests) {
</span></span><span style=display:flex><span>			requests.<span style=color:#a6e22e>offer</span>(runnable);
</span></span><span style=display:flex><span>		} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalStateException(<span style=color:#e6db74>&#34;Active object is no longer accepting requests&#34;</span>);
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>name</span>() {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>name</span>;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>该类具有构造函数，用于创建具有给定名称和指定大小阻塞请求队列的 Active Object。Active Object 在后台的单独线程上运行，该线程在循环中执行，直到被中断。它使用<code>run</code>方法执行添加到请求队列中的请求。<code>run</code>方法接受一个<code>Runnable</code>对象，并将其添加到请求队列中。如果 Active Object 不再接受请求，则抛出<code>IllegalStateException</code>。</p><p><code>shutdown</code>方法用于停止 Active Object。它首先将<code>isAcceptingRequests</code>标志设置为 false，这将防止将任何进一步的请求添加到队列中。然后等待队列变为空，然后将<code>isProcessingRequests</code>标志设置为 false，并中断 Active Object 的线程。</p><p>这个类本身已经是一个很好的 Active Object 模式的实现了，但是如果需要更高的性能或更好的扩展性，还可以进行一些优化：</p><ol><li><p>使用线程池：当前的实现中，每个 Active Object 都有一个单独的线程来处理请求。如果需要处理大量的 Active Object，这将会产生很多线程，从而影响系统的性能和稳定性。可以使用线程池来管理线程，从而更好地控制线程的数量和资源的使用。</p><blockquote><p>如果在使用 ActiveObject 时要执行耗时的任务，可以将任务放到一个单独的线程池中执行，以避免阻塞 ActiveObject 实例的请求处理线程。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Slf4j</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>abstract</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ActiveObject</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> BlockingQueue<span style=color:#f92672>&lt;</span>Runnable<span style=color:#f92672>&gt;</span> requests;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> String name;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> ExecutorService executorService;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> Thread thread;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> <span style=color:#66d9ef>volatile</span> <span style=color:#66d9ef>boolean</span> isAcceptingRequests <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> <span style=color:#66d9ef>volatile</span> <span style=color:#66d9ef>boolean</span> isProcessingRequests <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> <span style=color:#a6e22e>ActiveObject</span>(String name) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>this</span>(name, 16, <span style=color:#66d9ef>null</span>);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> <span style=color:#a6e22e>ActiveObject</span>(String name, <span style=color:#66d9ef>int</span> queueSize, Long sleepMillis) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>name</span> <span style=color:#f92672>=</span> name;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>requests</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> LinkedBlockingQueue<span style=color:#f92672>&lt;&gt;</span>(queueSize);
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>executorService</span> <span style=color:#f92672>=</span> Executors.<span style=color:#a6e22e>newFixedThreadPool</span>(5);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		thread <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Thread(() <span style=color:#f92672>-&gt;</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>while</span> (isProcessingRequests) {
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>					processRequest(requests.<span style=color:#a6e22e>take</span>(), executorService);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>if</span> (sleepMillis <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>						Thread.<span style=color:#a6e22e>sleep</span>(sleepMillis);
</span></span><span style=display:flex><span>					}
</span></span><span style=display:flex><span>				} <span style=color:#66d9ef>catch</span> (InterruptedException e) {
</span></span><span style=display:flex><span>					log.<span style=color:#a6e22e>warn</span>(<span style=color:#e6db74>&#34;Active Object thread interrupted, reason: {}&#34;</span>, e.<span style=color:#a6e22e>getMessage</span>());
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}, name);
</span></span><span style=display:flex><span>		thread.<span style=color:#a6e22e>start</span>();
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>processRequest</span>(Runnable task, ExecutorService executorService) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>			executorService.<span style=color:#a6e22e>submit</span>(task).<span style=color:#a6e22e>get</span>();
</span></span><span style=display:flex><span>		} <span style=color:#66d9ef>catch</span> (Exception e) {
</span></span><span style=display:flex><span>			log.<span style=color:#a6e22e>error</span>(<span style=color:#e6db74>&#34;Error processing request: {}&#34;</span>, e.<span style=color:#a6e22e>getMessage</span>());
</span></span><span style=display:flex><span>			<span style=color:#75715e>// 发送告警信息</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>shutdown</span>() {
</span></span><span style=display:flex><span>		isAcceptingRequests <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>while</span> (<span style=color:#f92672>!</span>requests.<span style=color:#a6e22e>isEmpty</span>()) {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>				Thread.<span style=color:#a6e22e>sleep</span>(100);
</span></span><span style=display:flex><span>			} <span style=color:#66d9ef>catch</span> (InterruptedException e) {
</span></span><span style=display:flex><span>				<span style=color:#75715e>// Ignore exception</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		isProcessingRequests <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>		executorService.<span style=color:#a6e22e>shutdown</span>();
</span></span><span style=display:flex><span>		thread.<span style=color:#a6e22e>interrupt</span>();
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>run</span>(Runnable runnable) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> (isAcceptingRequests) {
</span></span><span style=display:flex><span>			requests.<span style=color:#a6e22e>offer</span>(runnable);
</span></span><span style=display:flex><span>		} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalStateException(<span style=color:#e6db74>&#34;Active object is no longer accepting requests&#34;</span>);
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>name</span>() {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>name</span>;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>在修改后的代码中，添加了一个私有变量 executorService，用于存储一个线程池对象，其中线程池的大小为 5。在构造方法中，创建了一个新的 FixedThreadPoolExecutor 实例，并将其作为 executorService 的值。该线程池会在 ActiveObject 实例中处理耗时任务，避免阻塞请求队列的处理。</p><p>在 processRequest 方法中，使用 executorService.submit(task).get()来提交并执行任务。在执行任务时，使用了 get()方法来同步获取任务的执行结果，以确保任务执行完成后再处理下一个请求。</p><p>在 shutdown 方法中，添加了 executorService.shutdown()来关闭线程池。该方法会等待所有任务执行完成后关闭线程池，并防止新任务被提交。这样可以确保所有任务都被处理完毕后才关闭 ActiveObject 实例。</p><p>需要注意的是，在使用线程池时，要根据具体的业务需求和系统资源情况选择合适的线程池大小和类型，避免线程池过大或过小，从而影响系统性能或导致线程池拥堵。</p></blockquote></li><li><p>优化请求的处理：当前实现中，每个请求都会在执行完毕后等待 100 毫秒。如果请求处理较快，这将浪费很多时间。可以根据实际情况优化请求的处理方式，例如设置一个最小执行时间，或者使用更高效的数据结构来管理请求队列。</p><blockquote><p>在当前的实现中，使用了一个阻塞队列 LinkedBlockingQueue 来管理请求队列。这种数据结构的优点是可以保证线程安全，但是在高并发场景下可能会成为瓶颈，因为它是基于链表实现的，每次添加或删除元素时都需要进行同步操作，可能会影响性能。</p><p>如果需要更高效的请求队列管理方式，可以考虑使用无锁的并发队列，例如 Disruptor 或 ConcurrentLinkedQueue。这些数据结构可以在高并发场景下提供更好的性能和可扩展性，但是需要更加复杂的实现和使用方法，需要根据具体的场景进行权衡和选择。如果使用 Disruptor，需要进行更加细致的配置和调优，以便发挥最大的性能优势。如果使用 ConcurrentLinkedQueue，需要考虑并发问题，例如使用 CAS 操作来保证线程安全。</p><p>如果使用 ConcurrentLinkedQueue 来管理请求队列，需要考虑并发问题，因为该数据结构是非阻塞的，多个线程可以同时对其进行操作，可能会导致并发问题，例如竞态条件和内存一致性问题。</p><p>为了保证线程安全，可以使用 CAS（Compare and Swap）操作来实现原子性的元素插入和删除。CAS 操作可以保证只有一个线程能够成功修改共享变量的值，其他线程需要重试或者等待。</p><p>例如，在 ActiveObject 类中，可以将请求队列声明为 ConcurrentLinkedQueue 类型，并使用 CAS 操作来实现元素的插入和删除：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>abstract</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ActiveObject</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> ConcurrentLinkedQueue<span style=color:#f92672>&lt;</span>Runnable<span style=color:#f92672>&gt;</span> requests;
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>ActiveObject</span>(String name, <span style=color:#66d9ef>int</span> queueSize) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>name</span> <span style=color:#f92672>=</span> name;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>requests</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ConcurrentLinkedQueue<span style=color:#f92672>&lt;&gt;</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        thread <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Thread(() <span style=color:#f92672>-&gt;</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>while</span> (isProcessingRequests) {
</span></span><span style=display:flex><span>                Runnable task <span style=color:#f92672>=</span> requests.<span style=color:#a6e22e>poll</span>();
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> (task <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>                    task.<span style=color:#a6e22e>run</span>();
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>                    Thread.<span style=color:#a6e22e>sleep</span>(100);
</span></span><span style=display:flex><span>                } <span style=color:#66d9ef>catch</span> (InterruptedException e) {
</span></span><span style=display:flex><span>                    log.<span style=color:#a6e22e>warn</span>(<span style=color:#e6db74>&#34;Active Object thread interrupted, reason: {}&#34;</span>, e.<span style=color:#a6e22e>getMessage</span>());
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }, name);
</span></span><span style=display:flex><span>        thread.<span style=color:#a6e22e>start</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>在上面的代码中，使用了 ConcurrentLinkedQueue 来替换了原有的阻塞队列 LinkedBlockingQueue，并使用了 poll 方法来获取队列中的下一个元素，而不是 take 方法，这样可以避免线程阻塞。然后使用 CAS 操作来实现元素的添加，使用了 offer 方法，并检查返回值是否为 true，如果为 false 则表示 CAS 操作失败，需要重试或者等待。</p><p>需要注意的是，ConcurrentLinkedQueue 并不能保证元素的顺序，因此在处理请求时需要注意顺序问题，不能保证先进先出的顺序。如果需要保证顺序，可以使用其他的数据结构，例如 BlockingQueue。</p></blockquote></li></ol><p>上面的代码已经很不错了，但还有一些可以优化的地方：</p><ol><li>使用工厂方法来创建 ActiveObject 实例</li></ol><p>可以将 ActiveObject 类中的构造方法改为私有的，然后提供一个工厂方法来创建 ActiveObject 实例。这样可以将 ActiveObject 的创建逻辑与客户端代码分离，使得客户端代码更加简洁和易于维护。</p><ol start=2><li>将日志记录器作为静态变量</li></ol><p>可以将日志记录器作为静态变量，以便在整个类中共享。这样可以避免在每个方法中都创建一个日志记录器，提高代码的可读性和性能。</p><ol start=3><li>使用线程安全的单例模式</li></ol><p>可以使用线程安全的单例模式来确保 ActiveObject 实例的唯一性。这样可以避免在多个地方创建多个 ActiveObject 实例，从而导致系统资源浪费或数据不一致。</p><p>修改后的代码如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>abstract</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ActiveObject</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> Logger log <span style=color:#f92672>=</span> LoggerFactory.<span style=color:#a6e22e>getLogger</span>(ActiveObject.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> Map<span style=color:#f92672>&lt;</span>String, ActiveObject<span style=color:#f92672>&gt;</span> INSTANCES <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ConcurrentHashMap<span style=color:#f92672>&lt;&gt;</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> BlockingQueue<span style=color:#f92672>&lt;</span>Runnable<span style=color:#f92672>&gt;</span> requests;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> String name;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> ExecutorService executorService;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> Thread thread;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> <span style=color:#66d9ef>volatile</span> <span style=color:#66d9ef>boolean</span> isAcceptingRequests <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> <span style=color:#66d9ef>volatile</span> <span style=color:#66d9ef>boolean</span> isProcessingRequests <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> <span style=color:#a6e22e>ActiveObject</span>(String name, <span style=color:#66d9ef>int</span> queueSize, Long sleepMillis) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>name</span> <span style=color:#f92672>=</span> name;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>requests</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> LinkedBlockingQueue<span style=color:#f92672>&lt;&gt;</span>(queueSize);
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>executorService</span> <span style=color:#f92672>=</span> Executors.<span style=color:#a6e22e>newFixedThreadPool</span>(5);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		thread <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Thread(() <span style=color:#f92672>-&gt;</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>while</span> (isProcessingRequests) {
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>					processRequest(requests.<span style=color:#a6e22e>take</span>(), executorService);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>if</span> (sleepMillis <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>						Thread.<span style=color:#a6e22e>sleep</span>(sleepMillis);
</span></span><span style=display:flex><span>					}
</span></span><span style=display:flex><span>				} <span style=color:#66d9ef>catch</span> (InterruptedException e) {
</span></span><span style=display:flex><span>					log.<span style=color:#a6e22e>warn</span>(<span style=color:#e6db74>&#34;Active Object thread interrupted, reason: {}&#34;</span>, e.<span style=color:#a6e22e>getMessage</span>());
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}, name);
</span></span><span style=display:flex><span>		thread.<span style=color:#a6e22e>start</span>();
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>processRequest</span>(Runnable task, ExecutorService executorService) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>			executorService.<span style=color:#a6e22e>submit</span>(task).<span style=color:#a6e22e>get</span>();
</span></span><span style=display:flex><span>		} <span style=color:#66d9ef>catch</span> (Exception e) {
</span></span><span style=display:flex><span>			log.<span style=color:#a6e22e>error</span>(<span style=color:#e6db74>&#34;Error processing request: {}&#34;</span>, e.<span style=color:#a6e22e>getMessage</span>());
</span></span><span style=display:flex><span>			<span style=color:#75715e>// 发送告警信息</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>synchronized</span> ActiveObject <span style=color:#a6e22e>getInstance</span>(String name) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> getInstance(name, 16, <span style=color:#66d9ef>null</span>);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	publicvoid <span style=color:#a6e22e>submit</span>(Runnable task) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> (isAcceptingRequests) {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>				requests.<span style=color:#a6e22e>put</span>(task);
</span></span><span style=display:flex><span>			} <span style=color:#66d9ef>catch</span> (InterruptedException e) {
</span></span><span style=display:flex><span>				log.<span style=color:#a6e22e>error</span>(<span style=color:#e6db74>&#34;Error submitting request: {}&#34;</span>, e.<span style=color:#a6e22e>getMessage</span>());
</span></span><span style=display:flex><span>				<span style=color:#75715e>// 发送告警信息</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>			log.<span style=color:#a6e22e>warn</span>(<span style=color:#e6db74>&#34;Active Object is not accepting requests&#34;</span>);
</span></span><span style=display:flex><span>			<span style=color:#75715e>// 发送告警信息</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>synchronized</span> ActiveObject <span style=color:#a6e22e>getInstance</span>(String name, <span style=color:#66d9ef>int</span> queueSize, Long sleepMillis) {
</span></span><span style=display:flex><span>		ActiveObject instance <span style=color:#f92672>=</span> INSTANCES.<span style=color:#a6e22e>get</span>(name);
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> (instance <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>			instance <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ActiveObject(name, queueSize, sleepMillis);
</span></span><span style=display:flex><span>			INSTANCES.<span style=color:#a6e22e>put</span>(name, instance);
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> instance;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>shutdown</span>() {
</span></span><span style=display:flex><span>		isAcceptingRequests <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>while</span> (<span style=color:#f92672>!</span>requests.<span style=color:#a6e22e>isEmpty</span>()) {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>				Thread.<span style=color:#a6e22e>sleep</span>(100);
</span></span><span style=display:flex><span>			} <span style=color:#66d9ef>catch</span> (InterruptedException e) {
</span></span><span style=display:flex><span>				<span style=color:#75715e>// Ignore exception</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		isProcessingRequests <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>		executorService.<span style=color:#a6e22e>shutdown</span>();
</span></span><span style=display:flex><span>		thread.<span style=color:#a6e22e>interrupt</span>();
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>上面的代码已经很不错了，但还有一些可以进一步优化的地方：</p><ol><li>使用线程池来管理线程，而不是每次创建一个新的线程。这样可以减少线程的创建和销毁的开销，提高代码的性能。</li></ol><ol start=2><li><p>使用 Lambda 表达式简化代码，使代码更加简洁和易于理解。例如，可以将线程中的 while 循环改为 Lambda 表达式，简化代码。</p></li><li><p>使用 CompletableFuture 来实现异步处理，将请求的处理过程和结果的返回分离开来。这样可以提高代码的可读性和可维护性，同时也可以提高代码的性能。</p></li><li><p>使用 ThreadFactory 来命名线程，以便更好地跟踪线程的执行情况以及排查问题。</p></li><li><p>使用 CompletableFuture 的 exceptionally 方法处理异常，以避免在处理请求时出现异常而导致整个线程停止。</p></li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ActiveObject</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> Logger log <span style=color:#f92672>=</span> LoggerFactory.<span style=color:#a6e22e>getLogger</span>(ActiveObject.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> Map<span style=color:#f92672>&lt;</span>String, ActiveObject<span style=color:#f92672>&gt;</span> INSTANCES <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ConcurrentHashMap<span style=color:#f92672>&lt;&gt;</span>();
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> THREAD_POOL_SIZE <span style=color:#f92672>=</span> 5;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> BlockingQueue<span style=color:#f92672>&lt;</span>Runnable<span style=color:#f92672>&gt;</span> requests;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> String name;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> ExecutorService executorService;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> CompletableFuture<span style=color:#f92672>&lt;</span>Void<span style=color:#f92672>&gt;</span> processingFuture;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> <span style=color:#66d9ef>volatile</span> <span style=color:#66d9ef>boolean</span> isAcceptingRequests <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> <span style=color:#a6e22e>ActiveObject</span>(String name, <span style=color:#66d9ef>int</span> queueSize, Long sleepMillis) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>name</span> <span style=color:#f92672>=</span> name;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>requests</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> LinkedBlockingQueue<span style=color:#f92672>&lt;&gt;</span>(queueSize);
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>executorService</span> <span style=color:#f92672>=</span> Executors.<span style=color:#a6e22e>newFixedThreadPool</span>(THREAD_POOL_SIZE, <span style=color:#66d9ef>new</span> ThreadFactory() {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>private</span> AtomicInteger count <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> AtomicInteger(0);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>public</span> Thread <span style=color:#a6e22e>newThread</span>(Runnable r) {
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> Thread(r, <span style=color:#e6db74>&#34;ActiveObject-&#34;</span> <span style=color:#f92672>+</span> name <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;-&#34;</span> <span style=color:#f92672>+</span> count.<span style=color:#a6e22e>getAndIncrement</span>());
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		});
</span></span><span style=display:flex><span>		processingFuture <span style=color:#f92672>=</span> CompletableFuture.<span style=color:#a6e22e>runAsync</span>(() <span style=color:#f92672>-&gt;</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>while</span> (isAcceptingRequests) {
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>					executorService.<span style=color:#a6e22e>execute</span>(requests.<span style=color:#a6e22e>take</span>());
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>if</span> (sleepMillis <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>						Thread.<span style=color:#a6e22e>sleep</span>(sleepMillis);
</span></span><span style=display:flex><span>					}
</span></span><span style=display:flex><span>				} <span style=color:#66d9ef>catch</span> (InterruptedException e) {
</span></span><span style=display:flex><span>					Thread.<span style=color:#a6e22e>currentThread</span>().<span style=color:#a6e22e>interrupt</span>();
</span></span><span style=display:flex><span>					log.<span style=color:#a6e22e>warn</span>(<span style=color:#e6db74>&#34;Active Object thread interrupted, reason: {}&#34;</span>, e.<span style=color:#a6e22e>getMessage</span>());
</span></span><span style=display:flex><span>				} <span style=color:#66d9ef>catch</span> (Exception e) {
</span></span><span style=display:flex><span>					log.<span style=color:#a6e22e>error</span>(<span style=color:#e6db74>&#34;Error processing request: {}&#34;</span>, e.<span style=color:#a6e22e>getMessage</span>());
</span></span><span style=display:flex><span>					<span style=color:#75715e>// 发送告警信息</span>
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}).<span style=color:#a6e22e>exceptionally</span>(e <span style=color:#f92672>-&gt;</span> {
</span></span><span style=display:flex><span>			log.<span style=color:#a6e22e>error</span>(<span style=color:#e6db74>&#34;Exception occurred in ActiveObject thread: {}&#34;</span>, e.<span style=color:#a6e22e>getMessage</span>());
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>		});
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>submit</span>(Runnable task) {
</span></span><span style=display:flex><span>		requests.<span style=color:#a6e22e>offer</span>(task);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>stop</span>() {
</span></span><span style=display:flex><span>		isAcceptingRequests <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>		processingFuture.<span style=color:#a6e22e>cancel</span>(<span style=color:#66d9ef>true</span>);
</span></span><span style=display:flex><span>		executorService.<span style=color:#a6e22e>shutdown</span>();
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>synchronized</span> ActiveObject <span style=color:#a6e22e>getInstance</span>(String name) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> getInstance(name, 16, <span style=color:#66d9ef>null</span>);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>synchronized</span> ActiveObject <span style=color:#a6e22e>getInstance</span>(String name, <span style=color:#66d9ef>int</span> queueSize, Long sleepMillis) {
</span></span><span style=display:flex><span>		ActiveObject instance <span style=color:#f92672>=</span> INSTANCES.<span style=color:#a6e22e>get</span>(name);
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> (instance <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>			instance <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ActiveObject(name, queueSize, sleepMillis);
</span></span><span style=display:flex><span>			INSTANCES.<span style=color:#a6e22e>put</span>(name, instance);
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> instance;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>getName</span>() {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> name;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=总结>总结</h2><p>活动对象模式是一种支持异步处理和事件驱动的设计模式，适用于一些需要高性能、可伸缩和可靠的应用场景。以下是几个适用于活动对象模式的使用场景：</p><ol><li>大规模并发处理：在大规模并发的情况下，使用传统的同步处理方式会导致系统性能下降和响应时间延长。使用活动对象模式可以将并发请求转换成异步事件，通过事件驱动机制实现高性能和可伸缩。</li><li>高吞吐量数据处理：在需要处理大量数据的情况下，使用活动对象模式可以利用多核 CPU 和异步处理技术，提高系统的处理能力和吞吐量。</li><li>异步消息传递：在需要异步处理消息的情况下，使用活动对象模式可以实现异步消息的处理和分发，提高系统的可靠性和可维护性。</li><li>分布式系统：在分布式系统中，使用活动对象模式可以实现异步消息传递和事件驱动，提高系统的可靠性和可伸缩性。同时，活动对象模式还可以通过分布式锁和分布式计算等技术实现分布式并发控制和计算，提高系统的性能和可靠性。</li><li>UI 和后台逻辑分离：在需要将 UI 和后台逻辑分离的情况下，使用活动对象模式可以实现 UI 和后台逻辑的解耦和异步处理，提高系统的可维护性和可扩展性。</li><li>异步 IO 操作：在需要进行异步 IO 操作的情况下，使用活动对象模式可以实现非阻塞 IO 和异步事件处理，提高系统的性能和响应时间。</li></ol><p>总的来说，活动对象模式适用于一些需要异步处理、事件驱动、高性能、可伸缩和可靠的应用场景。通过使用活动对象模式，可以提高系统的性能和可维护性，同时降低系统的复杂度和成本。</p></div><div><div style=font-weight:700>Share this post:</div><a class=social-link-item href="https://twitter.com/intent/tweet?text=Java%e8%ae%be%e8%ae%a1%e6%a8%a1%e5%bc%8f%ef%bc%9aActive%20Object https%3a%2f%2fblog.chensoul.cc%2fposts%2f2023%2f05%2f26%2fjava-design-patterns-active-object%2f" target=_blank rel="noopener noreferrer" title="Click to share on Twitter"><i class="fa-brands fa-square-twitter fa-2xl" style=color:#55acee></i>
</a><a class=social-link-item href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fblog.chensoul.cc%2fposts%2f2023%2f05%2f26%2fjava-design-patterns-active-object%2f&title=Java%e8%ae%be%e8%ae%a1%e6%a8%a1%e5%bc%8f%ef%bc%9aActive%20Object" target=_blank rel="noopener noreferrer" title="Click to share on LinkedIn"><i class="fa-brands fa-linkedin fa-2xl" style=color:#007bb5></i>
</a><a class=social-link-item href="https://telegram.me/share/url?text=Java%e8%ae%be%e8%ae%a1%e6%a8%a1%e5%bc%8f%ef%bc%9aActive%20Object&amp;url=https%3a%2f%2fblog.chensoul.cc%2fposts%2f2023%2f05%2f26%2fjava-design-patterns-active-object%2f" target=_blank rel="noopener noreferrer" title="Click to share on telegram"><i class="fa-brands fa-telegram fa-2xl" style=color:#007bb5></i>
</a><a class=social-link-item href="https://reddit.com/submit?url=https%3a%2f%2fblog.chensoul.cc%2fposts%2f2023%2f05%2f26%2fjava-design-patterns-active-object%2f&title=Java%e8%ae%be%e8%ae%a1%e6%a8%a1%e5%bc%8f%ef%bc%9aActive%20Object" target=_blank rel="noopener noreferrer" title="Click to share on reddit"><i class="fa-brands fa-reddit fa-2xl" style=color:#007bb5></i>
</a><a class=social-link-item href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fblog.chensoul.cc%2fposts%2f2023%2f05%2f26%2fjava-design-patterns-active-object%2f" target=_blank rel="noopener noreferrer" title="Click to share on facebook"><i class="fa-brands fa-facebook fa-2xl" style=color:#007bb5></i>
</a><a class=social-link-item href="https://api.whatsapp.com/send?text=Java%e8%ae%be%e8%ae%a1%e6%a8%a1%e5%bc%8f%ef%bc%9aActive%20Object%20-%20https%3a%2f%2fblog.chensoul.cc%2fposts%2f2023%2f05%2f26%2fjava-design-patterns-active-object%2f" target=_blank rel="noopener noreferrer" title="Click to share on whatsapp"><i class="fa-brands fa-whatsapp fa-2xl" style=color:#007bb5></i></a></div></div></article><nav class="navigation post-navigation" role=navigation><h2 class=screen-reader-text>Post navigation</h2><div class=nav-links><div class=nav-previous><a href=/posts/2023/05/26/consider-implementing-comparable/ rel=next><span class=post-title>《Effective Java 3》笔记14：考虑实现 Comparable 接口</span></a></div><div class=nav-next><a href=/posts/2023/05/25/weekly_review_20/ rel=prev><span class=post-title>周报-20｜自动生成每日早报、周末团建</span></a></div></div></nav><h2>Related content</h2><ul><li><a href=/posts/2023/12/14/all-things-about-microprofile/>All things about MicroProfile</a></li><li><a href=/posts/2023/11/02/jhipster-intro/>JHipster安装和介绍</a></li><li><a href=/posts/2023/10/26/java-design-patterns-circuit-breaker/>Java设计模式：Circuit Breaker</a></li><li><a href=/posts/2023/10/16/java-design-patterns-chain/>Java设计模式：Chain</a></li><li><a href=/posts/2023/10/13/java-design-patterns-callback/>Java设计模式：Callback</a></li><li><a href=/posts/2023/09/25/java-design-patterns-cahcing/>Java设计模式：Caching</a></li><li><a href=/posts/2023/09/22/java-design-patterns-bytecode/>Java设计模式：Bytecode</a></li><li><a href=/posts/2023/09/05/java-design-patterns-builder/>Java设计模式：Builder</a></li><li><a href=/posts/2023/09/05/java-design-patterns-business-delegate/>Java设计模式：Business Delegate</a></li><li><a href=/posts/2023/08/28/java-design-patterns-bridge/>Java设计模式：Bridge</a></li></ul></main></section></div><div id=footer class=footer-wrap><footer id=colophon class="site-footer container clearfix" role=contentinfo><div id=footer-text class=site-info><span class=credit-link><a href=/ target=_blank rel="noopener noreferrer">ChenSoul</a>
Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreferrer">Hugo</a>
<a style=margin-left:20px href=/privacy_policy/ target=_blank rel="noopener noreferrer">Privacy Policy</a></span></div></footer></div></div><script type=text/javascript src=/main.min.js></script></body></html>