<!doctype html><html lang=en-US prefix="og: http://ogp.me/ns#"><head><meta charset=utf-8><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="本文主要介绍 Ambassador 模式，在 Java Design Patterns 网站上有对该模式进行介绍。这里主要是做个笔记，并添加一些扩展，以加深对该设计模式的理解。"><title>Java设计模式：Ambassador | ChenSoul</title>
<link rel=canonical href=https://blog.chensoul.cc/posts/2023/07/06/java-design-patterns-ambassador/><link rel=preconnect href=https://fonts.font.im><link rel=preconnect href=https://fonts.loli.net crossorigin><link href="https://fonts.loli.net/css2?family=Roboto+Slab:wght@400;500;700&display=swap" rel=stylesheet><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://blog.chensoul.cc/raw-images/favicon.jpg"><meta name=twitter:title content="Java设计模式：Ambassador"><meta name=twitter:description content="本文主要介绍 Ambassador 模式，在 Java Design Patterns 网站上有对该模式进行介绍。这里主要是做个笔记，并添加一些扩展，以加深对该设计模式的理解。"><meta property="og:locale" content="en_US"><meta property="og:site_name" content="chensoul"><meta property="og:url" content="https://blog.chensoul.cc/posts/2023/07/06/java-design-patterns-ambassador/"><meta property="og:site_name" content="ChenSoul"><meta property="og:title" content="Java设计模式：Ambassador"><meta property="og:description" content="本文主要介绍 Ambassador 模式，在 Java Design Patterns 网站上有对该模式进行介绍。这里主要是做个笔记，并添加一些扩展，以加深对该设计模式的理解。"><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-07-06T00:00:00+00:00"><meta property="article:modified_time" content="2023-07-06T00:00:00+00:00"><meta property="article:tag" content="Java"><meta property="og:image" content="https://blog.chensoul.cc/raw-images/favicon.jpg"><meta itemprop=name content="Java设计模式：Ambassador"><meta itemprop=description content="本文主要介绍 Ambassador 模式，在 Java Design Patterns 网站上有对该模式进行介绍。这里主要是做个笔记，并添加一些扩展，以加深对该设计模式的理解。"><meta itemprop=datePublished content="2023-07-06T00:00:00+00:00"><meta itemprop=dateModified content="2023-07-06T00:00:00+00:00"><meta itemprop=wordCount content="2875"><meta itemprop=image content="https://blog.chensoul.cc/raw-images/favicon.jpg"><meta itemprop=keywords content="Java"><link rel=stylesheet href=https://cdnjs.loli.net/ajax/libs/font-awesome/6.4.0/css/all.min.css media=all><link rel=stylesheet href=/main.min.css type=text/css media=all><link rel="shortcut icon" href=/favicon.ico type=image/x-icon><script type=application/ld+json>{"@context":"https://schema.org","@graph":[{"@type":"TechArticle","name":"Java设计模式：Ambassador","headline":"Java设计模式：Ambassador","inLanguage":"en-US","url":"https://blog.chensoul.cc/posts/2023/07/06/java-design-patterns-ambassador/","description":"\u003cp\u003e本文主要介绍 Ambassador 模式，在 \u003ca href=\"https://java-design-patterns.com/\" target=\"_blank\"\u003eJava Design Patterns\u003c/a\u003e 网站上有对该模式进行介绍。这里主要是做个笔记，并添加一些扩展，以加深对该设计模式的理解。\u003c/p\u003e","wordCount":"2875","keywords":["java"],"datePublished":"2023-07-06T00:00:00Z","dateModified":"2023-07-06T00:00:00Z","author":{"@type":"Person","name":"chensoul"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.chensoul.cc/posts/2023/07/06/java-design-patterns-ambassador/"},"publisher":{"@type":"Organization","name":"chensoul","url":"https://blog.chensoul.cc/posts/2023/07/06/java-design-patterns-ambassador/"}},{"@context":"https://schema.org","@type":"Organization","name":"chensoul","url":"https://blog.chensoul.cc/","sameAs":["https://twitter.com/","https://github.com/chensoul","https://www.linkedin.com/in/"]}]}</script></head><body class="home blog post-layout-one-column"><button onclick=topFunction() id=scrollTopBtn title="Go to top">
<i class="fa-solid fa-arrow-up"></i></button><div id=header-top class=header-bar-wrap></div><div id=page class=site><a class="skip-link screen-reader-text" href=#content>Skip to content</a><header id=masthead class="site-header clearfix" role=banner><div class="header-main container clearfix"><div id=logo class="site-branding clearfix"><h1 class=site-title><a href=/ title=ChenSoul rel=home>ChenSoul</a></h1><p class=site-description>Java, Spring Boot, Microservice, Cloud, Architecture and DevOps Tutorials</p></div><div class="header-widgets clearfix"><aside id=search-2 class="header-widget widget_search"><form role=search method=get class=search-form onsubmit="return searchSite(event)"><label><span class=screen-reader-text>Search for:</span>
<input type=search class=search-field placeholder="Enter search keyword" name=query id=query title="Enter search keyword">
</label><button type=submit class=search-submit title=Search> <span class=genericon-search></span>
<span class=screen-reader-text>Search</span></button></form></aside></div></div><div id=main-navigation-wrap class=primary-navigation-wrap><nav id=main-navigation class="primary-navigation navigation container clearfix" role=navigation><ul id=menu-home class=main-navigation-menu><li class="menu-item menu-item-type-custom menu-item-object-custom
current-menu-item current_page_item menu-item-home"><a href=/>Home</a></li><li class="menu-item menu-item-type-taxonomy menu-item-object-category"><a href=/categories/spring-boot/>Spring Boot</a></li><li class="menu-item menu-item-type-taxonomy menu-item-object-category"><a href=/categories/architecture/>Architecture</a></li><li class="menu-item menu-item-type-taxonomy menu-item-object-category"><a href=/categories/microservice/>Microservice</a></li><li class="menu-item menu-item-type-taxonomy menu-item-object-category"><a href=/categories/kubernetes/>Kubernetes</a></li><li class="menu-item menu-item-type-taxonomy menu-item-object-category
menu-item-has-children"><a href=/tutorials/>Tutorials</a><ul class=sub-menu><li class="menu-item menu-item-type-taxonomy menu-item-object-category"><a href=/spring-boot-tutorials/>Spring Boot Tutorials</a></li><li class="menu-item menu-item-type-taxonomy menu-item-object-category"><a href=/microservice-tutorials/>Microservice Tutorials</a></li><li class="menu-item menu-item-type-taxonomy menu-item-object-category"><a href=/kubernetes-tutorials/>Kubernetes Tutorials</a></li></ul></li><li class="menu-item menu-item-type-post_type menu-item-object-page"><a href=https://github.com/chensoul target=_blank>About Me</a></li></ul></nav></div></header><div id=content class="site-content container clearfix"><section id=primary class="content-archive content-area post-content-area"><main id=main class=site-main role=main><article class="post type-post"><div class=post-inner-content><header class=entry-header><h2 class=entry-title><a href=https://blog.chensoul.cc/posts/2023/07/06/java-design-patterns-ambassador/ rel=bookmark title=Java设计模式：Ambassador>Java设计模式：Ambassador</a></h2><hr><div class=entry-meta><span class=meta-date><time class="entry-date published" datetime=2023-07-06T00:00:00>2023-07-06
</time></span><span class=meta-author><span class="author vcard">chensoul</span>
</span><span class="tagcloud post-tags"><i class="fa fa-tags"></i>&nbsp;
<a class="tag-cloud-link widget__link widget__link--taglist" href=/tags/java/ title=java>java</a></span></div></header><div class=entry-content><p>本文主要介绍 Ambassador 模式，在 <a href=https://java-design-patterns.com/ target=_blank>Java Design Patterns</a> 网站上有对该模式进行介绍。这里主要是做个笔记，并添加一些扩展，以加深对该设计模式的理解。</p><blockquote><p><a href=https://java-design-patterns.com/ target=_blank>Java Design Patterns</a> 提供了各种 Java 设计模式的介绍、示例代码和用例说明。该网站旨在帮助 Java 开发人员了解和应用各种常见的设计模式，以提高代码的可读性、可维护性和可扩展性。</p><p>Java Design Patterns 网站提供了多种设计模式分类方式，包括创建型模式（Creational Patterns）、结构型模式（Structural Patterns）和行为型模式（Behavioral Patterns），以及其他一些常见的模式。</p><p>对于每个设计模式，该网站提供了详细的介绍、示例代码和用例说明，并且提供了一些常见的使用场景和注意事项。开发人员可以根据自己的需求选择适合自己的设计模式，并且可以参考示例代码和用例说明来理解和应用该模式。</p><p>此外，Java Design Patterns 网站还提供了一些其他资源，如设计模式的 UML 图、设计模式的优缺点、设计模式的比较等。这些资源可以帮助开发人员更好地理解和应用设计模式。</p><p>中文网站：<a href=https://java-design-patterns.com/zh/ target=_blank>https://java-design-patterns.com/zh/</a></p><p>Github 上源码仓库（非官方）：<a href=https://github.com/iluwatar/java-design-patterns target=_blank>https://github.com/iluwatar/java-design-patterns</a></p></blockquote><h2 id=目的>目的</h2><p>在客户端上提供帮助程序服务实例，并从共享资源上转移常用功能。</p><blockquote><p>Ambassador 设计模式的主要目的是将客户端应用程序与远程服务器之间的通信细节隔离开来，从而使客户端应用程序可以专注于自己的业务逻辑，而不必关注网络通信细节和错误处理。</p><p>在传统的客户端应用程序中，通常需要处理大量的网络通信细节和错误处理，这会使代码变得复杂且难以维护。而使用 Ambassador 设计模式可以将这些细节和处理逻辑集中在一个单独的类中，从而使客户端应用程序的代码更加简洁、易于维护和扩展。</p><p>此外，使用 Ambassador 设计模式还可以提高客户端应用程序与远程服务器之间的通信安全性和可靠性。例如，Ambassador 类可以负责统一处理所有的网络通信，从而可以更轻松地实现安全性和可靠性控制。</p></blockquote><h2 id=解释>解释</h2><p>假设有一个旧版的远程服务，该服务提供了许多客户端访问的功能，但由于用户的大量请求，导致连接问题变得普遍。此外，新的请求频率规则需要同时实现延迟检测和客户端日志功能。为了解决这些问题，可以使用 Ambassador 设计模式。</p><p><a href=https://learn.microsoft.com/en-us/azure/architecture/patterns/ambassador target=_blank>微软文档</a> 做了如下阐述</p><blockquote><p>可以将大使服务视为与客户端位于同一位置的进程外代理。 此模式对于以语言不可知的方式减轻常见的客户端连接任务（例如监视，日志记录，路由，安全性（如 TLS）和弹性模式）的工作很有用。 它通常与旧版应用程序或其他难以修改的应用程序一起使用，以扩展其网络功能。 它还可以使专业团队实现这些功能。</p></blockquote><p>在该模式中，可以创建一个 Ambassador 类来充当客户端应用程序和远程服务之间的代理。Ambassador 类负责处理所有的网络通信细节和错误处理，并实现新的请求频率规则，包括延迟检测和客户端日志功能。</p><p>具体来说，Ambassador 类可以实现以下功能：</p><ol><li>延迟检测：在请求到达远程服务之前，Ambassador 类可以检测请求的时间戳，并计算出请求的延迟时间。如果请求的延迟时间超过了预设的阈值，Ambassador 类可以将请求拒绝。</li><li>客户端日志功能：Ambassador 类可以记录请求的时间戳、请求的内容和响应的内容，并将这些信息保存到客户端的日志文件中。这样可以帮助客户端应用程序进行调试和故障排除。</li><li>连接问题处理：Ambassador 类可以监控远程服务的连接状态，并在连接出现问题时进行自动重试。同时，Ambassador 类还可以实现一些优化策略，例如使用连接池等，以提高连接的可靠性和性能。</li></ol><p><strong>程序示例</strong></p><p>有了上面的介绍我们将在这个例子中模仿功能。我们有一个用远程服务实现的接口，同时也是大使服务。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>RemoteServiceInterface</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>long</span> <span style=color:#a6e22e>doRemoteFunction</span>(<span style=color:#66d9ef>int</span> value) <span style=color:#66d9ef>throws</span> Exception;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>表示为单例的远程服务。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>RemoteService</span> <span style=color:#66d9ef>implements</span> RemoteServiceInterface {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> Logger LOGGER <span style=color:#f92672>=</span> LoggerFactory.<span style=color:#a6e22e>getLogger</span>(RemoteService.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> RemoteService service <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>synchronized</span> RemoteService <span style=color:#a6e22e>getRemoteService</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (service <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>            service <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> RemoteService();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> service;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>RemoteService</span>() {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>long</span> <span style=color:#a6e22e>doRemoteFunction</span>(<span style=color:#66d9ef>int</span> value) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>long</span> waitTime <span style=color:#f92672>=</span> (<span style=color:#66d9ef>long</span>) Math.<span style=color:#a6e22e>floor</span>(Math.<span style=color:#a6e22e>random</span>() <span style=color:#f92672>*</span> 1000);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>            sleep(waitTime);
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>catch</span> (InterruptedException e) {
</span></span><span style=display:flex><span>            LOGGER.<span style=color:#a6e22e>error</span>(<span style=color:#e6db74>&#34;Thread sleep interrupted&#34;</span>, e);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> waitTime <span style=color:#f92672>&gt;=</span> 200 <span style=color:#f92672>?</span> value <span style=color:#f92672>*</span> 10 : <span style=color:#f92672>-</span>1;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>服务大使添加了像日志和延迟检测的额外功能</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ServiceAmbassador</span> <span style=color:#66d9ef>implements</span> RemoteServiceInterface {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> Logger LOGGER <span style=color:#f92672>=</span> LoggerFactory.<span style=color:#a6e22e>getLogger</span>(ServiceAmbassador.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> RETRIES <span style=color:#f92672>=</span> 3;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> DELAY_MS <span style=color:#f92672>=</span> 3000;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  ServiceAmbassador() {
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>long</span> <span style=color:#a6e22e>doRemoteFunction</span>(<span style=color:#66d9ef>int</span> value) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> safeCall(value);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>long</span> <span style=color:#a6e22e>checkLatency</span>(<span style=color:#66d9ef>int</span> value) {
</span></span><span style=display:flex><span>    Long startTime <span style=color:#f92672>=</span> System.<span style=color:#a6e22e>currentTimeMillis</span>();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>long</span> result <span style=color:#f92672>=</span> RemoteService.<span style=color:#a6e22e>getRemoteService</span>().<span style=color:#a6e22e>doRemoteFunction</span>(value);
</span></span><span style=display:flex><span>    Long timeTaken <span style=color:#f92672>=</span> System.<span style=color:#a6e22e>currentTimeMillis</span>() <span style=color:#f92672>-</span> startTime;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    LOGGER.<span style=color:#a6e22e>info</span>(<span style=color:#e6db74>&#34;Time taken (ms): &#34;</span> <span style=color:#f92672>+</span> timeTaken);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> result;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>long</span> <span style=color:#a6e22e>safeCall</span>(<span style=color:#66d9ef>int</span> value) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> retries <span style=color:#f92672>=</span> 0;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>long</span> result <span style=color:#f92672>=</span> (<span style=color:#66d9ef>long</span>) FAILURE;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0; i <span style=color:#f92672>&lt;</span> RETRIES; i<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (retries <span style=color:#f92672>&gt;=</span> RETRIES) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> FAILURE;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> ((result <span style=color:#f92672>=</span> checkLatency(value)) <span style=color:#f92672>==</span> FAILURE) {
</span></span><span style=display:flex><span>        LOGGER.<span style=color:#a6e22e>info</span>(<span style=color:#e6db74>&#34;Failed to reach remote: (&#34;</span> <span style=color:#f92672>+</span> (i <span style=color:#f92672>+</span> 1) <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;)&#34;</span>);
</span></span><span style=display:flex><span>        retries<span style=color:#f92672>++</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>          sleep(DELAY_MS);
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>catch</span> (InterruptedException e) {
</span></span><span style=display:flex><span>          LOGGER.<span style=color:#a6e22e>error</span>(<span style=color:#e6db74>&#34;Thread sleep state interrupted&#34;</span>, e);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> result;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>客户端具有用于与远程服务进行交互的本地服务大使：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Client</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> Logger LOGGER <span style=color:#f92672>=</span> LoggerFactory.<span style=color:#a6e22e>getLogger</span>(Client.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> ServiceAmbassador serviceAmbassador <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ServiceAmbassador();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>long</span> <span style=color:#a6e22e>useService</span>(<span style=color:#66d9ef>int</span> value) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>long</span> result <span style=color:#f92672>=</span> serviceAmbassador.<span style=color:#a6e22e>doRemoteFunction</span>(value);
</span></span><span style=display:flex><span>    LOGGER.<span style=color:#a6e22e>info</span>(<span style=color:#e6db74>&#34;Service result: &#34;</span> <span style=color:#f92672>+</span> result);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> result;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>这是两个使用该服务的客户端。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>App</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span>(String<span style=color:#f92672>[]</span> args) {
</span></span><span style=display:flex><span>    Client host1 <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Client();
</span></span><span style=display:flex><span>    Client host2 <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Client();
</span></span><span style=display:flex><span>    host1.<span style=color:#a6e22e>useService</span>(12);
</span></span><span style=display:flex><span>    host2.<span style=color:#a6e22e>useService</span>(73);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Here&rsquo;s the output for running the example:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>Time <span style=color:#a6e22e>taken</span> (ms): 111
</span></span><span style=display:flex><span>Service result: 120
</span></span><span style=display:flex><span>Time <span style=color:#a6e22e>taken</span> (ms): 931
</span></span><span style=display:flex><span>Failed to reach remote: (1)
</span></span><span style=display:flex><span>Time <span style=color:#a6e22e>taken</span> (ms): 665
</span></span><span style=display:flex><span>Failed to reach remote: (2)
</span></span><span style=display:flex><span>Time <span style=color:#a6e22e>taken</span> (ms): 538
</span></span><span style=display:flex><span>Failed to reach remote: (3)
</span></span><span style=display:flex><span>Service result: <span style=color:#f92672>-</span>1
</span></span></code></pre></div><h2 id=类图>类图</h2><p><img src=https://java-design-patterns.com/assets/ambassador.urm-75077e88.png alt="alt text"></p><h2 id=适用场景>适用场景</h2><p>Ambassador 设计模式适用于以下场景：</p><ol><li>当客户端应用程序需要与远程服务器进行通信，并且需要处理与网络通信相关的所有细节时。</li><li>当客户端应用程序需要隔离与远程服务器的通信细节时，以便更好地专注于自己的业务逻辑。</li><li>当客户端应用程序需要处理与远程服务器的通信错误时。</li><li>当客户端应用程序需要实现新的请求频率规则，例如延迟检测和客户端日志功能等。</li><li>当客户端应用程序需要在不更改旧版远程服务代码的情况下，对远程服务进行定制化扩展时。</li></ol><h2 id=典型用例>典型用例</h2><p>Ambassador 设计模式可以用于许多场景，以下是其中的一些典型用例：</p><h3 id=限流和熔断保护>限流和熔断保护</h3><p>在分布式系统中，服务之间的调用是通过网络进行的，网络延迟、故障和不可用性是常见的问题。当一个服务被频繁调用时，可能会导致其过载或崩溃，从而影响整个系统的稳定性和可用性。使用 Ambassador 设计模式可以实现对服务的请求流量和执行频率进行限制，同时也可以实现熔断保护，当一个服务出现故障或不可用时，自动切换到备用服务。</p><h4 id=限流>限流</h4><p>当使用 Ambassador 设计模式时，可以在 Ambassador 类中实现新的请求频率规则。以下是一个简单的例子，说明如何使用 Ambassador 设计模式来实现请求频率规则：</p><p>假设有一个客户端应用程序需要向远程服务器发送请求，并且需要实现以下请求频率规则：每个客户端在 10 秒钟内只能发送 10 个请求。如果客户端发送的请求超过了这个限制，服务器将返回 429 Too Many Requests 错误。</p><p>为了实现这个规则，可以创建一个 Ambassador 类来充当客户端应用程序和远程服务器之间的代理。在 Ambassador 类中，可以使用计数器和定时器来实现请求频率控制逻辑。</p><p>具体来说，Ambassador 类可以实现以下功能：</p><ol><li>定义计数器和定时器：在 Ambassador 类的构造函数中，可以定义一个计数器和一个定时器。计数器用于记录客户端发送的请求次数，定时器用于在每个 10 秒钟后重置计数器的值。</li><li>处理请求：在 Ambassador 类的处理请求方法中，可以首先检查计数器的值是否超过了限制。如果超过了限制，则返回 429 Too Many Requests 错误；否则，将请求发送到远程服务器，并将计数器的值增加 1。</li><li>处理定时器：在 Ambassador 类中，可以使用定时器来定期重置计数器的值。当定时器触发时，将计数器的值设置为 0。</li></ol><p>以下是一个基于 Java 8 的 Ambassador 设计模式的示例代码，使用了 Java 8 中的 HttpClient 类来发送 HTTP 请求：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>import</span> java.time.Instant;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.util.concurrent.Executors;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.util.concurrent.ScheduledExecutorService;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.util.concurrent.TimeUnit;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.util.concurrent.atomic.LongAdder;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Ambassador</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> LongAdder counter <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> LongAdder();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> ScheduledExecutorService scheduler <span style=color:#f92672>=</span> Executors.<span style=color:#a6e22e>newSingleThreadScheduledExecutor</span>();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Instant lastResetTime <span style=color:#f92672>=</span> Instant.<span style=color:#a6e22e>now</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>handleRequest</span>(String url) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 检查计数器是否超过了限制</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (counter.<span style=color:#a6e22e>incrementAndGet</span>() <span style=color:#f92672>&gt;</span> 10) {
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 返回“Too Many Requests”错误</span>
</span></span><span style=display:flex><span>            counter.<span style=color:#a6e22e>decrementAndGet</span>();
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;429 Too Many Requests&#34;</span>;
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 发送请求到远程服务器</span>
</span></span><span style=display:flex><span>            String response <span style=color:#f92672>=</span> sendRequest(url);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 检查是否需要重置计数器</span>
</span></span><span style=display:flex><span>            Instant currentTime <span style=color:#f92672>=</span> Instant.<span style=color:#a6e22e>now</span>();
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (currentTime.<span style=color:#a6e22e>getEpochSecond</span>() <span style=color:#f92672>-</span> lastResetTime.<span style=color:#a6e22e>getEpochSecond</span>() <span style=color:#f92672>&gt;=</span> 10) {
</span></span><span style=display:flex><span>                counter.<span style=color:#a6e22e>reset</span>();
</span></span><span style=display:flex><span>                lastResetTime <span style=color:#f92672>=</span> currentTime;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 返回响应结果</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> response;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String <span style=color:#a6e22e>sendRequest</span>(String url) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 发送 HTTP GET 请求并返回响应结果</span>
</span></span><span style=display:flex><span>        HttpClient client <span style=color:#f92672>=</span> HttpClient.<span style=color:#a6e22e>newHttpClient</span>();
</span></span><span style=display:flex><span>        HttpRequest request <span style=color:#f92672>=</span> HttpRequest.<span style=color:#a6e22e>newBuilder</span>()
</span></span><span style=display:flex><span>                .<span style=color:#a6e22e>uri</span>(URI.<span style=color:#a6e22e>create</span>(url))
</span></span><span style=display:flex><span>                .<span style=color:#a6e22e>GET</span>()
</span></span><span style=display:flex><span>                .<span style=color:#a6e22e>build</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>            HttpResponse<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span> response <span style=color:#f92672>=</span> client.<span style=color:#a6e22e>send</span>(request, HttpResponse.<span style=color:#a6e22e>BodyHandlers</span>.<span style=color:#a6e22e>ofString</span>());
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> response.<span style=color:#a6e22e>body</span>();
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>catch</span> (IOException <span style=color:#f92672>|</span> InterruptedException e) {
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 处理请求异常</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;500 Internal Server Error&#34;</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>Ambassador</span>() {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 定时重置计数器</span>
</span></span><span style=display:flex><span>        scheduler.<span style=color:#a6e22e>scheduleAtFixedRate</span>(() <span style=color:#f92672>-&gt;</span> {
</span></span><span style=display:flex><span>            counter.<span style=color:#a6e22e>reset</span>();
</span></span><span style=display:flex><span>            lastResetTime <span style=color:#f92672>=</span> Instant.<span style=color:#a6e22e>now</span>();
</span></span><span style=display:flex><span>        }, 10, 10, TimeUnit.<span style=color:#a6e22e>SECONDS</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>shutdown</span>() {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 关闭定时器</span>
</span></span><span style=display:flex><span>        scheduler.<span style=color:#a6e22e>shutdown</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>在上述代码中，Ambassador 类使用了 LongAdder 类型的计数器和 ScheduledExecutorService 类型的定时器，并实现了处理请求的方法 handleRequest。当客户端调用 handleRequest 方法时，Ambassador 类会检查计数器的值是否超过了限制。如果超过了限制，则返回 429 Too Many Requests 错误；否则，将请求发送到远程服务器，并将计数器的值增加 1。同时，Ambassador 类还会使用 ScheduledExecutorService 来定期重置计数器的值。</p><h4 id=熔断>熔断</h4><p>Ambassador 设计模式可以使用熔断模式来保护服务免受故障或不可用性的影响。熔断模式是一种防止故障扩散的机制，当服务出现故障或不可用时，熔断器会自动切换到备用服务，并在一段时间内停止发送请求。如果备用服务也出现故障或不可用，熔断器会重新启动并继续发送请求。以下是一个使用 Ambassador 设计模式实现熔断的示例代码：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>import</span> java.util.concurrent.*;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.util.concurrent.atomic.AtomicInteger;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.util.logging.Level;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.util.logging.Logger;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Ambassador</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> AtomicInteger failureCount <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> AtomicInteger(0);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> AtomicBoolean circuitBreaker <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> AtomicBoolean(<span style=color:#66d9ef>false</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> Service primaryService;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> Service backupService;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> failureThreshold;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> timeout;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> ExecutorService executor;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> Logger logger;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>Ambassador</span>(Service primaryService, Service backupService, <span style=color:#66d9ef>int</span> failureThreshold, <span style=color:#66d9ef>int</span> timeout, <span style=color:#66d9ef>int</span> maxConcurrentRequests) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>primaryService</span> <span style=color:#f92672>=</span> primaryService;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>backupService</span> <span style=color:#f92672>=</span> backupService;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>failureThreshold</span> <span style=color:#f92672>=</span> failureThreshold;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>timeout</span> <span style=color:#f92672>=</span> timeout;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>executor</span> <span style=color:#f92672>=</span> Executors.<span style=color:#a6e22e>newFixedThreadPool</span>(maxConcurrentRequests);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>logger</span> <span style=color:#f92672>=</span> Logger.<span style=color:#a6e22e>getLogger</span>(Ambassador.<span style=color:#a6e22e>class</span>.<span style=color:#a6e22e>getName</span>());
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>handleRequest</span>(String request) <span style=color:#66d9ef>throws</span> TimeoutException {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 检查熔断器状态</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (circuitBreaker.<span style=color:#a6e22e>get</span>()) {
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 返回备用服务的响应</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> backupService.<span style=color:#a6e22e>process</span>(request);
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>                <span style=color:#75715e>// 创建 Callable 对象，并设置超时时间</span>
</span></span><span style=display:flex><span>                Callable<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span> task <span style=color:#f92672>=</span> () <span style=color:#f92672>-&gt;</span> primaryService.<span style=color:#a6e22e>process</span>(request);
</span></span><span style=display:flex><span>                Future<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span> future <span style=color:#f92672>=</span> executor.<span style=color:#a6e22e>submit</span>(task);
</span></span><span style=display:flex><span>                String response <span style=color:#f92672>=</span> future.<span style=color:#a6e22e>get</span>(timeout, TimeUnit.<span style=color:#a6e22e>MILLISECONDS</span>);
</span></span><span style=display:flex><span>                <span style=color:#75715e>// 重置故障计数器</span>
</span></span><span style=display:flex><span>                failureCount.<span style=color:#a6e22e>set</span>(0);
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> response;
</span></span><span style=display:flex><span>            } <span style=color:#66d9ef>catch</span> (InterruptedException <span style=color:#f92672>|</span> ExecutionException e) {
</span></span><span style=display:flex><span>                <span style=color:#75715e>// 处理请求异常</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// 增加故障计数器</span>
</span></span><span style=display:flex><span>                failureCount.<span style=color:#a6e22e>incrementAndGet</span>();
</span></span><span style=display:flex><span>                <span style=color:#75715e>// 检查故障计数器是否超过阈值</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> (failureCount.<span style=color:#a6e22e>get</span>() <span style=color:#f92672>&gt;=</span> failureThreshold) {
</span></span><span style=display:flex><span>                    <span style=color:#75715e>// 启动熔断器</span>
</span></span><span style=display:flex><span>                    circuitBreaker.<span style=color:#a6e22e>set</span>(<span style=color:#66d9ef>true</span>);
</span></span><span style=display:flex><span>                    logger.<span style=color:#a6e22e>log</span>(Level.<span style=color:#a6e22e>WARNING</span>, <span style=color:#e6db74>&#34;Circuit breaker is tripped, switching to backup service&#34;</span>);
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>                <span style=color:#75715e>// 返回备用服务的响应</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> backupService.<span style=color:#a6e22e>process</span>(request);
</span></span><span style=display:flex><span>            } <span style=color:#66d9ef>catch</span> (TimeoutException e) {
</span></span><span style=display:flex><span>                <span style=color:#75715e>// 处理请求超时异常</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> TimeoutException(<span style=color:#e6db74>&#34;Request timed out&#34;</span>);
</span></span><span style=display:flex><span>            } <span style=color:#66d9ef>finally</span> {
</span></span><span style=display:flex><span>                <span style=color:#75715e>// 检查熔断器状态</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> (circuitBreaker.<span style=color:#a6e22e>get</span>()) {
</span></span><span style=display:flex><span>                    <span style=color:#75715e>// 创建定时任务，定时重置熔断器状态</span>
</span></span><span style=display:flex><span>                    ScheduledExecutorService scheduler <span style=color:#f92672>=</span> Executors.<span style=color:#a6e22e>newSingleThreadScheduledExecutor</span>();
</span></span><span style=display:flex><span>                    scheduler.<span style=color:#a6e22e>schedule</span>(() <span style=color:#f92672>-&gt;</span> {
</span></span><span style=display:flex><span>                        <span style=color:#75715e>// 重置故障计数器和熔断器状态</span>
</span></span><span style=display:flex><span>                        failureCount.<span style=color:#a6e22e>set</span>(0);
</span></span><span style=display:flex><span>                        circuitBreaker.<span style=color:#a6e22e>set</span>(<span style=color:#66d9ef>false</span>);
</span></span><span style=display:flex><span>                        logger.<span style=color:#a6e22e>log</span>(Level.<span style=color:#a6e22e>INFO</span>, <span style=color:#e6db74>&#34;Circuit breaker is reset, switching back to primary service&#34;</span>);
</span></span><span style=display:flex><span>                        <span style=color:#75715e>// 关闭定时任务调度器</span>
</span></span><span style=display:flex><span>                        scheduler.<span style=color:#a6e22e>shutdown</span>();
</span></span><span style=display:flex><span>                    }, timeout, TimeUnit.<span style=color:#a6e22e>MILLISECONDS</span>);
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>需要注意的是，在实际应用中，我们需要根据业务需求和系统负载来设置故障计数器的阈值和熔断器的停止时间。如果故障计数器的值超过了阈值，熔断器会启动，并在一定时间内停止发送请求。在熔断器停止期间，Ambassador 类会将所有请求转发到备用服务。当熔断器停止时间到达后，Ambassador 类会重新启动熔断器，并将请求转发到主服务进行处理。同时，我们还需要考虑并发请求的数量和请求的响应时间，以便更好地保证系统的稳定性和性能。</p><h3 id=安全过滤器>安全过滤器</h3><p>在 Web 应用程序中，安全过滤器通常用于检查输入数据的合法性和防止攻击，如 SQL 注入、跨站脚本攻击等。使用 Ambassador 设计模式可以将安全过滤器部署在应用程序的前端，检查所有的输入数据，防止攻击和恶意行为。</p><p>下面是一个简单的示例，演示如何使用 Ambassador 设计模式来实现安全过滤器：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>import</span> java.util.regex.Pattern;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SecurityFilter</span> <span style=color:#66d9ef>implements</span> Service {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> Service service;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>SecurityFilter</span>(Service service) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>service</span> <span style=color:#f92672>=</span> service;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>process</span>(String request) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 检查输入数据，防止攻击和恶意行为</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>isValid(request)) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalArgumentException(<span style=color:#e6db74>&#34;Invalid request&#34;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 调用服务处理请求</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> service.<span style=color:#a6e22e>process</span>(request);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>isValid</span>(String request) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 检查输入数据是否包含恶意代码</span>
</span></span><span style=display:flex><span>        Pattern pattern <span style=color:#f92672>=</span> Pattern.<span style=color:#a6e22e>compile</span>(<span style=color:#e6db74>&#34;&lt;script&gt;(.*?)&lt;/script&gt;&#34;</span>, Pattern.<span style=color:#a6e22e>CASE_INSENSITIVE</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#f92672>!</span>pattern.<span style=color:#a6e22e>matcher</span>(request).<span style=color:#a6e22e>find</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>在上述代码中，我们创建了一个 SecurityFilter 类，实现了 Service 接口，并在构造函数中传入了一个服务对象。在 process 方法中，我们首先检查输入数据，防止攻击和恶意行为，然后调用服务处理请求。</p><p>在 isValid 方法中，我们使用正则表达式检查输入数据是否包含恶意代码。在这个例子中，我们检查输入数据中是否包含 <code>&lt;script></code> 和 <code>&lt;/script></code> 标签，如果包含则认为是恶意代码。</p><p>在实际应用中，我们可以根据具体的业务需求和安全策略，设计更加复杂和完善的安全过滤器。同时，我们还可以使用其他的设计模式和技术，如拦截器、过滤器链、黑白名单、加密算法等，来提高应用程序的安全性和可靠性。</p><p>以下是更进一步优化后的 SecurityFilter 类示例代码，其中使用了过滤器链和黑白名单来实现更加灵活和可配置的安全过滤器，同时增加了日志记录和异常处理，以便更好地监控和调试系统：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>import</span> java.util.ArrayList;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.util.List;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.util.regex.Pattern;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.util.logging.Level;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.util.logging.Logger;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SecurityFilter</span> <span style=color:#66d9ef>implements</span> Service {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> Service service;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> List<span style=color:#f92672>&lt;</span>Filter<span style=color:#f92672>&gt;</span> filters;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> List<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span> whiteList;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> List<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span> blackList;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> Logger logger <span style=color:#f92672>=</span> Logger.<span style=color:#a6e22e>getLogger</span>(SecurityFilter.<span style=color:#a6e22e>class</span>.<span style=color:#a6e22e>getName</span>());
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>SecurityFilter</span>(Service service) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>service</span> <span style=color:#f92672>=</span> service;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>filters</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ArrayList<span style=color:#f92672>&lt;&gt;</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>whiteList</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ArrayList<span style=color:#f92672>&lt;&gt;</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>blackList</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ArrayList<span style=color:#f92672>&lt;&gt;</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>addFilter</span>(Filter filter) {
</span></span><span style=display:flex><span>        filters.<span style=color:#a6e22e>add</span>(filter);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>addWhiteList</span>(String pattern) {
</span></span><span style=display:flex><span>        whiteList.<span style=color:#a6e22e>add</span>(pattern);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>addBlackList</span>(String pattern) {
</span></span><span style=display:flex><span>        blackList.<span style=color:#a6e22e>add</span>(pattern);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>process</span>(String request) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 检查白名单</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>isAllowed(request, whiteList)) {
</span></span><span style=display:flex><span>            logger.<span style=color:#a6e22e>log</span>(Level.<span style=color:#a6e22e>WARNING</span>, <span style=color:#e6db74>&#34;Request not allowed: &#34;</span> <span style=color:#f92672>+</span> request);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalArgumentException(<span style=color:#e6db74>&#34;Request not allowed&#34;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 检查黑名单</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (isBlocked(request, blackList)) {
</span></span><span style=display:flex><span>            logger.<span style=color:#a6e22e>log</span>(Level.<span style=color:#a6e22e>WARNING</span>, <span style=color:#e6db74>&#34;Request blocked: &#34;</span> <span style=color:#f92672>+</span> request);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalArgumentException(<span style=color:#e6db74>&#34;Request blocked&#34;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 执行过滤器链</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> (Filter filter : filters) {
</span></span><span style=display:flex><span>            request <span style=color:#f92672>=</span> filter.<span style=color:#a6e22e>doFilter</span>(request);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 调用服务处理请求</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> service.<span style=color:#a6e22e>process</span>(request);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>isAllowed</span>(String request, List<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span> patterns) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 检查请求是否在白名单中</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> patterns.<span style=color:#a6e22e>stream</span>().<span style=color:#a6e22e>anyMatch</span>(pattern <span style=color:#f92672>-&gt;</span> Pattern.<span style=color:#a6e22e>matches</span>(pattern, request));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>isBlocked</span>(String request, List<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span> patterns) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 检查请求是否在黑名单中</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> patterns.<span style=color:#a6e22e>stream</span>().<span style=color:#a6e22e>anyMatch</span>(pattern <span style=color:#f92672>-&gt;</span> Pattern.<span style=color:#a6e22e>matches</span>(pattern, request));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>Filter</span> {
</span></span><span style=display:flex><span>        String <span style=color:#a6e22e>doFilter</span>(String request);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=负载均衡>负载均衡</h3><p>在分布式系统中，负载均衡通常用于将请求分发到多个服务器上，以实现高可用性和容错性。使用 Ambassador 设计模式可以实现负载均衡，将请求分发到多个服务实例上，从而提高系统的可用性和性能。</p><p>下面是一个简单的示例，演示如何使用 Ambassador 设计模式来实现负载均衡：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>import</span> java.util.List;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.util.concurrent.ThreadLocalRandom;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>LoadBalancer</span> <span style=color:#66d9ef>implements</span> Service {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> List<span style=color:#f92672>&lt;</span>Service<span style=color:#f92672>&gt;</span> services;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> LoadBalancingStrategy strategy;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>LoadBalancer</span>(List<span style=color:#f92672>&lt;</span>Service<span style=color:#f92672>&gt;</span> services, LoadBalancingStrategy strategy) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>services</span> <span style=color:#f92672>=</span> services;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>strategy</span> <span style=color:#f92672>=</span> strategy;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>process</span>(String request) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 根据负载均衡策略选择服务实例</span>
</span></span><span style=display:flex><span>        Service service <span style=color:#f92672>=</span> strategy.<span style=color:#a6e22e>select</span>(services);
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 调用选择的服务处理请求</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> service.<span style=color:#a6e22e>process</span>(request);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>LoadBalancingStrategy</span> {
</span></span><span style=display:flex><span>        Service <span style=color:#a6e22e>select</span>(List<span style=color:#f92672>&lt;</span>Service<span style=color:#f92672>&gt;</span> services);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>RandomStrategy</span> <span style=color:#66d9ef>implements</span> LoadBalancingStrategy {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> Service <span style=color:#a6e22e>select</span>(List<span style=color:#f92672>&lt;</span>Service<span style=color:#f92672>&gt;</span> services) {
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 随机选择一个服务实例</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>int</span> index <span style=color:#f92672>=</span> ThreadLocalRandom.<span style=color:#a6e22e>current</span>().<span style=color:#a6e22e>nextInt</span>(services.<span style=color:#a6e22e>size</span>());
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> services.<span style=color:#a6e22e>get</span>(index);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>RoundRobinStrategy</span> <span style=color:#66d9ef>implements</span> LoadBalancingStrategy {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>int</span> index <span style=color:#f92672>=</span> 0;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> Service <span style=color:#a6e22e>select</span>(List<span style=color:#f92672>&lt;</span>Service<span style=color:#f92672>&gt;</span> services) {
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 轮询选择服务实例</span>
</span></span><span style=display:flex><span>            Service service <span style=color:#f92672>=</span> services.<span style=color:#a6e22e>get</span>(index);
</span></span><span style=display:flex><span>            index <span style=color:#f92672>=</span> (index <span style=color:#f92672>+</span> 1) <span style=color:#f92672>%</span> services.<span style=color:#a6e22e>size</span>();
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> service;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>在上述代码中，我们创建了一个 LoadBalancer 类，实现了 Service 接口，并在构造函数中传入了一个服务列表和一个负载均衡策略。在 process 方法中，我们根据负载均衡策略选择一个服务实例，然后调用选择的服务处理请求。</p><p>在 LoadBalancingStrategy 接口中，我们定义了一个 select 方法，用于选择服务实例。在 RandomStrategy 类中，我们使用 ThreadLocalRandom 来随机选择一个服务实例。在 RoundRobinStrategy 类中，我们使用轮询算法来选择服务实例。</p><p>在实际应用中，我们可以根据具体的业务需求和性能指标，选择合适的负载均衡策略和算法，如加权轮询、最少连接数、哈希算法等，来实现更加高效和灵活的负载均衡。同时，我们还可以使用其他的设计模式和技术，如缓存、异步处理、分布式锁等，来进一步提高系统的可用性和性能。需要注意的是，在设计负载均衡器时，我们需要根据实际情况和负载均衡算法的特点，合理地分配服务实例和请求，避免出现负载不均衡或性能瓶颈的问题。</p><p>以下是经过优化后的负载均衡器的代码：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>import</span> java.util.ArrayList;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.util.List;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.util.concurrent.ConcurrentHashMap;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.util.concurrent.ThreadLocalRandom;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.util.concurrent.atomic.AtomicInteger;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.util.function.Function;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>LoadBalancer</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> List<span style=color:#f92672>&lt;</span>Service<span style=color:#f92672>&gt;</span> services;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> LoadBalancingStrategy strategy;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> ConcurrentHashMap<span style=color:#f92672>&lt;</span>Service, Integer<span style=color:#f92672>&gt;</span> weights <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ConcurrentHashMap<span style=color:#f92672>&lt;&gt;</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>LoadBalancer</span>(List<span style=color:#f92672>&lt;</span>Service<span style=color:#f92672>&gt;</span> services, LoadBalancingStrategy strategy) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>services</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ArrayList<span style=color:#f92672>&lt;&gt;</span>(services);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>strategy</span> <span style=color:#f92672>=</span> strategy;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> (Service service : services) {
</span></span><span style=display:flex><span>            weights.<span style=color:#a6e22e>put</span>(service, 1);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Service <span style=color:#a6e22e>getService</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> strategy.<span style=color:#a6e22e>select</span>(services, weights);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setWeight</span>(Service service, <span style=color:#66d9ef>int</span> weight) {
</span></span><span style=display:flex><span>        weights.<span style=color:#a6e22e>put</span>(service, weight);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> LoadBalancer <span style=color:#a6e22e>create</span>(List<span style=color:#f92672>&lt;</span>Service<span style=color:#f92672>&gt;</span> services, LoadBalancingStrategy strategy) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> LoadBalancer(services, strategy);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> LoadBalancer <span style=color:#a6e22e>createWithRoundRobin</span>(List<span style=color:#f92672>&lt;</span>Service<span style=color:#f92672>&gt;</span> services) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> LoadBalancer(services, LoadBalancingStrategy.<span style=color:#a6e22e>ROUND_ROBIN</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> LoadBalancer <span style=color:#a6e22e>createWithRandom</span>(List<span style=color:#f92672>&lt;</span>Service<span style=color:#f92672>&gt;</span> services) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> LoadBalancer(services, LoadBalancingStrategy.<span style=color:#a6e22e>RANDOM</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>enum</span> LoadBalancingStrategy {
</span></span><span style=display:flex><span>        RANDOM(services <span style=color:#f92672>-&gt;</span> services.<span style=color:#a6e22e>get</span>(ThreadLocalRandom.<span style=color:#a6e22e>current</span>().<span style=color:#a6e22e>nextInt</span>(services.<span style=color:#a6e22e>size</span>()))),
</span></span><span style=display:flex><span>        ROUND_ROBIN(services <span style=color:#f92672>-&gt;</span> {
</span></span><span style=display:flex><span>            AtomicInteger index <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> AtomicInteger(0);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> services.<span style=color:#a6e22e>get</span>(index.<span style=color:#a6e22e>getAndIncrement</span>() <span style=color:#f92672>%</span> services.<span style=color:#a6e22e>size</span>());
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> Function<span style=color:#f92672>&lt;</span>List<span style=color:#f92672>&lt;</span>Service<span style=color:#f92672>&gt;</span>, Service<span style=color:#f92672>&gt;</span> selector;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        LoadBalancingStrategy(Function<span style=color:#f92672>&lt;</span>List<span style=color:#f92672>&lt;</span>Service<span style=color:#f92672>&gt;</span>, Service<span style=color:#f92672>&gt;</span> selector) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>selector</span> <span style=color:#f92672>=</span> selector;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> Service <span style=color:#a6e22e>select</span>(List<span style=color:#f92672>&lt;</span>Service<span style=color:#f92672>&gt;</span> services, ConcurrentHashMap<span style=color:#f92672>&lt;</span>Service, Integer<span style=color:#f92672>&gt;</span> weights) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (services <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>||</span> services.<span style=color:#a6e22e>isEmpty</span>()) {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalArgumentException(<span style=color:#e6db74>&#34;Services cannot be empty&#34;</span>);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (services.<span style=color:#a6e22e>size</span>() <span style=color:#f92672>==</span> 1) {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> services.<span style=color:#a6e22e>get</span>(0);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            List<span style=color:#f92672>&lt;</span>Service<span style=color:#f92672>&gt;</span> candidates <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ArrayList<span style=color:#f92672>&lt;&gt;</span>(services.<span style=color:#a6e22e>size</span>() <span style=color:#f92672>*</span> 100);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span> (Service service : services) {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>int</span> weight <span style=color:#f92672>=</span> weights.<span style=color:#a6e22e>getOrDefault</span>(service, 1);
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0; i <span style=color:#f92672>&lt;</span> weight; i<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>                    candidates.<span style=color:#a6e22e>add</span>(service);
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> selector.<span style=color:#a6e22e>apply</span>(candidates);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>在上述代码中，我们进行了以下优化：</p><ol><li>使用了 ConcurrentHashMap 来代替 HashMap，确保在并发环境下的线程安全性。</li><li>使用了枚举类型来代替字符串常量，提高代码的可读性和安全性。</li><li>使用了 Lambda 表达式和方法引用来简化负载均衡策略的实现。</li><li>使用了静态工厂方法来创建负载均衡器对象，提高代码的可读性和灵活性。</li><li>重构了 select 方法，将其实现逻辑从 LoadBalancer 类中抽离出来，并优化了权重的处理逻辑。</li></ol><h3 id=缓存>缓存</h3><p>缓存可以提高应用程序的性能和响应速度，减少对数据库等后端资源的访问。使用 Ambassador 设计模式可以将缓存部署在应用程序的前端，将请求转发给缓存服务器进行处理，减少对后端资源的访问，提高系统的性能和响应速度。</p><p>以下是一个使用 Java 实现的简单示例，演示了如何使用 Ambassador 设计模式将请求转发给缓存服务器：</p><p>假设我们有一个简单的电子商务应用程序，用户可以浏览商品、下单、支付等操作。为了提高系统的性能和响应速度，我们可以在应用程序的前端部署一个缓存服务器，并使用 Ambassador 设计模式将请求转发给缓存服务器进行处理。在这个应用程序中，我们假设有一个名为 <code>ProductService</code> 的服务，用于获取商品信息。我们可以在应用程序的前端部署一个缓存服务器，并使用 Ambassador 设计模式将请求转发给缓存服务器。</p><p>首先，我们需要定义一个 <code>ProductService</code> 接口，用于获取商品信息：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>ProductService</span> {
</span></span><span style=display:flex><span>    Product <span style=color:#a6e22e>getProductById</span>(String id);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>接下来，我们定义一个 <code>ProductServiceImpl</code> 类，实现 <code>ProductService</code> 接口，并用于从后端数据库获取商品信息：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ProductServiceImpl</span> <span style=color:#66d9ef>implements</span> ProductService {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Product <span style=color:#a6e22e>getProductById</span>(String id) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 从后端数据库获取商品信息</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> Product(id, <span style=color:#e6db74>&#34;Product &#34;</span> <span style=color:#f92672>+</span> id);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>然后，我们定义一个 <code>ProductCache</code> 类，用于缓存商品信息：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ProductCache</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> Map<span style=color:#f92672>&lt;</span>String, Product<span style=color:#f92672>&gt;</span> cache <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HashMap<span style=color:#f92672>&lt;&gt;</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Product <span style=color:#a6e22e>getProductById</span>(String id) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> cache.<span style=color:#a6e22e>get</span>(id);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>putProduct</span>(Product product) {
</span></span><span style=display:flex><span>        cache.<span style=color:#a6e22e>put</span>(product.<span style=color:#a6e22e>getId</span>(), product);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>接下来，我们定义一个 <code>ProductCacheService</code> 类，实现 <code>ProductService</code> 接口，并用于从缓存服务器获取商品信息。如果缓存服务器中没有所需的数据，那么就将请求转发给后端服务进行处理，并将处理结果缓存起来：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ProductCacheService</span> <span style=color:#66d9ef>implements</span> ProductService {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> ProductService backendService;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> ProductCache cache;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>ProductCacheService</span>(ProductService backendService, ProductCache cache) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>backendService</span> <span style=color:#f92672>=</span> backendService;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>cache</span> <span style=color:#f92672>=</span> cache;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Product <span style=color:#a6e22e>getProductById</span>(String id) {
</span></span><span style=display:flex><span>        Product product <span style=color:#f92672>=</span> cache.<span style=color:#a6e22e>getProductById</span>(id);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (product <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 缓存服务器中没有所需的数据，将请求转发给后端服务进行处理</span>
</span></span><span style=display:flex><span>            product <span style=color:#f92672>=</span> backendService.<span style=color:#a6e22e>getProductById</span>(id);
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 将处理结果缓存起来，以便后续的请求可以直接从缓存服务器获取数据</span>
</span></span><span style=display:flex><span>            cache.<span style=color:#a6e22e>putProduct</span>(product);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> product;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>最后，我们定义一个 <code>ProductServiceAmbassador</code> 类，用于接收来自应用程序的请求，并根据一定的规则将请求转发给缓存服务器或后端服务。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ProductServiceAmbassador</span> <span style=color:#66d9ef>implements</span> ProductService {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> ProductService cacheService;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> ProductService backendService;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> Map<span style=color:#f92672>&lt;</span>String, Long<span style=color:#f92672>&gt;</span> cachedIds <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ConcurrentHashMap<span style=color:#f92672>&lt;&gt;</span>();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>long</span> cacheExpireTime <span style=color:#f92672>=</span> 60 <span style=color:#f92672>*</span> 1000L; <span style=color:#75715e>// 缓存过期时间为 60 秒</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>ProductServiceAmbassador</span>(ProductService cacheService,
</span></span><span style=display:flex><span>                                    ProductService backendService) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>cacheService</span> <span style=color:#f92672>=</span> cacheService;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>backendService</span> <span style=color:#f92672>=</span> backendService;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Product <span style=color:#a6e22e>getProductById</span>(String id) {
</span></span><span style=display:flex><span>        Long cachedTime <span style=color:#f92672>=</span> cachedIds.<span style=color:#a6e22e>get</span>(id);
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 如果商品 ID 在缓存中存在，并且缓存未过期，那么就直接返回缓存中的商品信息</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (cachedTime <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> System.<span style=color:#a6e22e>currentTimeMillis</span>() <span style=color:#f92672>-</span> cachedTime <span style=color:#f92672>&lt;</span> cacheExpireTime) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> cacheService.<span style=color:#a6e22e>getProductById</span>(id);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 如果商品 ID 在缓存中不存在，或者缓存已过期，那么就将请求转发给后端服务进行处理，并将处理结果缓存起来</span>
</span></span><span style=display:flex><span>        Product product <span style=color:#f92672>=</span> backendService.<span style=color:#a6e22e>getProductById</span>(id);
</span></span><span style=display:flex><span>        cacheService.<span style=color:#a6e22e>putProduct</span>(product);
</span></span><span style=display:flex><span>        cachedIds.<span style=color:#a6e22e>put</span>(id, System.<span style=color:#a6e22e>currentTimeMillis</span>());
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> product;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=服务发现和路由>服务发现和路由</h3><p>在分布式系统中，服务发现和路由通常用于将请求路由到正确的服务实例上，以实现高可用性和容错性。使用 Ambassador 设计模式可以实现服务发现和路由，将请求路由到正确的服务实例上，从而提高系统的可用性和性能。</p><p>以下是一个使用 Ambassador 设计模式实现服务发现和路由的 Java 示例代码：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>ProductService</span> {
</span></span><span style=display:flex><span>    Product <span style=color:#a6e22e>getProductById</span>(String id);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Product</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String id;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String name;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>Product</span>(String id, String name) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>id</span> <span style=color:#f92672>=</span> id;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>name</span> <span style=color:#f92672>=</span> name;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>getId</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> id;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>getName</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> name;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setName</span>(String name) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>name</span> <span style=color:#f92672>=</span> name;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>ProductDiscoveryClient</span> {
</span></span><span style=display:flex><span>    List<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>getInstances</span>();
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ProductDiscoveryClientImpl</span> <span style=color:#66d9ef>implements</span> ProductDiscoveryClient {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> List<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>getInstances</span>() {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 假装从服务注册中心获取服务实例列表</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> Arrays.<span style=color:#a6e22e>asList</span>(<span style=color:#e6db74>&#34;http://localhost:8080&#34;</span>, <span style=color:#e6db74>&#34;http://localhost:8081&#34;</span>, <span style=color:#e6db74>&#34;http://localhost:8082&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>ProductRoutingStrategy</span> {
</span></span><span style=display:flex><span>    String <span style=color:#a6e22e>getRoute</span>(String productId, List<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span> instances);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ProductRoutingStrategyImpl</span> <span style=color:#66d9ef>implements</span> ProductRoutingStrategy {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>getRoute</span>(String productId, List<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span> instances) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 假装使用负载均衡算法选择一个服务实例</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> index <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Random().<span style=color:#a6e22e>nextInt</span>(instances.<span style=color:#a6e22e>size</span>());
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> instances.<span style=color:#a6e22e>get</span>(index) <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;/product/&#34;</span> <span style=color:#f92672>+</span> productId;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ProductServiceAmbassador</span> <span style=color:#66d9ef>implements</span> ProductService {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> ProductDiscoveryClient discoveryClient;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> ProductRoutingStrategy routingStrategy;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> RestTemplate restTemplate;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>ProductServiceAmbassador</span>(ProductDiscoveryClient discoveryClient, ProductRoutingStrategy routingStrategy) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>discoveryClient</span> <span style=color:#f92672>=</span> discoveryClient;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>routingStrategy</span> <span style=color:#f92672>=</span> routingStrategy;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>restTemplate</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> RestTemplate();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Product <span style=color:#a6e22e>getProductById</span>(String id) {
</span></span><span style=display:flex><span>        List<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span> instances <span style=color:#f92672>=</span> discoveryClient.<span style=color:#a6e22e>getInstances</span>();
</span></span><span style=display:flex><span>        String route <span style=color:#f92672>=</span> routingStrategy.<span style=color:#a6e22e>getRoute</span>(id, instances);
</span></span><span style=display:flex><span>        ResponseEntity<span style=color:#f92672>&lt;</span>Product<span style=color:#f92672>&gt;</span> response <span style=color:#f92672>=</span> restTemplate.<span style=color:#a6e22e>getForEntity</span>(route, Product.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> response.<span style=color:#a6e22e>getBody</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>在这个示例中，我们定义了一个 <code>ProductService</code> 接口和一个 <code>Product</code> 类，用于表示商品服务和商品信息。然后，我们定义了一个 <code>ProductDiscoveryClient</code> 接口和一个 <code>ProductDiscoveryClientImpl</code> 类，用于获取服务实例列表。在 <code>ProductDiscoveryClientImpl</code> 类中，我们假装从服务注册中心获取服务实例列表，这里我们将服务实例列表硬编码为三个本地的 HTTP 地址。</p><p>接下来，我们定义了一个 <code>ProductRoutingStrategy</code> 接口和一个 <code>ProductRoutingStrategyImpl</code> 类，用于选择服务实例。在 <code>ProductRoutingStrategyImpl</code> 类中，我们使用了随机负载均衡算法来选择一个服务实例，并将商品 ID 和服务实例的 URL 拼接在一起，形成最终的路由信息。</p><p>在最后，我们定义了一个 <code>ProductServiceAmbassador</code> 类，用于实现商品服务的代理。在 <code>ProductServiceAmbassador</code> 类中，我们使用了依赖注入（DI）的方式来注入 <code>ProductDiscoveryClient</code> 和 <code>ProductRoutingStrategy</code> 的实现类。在 <code>getProductById</code> 方法中，我们首先通过 <code>ProductDiscoveryClient</code> 获取服务实例列表，然后使用 <code>ProductRoutingStrategy</code> 选择一个服务实例，并将商品 ID 和服务实例的 URL 拼接在一起，形成最终的路由信息。最后，我们使用 <code>RestTemplate</code> 发送 HTTP GET 请求，并将响应的 JSON 数据转换为 <code>Product</code> 对象返回。</p><p>使用 Ambassador 设计模式可以实现服务发现和路由，从而提高系统的可用性和性能，使得服务消费者无需关心服务实例的具体位置和负载均衡算法，只需要通过代理对象来访问服务即可。</p><h3 id=日志记录和监控>日志记录和监控</h3><p>在分布式系统中，日志记录和监控通常用于跟踪服务的运行状态和性能指标，以便进行故障排除和性能优化。使用 Ambassador 设计模式可以将日志记录和监控部署在应用程序的前端，监控服务的运行状态和性能指标，从而实现故障排除和性能优化。</p><p>以下是一个使用 Ambassador 设计模式实现日志记录和监控的 Java 示例代码：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>ProductService</span> {
</span></span><span style=display:flex><span>    Product <span style=color:#a6e22e>getProductById</span>(String id);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Product</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String id;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String name;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>Product</span>(String id, String name) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>id</span> <span style=color:#f92672>=</span> id;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>name</span> <span style=color:#f92672>=</span> name;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>getId</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> id;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>getName</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> name;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setName</span>(String name) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>name</span> <span style=color:#f92672>=</span> name;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>ProductLogger</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>logRequest</span>(String id);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>logResponse</span>(String id, Product product);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ProductLoggerImpl</span> <span style=color:#66d9ef>implements</span> ProductLogger {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> Logger logger <span style=color:#f92672>=</span> LoggerFactory.<span style=color:#a6e22e>getLogger</span>(ProductLoggerImpl.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>logRequest</span>(String id) {
</span></span><span style=display:flex><span>        logger.<span style=color:#a6e22e>info</span>(<span style=color:#e6db74>&#34;Requesting product with ID: {}&#34;</span>, id);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>logResponse</span>(String id, Product product) {
</span></span><span style=display:flex><span>        logger.<span style=color:#a6e22e>info</span>(<span style=color:#e6db74>&#34;Received product with ID: {}, Name: {}&#34;</span>, id, product.<span style=color:#a6e22e>getName</span>());
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>ProductMonitor</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>recordLatency</span>(String id, <span style=color:#66d9ef>long</span> latency);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>incrementCounter</span>(String id);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ProductMonitorImpl</span> <span style=color:#66d9ef>implements</span> ProductMonitor {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> StatsDClient statsd;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>ProductMonitorImpl</span>(String host, <span style=color:#66d9ef>int</span> port) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>statsd</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> NonBlockingStatsDClient(<span style=color:#e6db74>&#34;product-service&#34;</span>, host, port);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>recordLatency</span>(String id, <span style=color:#66d9ef>long</span> latency) {
</span></span><span style=display:flex><span>        statsd.<span style=color:#a6e22e>recordExecutionTime</span>(<span style=color:#e6db74>&#34;product.latency&#34;</span>, latency, <span style=color:#e6db74>&#34;id:&#34;</span> <span style=color:#f92672>+</span> id);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>incrementCounter</span>(String id) {
</span></span><span style=display:flex><span>        statsd.<span style=color:#a6e22e>increment</span>(<span style=color:#e6db74>&#34;product.counter&#34;</span>, <span style=color:#e6db74>&#34;id:&#34;</span> <span style=color:#f92672>+</span> id);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ProductServiceAmbassador</span> <span style=color:#66d9ef>implements</span> ProductService {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> ProductService productService;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> ProductLogger logger;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> ProductMonitor monitor;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>ProductServiceAmbassador</span>(ProductService productService, ProductLogger logger, ProductMonitor monitor) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>productService</span> <span style=color:#f92672>=</span> productService;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>logger</span> <span style=color:#f92672>=</span> logger;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>monitor</span> <span style=color:#f92672>=</span> monitor;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Product <span style=color:#a6e22e>getProductById</span>(String id) {
</span></span><span style=display:flex><span>        logger.<span style=color:#a6e22e>logRequest</span>(id);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>long</span> startTime <span style=color:#f92672>=</span> System.<span style=color:#a6e22e>currentTimeMillis</span>();
</span></span><span style=display:flex><span>        Product product <span style=color:#f92672>=</span> productService.<span style=color:#a6e22e>getProductById</span>(id);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>long</span> endTime <span style=color:#f92672>=</span> System.<span style=color:#a6e22e>currentTimeMillis</span>();
</span></span><span style=display:flex><span>        logger.<span style=color:#a6e22e>logResponse</span>(id, product);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>long</span> latency <span style=color:#f92672>=</span> endTime <span style=color:#f92672>-</span> startTime;
</span></span><span style=display:flex><span>        monitor.<span style=color:#a6e22e>recordLatency</span>(id, latency);
</span></span><span style=display:flex><span>        monitor.<span style=color:#a6e22e>incrementCounter</span>(id);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> product;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>在这个示例中，我们定义了一个 <code>ProductService</code> 接口和一个 <code>Product</code> 类，用于表示商品服务和商品信息。然后，我们定义了一个 <code>ProductLogger</code> 接口和一个 <code>ProductLoggerImpl</code> 类，用于记录请求和响应的日志信息。在 <code>ProductLoggerImpl</code> 类中，我们使用了 <code>SLF4J</code> 日志框架来记录日志信息。</p><p>接下来，我们定义了一个 <code>ProductMonitor</code> 接口和一个 <code>ProductMonitorImpl</code> 类，用于记录运行状态和性能指标。在 <code>ProductMonitorImpl</code> 类中，我们使用了 <code>StatsD</code> 客户端来记录运行状态和性能指标，例如请求的延迟和调用次数等。在 <code>ProductMonitorImpl</code> 的构造函数中，我们可以指定 <code>StatsD</code> 客户端的主机和端口。</p><p>最后，我们定义了一个 <code>ProductServiceAmbassador</code> 类，用于实现商品服务的代理。在 <code>ProductServiceAmbassador</code> 类中，我们通过依赖注入（DI）的方式将 <code>ProductService</code>、<code>ProductLogger</code> 和 <code>ProductMonitor</code> 的实现类注入到构造函数中。在 <code>getProductById</code> 方法中，我们首先调用 <code>ProductLogger</code> 的 <code>logRequest</code> 方法来记录请求的日志信息。然后，我们使用 <code>System.currentTimeMillis()</code> 来记录请求的开始时间，然后调用 <code>ProductService</code> 的 <code>getProductById</code> 方法来获取商品信息。接下来，我们使用 <code>System.currentTimeMillis()</code> 来记录请求的结束时间，并调用 <code>ProductLogger</code> 的 <code>logResponse</code> 方法来记录响应的日志信息。最后，我们计算请求的延迟，并调用 <code>ProductMonitor</code> 的 <code>recordLatency</code> 方法来记录请求的延迟，调用 <code>ProductMonitor</code> 的 <code>incrementCounter</code> 方法来记录调用次数。</p><p>使用 Ambassador 设计模式可以将日志记录和监控部署在应用程序的前端，从而监控服务的运行状态和性能指标，并提供实时的故障排除和性能优化。由于日志记录和监控是与业务逻辑解耦的，因此我们可以随时在运行时添加、删除或更改日志记录和监控的实现，而不影响应用程序的正常运行。</p><h2 id=已知使用>已知使用</h2><p>Ambassador 设计模式通常用于分布式系统中，用于解决服务间的通信问题和负载均衡问题。许多开源框架和工具都使用了 Ambassador 模式来实现服务代理和增强等功能。以下是一些常见的使用了 Ambassador 模式的开源框架和工具：</p><ol><li>Istio：Istio 是一个流行的服务网格框架，它使用了 Ambassador 模式来实现服务代理和增强等功能，例如流量管理、安全认证、监控和日志等。</li><li>Envoy：Envoy 是一个高性能的代理服务器，它使用了 Ambassador 模式来实现负载均衡、流量转发和服务代理等功能。</li><li>Linkerd：Linkerd 是另一个流行的服务网格框架，它使用了 Ambassador 模式来实现服务代理和增强等功能，例如负载均衡、故障恢复和流量管理等。</li><li>Open Service Mesh：Open Service Mesh 是一个开源的服务网格框架，它使用了 Ambassador 模式来实现服务代理和增强等功能，例如流量管理、安全认证和监控等。</li><li>Consul：Consul 是一个流行的服务发现和配置工具，它使用了 Ambassador 模式来实现服务代理和增强等功能，例如负载均衡、健康检查和故障恢复等。</li><li>Kubernetes：Kubernetes 是一个流行的容器编排平台，它使用了 Ambassador 模式来实现服务代理和增强等功能，例如服务发现、负载均衡和流量管理等。</li><li>Nginx：Nginx 是一个高性能的 Web 服务器和反向代理服务器，它使用了 Ambassador 模式来实现负载均衡、流量转发和服务代理等功能。</li><li>Kong：Kong 是一个开源的 API 网关，它使用了 Ambassador 模式来实现流量管理、安全认证和监控等功能。</li><li>Traefik：Traefik 是一个流行的反向代理和负载均衡器，它使用了 Ambassador 模式来实现服务代理和增强等功能，例如动态配置、自动发现和流量转发等。</li></ol><p>当然，Java 生态系统中也有许多开源框架和工具使用了 Ambassador 模式。以下是其中的一些：</p><ol><li>Spring Cloud Netflix：Spring Cloud Netflix 是一个流行的微服务框架，它使用了 Netflix OSS 中的 Ribbon 和 Zuul 组件来实现服务代理和增强等功能，例如负载均衡、服务发现和路由等。</li><li>Spring Cloud Gateway：Spring Cloud Gateway 是 Spring Cloud 生态系统中的一个新型 API 网关，它使用了 Reactor Netty 和 Spring WebFlux 等技术来实现服务代理和增强等功能，例如负载均衡、路由和限流等。</li><li>Netflix OSS：Netflix OSS 是 Netflix 开源的一组分布式系统工具，其中包括了许多使用了 Ambassador 模式的组件，例如 Ribbon、Hystrix、Zuul 和 Eureka 等。</li><li>Micronaut：Micronaut 是一个轻量级的 Java 框架，它使用了 Netty 和 Reactive Streams 等技术来实现服务代理和增强等功能，例如负载均衡、服务发现和路由等。</li><li>Vert.x：Vert.x 是一个高性能的异步编程框架，它使用了 Netty 和 Reactive Streams 等技术来实现服务代理和增强等功能，例如负载均衡、路由和限流等。</li></ol><h3 id=spring-cloud-gateway>Spring Cloud Gateway</h3><p>Spring Cloud Gateway 是 Spring Cloud 生态系统中的一个新型 API 网关，它使用了 Reactor Netty 和 Spring WebFlux 等技术来实现服务代理和增强等功能。它的设计理念就是基于 Ambassador 模式来构建的，它将每个后端服务都看作一个独立的实体，通过一个中央入口点来统一管理和控制。</p><p>下面通过代码来说明 Spring Cloud Gateway 如何使用 Ambassador 模式。假设我们有两个后端服务，一个是 user-service，一个是 order-service，我们希望通过 Spring Cloud Gateway 来实现负载均衡和路由的功能。</p><p>首先，我们需要添加 Spring Cloud Gateway 依赖，可以在 Maven 中添加以下依赖：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;groupId&gt;</span>org.springframework.cloud<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;artifactId&gt;</span>spring-cloud-starter-gateway<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>然后，我们需要在配置文件中配置 Spring Cloud Gateway，例如 application.yml 文件：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>spring</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>cloud</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>gateway</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>routes</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>id</span>: <span style=color:#ae81ff>user-service</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>uri</span>: <span style=color:#ae81ff>lb://user-service</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>predicates</span>:
</span></span><span style=display:flex><span>            - <span style=color:#ae81ff>Path=/users/**</span>
</span></span><span style=display:flex><span>        - <span style=color:#f92672>id</span>: <span style=color:#ae81ff>order-service</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>uri</span>: <span style=color:#ae81ff>lb://order-service</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>predicates</span>:
</span></span><span style=display:flex><span>            - <span style=color:#ae81ff>Path=/orders/**</span>
</span></span></code></pre></div><p>这段配置代码的意思是，我们定义了两个路由规则，一个是对于 /users/** 的请求，将会被路由到 user-service 服务上，另一个是对于 /orders/** 的请求，将会被路由到 order-service 服务上。其中，uri 前缀的 lb:// 表示使用负载均衡的方式来路由请求，这里我们使用了 Spring Cloud LoadBalancer 组件来实现负载均衡的功能。</p><p>最后，我们需要在启动类上添加 @EnableGateway 注解，来启用 Spring Cloud Gateway：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@SpringBootApplication</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@EnableDiscoveryClient</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@EnableGateway</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>GatewayApplication</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span>(String<span style=color:#f92672>[]</span> args) {
</span></span><span style=display:flex><span>        SpringApplication.<span style=color:#a6e22e>run</span>(GatewayApplication.<span style=color:#a6e22e>class</span>, args);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>这样，我们就完成了 Spring Cloud Gateway 的配置和启用。通过以上的配置和代码，我们实现了 Ambassador 模式的基本功能，即通过一个中央入口点来统一管理和控制后端服务。同时，由于 Spring Cloud Gateway 基于 Reactor Netty 和 Spring WebFlux 等技术实现，它也具有非常高的性能和可扩展性。</p><p>Spring Cloud Gateway 源码中的实现方式，主要是基于 Reactor Netty 和 Spring WebFlux 框架来实现的。它的核心组件是 GatewayFilter 和 RouteLocator，其中 GatewayFilter 用于实现各种过滤器，例如请求转发、重定向、限流和认证等，而 RouteLocator 用于实现动态路由和负载均衡等功能。</p><p>具体来说，Spring Cloud Gateway 的工作原理如下：</p><ol><li>Spring Cloud Gateway 接收客户端的请求，然后根据配置文件中的路由规则，选择一个合适的路由器进行处理。</li><li>路由器会根据请求的 URL 和配置文件中的路由规则，选择一个或多个过滤器对请求进行处理。过滤器可以选择性地修改请求和响应，或者中断请求并返回响应。</li><li>过滤器将处理后的请求发送到后端服务，然后将响应返回给客户端。</li><li>在处理请求和响应的过程中，Spring Cloud Gateway 支持多种协议和格式，例如 HTTP、WebSocket、JSON 和 XML 等。</li></ol><p>在 Spring Cloud Gateway 的源码中，它的核心组件是 GatewayFilter 和 RouteLocator。其中，GatewayFilter 是一个过滤器接口，它定义了一个过滤器的基本方法链，开发者可以通过实现 GatewayFilter 接口来实现自定义的过滤器。而 RouteLocator 则是一个路由规则接口，它定义了一个动态路由表，开发者可以通过实现 RouteLocator 接口来实现自定义的路由规则，例如基于服务发现的路由规则。</p><blockquote><p>Spring Cloud Gateway 支持 WebSocket 协议。WebSocket 是一种在单个 TCP 连接上进行全双工通信的协议，它允许客户端和服务器之间进行实时交互和通信。Spring Cloud Gateway 通过支持 WebSocket 协议，可以实现实时通信、推送和广播等功能。</p><p>要在 Spring Cloud Gateway 中支持 WebSocket 协议，需要进行以下步骤：</p><ol><li><p>引入 Spring Cloud Gateway WebSocket 依赖，可以在 Maven 中添加以下依赖：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;groupId&gt;</span>org.springframework.cloud<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;artifactId&gt;</span>spring-cloud-starter-gateway-websocket<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span></code></pre></div></li><li><p>配置 Spring Cloud Gateway，需要在 application.yml 或 application.properties 文件中添加以下配置：</p></li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>spring</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>cloud</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>gateway</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>websockets</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>enabled</span>: <span style=color:#66d9ef>true</span>
</span></span></code></pre></div><pre><code>  这段配置代码的意思是，启用 Spring Cloud Gateway 的 WebSocket 支持。
</code></pre><ol start=3><li><p>配置 WebSocket 路由，需要在 application.yml 或 application.properties 文件中添加以下配置：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>spring</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>cloud</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>gateway</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>routes</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>id</span>: <span style=color:#ae81ff>ws-route</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>uri</span>: <span style=color:#ae81ff>ws://localhost:8080</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>predicates</span>:
</span></span><span style=display:flex><span>            - <span style=color:#ae81ff>Path=/ws/**</span>
</span></span></code></pre></div><p>这段配置代码的意思是，将 /ws/** 的请求路由到 uri 为 ws://localhost:8080 的 WebSocket 服务上。</p></li><li><p>实现 WebSocket 处理器，需要编写一个实现 WebSocketHandler 接口的处理器，例如：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Component</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>EchoWebSocketHandler</span> <span style=color:#66d9ef>implements</span> WebSocketHandler {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>public</span> Mono<span style=color:#f92672>&lt;</span>Void<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>handle</span>(WebSocketSession session) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 处理 WebSocketSession</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> session.<span style=color:#a6e22e>send</span>(session.<span style=color:#a6e22e>receive</span>().<span style=color:#a6e22e>map</span>(msg <span style=color:#f92672>-&gt;</span> session.<span style=color:#a6e22e>textMessage</span>(<span style=color:#e6db74>&#34;Echo: &#34;</span> <span style=color:#f92672>+</span> msg.<span style=color:#a6e22e>getPayloadAsText</span>())));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>这段代码的意思是，实现一个处理器，用来处理 WebSocketSession。在此示例中，处理器会将接收到的消息进行回显，并返回给客户端。</p></li><li><p>配置 WebSocket 处理器，需要在 application.yml 或 application.properties 文件中添加以下配置：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>spring</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>cloud</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>gateway</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>routes</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>id</span>: <span style=color:#ae81ff>ws-route</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>uri</span>: <span style=color:#ae81ff>ws://localhost:8080</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>predicates</span>:
</span></span><span style=display:flex><span>            - <span style=color:#ae81ff>Path=/ws/**</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>filters</span>:
</span></span><span style=display:flex><span>            - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>WebSocket</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>args</span>:
</span></span><span style=display:flex><span>                <span style=color:#f92672>handler</span>: <span style=color:#ae81ff>echoWebSocketHandler</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>subprotocols</span>: <span style=color:#ae81ff>subprotocol1, subprotocol2</span>
</span></span></code></pre></div><p>这段配置代码的意思是，将 WebSocket 处理器 echoWebSocketHandler 绑定到 WebSocket 路由上，并指定了子协议 subprotocol1 和 subprotocol2。</p></li></ol><p>这样，我们就完成了在 Spring Cloud Gateway 中支持 WebSocket 协议的配置和代码实现。通过以上的配置和代码，我们可以在 Spring Cloud Gateway 上实现 WebSocket 的功能，例如实时通信、推送和广播等。</p></blockquote><h2 id=相关模式>相关模式</h2><ul><li><a href=https://java-design-patterns.com/patterns/proxy/ target=_blank>Proxy</a></li></ul><h2 id=其他>其他</h2><h3 id=ambassador-和-aop>Ambassador 和 AOP</h3><p>Ambassador 设计模式和 AOP（面向切面编程）都是用于实现横切关注点的设计模式。它们都可以在不修改现有代码的情况下，往程序中添加一些额外的行为，例如日志记录、性能监控、安全验证等。</p><p>Ambassador 设计模式是一种结构型设计模式，它通过代理对象来隐藏底层服务的实现细节，并提供一些额外的功能，例如服务发现、负载均衡、日志记录和监控等。在 Ambassador 设计模式中，代理对象和原始对象都实现了同一个接口，代理对象负责将调用转发到原始对象，并在调用前后执行一些额外的逻辑。</p><p>AOP 也是一种结构型设计模式，它通过将横切关注点从业务逻辑中分离出来，实现了一种基于切面的模块化设计。在 AOP 中，横切关注点被封装成切面，并通过切点和通知来定义切面的行为。在程序运行期间，AOP 框架会动态地将切面织入到目标对象的方法调用中，从而实现切面的功能。</p><p>虽然 Ambassador 设计模式和 AOP 都可以实现横切关注点，但它们的应用场景和目的略有不同。Ambassador 设计模式通常用于实现与底层服务相关的功能，例如服务发现、负载均衡、日志记录和监控等。而 AOP 则更加通用，可以用于实现任何与业务逻辑无关的功能，例如事务管理、安全验证、性能监控等。此外，AOP 还可以通过切面的织入顺序来实现一些复杂的功能，例如事务嵌套和并发控制等。</p><p>在实践中，Ambassador 设计模式和 AOP 可以结合使用，从而实现更加灵活和可扩展的应用程序设计。例如，在使用 Ambassador 设计模式实现服务调用时，我们可以使用 AOP 来记录请求和响应的日志信息，或者实现安全验证和性能监控等功能。在这种情况下，Ambassador 设计模式和 AOP 通常是相互补充的，可以在不同的层次上实现横切关注点的功能。</p><h3 id=ambassador-和代理>Ambassador 和代理</h3><p>Ambassador 设计模式和代理模式都是结构型设计模式，它们都使用代理对象来隐藏真实对象的实现细节，并提供一些额外的功能。然而，它们的目的和实现方式略有不同。</p><p>代理模式是一种结构型设计模式，它通过代理对象来控制对真实对象的访问。在代理模式中，代理对象和真实对象实现相同的接口，代理对象负责将方法调用传递给真实对象，并在此基础上添加一些额外的逻辑，例如权限控制、缓存、远程访问等。代理模式可以在不修改现有代码的情况下，为真实对象提供额外的功能和保护。</p><p>Ambassador 设计模式也是一种结构型设计模式，它通过代理对象来隐藏底层服务的实现细节，并提供一些额外的功能，例如服务发现、负载均衡、日志记录和监控等。在 Ambassador 设计模式中，代理对象和底层服务实现相同的接口，代理对象负责将调用转发到底层服务，并在此基础上添加一些额外的逻辑。Ambassador 设计模式通常用于实现与底层服务相关的功能。</p><p>Ambassador 设计模式和代理模式在某些方面确实非常相似，它们都使用代理对象来隐藏真实对象的实现细节，并提供一些额外的功能。然而，它们的目的和应用场景略有不同，这也是它们的区别所在。</p><p>代理模式通常用于控制对真实对象的访问，例如权限控制、缓存、远程访问等。它的重点在于实现对真实对象的保护和控制。代理模式的应用场景非常广泛，可以用于任何需要对真实对象进行访问控制和保护的场景。</p><p>Ambassador 设计模式则更加专注于底层服务的代理和增强，例如服务发现、负载均衡、日志记录和监控等。它通常用于分布式系统中，用于解决服务间的通信问题和负载均衡问题。Ambassador 设计模式的重点在于为底层服务提供代理和增强功能，以便更好地管理和控制底层服务。</p><p>虽然 Ambassador 设计模式和代理模式在某些方面非常相似，但它们在实际应用中通常被用于不同的场景和目的。在实践中，我们可以根据具体的需求和应用场景来选择使用哪种模式，或者将它们结合起来使用，以实现更加灵活和可扩展的应用程序设计。</p><h2 id=参考文章>参考文章</h2><ol><li><a href=https://docs.microsoft.com/en-us/azure/architecture/patterns/ambassador target=_blank>Ambassador Pattern</a>: 该文章介绍了 Ambassador 模式的概念和应用场景，并提供了一些实际案例供参考。</li><li><a href=https://dzone.com/articles/design-patterns-for-microservices-ambassador-anti target=_blank>Design Patterns for Microservices: Ambassador, Anti-Corruption Layer, and Backends for Frontends</a> : 这篇文章介绍了在微服务架构中使用的两种设计模式：Ambassador 模式和 Anti-corruption Layer 模式。。</li><li><a href=https://itnext.io/ambassador-and-istio-edge-proxy-and-service-mesh-814aac9f23df target=_blank>The Ambassador pattern and Istio</a>: 这篇文章介绍了如何使用 Istio 和 Ambassador 模式来实现微服务的边缘代理和服务网格。</li><li><a href=https://medium.com/bb-tutorials-and-thoughts/kubernetes-learn-ambassador-container-pattern-bc2e1331bd3a target=_blank>Kubernetes — Learn Ambassador Container Pattern</a> 介绍了如何在 Kubernetes 中使用 Ambassador 模式来解决微服务通信的问题。</li><li><a href=https://blog.getambassador.io/api-gateway-vs-service-mesh-104c01fa4784 target=_blank>Ambassador vs API Gateway</a>: 该文章对比了 Ambassador 模式和传统的 API 网关的优缺点，分析了它们在不同场景下的应用和适用性。</li></ol></div><div><div style=font-weight:700>Share this post:</div><a class=social-link-item href="https://twitter.com/intent/tweet?text=Java%e8%ae%be%e8%ae%a1%e6%a8%a1%e5%bc%8f%ef%bc%9aAmbassador https%3a%2f%2fblog.chensoul.cc%2fposts%2f2023%2f07%2f06%2fjava-design-patterns-ambassador%2f" target=_blank rel="noopener noreferrer" title="Click to share on Twitter"><i class="fa-brands fa-square-twitter fa-2xl" style=color:#55acee></i>
</a><a class=social-link-item href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fblog.chensoul.cc%2fposts%2f2023%2f07%2f06%2fjava-design-patterns-ambassador%2f&title=Java%e8%ae%be%e8%ae%a1%e6%a8%a1%e5%bc%8f%ef%bc%9aAmbassador" target=_blank rel="noopener noreferrer" title="Click to share on LinkedIn"><i class="fa-brands fa-linkedin fa-2xl" style=color:#007bb5></i>
</a><a class=social-link-item href="https://telegram.me/share/url?text=Java%e8%ae%be%e8%ae%a1%e6%a8%a1%e5%bc%8f%ef%bc%9aAmbassador&amp;url=https%3a%2f%2fblog.chensoul.cc%2fposts%2f2023%2f07%2f06%2fjava-design-patterns-ambassador%2f" target=_blank rel="noopener noreferrer" title="Click to share on telegram"><i class="fa-brands fa-telegram fa-2xl" style=color:#007bb5></i>
</a><a class=social-link-item href="https://reddit.com/submit?url=https%3a%2f%2fblog.chensoul.cc%2fposts%2f2023%2f07%2f06%2fjava-design-patterns-ambassador%2f&title=Java%e8%ae%be%e8%ae%a1%e6%a8%a1%e5%bc%8f%ef%bc%9aAmbassador" target=_blank rel="noopener noreferrer" title="Click to share on reddit"><i class="fa-brands fa-reddit fa-2xl" style=color:#007bb5></i>
</a><a class=social-link-item href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fblog.chensoul.cc%2fposts%2f2023%2f07%2f06%2fjava-design-patterns-ambassador%2f" target=_blank rel="noopener noreferrer" title="Click to share on facebook"><i class="fa-brands fa-facebook fa-2xl" style=color:#007bb5></i>
</a><a class=social-link-item href="https://api.whatsapp.com/send?text=Java%e8%ae%be%e8%ae%a1%e6%a8%a1%e5%bc%8f%ef%bc%9aAmbassador%20-%20https%3a%2f%2fblog.chensoul.cc%2fposts%2f2023%2f07%2f06%2fjava-design-patterns-ambassador%2f" target=_blank rel="noopener noreferrer" title="Click to share on whatsapp"><i class="fa-brands fa-whatsapp fa-2xl" style=color:#007bb5></i></a></div></div></article><nav class="navigation post-navigation" role=navigation><h2 class=screen-reader-text>Post navigation</h2><div class=nav-links><div class=nav-previous><a href=/posts/2023/07/08/python-input-and-output/ rel=next><span class=post-title>Python学习7：输入和输出</span></a></div><div class=nav-next><a href=/posts/2023/07/06/python-module-package/ rel=prev><span class=post-title>Python学习6：模块和包</span></a></div></div></nav><h2>Related content</h2><ul><li><a href=/posts/2023/12/14/all-things-about-microprofile/>All things about MicroProfile</a></li><li><a href=/posts/2023/11/02/jhipster-intro/>JHipster安装和介绍</a></li><li><a href=/posts/2023/10/26/java-design-patterns-circuit-breaker/>Java设计模式：Circuit Breaker</a></li><li><a href=/posts/2023/10/16/java-design-patterns-chain/>Java设计模式：Chain</a></li><li><a href=/posts/2023/10/13/java-design-patterns-callback/>Java设计模式：Callback</a></li><li><a href=/posts/2023/09/25/java-design-patterns-cahcing/>Java设计模式：Caching</a></li><li><a href=/posts/2023/09/22/java-design-patterns-bytecode/>Java设计模式：Bytecode</a></li><li><a href=/posts/2023/09/05/java-design-patterns-builder/>Java设计模式：Builder</a></li><li><a href=/posts/2023/09/05/java-design-patterns-business-delegate/>Java设计模式：Business Delegate</a></li><li><a href=/posts/2023/08/28/java-design-patterns-bridge/>Java设计模式：Bridge</a></li></ul></main></section></div><div id=footer class=footer-wrap><footer id=colophon class="site-footer container clearfix" role=contentinfo><div id=footer-text class=site-info><span class=credit-link><a href=/ target=_blank rel="noopener noreferrer">ChenSoul</a>
Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreferrer">Hugo</a>
<a style=margin-left:20px href=/privacy_policy/ target=_blank rel="noopener noreferrer">Privacy Policy</a></span></div></footer></div></div><script type=text/javascript src=/main.min.js></script></body></html>