<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>[译]使用Spring Boot2和Spring Security 5以及JDBC令牌存储进行Oauth2集中授权 | ChenSoul</title><meta name=keywords content="java"><meta name=description content="在这篇文章中，我们将了解如何使用 Spring Boot 2 和 Spring Security 5 OAuth2 来实现集中授权的授权服务器以及如何通过 GUI 对其进行管理，还将提供资源服务器演示以及 github 下的整个项"><meta name=author content="chensoul"><link rel=canonical href=https://blog.chensoul.com/posts/2023/07/14/oauth-2-centralized-authorization-with-spring-boot-2-and-spring-security-5-and-jdbc-token-store/><meta name=google-site-verification content="nBXwg45SBRjTX78SA-mH0asrAbsdu9c1nk0ObSry7aQ"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="8E787EFCDB0CE747FE1A4DA0ABEC66E4"><link crossorigin=anonymous href=/assets/css/stylesheet.css rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.js onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://blog.chensoul.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://blog.chensoul.com/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://blog.chensoul.com/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://blog.chensoul.com/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://blog.chensoul.com/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta name=baidu-site-verification content="codeva-FYpQY8JdLU"><meta property="og:title" content="[译]使用Spring Boot2和Spring Security 5以及JDBC令牌存储进行Oauth2集中授权"><meta property="og:description" content="在这篇文章中，我们将了解如何使用 Spring Boot 2 和 Spring Security 5 OAuth2 来实现集中授权的授权服务器以及如何通过 GUI 对其进行管理，还将提供资源服务器演示以及 github 下的整个项"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.chensoul.com/posts/2023/07/14/oauth-2-centralized-authorization-with-spring-boot-2-and-spring-security-5-and-jdbc-token-store/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-07-14T09:00:00+08:00"><meta property="article:modified_time" content="2023-07-14T09:00:00+08:00"><meta property="og:site_name" content="ChenSoul"><meta name=twitter:card content="summary"><meta name=twitter:title content="[译]使用Spring Boot2和Spring Security 5以及JDBC令牌存储进行Oauth2集中授权"><meta name=twitter:description content="在这篇文章中，我们将了解如何使用 Spring Boot 2 和 Spring Security 5 OAuth2 来实现集中授权的授权服务器以及如何通过 GUI 对其进行管理，还将提供资源服务器演示以及 github 下的整个项"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://blog.chensoul.com/posts/"},{"@type":"ListItem","position":2,"name":"[译]使用Spring Boot2和Spring Security 5以及JDBC令牌存储进行Oauth2集中授权","item":"https://blog.chensoul.com/posts/2023/07/14/oauth-2-centralized-authorization-with-spring-boot-2-and-spring-security-5-and-jdbc-token-store/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"[译]使用Spring Boot2和Spring Security 5以及JDBC令牌存储进行Oauth2集中授权","name":"[译]使用Spring Boot2和Spring Security 5以及JDBC令牌存储进行Oauth2集中授权","description":"在这篇文章中，我们将了解如何使用 Spring Boot 2 和 Spring Security 5 OAuth2 来实现集中授权的授权服务器以及如何通过 GUI 对其进行管理，还将提供资源服务器演示以及 github 下的整个项","keywords":["java"],"articleBody":"在这篇文章中，我们将了解如何使用 Spring Boot 2 和 Spring Security 5 OAuth2 来实现集中授权的授权服务器以及如何通过 GUI 对其进行管理，还将提供资源服务器演示以及 github 下的整个项目。\n很多示例涵盖了基于早期版本的 Spring boot 2 和 Spring Security 5 使用内存令牌实现 Oauth2，因此想法是使用 MySql 数据库作为令牌存储。\n为了深入探讨这个主题，我们必须：\n配置Spring安全。 配置数据库。 创建授权服务器。 创建资源服务器。 使用curl 客户端使用访问令牌获取安全资源。 什么是 Oauth 2？ OAuth 2.0 是行业标准授权协议。 OAuth 2.0 取代了 2006 年创建的原始 OAuth 协议上所做的工作。OAuth 2.0 注重客户端开发人员的简单性，同时为 Web 应用程序、桌面应用程序、移动电话和客厅设备提供特定的授权流程。\n该规范及其扩展正在 IETF OAuth 工作组内开发。\nOauth 2 角色 OAuth2定义了4个角色：\n资源所有者：通常是您自己。\n资源服务器：托管受保护数据的服务器（例如 Google 托管您的个人资料和个人信息）。\n客户端：请求访问资源服务器的应用程序（网站、Javascript 应用程序或移动应用程序……）。\n授权服务器：向客户端颁发访问令牌的服务器。该令牌将用于客户端请求资源服务器。该服务器可以与资源服务器相同（相同的物理服务器和相同的应用程序），而且经常是这种情况。\n下图说明了角色流程：\n授权类型 OAuth 2 为不同的用例提供了多种“授权类型”。定义的授权类型型有：\n授权码：授权码授予是使用您的 Facebook 或 Google 帐户登录应用程序的功能。 密码：旨在用于基于用户代理的客户端。其次，授权服务器不会像授权代码授予那样返回授权代码来交换访问令牌，而是返回访问令牌。 客户端凭据：客户端可以仅使用其客户端凭据（或其他支持的身份验证方式）请求访问令牌，当客户端请求访问其下的受保护资源控制权，或先前已被其他资源所有者控制的与授权服务器安排。 隐式授权：隐式授权是一种简化的授权代码流，针对使用 JavaScript 等脚本语言在浏览器中实现的客户端进行了优化。在隐式流程中，而不是向客户端发出授权代码，直接向客户端颁发访问令牌。 示范 让我们动手吧\n业务层 为简单起见，我们的主要业务应用程序将是使用一个实体的产品 API，我们的访问规则将是：\nPRODUCT_CREATE PRODUCT_UPDATE PRODUCT_DISPLAY PRODUCT_ADMIN OAuth2 客户端设置 要设置 Oauth 2 客户端，我们需要创建下表 [有关更多详细信息，请参阅链接]\nOAUTH_CLIENT_DETAILS OAUTH_CLIENT_DETAILS OAUTH_CLIENT_TOKEN OAUTH_CLIENT_TOKEN OAUTH_ACCESS_TOKEN OAUTH_ACCESS_TOKEN OAUTH_REFRESH_TOKEN OAUTH_REFRESH_TOKEN OAUTH_CODE OAUTH_代码 OAUTH_APPROVALS OAUTH_APPROVALS 我们将调用像“product_api”这样的资源服务器 对于该服务器，我们定义一个客户端，称为：\n读-写-客户端（授权授权类型：读、写） INSERT INTO OAUTH_CLIENT_DETAILS(CLIENT_ID, RESOURCE_IDS, CLIENT_SECRET, SCOPE, AUTHORIZED_GRANT_TYPES, AUTHORITIES, ACCESS_TOKEN_VALIDITY, REFRESH_TOKEN_VALIDITY) VALUES ('read-write-client', 'product-api','$2a$10$BurTWIy5NTF9GJJH4magz.9Bd4bBurWYG8tmXxeQh1vs7r/wnCFG2','read,write', 'client_credentials', 'ROLE_PRODUCT_ADMIN', 10800, 2592000); #password [hashed with BCCrypt] :user 权限和用户设置 Spring Security 附带两个有用的接口：\nUserDetails — 提供核心用户信息。\nGrantedAuthority — 表示授予身份验证对象的权限。\n下面的脚本将加载所有权限和凭据（用户）：\nINSERT INTO authority VALUES(1,'ROLE_OAUTH_ADMIN'); INSERT INTO authority VALUES(2,'ROLE_ADMIN_PRODUCT'); INSERT INTO authority VALUES(3,'ROLE_RESOURCE_ADMIN'); INSERT INTO credentials VALUES(1,b'1','oauth_admin','$2a$10$BurTWIy5NTF9GJJH4magz.9Bd4bBurWYG8tmXxeQh1vs7r/wnCFG2','0'); INSERT INTO credentials VALUES(2,b'1','resource_admin','$2a$10$BurTWIy5NTF9GJJH4magz.9Bd4bBurWYG8tmXxeQh1vs7r/wnCFG2','0'); INSERT INTO credentials VALUES(3,b'1','user','$2a$10$BurTWIy5NTF9GJJH4magz.9Bd4bBurWYG8tmXxeQh1vs7r/wnCFG2','0'); INSERT INTO credentials_authorities VALUES (1, 1); INSERT INTO credentials_authorities VALUES (2, 3); INSERT INTO credentials_authorities VALUES (3, 2); #Password : user API层 对于演示，基于 Spring Boot 开发了 RESTful 应用程序并公开以下端点：\nSpring安全配置 我们必须提供 UserDetailsService 接口的实现，以便获取用户凭据和权限，如下所示\n为了向应用程序提供安全性，我们将使用 @EnableWebSecurity 注释和 WebSecurityConfigurerAdapter\npackage com.aak.configuration; import org.springframework.context.annotation.Bean; import org.springframework.context.annotation.Configuration; import org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder; import org.springframework.security.config.annotation.web.builders.HttpSecurity; import org.springframework.security.config.annotation.web.builders.WebSecurity; import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity; import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter; import org.springframework.security.core.userdetails.UserDetailsService; import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder; import org.springframework.security.crypto.password.PasswordEncoder; import org.springframework.security.provisioning.JdbcUserDetailsManager; import org.springframework.security.web.util.matcher.AntPathRequestMatcher; /** * Created by ahmed on 20.5.18. */ @EnableWebSecurity @Configuration public class WebSecurityConfiguration extends WebSecurityConfigurerAdapter { @Bean public PasswordEncoder passwordEncoder() { return new BCryptPasswordEncoder(); } @Bean @Override public UserDetailsService userDetailsServiceBean() throws Exception { return new JdbcUserDetails(); } @Override public void configure(WebSecurity web) throws Exception { web.ignoring().antMatchers(\"/webjars/**\"); } @Override protected void configure(HttpSecurity http) throws Exception { http .authorizeRequests() .antMatchers(\"/login\",\"/logout.do\").permitAll() .antMatchers(\"/**\").authenticated() .and() .formLogin() .loginProcessingUrl(\"/login.do\") .usernameParameter(\"username\") .passwordParameter(\"password\") .loginPage(\"/login\") .and() .logout() .logoutRequestMatcher(new AntPathRequestMatcher(\"/logout.do\")) .and() .userDetailsService(userDetailsServiceBean()); } @Override protected void configure(AuthenticationManagerBuilder auth) throws Exception { auth.userDetailsService(userDetailsServiceBean()) .passwordEncoder(passwordEncoder()); } } OAuth2 配置 要设置 Oauth 2，需要实现两个组件\nAuthorization Server 授权服务器 Resource Server 资源服务器 授权服务器 授权服务器负责验证用户身份并提供令牌，使用@EnableAuthorizationServer注解启用授权服务器配置\npackage com.aak.configuration; import org.springframework.boot.context.properties.ConfigurationProperties; import org.springframework.boot.jdbc.DataSourceBuilder; import org.springframework.context.annotation.Bean; import org.springframework.context.annotation.Configuration; import org.springframework.security.oauth2.config.annotation.configurers.ClientDetailsServiceConfigurer; import org.springframework.security.oauth2.config.annotation.web.configuration.AuthorizationServerConfigurerAdapter; import org.springframework.security.oauth2.config.annotation.web.configuration.EnableAuthorizationServer; import org.springframework.security.oauth2.config.annotation.web.configurers.AuthorizationServerEndpointsConfigurer; import org.springframework.security.oauth2.config.annotation.web.configurers.AuthorizationServerSecurityConfigurer; import org.springframework.security.oauth2.provider.approval.ApprovalStore; import org.springframework.security.oauth2.provider.approval.JdbcApprovalStore; import org.springframework.security.oauth2.provider.client.JdbcClientDetailsService; import org.springframework.security.oauth2.provider.code.AuthorizationCodeServices; import org.springframework.security.oauth2.provider.code.JdbcAuthorizationCodeServices; import org.springframework.security.oauth2.provider.token.TokenStore; import org.springframework.security.oauth2.provider.token.store.JdbcTokenStore; import javax.sql.DataSource; /** * Created by ahmed on 21.5.18. */ @Configuration @EnableAuthorizationServer public class AuthorizationServerConfiguration extends AuthorizationServerConfigurerAdapter { @Bean @ConfigurationProperties(prefix = \"spring.datasource\") public DataSource oauthDataSource() { return DataSourceBuilder.create().build(); } @Bean public JdbcClientDetailsService clientDetailsService() { return new JdbcClientDetailsService(oauthDataSource()); } @Bean public TokenStore tokenStore() { return new JdbcTokenStore(oauthDataSource()); } @Bean public ApprovalStore approvalStore() { return new JdbcApprovalStore(oauthDataSource()); } @Bean public AuthorizationCodeServices authorizationCodeServices() { return new JdbcAuthorizationCodeServices(oauthDataSource()); } @Override public void configure(ClientDetailsServiceConfigurer clients) throws Exception { clients.withClientDetails(clientDetailsService()); } @Override public void configure(AuthorizationServerSecurityConfigurer oauthServer) throws Exception { } @Override public void configure(AuthorizationServerEndpointsConfigurer endpoints) throws Exception { endpoints .approvalStore(approvalStore()) .authorizationCodeServices(authorizationCodeServices()) .tokenStore(tokenStore()); } } 成功配置运行授权服务器后，您将获得登录页面来管理授权服务器\n使用 oauth_admin/user 作为用户名/密码访问 Oauth2 仪表板，您可以在其中创建服务器客户端\n资源服务器 资源服务器托管受 OAuth2 令牌保护的资源（基本上是我们的产品 API）\npackage com.aak.configuration; import org.springframework.boot.context.properties.ConfigurationProperties; import org.springframework.boot.jdbc.DataSourceBuilder; import org.springframework.context.annotation.Bean; import org.springframework.context.annotation.Configuration; import org.springframework.http.HttpMethod; import org.springframework.security.config.annotation.web.builders.HttpSecurity; import org.springframework.security.oauth2.config.annotation.web.configuration.EnableResourceServer; import org.springframework.security.oauth2.config.annotation.web.configuration.ResourceServerConfigurerAdapter; import org.springframework.security.oauth2.config.annotation.web.configurers.ResourceServerSecurityConfigurer; import org.springframework.security.oauth2.provider.token.TokenStore; import org.springframework.security.oauth2.provider.token.store.JdbcTokenStore; import javax.sql.DataSource; /** * Created by ahmed on 30.5.18. */ @EnableResourceServer @Configuration public class ResourcesServerConfiguration extends ResourceServerConfigurerAdapter { @Bean @ConfigurationProperties(prefix=\"spring.datasource\") public DataSource ouathDataSource(){return DataSourceBuilder.create().build();} @Override public void configure(ResourceServerSecurityConfigurer resources)throws Exception{ TokenStore tokenStore=new JdbcTokenStore(ouathDataSource()); resources.resourceId(\"product_api\").tokenStore(tokenStore); } @Override public void configure(HttpSecurity http) throws Exception{ http .authorizeRequests() .antMatchers(HttpMethod.GET, \"/**\").access(\"#oauth2.hasScope('read')\") .antMatchers(HttpMethod.POST, \"/**\").access(\"#oauth2.hasScope('write')\") .antMatchers(HttpMethod.PATCH, \"/**\").access(\"#oauth2.hasScope('write')\") .antMatchers(HttpMethod.PUT, \"/**\").access(\"#oauth2.hasScope('write')\") .antMatchers(HttpMethod.DELETE, \"/**\").access(\"#oauth2.hasScope('write')\") .and() .headers().addHeaderWriter((request, response) -\u003e { response.addHeader(\"Access-Control-Allow-Origin\", \"*\"); if (request.getMethod().equals(\"OPTIONS\")) { response.setHeader(\"Access-Control-Allow-Methods\", request.getHeader(\"Access-Control-Request-Method\")); response.setHeader(\"Access-Control-Allow-Headers\", request.getHeader(\"Access-Control-Request-Headers\")); } }); } } 使用以下 Curl 客户端测试产品列表端点：\n#!/bin/sh TOKEN=`curl -s -u curl_client:user -X POST localhost:8081/oauth/token\\?grant_type=client_credentials | egrep -o ‘[a-f0–9-]{20,}’` echo “ tGot token for curl client as :$TOKEN” curl localhost:8083/product/products -H “Authorization: Bearer $TOKEN” 运行 Curl 客户端 bash 脚本后得到响应：\n$ ./client.sh Got token for curl client as : 3be01519–0cab-4049-b87d-617c48bda502 [{“version”:0,”name”:”product_1\",”available”:false},{“version”:0,”name”:”product_2\",”available”:true}] 从 github 上查看整个代码：https://github.com/Akourtiim/oauth2-spring-boot-2.0.2.git\n参考：\nhttps://tools.ietf.org/html/rfc6749 https://dzone.com/articles/secure-spring-rest-with-spring-security-and-oauth2 http://www.bubblecode.net/en/2016/01/22/understanding-oauth2/ https://github.com/FrontierPsychiatrist/spring-oauth-example 原文链接：Oauth 2 Centralized Authorization with Spring Boot 2.0.2 and Spring Security 5 and JDBC token store\n","wordCount":"2108","inLanguage":"en","datePublished":"2023-07-14T09:00:00+08:00","dateModified":"2023-07-14T09:00:00+08:00","author":{"@type":"Person","name":"chensoul"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.chensoul.com/posts/2023/07/14/oauth-2-centralized-authorization-with-spring-boot-2-and-spring-security-5-and-jdbc-token-store/"},"publisher":{"@type":"Organization","name":"ChenSoul","logo":{"@type":"ImageObject","url":"https://blog.chensoul.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://blog.chensoul.com/ accesskey=h title="ChenSoul (Alt + H)">ChenSoul</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://blog.chensoul.com/categories/ideas title=周报><span>周报</span></a></li><li><a href=https://blog.chensoul.com/categories/notes title=编程><span>编程</span></a></li><li><a href=https://blog.chensoul.com/tags title=标签><span>标签</span></a></li><li><a href=https://blog.chensoul.com/about title=关于><span>关于</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>[译]使用Spring Boot2和Spring Security 5以及JDBC令牌存储进行Oauth2集中授权</h1><div class=post-meta><span title='2023-07-14 09:00:00 +0800 +0800'>2023-07-14</span>&nbsp;·&nbsp;chensoul</div></header><div class=post-content><p>在这篇文章中，我们将了解如何使用 Spring Boot 2 和 Spring Security 5 OAuth2 来实现集中授权的授权服务器以及如何通过 GUI 对其进行管理，还将提供资源服务器演示以及 github 下的整个项目。</p><p>很多示例涵盖了基于早期版本的 Spring boot 2 和 Spring Security 5 使用内存令牌实现 Oauth2，因此想法是使用 MySql 数据库作为令牌存储。</p><p>为了深入探讨这个主题，我们必须：</p><ul><li>配置Spring安全。</li><li>配置数据库。</li><li>创建授权服务器。</li><li>创建资源服务器。</li><li>使用curl 客户端使用访问令牌获取安全资源。</li></ul><h2 id=什么是-oauth-2>什么是 Oauth 2？<a hidden class=anchor aria-hidden=true href=#什么是-oauth-2>#</a></h2><p>OAuth 2.0 是行业标准授权协议。 OAuth 2.0 取代了 2006 年创建的原始 OAuth 协议上所做的工作。OAuth 2.0 注重客户端开发人员的简单性，同时为 Web 应用程序、桌面应用程序、移动电话和客厅设备提供特定的授权流程。</p><p>该规范及其扩展正在 <a href=https://www.ietf.org/mailman/listinfo/oauth>IETF OAuth 工作组内</a>开发。</p><h2 id=oauth-2-角色>Oauth 2 角色<a hidden class=anchor aria-hidden=true href=#oauth-2-角色>#</a></h2><p>OAuth2定义了4个角色：</p><ul><li><p>资源所有者：通常是您自己。</p></li><li><p>资源服务器：托管受保护数据的服务器（例如 Google 托管您的个人资料和个人信息）。</p></li><li><p>客户端：请求访问资源服务器的应用程序（网站、Javascript 应用程序或移动应用程序&mldr;&mldr;）。</p></li><li><p>授权服务器：向客户端颁发访问令牌的服务器。该令牌将用于客户端请求资源服务器。该服务器可以与资源服务器相同（相同的物理服务器和相同的应用程序），而且经常是这种情况。</p></li></ul><p>下图说明了角色流程：</p><p><img loading=lazy src=https://miro.medium.com/v2/resize:fit:862/1*LrU0kZBljjwd32vLy5IlwA.png alt=img></p><h2 id=授权类型>授权类型<a hidden class=anchor aria-hidden=true href=#授权类型>#</a></h2><p>OAuth 2 为不同的用例提供了多种“授权类型”。定义的授权类型型有：</p><ul><li>授权码：授权码授予是使用您的 Facebook 或 Google 帐户登录应用程序的功能。</li><li>密码：旨在用于基于用户代理的客户端。其次，授权服务器不会像授权代码授予那样返回授权代码来交换访问令牌，而是返回访问令牌。</li><li>客户端凭据：客户端可以仅使用其客户端凭据（或其他支持的身份验证方式）请求访问令牌，当客户端请求访问其下的受保护资源控制权，或先前已被其他资源所有者控制的与授权服务器安排。</li><li>隐式授权：隐式授权是一种简化的授权代码流，针对使用 JavaScript 等脚本语言在浏览器中实现的客户端进行了优化。在隐式流程中，而不是向客户端发出授权代码，直接向客户端颁发访问令牌。</li></ul><h2 id=示范>示范<a hidden class=anchor aria-hidden=true href=#示范>#</a></h2><p>让我们动手吧</p><h3 id=业务层><strong>业务层</strong><a hidden class=anchor aria-hidden=true href=#业务层>#</a></h3><p>为简单起见，我们的主要业务应用程序将是使用一个实体的产品 API，我们的访问规则将是：</p><ul><li>PRODUCT_CREATE</li><li>PRODUCT_UPDATE</li><li>PRODUCT_DISPLAY</li><li>PRODUCT_ADMIN</li></ul><h3 id=oauth2-客户端设置>OAuth2 客户端设置<a hidden class=anchor aria-hidden=true href=#oauth2-客户端设置>#</a></h3><p>要设置 Oauth 2 客户端，我们需要创建下表 [有关更多详细信息，请参阅链接]</p><ul><li><a href=https://github.com/spring-projects/spring-security-oauth/blob/2.2.1.RELEASE/spring-security-oauth2/src/main/java/org/springframework/security/oauth2/provider/client/JdbcClientDetailsService.java>OAUTH_CLIENT_DETAILS OAUTH_CLIENT_DETAILS</a></li><li><a href=https://github.com/spring-projects/spring-security-oauth/blob/2.2.1.RELEASE/spring-security-oauth2/src/main/java/org/springframework/security/oauth2/client/token/JdbcClientTokenServices.java>OAUTH_CLIENT_TOKEN OAUTH_CLIENT_TOKEN</a></li><li><a href=https://github.com/spring-projects/spring-security-oauth/blob/2.2.1.RELEASE/spring-security-oauth2/src/main/java/org/springframework/security/oauth2/provider/token/store/JdbcTokenStore.java>OAUTH_ACCESS_TOKEN OAUTH_ACCESS_TOKEN</a></li><li><a href=https://github.com/spring-projects/spring-security-oauth/blob/2.2.1.RELEASE/spring-security-oauth2/src/main/java/org/springframework/security/oauth2/provider/token/store/JdbcTokenStore.java>OAUTH_REFRESH_TOKEN OAUTH_REFRESH_TOKEN</a></li><li><a href=https://github.com/spring-projects/spring-security-oauth/blob/2.2.1.RELEASE/spring-security-oauth2/src/main/java/org/springframework/security/oauth2/provider/code/JdbcAuthorizationCodeServices.java>OAUTH_CODE OAUTH_代码</a></li><li><a href=https://github.com/spring-projects/spring-security-oauth/blob/2.2.1.RELEASE/spring-security-oauth2/src/main/java/org/springframework/security/oauth2/provider/approval/JdbcApprovalStore.java>OAUTH_APPROVALS OAUTH_APPROVALS</a></li></ul><p>我们将调用像“product_api”这样的资源服务器 对于该服务器，我们定义一个客户端，称为：</p><ul><li>读-写-客户端（授权授权类型：读、写）</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>INSERT</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=n>OAUTH_CLIENT_DETAILS</span><span class=p>(</span><span class=n>CLIENT_ID</span><span class=p>,</span><span class=w> </span><span class=n>RESOURCE_IDS</span><span class=p>,</span><span class=w> </span><span class=n>CLIENT_SECRET</span><span class=p>,</span><span class=w> </span><span class=k>SCOPE</span><span class=p>,</span><span class=w> </span><span class=n>AUTHORIZED_GRANT_TYPES</span><span class=p>,</span><span class=w> </span><span class=n>AUTHORITIES</span><span class=p>,</span><span class=w> </span><span class=n>ACCESS_TOKEN_VALIDITY</span><span class=p>,</span><span class=w> </span><span class=n>REFRESH_TOKEN_VALIDITY</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>VALUES</span><span class=w> </span><span class=p>(</span><span class=s1>&#39;read-write-client&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;product-api&#39;</span><span class=p>,</span><span class=s1>&#39;$2a$10$BurTWIy5NTF9GJJH4magz.9Bd4bBurWYG8tmXxeQh1vs7r/wnCFG2&#39;</span><span class=p>,</span><span class=s1>&#39;read,write&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;client_credentials&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;ROLE_PRODUCT_ADMIN&#39;</span><span class=p>,</span><span class=w> </span><span class=mi>10800</span><span class=p>,</span><span class=w> </span><span class=mi>2592000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>#</span><span class=n>password</span><span class=w> </span><span class=p>[</span><span class=n>hashed</span><span class=w> </span><span class=k>with</span><span class=w> </span><span class=n>BCCrypt</span><span class=p>]</span><span class=w> </span><span class=p>:</span><span class=k>user</span><span class=w> 
</span></span></span></code></pre></div><h3 id=权限和用户设置>权限和用户设置<a hidden class=anchor aria-hidden=true href=#权限和用户设置>#</a></h3><p>Spring Security 附带两个有用的接口：</p><ul><li><p><a href=https://docs.spring.io/spring-security/site/docs/5.0.x/api/org/springframework/security/core/userdetails/UserDetails.html>UserDetails</a> — 提供核心用户信息。</p></li><li><p><a href=https://docs.spring.io/spring-security/site/docs/5.0.x/api/org/springframework/security/core/GrantedAuthority.html>GrantedAuthority</a> — 表示授予身份验证对象的权限。</p></li></ul><p>下面的脚本将加载所有权限和凭据（用户）：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>INSERT</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=n>authority</span><span class=w>  </span><span class=k>VALUES</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=s1>&#39;ROLE_OAUTH_ADMIN&#39;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>INSERT</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=n>authority</span><span class=w> </span><span class=k>VALUES</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span><span class=s1>&#39;ROLE_ADMIN_PRODUCT&#39;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>INSERT</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=n>authority</span><span class=w> </span><span class=k>VALUES</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span><span class=s1>&#39;ROLE_RESOURCE_ADMIN&#39;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>INSERT</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=n>credentials</span><span class=w> </span><span class=k>VALUES</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=n>b</span><span class=s1>&#39;1&#39;</span><span class=p>,</span><span class=s1>&#39;oauth_admin&#39;</span><span class=p>,</span><span class=s1>&#39;$2a$10$BurTWIy5NTF9GJJH4magz.9Bd4bBurWYG8tmXxeQh1vs7r/wnCFG2&#39;</span><span class=p>,</span><span class=s1>&#39;0&#39;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>INSERT</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=n>credentials</span><span class=w> </span><span class=k>VALUES</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span><span class=n>b</span><span class=s1>&#39;1&#39;</span><span class=p>,</span><span class=s1>&#39;resource_admin&#39;</span><span class=p>,</span><span class=s1>&#39;$2a$10$BurTWIy5NTF9GJJH4magz.9Bd4bBurWYG8tmXxeQh1vs7r/wnCFG2&#39;</span><span class=p>,</span><span class=s1>&#39;0&#39;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>INSERT</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=n>credentials</span><span class=w>  </span><span class=k>VALUES</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span><span class=n>b</span><span class=s1>&#39;1&#39;</span><span class=p>,</span><span class=s1>&#39;user&#39;</span><span class=p>,</span><span class=s1>&#39;$2a$10$BurTWIy5NTF9GJJH4magz.9Bd4bBurWYG8tmXxeQh1vs7r/wnCFG2&#39;</span><span class=p>,</span><span class=s1>&#39;0&#39;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>INSERT</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=n>credentials_authorities</span><span class=w> </span><span class=k>VALUES</span><span class=w> </span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>INSERT</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=n>credentials_authorities</span><span class=w> </span><span class=k>VALUES</span><span class=w> </span><span class=p>(</span><span class=mi>2</span><span class=p>,</span><span class=w> </span><span class=mi>3</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>INSERT</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=n>credentials_authorities</span><span class=w> </span><span class=k>VALUES</span><span class=w> </span><span class=p>(</span><span class=mi>3</span><span class=p>,</span><span class=w> </span><span class=mi>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>#</span><span class=n>Password</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=k>user</span><span class=w>
</span></span></span></code></pre></div><h3 id=api层>API层<a hidden class=anchor aria-hidden=true href=#api层>#</a></h3><p>对于演示，基于 Spring Boot 开发了 RESTful 应用程序并公开以下端点：</p><p><img loading=lazy src=https://miro.medium.com/v2/resize:fit:1400/1*hHVGQGdvto-JkXNCZxzNyw.jpeg alt=img></p><h3 id=spring安全配置>Spring安全配置<a hidden class=anchor aria-hidden=true href=#spring安全配置>#</a></h3><p>我们必须提供 <a href=https://docs.spring.io/spring-security/site/docs/4.2.3.RELEASE/apidocs/org/springframework/security/core/userdetails/UserDetailsService.html>UserDetailsService</a> 接口的实现，以便获取用户凭据和权限，如下所示</p><p><img loading=lazy src=https://miro.medium.com/v2/resize:fit:1400/1*dyyiX3P9XSdsPuYQyc4_kA.jpeg alt=img></p><p>为了向应用程序提供安全性，我们将使用 <a href=https://docs.spring.io/spring-security/site/docs/4.2.3.RELEASE/apidocs/org/springframework/security/config/annotation/web/configuration/EnableWebSecurity.html>@EnableWebSecurity</a> 注释和 WebSecurityConfigurerAdapter</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>package</span> <span class=nn>com.aak.configuration</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>org.springframework.context.annotation.Bean</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>org.springframework.context.annotation.Configuration</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>org.springframework.security.config.annotation.web.builders.HttpSecurity</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>org.springframework.security.config.annotation.web.builders.WebSecurity</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>org.springframework.security.config.annotation.web.configuration.EnableWebSecurity</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>org.springframework.security.core.userdetails.UserDetailsService</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>org.springframework.security.crypto.password.PasswordEncoder</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>org.springframework.security.provisioning.JdbcUserDetailsManager</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>org.springframework.security.web.util.matcher.AntPathRequestMatcher</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Created by ahmed on 20.5.18.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nd>@EnableWebSecurity</span>
</span></span><span class=line><span class=cl><span class=nd>@Configuration</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>WebSecurityConfiguration</span> <span class=kd>extends</span> <span class=n>WebSecurityConfigurerAdapter</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Bean</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>PasswordEncoder</span> <span class=nf>passwordEncoder</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>new</span> <span class=n>BCryptPasswordEncoder</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Bean</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>UserDetailsService</span> <span class=nf>userDetailsServiceBean</span><span class=o>()</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>new</span> <span class=n>JdbcUserDetails</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>configure</span><span class=o>(</span><span class=n>WebSecurity</span> <span class=n>web</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>web</span><span class=o>.</span><span class=na>ignoring</span><span class=o>().</span><span class=na>antMatchers</span><span class=o>(</span><span class=s>&#34;/webjars/**&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>configure</span><span class=o>(</span><span class=n>HttpSecurity</span> <span class=n>http</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>http</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>authorizeRequests</span><span class=o>()</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>antMatchers</span><span class=o>(</span><span class=s>&#34;/login&#34;</span><span class=o>,</span><span class=s>&#34;/logout.do&#34;</span><span class=o>).</span><span class=na>permitAll</span><span class=o>()</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>antMatchers</span><span class=o>(</span><span class=s>&#34;/**&#34;</span><span class=o>).</span><span class=na>authenticated</span><span class=o>()</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>and</span><span class=o>()</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>formLogin</span><span class=o>()</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>loginProcessingUrl</span><span class=o>(</span><span class=s>&#34;/login.do&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>usernameParameter</span><span class=o>(</span><span class=s>&#34;username&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>passwordParameter</span><span class=o>(</span><span class=s>&#34;password&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>loginPage</span><span class=o>(</span><span class=s>&#34;/login&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>and</span><span class=o>()</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>logout</span><span class=o>()</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>logoutRequestMatcher</span><span class=o>(</span><span class=k>new</span> <span class=n>AntPathRequestMatcher</span><span class=o>(</span><span class=s>&#34;/logout.do&#34;</span><span class=o>))</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>and</span><span class=o>()</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>userDetailsService</span><span class=o>(</span><span class=n>userDetailsServiceBean</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>configure</span><span class=o>(</span><span class=n>AuthenticationManagerBuilder</span> <span class=n>auth</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>auth</span><span class=o>.</span><span class=na>userDetailsService</span><span class=o>(</span><span class=n>userDetailsServiceBean</span><span class=o>())</span>
</span></span><span class=line><span class=cl>        <span class=o>.</span><span class=na>passwordEncoder</span><span class=o>(</span><span class=n>passwordEncoder</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><h3 id=oauth2-配置>OAuth2 配置<a hidden class=anchor aria-hidden=true href=#oauth2-配置>#</a></h3><p>要设置 Oauth 2，需要实现两个组件</p><ul><li>Authorization Server 授权服务器</li><li>Resource Server 资源服务器</li></ul><h3 id=授权服务器>授权服务器<a hidden class=anchor aria-hidden=true href=#授权服务器>#</a></h3><p>授权服务器负责验证用户身份并提供令牌，使用@EnableAuthorizationServer注解启用授权服务器配置</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>package</span> <span class=nn>com.aak.configuration</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>org.springframework.boot.context.properties.ConfigurationProperties</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>org.springframework.boot.jdbc.DataSourceBuilder</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>org.springframework.context.annotation.Bean</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>org.springframework.context.annotation.Configuration</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>org.springframework.security.oauth2.config.annotation.configurers.ClientDetailsServiceConfigurer</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>org.springframework.security.oauth2.config.annotation.web.configuration.AuthorizationServerConfigurerAdapter</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>org.springframework.security.oauth2.config.annotation.web.configuration.EnableAuthorizationServer</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>org.springframework.security.oauth2.config.annotation.web.configurers.AuthorizationServerEndpointsConfigurer</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>org.springframework.security.oauth2.config.annotation.web.configurers.AuthorizationServerSecurityConfigurer</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>org.springframework.security.oauth2.provider.approval.ApprovalStore</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>org.springframework.security.oauth2.provider.approval.JdbcApprovalStore</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>org.springframework.security.oauth2.provider.client.JdbcClientDetailsService</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>org.springframework.security.oauth2.provider.code.AuthorizationCodeServices</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>org.springframework.security.oauth2.provider.code.JdbcAuthorizationCodeServices</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>org.springframework.security.oauth2.provider.token.TokenStore</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>org.springframework.security.oauth2.provider.token.store.JdbcTokenStore</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>javax.sql.DataSource</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Created by ahmed on 21.5.18.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nd>@Configuration</span>
</span></span><span class=line><span class=cl><span class=nd>@EnableAuthorizationServer</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>AuthorizationServerConfiguration</span> <span class=kd>extends</span> <span class=n>AuthorizationServerConfigurerAdapter</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Bean</span>
</span></span><span class=line><span class=cl>    <span class=nd>@ConfigurationProperties</span><span class=o>(</span><span class=n>prefix</span> <span class=o>=</span> <span class=s>&#34;spring.datasource&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>DataSource</span> <span class=nf>oauthDataSource</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>DataSourceBuilder</span><span class=o>.</span><span class=na>create</span><span class=o>().</span><span class=na>build</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Bean</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>JdbcClientDetailsService</span> <span class=nf>clientDetailsService</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>new</span> <span class=n>JdbcClientDetailsService</span><span class=o>(</span><span class=n>oauthDataSource</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Bean</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>TokenStore</span> <span class=nf>tokenStore</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>new</span> <span class=n>JdbcTokenStore</span><span class=o>(</span><span class=n>oauthDataSource</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Bean</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>ApprovalStore</span> <span class=nf>approvalStore</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>new</span> <span class=n>JdbcApprovalStore</span><span class=o>(</span><span class=n>oauthDataSource</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Bean</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>AuthorizationCodeServices</span> <span class=nf>authorizationCodeServices</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>new</span> <span class=n>JdbcAuthorizationCodeServices</span><span class=o>(</span><span class=n>oauthDataSource</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>configure</span><span class=o>(</span><span class=n>ClientDetailsServiceConfigurer</span> <span class=n>clients</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>clients</span><span class=o>.</span><span class=na>withClientDetails</span><span class=o>(</span><span class=n>clientDetailsService</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>configure</span><span class=o>(</span><span class=n>AuthorizationServerSecurityConfigurer</span> <span class=n>oauthServer</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>configure</span><span class=o>(</span><span class=n>AuthorizationServerEndpointsConfigurer</span> <span class=n>endpoints</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>endpoints</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>approvalStore</span><span class=o>(</span><span class=n>approvalStore</span><span class=o>())</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>authorizationCodeServices</span><span class=o>(</span><span class=n>authorizationCodeServices</span><span class=o>())</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>tokenStore</span><span class=o>(</span><span class=n>tokenStore</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>成功配置运行授权服务器后，您将获得登录页面来管理授权服务器</p><p><img loading=lazy src=https://miro.medium.com/v2/resize:fit:1400/1*2pQ9mmQ-AvOv3uBctFPHew.jpeg alt=img></p><p>使用 oauth_admin/user 作为用户名/密码访问 Oauth2 仪表板，您可以在其中创建服务器客户端</p><p><img loading=lazy src=https://miro.medium.com/v2/resize:fit:1400/1*L4h4ZNPrYt0sa8Qln_c4NA.jpeg alt=img></p><h2 id=资源服务器>资源服务器<a hidden class=anchor aria-hidden=true href=#资源服务器>#</a></h2><p>资源服务器托管受 OAuth2 令牌保护的资源（基本上是我们的产品 API）</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>package</span> <span class=nn>com.aak.configuration</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>org.springframework.boot.context.properties.ConfigurationProperties</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>org.springframework.boot.jdbc.DataSourceBuilder</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>org.springframework.context.annotation.Bean</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>org.springframework.context.annotation.Configuration</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>org.springframework.http.HttpMethod</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>org.springframework.security.config.annotation.web.builders.HttpSecurity</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>org.springframework.security.oauth2.config.annotation.web.configuration.EnableResourceServer</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>org.springframework.security.oauth2.config.annotation.web.configuration.ResourceServerConfigurerAdapter</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>org.springframework.security.oauth2.config.annotation.web.configurers.ResourceServerSecurityConfigurer</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>org.springframework.security.oauth2.provider.token.TokenStore</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>org.springframework.security.oauth2.provider.token.store.JdbcTokenStore</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>javax.sql.DataSource</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Created by ahmed on 30.5.18.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nd>@EnableResourceServer</span>
</span></span><span class=line><span class=cl><span class=nd>@Configuration</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>ResourcesServerConfiguration</span>  <span class=kd>extends</span> <span class=n>ResourceServerConfigurerAdapter</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Bean</span>
</span></span><span class=line><span class=cl>    <span class=nd>@ConfigurationProperties</span><span class=o>(</span><span class=n>prefix</span><span class=o>=</span><span class=s>&#34;spring.datasource&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>DataSource</span> <span class=nf>ouathDataSource</span><span class=o>(){</span><span class=k>return</span> <span class=n>DataSourceBuilder</span><span class=o>.</span><span class=na>create</span><span class=o>().</span><span class=na>build</span><span class=o>();}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>configure</span><span class=o>(</span><span class=n>ResourceServerSecurityConfigurer</span> <span class=n>resources</span><span class=o>)</span><span class=kd>throws</span> <span class=n>Exception</span><span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>TokenStore</span> <span class=n>tokenStore</span><span class=o>=</span><span class=k>new</span> <span class=n>JdbcTokenStore</span><span class=o>(</span><span class=n>ouathDataSource</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=n>resources</span><span class=o>.</span><span class=na>resourceId</span><span class=o>(</span><span class=s>&#34;product_api&#34;</span><span class=o>).</span><span class=na>tokenStore</span><span class=o>(</span><span class=n>tokenStore</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>configure</span><span class=o>(</span><span class=n>HttpSecurity</span> <span class=n>http</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span><span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>http</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>authorizeRequests</span><span class=o>()</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>antMatchers</span><span class=o>(</span><span class=n>HttpMethod</span><span class=o>.</span><span class=na>GET</span><span class=o>,</span> <span class=s>&#34;/**&#34;</span><span class=o>).</span><span class=na>access</span><span class=o>(</span><span class=s>&#34;#oauth2.hasScope(&#39;read&#39;)&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>antMatchers</span><span class=o>(</span><span class=n>HttpMethod</span><span class=o>.</span><span class=na>POST</span><span class=o>,</span> <span class=s>&#34;/**&#34;</span><span class=o>).</span><span class=na>access</span><span class=o>(</span><span class=s>&#34;#oauth2.hasScope(&#39;write&#39;)&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>antMatchers</span><span class=o>(</span><span class=n>HttpMethod</span><span class=o>.</span><span class=na>PATCH</span><span class=o>,</span> <span class=s>&#34;/**&#34;</span><span class=o>).</span><span class=na>access</span><span class=o>(</span><span class=s>&#34;#oauth2.hasScope(&#39;write&#39;)&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>antMatchers</span><span class=o>(</span><span class=n>HttpMethod</span><span class=o>.</span><span class=na>PUT</span><span class=o>,</span> <span class=s>&#34;/**&#34;</span><span class=o>).</span><span class=na>access</span><span class=o>(</span><span class=s>&#34;#oauth2.hasScope(&#39;write&#39;)&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>antMatchers</span><span class=o>(</span><span class=n>HttpMethod</span><span class=o>.</span><span class=na>DELETE</span><span class=o>,</span> <span class=s>&#34;/**&#34;</span><span class=o>).</span><span class=na>access</span><span class=o>(</span><span class=s>&#34;#oauth2.hasScope(&#39;write&#39;)&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>and</span><span class=o>()</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>headers</span><span class=o>().</span><span class=na>addHeaderWriter</span><span class=o>((</span><span class=n>request</span><span class=o>,</span> <span class=n>response</span><span class=o>)</span> <span class=o>-&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            			<span class=n>response</span><span class=o>.</span><span class=na>addHeader</span><span class=o>(</span><span class=s>&#34;Access-Control-Allow-Origin&#34;</span><span class=o>,</span> <span class=s>&#34;*&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                  <span class=k>if</span> <span class=o>(</span><span class=n>request</span><span class=o>.</span><span class=na>getMethod</span><span class=o>().</span><span class=na>equals</span><span class=o>(</span><span class=s>&#34;OPTIONS&#34;</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                      <span class=n>response</span><span class=o>.</span><span class=na>setHeader</span><span class=o>(</span><span class=s>&#34;Access-Control-Allow-Methods&#34;</span><span class=o>,</span> <span class=n>request</span><span class=o>.</span><span class=na>getHeader</span><span class=o>(</span><span class=s>&#34;Access-Control-Request-Method&#34;</span><span class=o>));</span>
</span></span><span class=line><span class=cl>                      <span class=n>response</span><span class=o>.</span><span class=na>setHeader</span><span class=o>(</span><span class=s>&#34;Access-Control-Allow-Headers&#34;</span><span class=o>,</span> <span class=n>request</span><span class=o>.</span><span class=na>getHeader</span><span class=o>(</span><span class=s>&#34;Access-Control-Request-Headers&#34;</span><span class=o>));</span>
</span></span><span class=line><span class=cl>                  <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>});</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>使用以下 Curl 客户端测试产品列表端点：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=cp>#!/bin/sh
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=nv>TOKEN</span><span class=o>=</span><span class=sb>`</span>curl -s -u curl_client:user -X POST localhost:8081/oauth/token<span class=se>\?</span><span class=nv>grant_type</span><span class=o>=</span>client_credentials <span class=p>|</span> egrep -o ‘<span class=o>[</span>a-f0–9-<span class=o>]{</span>20,<span class=o>}</span>’<span class=sb>`</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> “ tGot token <span class=k>for</span> curl client as :<span class=nv>$TOKEN</span>”
</span></span><span class=line><span class=cl>curl localhost:8083/product/products -H “Authorization: Bearer <span class=nv>$TOKEN</span>”
</span></span></code></pre></div><p>运行 Curl 客户端 bash 脚本后得到响应：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ ./client.sh
</span></span><span class=line><span class=cl>Got token <span class=k>for</span> curl client as : 3be01519–0cab-4049-b87d-617c48bda502
</span></span><span class=line><span class=cl><span class=o>[{</span>“version”:0,”name”:”product_1<span class=s2>&#34;,”available”:false},{“version”:0,”name”:”product_2&#34;</span>,”available”:true<span class=o>}]</span>
</span></span></code></pre></div><p>从 github 上查看整个代码：https://github.com/Akourtiim/oauth2-spring-boot-2.0.2.git</p><p><strong>参考：</strong></p><ul><li><a href=https://tools.ietf.org/html/rfc6749>https://tools.ietf.org/html/rfc6749</a></li><li><a href=https://dzone.com/articles/secure-spring-rest-with-spring-security-and-oauth2>https://dzone.com/articles/secure-spring-rest-with-spring-security-and-oauth2</a></li><li><a href=http://www.bubblecode.net/en/2016/01/22/understanding-oauth2/>http://www.bubblecode.net/en/2016/01/22/understanding-oauth2/</a></li><li><a href=https://github.com/FrontierPsychiatrist/spring-oauth-example>https://github.com/FrontierPsychiatrist/spring-oauth-example</a></li></ul><p>原文链接：<a href=https://akourtim-ahmed.medium.com/oauth-2-centralized-authorization-with-spring-boot-2-0-2-and-spring-security-5-and-jdbc-token-store-8dbc063bd5d4>Oauth 2 Centralized Authorization with Spring Boot 2.0.2 and Spring Security 5 and JDBC token store</a></p></div><footer class=post-footer><ul class=post-tags><li><a href=https://blog.chensoul.com/tags/java/>java</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://blog.chensoul.com/>ChenSoul</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script async src=https://umami.chensoul.com/script.js data-website-id=f110cfa0-b737-4690-a032-2b9073a57fc3></script>
<script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>