<!doctype html><html lang=en-US prefix="og: http://ogp.me/ns#"><head><meta charset=utf-8><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="概述
在本文中，我们将创建一个授权服务器，为任何客户端生成 access_token。这称为 OAuth2 的 client_credentials 流程。它主要用于服务间通信。"><title>[译]Spring Boot授权服务器 - 使用 Java 的资源服务器和客户端凭证示例 | ChenSoul</title>
<link rel=canonical href=https://blog.chensoul.cc/posts/2023/07/26/spring-boot-authorization-server/><link rel=preconnect href=https://fonts.font.im><link rel=preconnect href=https://fonts.loli.net crossorigin><link href="https://fonts.loli.net/css2?family=Roboto+Slab:wght@400;500;700&display=swap" rel=stylesheet><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://blog.chensoul.cc/images/favicon.webp"><meta name=twitter:title content="[译]Spring Boot授权服务器 - 使用 Java 的资源服务器和客户端凭证示例"><meta name=twitter:description content="概述 在本文中，我们将创建一个授权服务器，为任何客户端生成 access_token。这称为 OAuth2 的 client_credentials 流程。它主要用于服务间通信。"><meta name=twitter:creator content="@ichensoul"><meta property="og:locale" content="en_US"><meta property="og:site_name" content="chensoul"><meta property="og:url" content="https://blog.chensoul.cc/posts/2023/07/26/spring-boot-authorization-server/"><meta property="og:site_name" content="ChenSoul"><meta property="og:title" content="[译]Spring Boot授权服务器 - 使用 Java 的资源服务器和客户端凭证示例"><meta property="og:description" content="概述 在本文中，我们将创建一个授权服务器，为任何客户端生成 access_token。这称为 OAuth2 的 client_credentials 流程。它主要用于服务间通信。"><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-07-26T00:00:00+00:00"><meta property="article:modified_time" content="2023-07-26T00:00:00+00:00"><meta property="article:tag" content="Spring-Security"><meta property="article:tag" content="Oauth2"><meta property="og:image" content="https://blog.chensoul.cc/images/favicon.webp"><meta itemprop=name content="[译]Spring Boot授权服务器 - 使用 Java 的资源服务器和客户端凭证示例"><meta itemprop=description content="概述 在本文中，我们将创建一个授权服务器，为任何客户端生成 access_token。这称为 OAuth2 的 client_credentials 流程。它主要用于服务间通信。"><meta itemprop=datePublished content="2023-07-26T00:00:00+00:00"><meta itemprop=dateModified content="2023-07-26T00:00:00+00:00"><meta itemprop=wordCount content="462"><meta itemprop=image content="https://blog.chensoul.cc/images/favicon.webp"><meta itemprop=keywords content="Spring-Security,Oauth2"><link rel=stylesheet href=https://cdnjs.loli.net/ajax/libs/font-awesome/6.4.0/css/all.min.css media=all><link rel=stylesheet href=/main.min.css type=text/css media=all><link rel="shortcut icon" href=/favicon.ico type=image/x-icon><script type=application/ld+json>{"@context":"https://schema.org","@graph":[{"@type":"TechArticle","name":"[译]Spring Boot授权服务器 - 使用 Java 的资源服务器和客户端凭证示例","headline":"[译]Spring Boot授权服务器 - 使用 Java 的资源服务器和客户端凭证示例","inLanguage":"en-US","url":"https://blog.chensoul.cc/posts/2023/07/26/spring-boot-authorization-server/","description":"\u003ch1 id=\"概述\"\u003e概述\u003c/h1\u003e\n\u003cp\u003e在本文中，我们将创建一个授权服务器，为任何客户端生成 access_token。这称为 OAuth2 的 \u003ccode\u003eclient_credentials\u003c/code\u003e 流程。它主要用于服务间通信。\u003c/p\u003e","wordCount":"462","keywords":["spring-security","oauth2"],"datePublished":"2023-07-26T00:00:00Z","dateModified":"2023-07-26T00:00:00Z","author":{"@type":"Person","name":"chensoul"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.chensoul.cc/posts/2023/07/26/spring-boot-authorization-server/"},"publisher":{"@type":"Organization","name":"chensoul","url":"https://blog.chensoul.cc/posts/2023/07/26/spring-boot-authorization-server/"}},{"@context":"https://schema.org","@type":"Organization","name":"chensoul","url":"https://blog.chensoul.cc/","sameAs":["https://x.com/ichensoul","https://github.com/chensoul","https://www.linkedin.com/in/","https://www.youtube.com/@chensoul","https://t.me/chensouls"]}]}</script><script defer src=https://umami.chensoul.cc/random-string.js data-website-id=821c25f8-a31a-4607-92d7-91ee76843d00></script></head><body class="home blog post-layout-one-column"><button onclick=topFunction() id=scrollTopBtn title="Go to top">
<i class="fa-solid fa-arrow-up"></i></button><div id=header-top class=header-bar-wrap></div><div id=page class=site><a class="skip-link screen-reader-text" href=#content>Skip to content</a><header id=masthead class="site-header clearfix" role=banner><div class="header-main container clearfix"><div id=logo class="site-branding clearfix"><h1 class=site-title><a href=/ title=ChenSoul rel=home>ChenSoul</a></h1><p class=site-description>Java, Spring Boot, Microservice, Cloud, Architecture and DevOps Tutorials</p></div><div class="header-widgets clearfix"><aside id=search-2 class="header-widget widget_search"><form role=search method=get class=search-form onsubmit="return searchSite(event)"><label><span class=screen-reader-text>Search for:</span>
<input type=search class=search-field placeholder="Enter search keyword" name=query id=query title="Enter search keyword">
</label><button type=submit class=search-submit title=Search> <span class=genericon-search></span>
<span class=screen-reader-text>Search</span></button></form></aside></div></div><div id=main-navigation-wrap class=primary-navigation-wrap><nav id=main-navigation class="primary-navigation navigation container clearfix" role=navigation><ul id=menu-home class=main-navigation-menu><li class="menu-item menu-item-type-custom menu-item-object-custom
current-menu-item current_page_item menu-item-home"><a href=/>Home</a></li><li class="menu-item menu-item-type-taxonomy menu-item-object-category"><a href=/categories/spring-boot/>Spring Boot</a></li><li class="menu-item menu-item-type-taxonomy menu-item-object-category"><a href=/categories/architecture/>Architecture</a></li><li class="menu-item menu-item-type-taxonomy menu-item-object-category"><a href=/categories/microservice/>Microservice</a></li><li class="menu-item menu-item-type-taxonomy menu-item-object-category"><a href=/categories/kubernetes/>Kubernetes</a></li><li class="menu-item menu-item-type-taxonomy menu-item-object-category
menu-item-has-children"><a href=/tutorials/>Tutorials</a><ul class=sub-menu><li class="menu-item menu-item-type-taxonomy menu-item-object-category"><a href=/spring-boot-tutorials/>Spring Boot Tutorials</a></li><li class="menu-item menu-item-type-taxonomy menu-item-object-category"><a href=/microservice-tutorials/>Microservice Tutorials</a></li><li class="menu-item menu-item-type-taxonomy menu-item-object-category"><a href=/kubernetes-tutorials/>Kubernetes Tutorials</a></li></ul></li><li class="menu-item menu-item-type-post_type menu-item-object-page"><a href=https://github.com/chensoul target=_blank>About Me</a></li></ul></nav></div></header><div id=content class="site-content container clearfix"><section id=primary class="content-archive content-area post-content-area"><main id=main class=site-main role=main><article class="post type-post"><div class=post-inner-content><header class=entry-header><h2 class=entry-title><a href=https://blog.chensoul.cc/posts/2023/07/26/spring-boot-authorization-server/ rel=bookmark title="[译]Spring Boot授权服务器 - 使用 Java 的资源服务器和客户端凭证示例">[译]Spring Boot授权服务器 - 使用 Java 的资源服务器和客户端凭证示例</a></h2><div class=entry-meta><span class=meta-date><time class="entry-date published" datetime=2023-07-26T00:00:00>2023-07-26
</time></span><span class=meta-author><span class="author vcard">chensoul</span>
</span><span class="tagcloud post-tags"><i class="fa fa-tags"></i>&nbsp;
<a class="tag-cloud-link widget__link widget__link--taglist" href=/tags/spring-security/ title=spring-security>spring-security</a>
&nbsp;
<a class="tag-cloud-link widget__link widget__link--taglist" href=/tags/oauth2/ title=oauth2>oauth2</a></span></div></header><div style=background-color:#f1f3f5;margin-top:20px><aside style=margin:5px><span style=font-size:20px;font-weight:700>Table of Contents</span><div style=padding-left:30px><nav id=TableOfContents><ul><li><a href=#依赖项>依赖项：</a></li><li><a href=#java-实现>Java 实现：</a></li></ul><ul><li><a href=#依赖项-1>依赖项：</a></li><li><a href=#java-实现-1>Java 实现：</a></li></ul><ul><li><a href=#依赖项-2>依赖项：</a></li><li><a href=#java-实现-2>Java 实现：</a></li></ul></nav></div></aside></div><div class=entry-content><h1 id=概述>概述</h1><p>在本文中，我们将创建一个授权服务器，为任何客户端生成 access_token。这称为 OAuth2 的 <code>client_credentials</code> 流程。它主要用于服务间通信。</p><p>我们将使用 spring boot oauth2 授权服务器依赖项来创建身份验证服务器。我们还将创建一个资源服务器和客户端来对其进行端到端测试。</p><h1 id=spring-授权服务器>Spring 授权服务器</h1><p>我们首先创建授权服务器。</p><h2 id=依赖项>依赖项：</h2><p>让我们将以下依赖项添加到我们的项目中。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>implementation &#39;org.springframework.security:spring-security-oauth2-authorization-server:1.0.0&#39;
</span></span><span style=display:flex><span>implementation &#39;org.springframework.boot:spring-boot-starter-security&#39;
</span></span><span style=display:flex><span>implementation &#39;org.springframework.boot:spring-boot-starter-web&#39;
</span></span><span style=display:flex><span>testImplementation &#39;org.springframework.boot:spring-boot-starter-test&#39;
</span></span><span style=display:flex><span>testImplementation &#39;org.springframework.security:spring-security-test&#39;
</span></span></code></pre></div><p>我们正在使用 spring oauth2 依赖项的最新（当时）稳定版本。</p><h2 id=java-实现>Java 实现：</h2><p>让我们创建一个名为 AuthorizationServerConfig 的配置类，并向该类添加 @Configuration 注解。现在让我们创建以下 bean 来完成配置：</p><ul><li><strong>SecurityFilterChain</strong></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Order</span>(Ordered.<span style=color:#a6e22e>HIGHEST_PRECEDENCE</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> SecurityFilterChain <span style=color:#a6e22e>authServerSecurityFilterChain</span>(HttpSecurity http) <span style=color:#66d9ef>throws</span> Exception {
</span></span><span style=display:flex><span>    OAuth2AuthorizationServerConfiguration.<span style=color:#a6e22e>applyDefaultSecurity</span>(http);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> http.<span style=color:#a6e22e>build</span>();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>我们将把 bean 的顺序设置为最高，因为我们想首先执行它。</p><ul><li><strong>RegisteredClientRepository</strong></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> RegisteredClientRepository <span style=color:#a6e22e>registeredClientRepository</span>() {
</span></span><span style=display:flex><span>    RegisteredClient registeredClient <span style=color:#f92672>=</span> RegisteredClient.<span style=color:#a6e22e>withId</span>(UUID.<span style=color:#a6e22e>randomUUID</span>().<span style=color:#a6e22e>toString</span>())
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>clientId</span>(<span style=color:#e6db74>&#34;oauth-client&#34;</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>clientSecret</span>(<span style=color:#e6db74>&#34;{noop}oauth-secret&#34;</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>clientAuthenticationMethod</span>(ClientAuthenticationMethod.<span style=color:#a6e22e>CLIENT_SECRET_BASIC</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>authorizationGrantType</span>(AuthorizationGrantType.<span style=color:#a6e22e>CLIENT_CREDENTIALS</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>scope</span>(OidcScopes.<span style=color:#a6e22e>OPENID</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>scope</span>(<span style=color:#e6db74>&#34;articles.read&#34;</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>build</span>();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> InMemoryRegisteredClientRepository(registeredClient);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>现在让我们使用内存存储库对内容进行硬编码。我们可以根据我们的需要更新这些。</p><ul><li><strong>JwtDecoder</strong></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> JwtDecoder <span style=color:#a6e22e>jwtDecoder</span>(JWKSource<span style=color:#f92672>&lt;</span>SecurityContext<span style=color:#f92672>&gt;</span> jwkSource) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> OAuth2AuthorizationServerConfiguration.<span style=color:#a6e22e>jwtDecoder</span>(jwkSource);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>我们将使用它来解码令牌以进行验证。</p><ul><li><strong>JWKSource</strong></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> JWKSource<span style=color:#f92672>&lt;</span>SecurityContext<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>jwkSource</span>() <span style=color:#66d9ef>throws</span> NoSuchAlgorithmException {
</span></span><span style=display:flex><span>    RSAKey rsaKey <span style=color:#f92672>=</span> generateRsa();
</span></span><span style=display:flex><span>    JWKSet jwkSet <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> JWKSet(rsaKey);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> (jwkSelector, securityContext) <span style=color:#f92672>-&gt;</span> jwkSelector.<span style=color:#a6e22e>select</span>(jwkSet);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> RSAKey <span style=color:#a6e22e>generateRsa</span>() <span style=color:#66d9ef>throws</span> NoSuchAlgorithmException {
</span></span><span style=display:flex><span>    KeyPair keyPair <span style=color:#f92672>=</span> generateRsaKey();
</span></span><span style=display:flex><span>    RSAPublicKey publicKey <span style=color:#f92672>=</span> (RSAPublicKey) keyPair.<span style=color:#a6e22e>getPublic</span>();
</span></span><span style=display:flex><span>    RSAPrivateKey privateKey <span style=color:#f92672>=</span> (RSAPrivateKey) keyPair.<span style=color:#a6e22e>getPrivate</span>();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> RSAKey.<span style=color:#a6e22e>Builder</span>(publicKey)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>privateKey</span>(privateKey)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>keyID</span>(UUID.<span style=color:#a6e22e>randomUUID</span>().<span style=color:#a6e22e>toString</span>())
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>build</span>();
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> KeyPair <span style=color:#a6e22e>generateRsaKey</span>() <span style=color:#66d9ef>throws</span> NoSuchAlgorithmException {
</span></span><span style=display:flex><span>    KeyPairGenerator keyPairGenerator <span style=color:#f92672>=</span> KeyPairGenerator.<span style=color:#a6e22e>getInstance</span>(<span style=color:#e6db74>&#34;RSA&#34;</span>);
</span></span><span style=display:flex><span>    keyPairGenerator.<span style=color:#a6e22e>initialize</span>(2048);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> keyPairGenerator.<span style=color:#a6e22e>generateKeyPair</span>();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>我们在解码器 bean 中使用这个源，所以我们需要定义它。我们使用 RSA 2048 密钥对，我们也可以在需要时更改它。</p><ul><li><strong>AuthorizationServerSettings</strong></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> AuthorizationServerSettings <span style=color:#a6e22e>authorizationServerSettings</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> AuthorizationServerSettings.<span style=color:#a6e22e>builder</span>().<span style=color:#a6e22e>build</span>();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>现在我们已经配置了一切，让我们尝试运行应用程序并获取令牌：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -X POST <span style=color:#e6db74>&#39;http://localhost:9090/oauth2/token?grant_type=client_credentials&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --header <span style=color:#e6db74>&#39;Authorization: Basic b2F1dGgtY2xpZW50Om9hdXRoLXNlY3JldA==&#39;</span>
</span></span></code></pre></div><p>注意：根据您的配置更新端口号。</p><p>它应该给出如下响应：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;access_token&#34;</span>: <span style=color:#e6db74>&#34;eyJraWQiOiJiYWM0ZmMxYS02MGJiLTQ0ZTAtODU4MC1iNzcwYWU2MjkwZWEiLCJhbGciOiJSUzI1NiJ9.eyJzdWIiOiJvYXV0aC1jbGllbnQiLCJhdWQiOiJvYXV0aC1jbGllbnQiLCJuYmYiOjE2NzQ5ODYzNjcsImlzcyI6Imh0dHA6Ly9sb2NhbGhvc3Q6OTA5MCIsImV4cCI6MTY3NDk4NjY2NywiaWF0IjoxNjc0OTg2MzY3fQ.DxiIbV7jdRnW15WnnqcjFCLyfXmrU_trl1M3nxej_nIWK60Jx9Vm4HzpxBJugemhrMg-qizQ03TTNswfL9AgTIsLeh_D8TDjcQJy6XFWgElxfUYqUFeZmlXPmQKFmmPyIChlSAFbX1L8QvcgFE1c8GHC900RiKVgGLhT5MOZx5l1WBCbNQ_Rv2u9utcz7EqYTb0y_PjD4EC8UaGdGGlqvEAnKvRVIhxRqFarqh-OW4oUfwfwu1xQIvyWphSDegcOjIERFkhVcQeKO-a3zZS9sfJ03ppZhzAsa5O-qswtbzThO9SWQg7JUgyo7qd-zHIRhwPtEWxDGaBt2QGo7jjopw&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;token_type&#34;</span>: <span style=color:#e6db74>&#34;Bearer&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;expires_in&#34;</span>: <span style=color:#ae81ff>299</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h1 id=spring-资源服务器>Spring 资源服务器</h1><p>现在让我们创建一个受此身份验证服务器保护的 API 端点，其范围为我们在令牌创建中使用的 articles.read。</p><h2 id=依赖项-1>依赖项：</h2><p>让我们将以下依赖项添加到我们的项目中：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>implementation &#39;org.springframework.boot:spring-boot-starter-oauth2-resource-server&#39;
</span></span><span style=display:flex><span>implementation &#39;org.springframework.boot:spring-boot-starter-security&#39;
</span></span><span style=display:flex><span>implementation &#39;org.springframework.boot:spring-boot-starter-web&#39;
</span></span><span style=display:flex><span>testImplementation &#39;org.springframework.boot:spring-boot-starter-test&#39;
</span></span><span style=display:flex><span>testImplementation &#39;org.springframework.security:spring-security-test&#39;
</span></span></code></pre></div><h2 id=java-实现-1>Java 实现：</h2><p>让我们首先创建一个简单的 rest 控制器，然后创建一个配置，以在正确的范围内保护该 API。之后，我们将在 application.yml 文件中配置身份验证服务器设置。</p><ul><li><strong>API 控制器</strong></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@RestController</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ArticlesController</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@GetMapping</span>(<span style=color:#e6db74>&#34;/articles&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String<span style=color:#f92672>[]</span> <span style=color:#a6e22e>getArticles</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> String<span style=color:#f92672>[]</span> { <span style=color:#e6db74>&#34;Article 1&#34;</span>, <span style=color:#e6db74>&#34;Article 2&#34;</span>, <span style=color:#e6db74>&#34;Article 3&#34;</span> };
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>我们创建了一个简单的 GET API 端点 /articles，它将返回文章列表。</p><ul><li><strong>ResourceServerConfig</strong></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@EnableWebSecurity</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ResourceServerConfig</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>    SecurityFilterChain <span style=color:#a6e22e>securityFilterChain</span>(HttpSecurity http) <span style=color:#66d9ef>throws</span> Exception {
</span></span><span style=display:flex><span>        http
</span></span><span style=display:flex><span>          .<span style=color:#a6e22e>authorizeRequests</span>()
</span></span><span style=display:flex><span>          .<span style=color:#a6e22e>requestMatchers</span>(<span style=color:#e6db74>&#34;/articles/**&#34;</span>)
</span></span><span style=display:flex><span>          .<span style=color:#a6e22e>access</span>(<span style=color:#e6db74>&#34;hasAuthority(&#39;SCOPE_articles.read&#39;)&#34;</span>)
</span></span><span style=display:flex><span>          .<span style=color:#a6e22e>and</span>()
</span></span><span style=display:flex><span>          .<span style=color:#a6e22e>oauth2ResourceServer</span>()
</span></span><span style=display:flex><span>          .<span style=color:#a6e22e>jwt</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> http.<span style=color:#a6e22e>build</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>我们将创建一个配置类并使用@EnableWebSecurity 对其进行注释。我们将创建一个 SecurityFilterChain 的 bean，在其中定义 API 和所需的范围。</p><ul><li><strong>application.yml</strong></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>spring</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>security</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>oauth2</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>resourceserver</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>jwt</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>issuer-uri</span>: <span style=color:#ae81ff>http://localhost:9090</span>
</span></span></code></pre></div><p>我们在这里定义 oauth2 配置，注意将 issuer-url 的端口更新为正确的端口。</p><p>现在一切都已配置完毕，让我们启动该服务并向 API 发出带有或不带有令牌的请求。您应该得到一个没有令牌或带有无效令牌的 401 响应，并且您应该得到带有有效令牌的正确响应。</p><h1 id=客户端服务器>客户端服务器</h1><p>我们现在将创建一个简单的 Spring Boot 项目，它将使用资源服务器创建的 API。我们将在此处配置身份验证服务器详细信息，以便它在发出 API 请求之前自动获取令牌。</p><h2 id=依赖项-2>依赖项：</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>implementation &#39;org.springframework.boot:spring-boot-starter-oauth2-client&#39;
</span></span><span style=display:flex><span>implementation &#39;org.springframework.boot:spring-boot-starter-web&#39;
</span></span><span style=display:flex><span>implementation &#39;org.springframework:spring-webflux&#39;
</span></span><span style=display:flex><span>testImplementation &#39;org.springframework.boot:spring-boot-starter-test&#39;
</span></span><span style=display:flex><span>testImplementation &#39;org.springframework.security:spring-security-test&#39;
</span></span></code></pre></div><h2 id=java-实现-2>Java 实现：</h2><p>我们首先创建配置类，然后创建一个测试 API 来向资源服务器发出请求。之后，我们将在 application.yml 文件中定义令牌配置。</p><ul><li>**SecurityConfig **</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Configuration</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SecurityConfig</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>    SecurityFilterChain <span style=color:#a6e22e>securityFilterChain</span>(HttpSecurity http) <span style=color:#66d9ef>throws</span> Exception {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> http.<span style=color:#a6e22e>oauth2Client</span>().<span style=color:#a6e22e>and</span>().<span style=color:#a6e22e>build</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>    WebClient <span style=color:#a6e22e>webClient</span>(OAuth2AuthorizedClientManager authorizedClientManager) {
</span></span><span style=display:flex><span>        ServletOAuth2AuthorizedClientExchangeFilterFunction oauth2Client <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ServletOAuth2AuthorizedClientExchangeFilterFunction(authorizedClientManager);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> WebClient.<span style=color:#a6e22e>builder</span>()
</span></span><span style=display:flex><span>          .<span style=color:#a6e22e>apply</span>(oauth2Client.<span style=color:#a6e22e>oauth2Configuration</span>())
</span></span><span style=display:flex><span>          .<span style=color:#a6e22e>build</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>    OAuth2AuthorizedClientManager <span style=color:#a6e22e>authorizedClientManager</span>(ClientRegistrationRepository clientRegistrationRepository,
</span></span><span style=display:flex><span>      OAuth2AuthorizedClientService oAuth2AuthorizedClientService,
</span></span><span style=display:flex><span>      OAuth2AccessTokenResponseClient<span style=color:#f92672>&lt;</span>OAuth2ClientCredentialsGrantRequest<span style=color:#f92672>&gt;</span> tokenResponseClient) {
</span></span><span style=display:flex><span>        OAuth2AuthorizedClientProvider authorizedClientProvider <span style=color:#f92672>=</span> OAuth2AuthorizedClientProviderBuilder.<span style=color:#a6e22e>builder</span>()
</span></span><span style=display:flex><span>          .<span style=color:#a6e22e>clientCredentials</span>(r <span style=color:#f92672>-&gt;</span> r.<span style=color:#a6e22e>accessTokenResponseClient</span>(tokenResponseClient)).<span style=color:#a6e22e>clientCredentials</span>().<span style=color:#a6e22e>build</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>var</span> authorizedClientManager <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> AuthorizedClientServiceOAuth2AuthorizedClientManager(
</span></span><span style=display:flex><span>          clientRegistrationRepository, oAuth2AuthorizedClientService);
</span></span><span style=display:flex><span>        authorizedClientManager.<span style=color:#a6e22e>setAuthorizedClientProvider</span>(authorizedClientProvider);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> authorizedClientManager;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>    OAuth2AccessTokenResponseClient<span style=color:#f92672>&lt;</span>OAuth2ClientCredentialsGrantRequest<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>tokenResponseClient</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> DefaultClientCredentialsTokenResponseClient();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li><strong>application.yml</strong></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>spring</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>security</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>oauth2</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>client</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>registration</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>articles-client</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>client-id</span>: <span style=color:#ae81ff>oauth-client</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>client-secret</span>: <span style=color:#ae81ff>oauth-secret</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>authorization-grant-type</span>: <span style=color:#ae81ff>client_credentials</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>scope</span>: <span style=color:#ae81ff>articles.read</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>client-name</span>: <span style=color:#ae81ff>spring-client</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>provider</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>articles-client</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>token-uri</span>: <span style=color:#ae81ff>http://localhost:9090/oauth2/token</span>
</span></span></code></pre></div><ul><li>客户端 API（向资源服务器发出请求）</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@RestController</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ArticlesController</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> WebClient webClient;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@GetMapping</span>(value <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/test&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String<span style=color:#f92672>[]</span> <span style=color:#a6e22e>test</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>webClient</span>
</span></span><span style=display:flex><span>          .<span style=color:#a6e22e>get</span>()
</span></span><span style=display:flex><span>          .<span style=color:#a6e22e>uri</span>(<span style=color:#e6db74>&#34;http://127.0.0.1:9091/articles&#34;</span>)
</span></span><span style=display:flex><span>          .<span style=color:#a6e22e>attributes</span>(clientRegistrationId(<span style=color:#e6db74>&#34;articles-client&#34;</span>))
</span></span><span style=display:flex><span>          .<span style=color:#a6e22e>retrieve</span>()
</span></span><span style=display:flex><span>          .<span style=color:#a6e22e>bodyToMono</span>(String<span style=color:#f92672>[]</span>.<span style=color:#a6e22e>class</span>)
</span></span><span style=display:flex><span>          .<span style=color:#a6e22e>block</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>我们可以在这里看到，当我们调用 /test API 时，它会从我们的身份验证服务器获取令牌，然后向我们的资源服务器 /articles 端点发出请求并返回响应。</p><p>让我们运行所有三个服务器并向客户端服务器发出请求，它应该返回正确的响应。请注意更新所有位置的端口号。在示例中，我使用了以下端口：</p><ul><li>9090: auth-server</li><li>9091: resource-server</li><li>9092: client-server</li></ul><h1 id=结论>结论</h1><p>在本文中，我们学习了如何使用 Spring Boot 创建授权服务器以及如何在资源服务器和客户端服务器中配置它。</p><p>您可以在此 GitHub 存储库中找到此 <a href=https://github.com/kumarprabhashanand/spring-authorization-server target=_blank>示例的代码</a>。</p><p>原文链接：<a href=https://blog.devgenius.io/spring-boot-authorization-server-825230ae0ed2 target=_blank>https://blog.devgenius.io/spring-boot-authorization-server-825230ae0ed2</a></p></div><div><div style=font-weight:700>Share this post:</div><a class=social-link-item href="https://twitter.com/intent/tweet?text=%5b%e8%af%91%5dSpring%20Boot%e6%8e%88%e6%9d%83%e6%9c%8d%e5%8a%a1%e5%99%a8%20-%20%e4%bd%bf%e7%94%a8%20Java%20%e7%9a%84%e8%b5%84%e6%ba%90%e6%9c%8d%e5%8a%a1%e5%99%a8%e5%92%8c%e5%ae%a2%e6%88%b7%e7%ab%af%e5%87%ad%e8%af%81%e7%a4%ba%e4%be%8b https%3a%2f%2fblog.chensoul.cc%2fposts%2f2023%2f07%2f26%2fspring-boot-authorization-server%2f" target=_blank rel="noopener noreferrer" title="Click to share on Twitter"><i class="fa-brands fa-square-twitter fa-2xl" style=color:#55acee></i>
</a><a class=social-link-item href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fblog.chensoul.cc%2fposts%2f2023%2f07%2f26%2fspring-boot-authorization-server%2f&title=%5b%e8%af%91%5dSpring%20Boot%e6%8e%88%e6%9d%83%e6%9c%8d%e5%8a%a1%e5%99%a8%20-%20%e4%bd%bf%e7%94%a8%20Java%20%e7%9a%84%e8%b5%84%e6%ba%90%e6%9c%8d%e5%8a%a1%e5%99%a8%e5%92%8c%e5%ae%a2%e6%88%b7%e7%ab%af%e5%87%ad%e8%af%81%e7%a4%ba%e4%be%8b" target=_blank rel="noopener noreferrer" title="Click to share on LinkedIn"><i class="fa-brands fa-linkedin fa-2xl" style=color:#007bb5></i>
</a><a class=social-link-item href="https://telegram.me/share/url?text=%5b%e8%af%91%5dSpring%20Boot%e6%8e%88%e6%9d%83%e6%9c%8d%e5%8a%a1%e5%99%a8%20-%20%e4%bd%bf%e7%94%a8%20Java%20%e7%9a%84%e8%b5%84%e6%ba%90%e6%9c%8d%e5%8a%a1%e5%99%a8%e5%92%8c%e5%ae%a2%e6%88%b7%e7%ab%af%e5%87%ad%e8%af%81%e7%a4%ba%e4%be%8b&amp;url=https%3a%2f%2fblog.chensoul.cc%2fposts%2f2023%2f07%2f26%2fspring-boot-authorization-server%2f" target=_blank rel="noopener noreferrer" title="Click to share on telegram"><i class="fa-brands fa-telegram fa-2xl" style=color:#007bb5></i>
</a><a class=social-link-item href="https://reddit.com/submit?url=https%3a%2f%2fblog.chensoul.cc%2fposts%2f2023%2f07%2f26%2fspring-boot-authorization-server%2f&title=%5b%e8%af%91%5dSpring%20Boot%e6%8e%88%e6%9d%83%e6%9c%8d%e5%8a%a1%e5%99%a8%20-%20%e4%bd%bf%e7%94%a8%20Java%20%e7%9a%84%e8%b5%84%e6%ba%90%e6%9c%8d%e5%8a%a1%e5%99%a8%e5%92%8c%e5%ae%a2%e6%88%b7%e7%ab%af%e5%87%ad%e8%af%81%e7%a4%ba%e4%be%8b" target=_blank rel="noopener noreferrer" title="Click to share on reddit"><i class="fa-brands fa-reddit fa-2xl" style=color:#007bb5></i>
</a><a class=social-link-item href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fblog.chensoul.cc%2fposts%2f2023%2f07%2f26%2fspring-boot-authorization-server%2f" target=_blank rel="noopener noreferrer" title="Click to share on facebook"><i class="fa-brands fa-facebook fa-2xl" style=color:#007bb5></i>
</a><a class=social-link-item href="https://api.whatsapp.com/send?text=%5b%e8%af%91%5dSpring%20Boot%e6%8e%88%e6%9d%83%e6%9c%8d%e5%8a%a1%e5%99%a8%20-%20%e4%bd%bf%e7%94%a8%20Java%20%e7%9a%84%e8%b5%84%e6%ba%90%e6%9c%8d%e5%8a%a1%e5%99%a8%e5%92%8c%e5%ae%a2%e6%88%b7%e7%ab%af%e5%87%ad%e8%af%81%e7%a4%ba%e4%be%8b%20-%20https%3a%2f%2fblog.chensoul.cc%2fposts%2f2023%2f07%2f26%2fspring-boot-authorization-server%2f" target=_blank rel="noopener noreferrer" title="Click to share on whatsapp"><i class="fa-brands fa-whatsapp fa-2xl" style=color:#007bb5></i></a></div></div></article><nav class="navigation post-navigation" role=navigation><h2 class=screen-reader-text>Post navigation</h2><div class=nav-links><div class=nav-previous><a href=/posts/2023/07/26/spring-boot-exception-handling/ rel=next><span class=post-title>[译]Spring Boot异常处理完整指南</span></a></div><div class=nav-next><a href=/posts/2023/07/26/spring-cors/ rel=prev><span class=post-title>[译]使用 Spring Boot 和 Spring Security 配置 CORS</span></a></div></div></nav><h2>Related content</h2><ul><li><a href=/posts/2023/10/13/new-features-in-spring-boot-3-and-spring-6/>[译]Spring Boot3和Spring6中的新特性</a></li><li><a href=/posts/2023/10/12/spring-security-interview-questions/>[译]Spring Security 面试问题</a></li><li><a href=/posts/2023/09/19/spring-security-tutorial/>[译]Spring Security 与 JWT for REST API</a></li><li><a href=/posts/2023/09/19/spring-security-jwt/>[译]如何使用Spring Security和JWT保护您的REST API</a></li><li><a href=/posts/2023/08/25/global-error-handler-in-a-spring-rest-api/>[译]REST API 的自定义错误消息处理</a></li><li><a href=/posts/2023/08/25/spring-events/>[译]Spring Events</a></li><li><a href=/posts/2023/08/25/spring-security-async-principal-propagation/>[译]使用@Async进行Spring Security上下文传播</a></li><li><a href=/posts/2023/08/25/exception-handling-for-rest-with-spring/>[译]使用Spring进行REST的错误处理</a></li><li><a href=/posts/2023/08/25/spring-async/>[译]如何在Spring中执行@Async</a></li><li><a href=/posts/2023/08/18/how-to-implement-jwt-authentication-in-spring-boot-project/>[译]Spring Boot项目如何实现JWT认证？</a></li></ul></main></section></div><div id=footer class=footer-wrap><footer id=colophon class="site-footer container clearfix" role=contentinfo><div id=footer-text class=site-info><span class=credit-link><a href=/ target=_blank rel="noopener noreferrer">ChenSoul</a>
Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreferrer">Hugo</a>
<a style=margin-left:20px href=/privacy_policy/ target=_blank rel="noopener noreferrer">Privacy Policy</a></span></div></footer></div></div><script type=text/javascript src=/main.min.js></script></body></html>