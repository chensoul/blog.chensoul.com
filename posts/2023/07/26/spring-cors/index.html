<!doctype html><html lang=en-US prefix="og: http://ogp.me/ns#"><head><meta charset=utf-8><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="跨源资源共享 (CORS) 是一种基于 HTTP 标头的机制，允许服务器显式将某些源列入白名单，并帮助绕过同源策略。"><title>[译]使用 Spring Boot 和 Spring Security 配置 CORS | ChenSoul</title>
<link rel=canonical href=https://blog.chensoul.cc/posts/2023/07/26/spring-cors/><link rel=preconnect href=https://fonts.font.im><link rel=preconnect href=https://fonts.loli.net crossorigin><link href="https://fonts.loli.net/css2?family=Roboto+Slab:wght@400;500;700&display=swap" rel=stylesheet><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://blog.chensoul.cc/images/favicon.webp"><meta name=twitter:title content="[译]使用 Spring Boot 和 Spring Security 配置 CORS"><meta name=twitter:description content="跨源资源共享 (CORS) 是一种基于 HTTP 标头的机制，允许服务器显式将某些源列入白名单，并帮助绕过同源策略。"><meta name=twitter:creator content="@ichensoul"><meta property="og:locale" content="en_US"><meta property="og:site_name" content="chensoul"><meta property="og:url" content="https://blog.chensoul.cc/posts/2023/07/26/spring-cors/"><meta property="og:site_name" content="ChenSoul"><meta property="og:title" content="[译]使用 Spring Boot 和 Spring Security 配置 CORS"><meta property="og:description" content="跨源资源共享 (CORS) 是一种基于 HTTP 标头的机制，允许服务器显式将某些源列入白名单，并帮助绕过同源策略。"><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-07-26T00:00:00+00:00"><meta property="article:modified_time" content="2023-07-26T00:00:00+00:00"><meta property="article:tag" content="Spring-Security"><meta property="og:image" content="https://blog.chensoul.cc/images/favicon.webp"><meta itemprop=name content="[译]使用 Spring Boot 和 Spring Security 配置 CORS"><meta itemprop=description content="跨源资源共享 (CORS) 是一种基于 HTTP 标头的机制，允许服务器显式将某些源列入白名单，并帮助绕过同源策略。"><meta itemprop=datePublished content="2023-07-26T00:00:00+00:00"><meta itemprop=dateModified content="2023-07-26T00:00:00+00:00"><meta itemprop=wordCount content="958"><meta itemprop=image content="https://blog.chensoul.cc/images/favicon.webp"><meta itemprop=keywords content="Spring-Security"><link rel=stylesheet href=https://cdnjs.loli.net/ajax/libs/font-awesome/6.4.0/css/all.min.css media=all><link rel=stylesheet href=/main.min.css type=text/css media=all><link rel="shortcut icon" href=/favicon.ico type=image/x-icon><script type=application/ld+json>{"@context":"https://schema.org","@graph":[{"@type":"TechArticle","name":"[译]使用 Spring Boot 和 Spring Security 配置 CORS","headline":"[译]使用 Spring Boot 和 Spring Security 配置 CORS","inLanguage":"en-US","url":"https://blog.chensoul.cc/posts/2023/07/26/spring-cors/","description":"\u003cp\u003e跨源资源共享 (CORS) 是一种基于 HTTP 标头的机制，允许服务器显式将某些源列入白名单，并帮助绕过同源策略。\u003c/p\u003e","wordCount":"958","keywords":["spring-security"],"datePublished":"2023-07-26T00:00:00Z","dateModified":"2023-07-26T00:00:00Z","author":{"@type":"Person","name":"chensoul"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.chensoul.cc/posts/2023/07/26/spring-cors/"},"publisher":{"@type":"Organization","name":"chensoul","url":"https://blog.chensoul.cc/posts/2023/07/26/spring-cors/"}},{"@context":"https://schema.org","@type":"Organization","name":"chensoul","url":"https://blog.chensoul.cc/","sameAs":["https://x.com/ichensoul","https://github.com/chensoul","https://www.linkedin.com/in/","https://www.youtube.com/@chensoul","https://t.me/chensouls"]}]}</script></head><body class="home blog post-layout-one-column"><button onclick=topFunction() id=scrollTopBtn title="Go to top">
<i class="fa-solid fa-arrow-up"></i></button><div id=header-top class=header-bar-wrap></div><div id=page class=site><a class="skip-link screen-reader-text" href=#content>Skip to content</a><header id=masthead class="site-header clearfix" role=banner><div class="header-main container clearfix"><div id=logo class="site-branding clearfix"><h1 class=site-title><a href=/ title=ChenSoul rel=home>ChenSoul</a></h1><p class=site-description>Java, Spring Boot, Microservice, Cloud, Architecture and DevOps Tutorials</p></div><div class="header-widgets clearfix"><aside id=search-2 class="header-widget widget_search"><form role=search method=get class=search-form onsubmit="return searchSite(event)"><label><span class=screen-reader-text>Search for:</span>
<input type=search class=search-field placeholder="Enter search keyword" name=query id=query title="Enter search keyword">
</label><button type=submit class=search-submit title=Search> <span class=genericon-search></span>
<span class=screen-reader-text>Search</span></button></form></aside></div></div><div id=main-navigation-wrap class=primary-navigation-wrap><nav id=main-navigation class="primary-navigation navigation container clearfix" role=navigation><ul id=menu-home class=main-navigation-menu><li class="menu-item menu-item-type-custom menu-item-object-custom
current-menu-item current_page_item menu-item-home"><a href=/>Home</a></li><li class="menu-item menu-item-type-taxonomy menu-item-object-category"><a href=/categories/spring-boot/>Spring Boot</a></li><li class="menu-item menu-item-type-taxonomy menu-item-object-category"><a href=/categories/architecture/>Architecture</a></li><li class="menu-item menu-item-type-taxonomy menu-item-object-category"><a href=/categories/microservice/>Microservice</a></li><li class="menu-item menu-item-type-taxonomy menu-item-object-category"><a href=/categories/kubernetes/>Kubernetes</a></li><li class="menu-item menu-item-type-taxonomy menu-item-object-category
menu-item-has-children"><a href=/tutorials/>Tutorials</a><ul class=sub-menu><li class="menu-item menu-item-type-taxonomy menu-item-object-category"><a href=/spring-boot-tutorials/>Spring Boot Tutorials</a></li><li class="menu-item menu-item-type-taxonomy menu-item-object-category"><a href=/microservice-tutorials/>Microservice Tutorials</a></li><li class="menu-item menu-item-type-taxonomy menu-item-object-category"><a href=/kubernetes-tutorials/>Kubernetes Tutorials</a></li></ul></li><li class="menu-item menu-item-type-post_type menu-item-object-page"><a href=https://github.com/chensoul target=_blank>About Me</a></li></ul></nav></div></header><div id=content class="site-content container clearfix"><section id=primary class="content-archive content-area post-content-area"><main id=main class=site-main role=main><article class="post type-post"><div class=post-inner-content><header class=entry-header><h2 class=entry-title><a href=https://blog.chensoul.cc/posts/2023/07/26/spring-cors/ rel=bookmark title="[译]使用 Spring Boot 和 Spring Security 配置 CORS">[译]使用 Spring Boot 和 Spring Security 配置 CORS</a></h2><div class=entry-meta><span class=meta-date><time class="entry-date published" datetime=2023-07-26T00:00:00>2023-07-26
</time></span><span class=meta-author><span class="author vcard">chensoul</span>
</span><span class="tagcloud post-tags"><i class="fa fa-tags"></i>&nbsp;
<a class="tag-cloud-link widget__link widget__link--taglist" href=/tags/spring-security/ title=spring-security>spring-security</a></span></div></header><div style=background-color:#f1f3f5;margin-top:20px><aside style=margin:5px><span style=font-size:20px;font-weight:700>Table of Contents</span><div style=padding-left:30px><nav id=TableOfContents><ul><li><a href=#示例代码>示例代码</a></li><li><a href=#cors-特定-http-响应标头概述>CORS 特定 HTTP 响应标头概述</a></li><li><a href=#设置示例客户端应用程序>设置示例客户端应用程序</a></li><li><a href=#设置示例服务器应用程序>设置示例服务器应用程序</a></li><li><a href=#了解-crossorigin-属性>了解 <code>@CrossOrigin</code> 属性</a></li><li><a href=#如果不配置-cors-怎么办>如果不配置 CORS 怎么办？</a></li><li><a href=#在-spring-web-mvc-应用程序中配置-cors>在 Spring Web MVC 应用程序中配置 CORS</a><ul><li><a href=#在类级别定义-crossorigin>在类级别定义 <code>@CrossOrigin</code></a></li><li><a href=#在方法级别定义-crossorigin>在方法级别定义 <code>@CrossOrigin</code></a></li><li><a href=#类和方法级别的-crossorigin-组合>类和方法级别的 <code>@CrossOrigin</code> 组合</a></li><li><a href=#全局启用-cors>全局启用 CORS</a></li></ul></li><li><a href=#在-spring-webflux-应用程序中配置-cors>在 Spring Webflux 应用程序中配置 CORS</a><ul><li><a href=#使用-crossorigin-进行-spring-webflux-的-cors-配置>使用 <code>@CrossOrigin</code> 进行 Spring Webflux 的 CORS 配置</a></li><li><a href=#在-spring-webflux-中全局启用-cors-配置>在 Spring Webflux 中全局启用 CORS 配置</a></li><li><a href=#使用-webfilter-启用-cors>使用 <code>WebFilter</code> 启用 CORS</a></li></ul></li><li><a href=#使用-spring-security-启用-cors>使用 Spring Security 启用 CORS</a><ul><li><a href=#spring-security-应用于-spring-web-mvc>Spring Security 应用于 Spring Web MVC</a></li><li><a href=#spring-security-应用于-spring-webflux>Spring Security 应用于 Spring Webflux</a></li></ul></li><li><a href=#结论>结论</a></li></ul></nav></div></aside></div><div class=entry-content><p>跨源资源共享 (CORS) 是一种基于 HTTP 标头的机制，允许服务器显式将某些源列入白名单，并帮助绕过同源策略。</p><p>这是必需的，因为浏览器默认应用同源策略以确保安全。通过在 Web 应用程序中实施 CORS，网页可以请求额外的资源并从其他域加载到浏览器中。</p><p>本文将重点介绍在基于 Spring 的应用程序中实现 CORS 的各种方式。要详细了解 CORS 的工作原理，请参阅这篇优秀的<a href=https://reflectoring.io/complete-guide-to-cors/ target=_blank>介绍性文章</a>。</p><h2 id=示例代码>示例代码</h2><p>本文附有 GitHub 上的工作<a href=https://github.com/thombergs/code-examples/tree/master/spring-boot/cors/configuring-cors-with-spring target=_blank>代码示例</a>。</p><h2 id=cors-特定-http-响应标头概述>CORS 特定 HTTP 响应标头概述</h2><p>CORS 规范定义了服务器返回的一组响应标头，这将是后续部分的重点。</p><table><thead><tr><th>响应头</th><th>描述</th></tr></thead><tbody><tr><td><code>Access-Control-Allow-Origin</code></td><td>以逗号分隔的白名单来源列表或“*”。</td></tr><tr><td><code>Access-Control-Allow-Methods</code></td><td>Web 服务器允许跨源请求的 HTTP 方法的逗号分隔列表。</td></tr><tr><td><code>Access-Control-Allow-Headers</code></td><td>Web 服务器允许跨源请求的 HTTP 标头的逗号分隔列表。</td></tr><tr><td><code>Access-Control-Expose-Headers</code></td><td>客户端脚本认为可以安全显示的以逗号分隔的 HTTP 标头列表。</td></tr><tr><td><code>Access-Control-Allow-Credentials</code></td><td>如果浏览器通过传递凭据（以 cookie 或授权标头的形式）向服务器发出请求，则其值设置为 <code>true</code> 。</td></tr><tr><td><code>Access-Control-Max-Age</code></td><td>指示预检请求的结果可以缓存多长时间。</td></tr></tbody></table><h2 id=设置示例客户端应用程序>设置示例客户端应用程序</h2><p>我们将使用一个简单的角度应用程序来调用 REST 端点，我们可以使用浏览器开发人员工具检查这些端点。您可以在 GitHub 上查看<a href=https://github.com/thombergs/code-examples/tree/master/spring-boot/cors/configuring-cors-with-spring/cors-app target=_blank>源代码</a>。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>    ng serve --open
</span></span></code></pre></div><p>我们应该能够成功启动客户端应用程序。</p><p><img src=/images/configuring-cors-with-spring-01.webp alt=settings></p><h2 id=设置示例服务器应用程序>设置示例服务器应用程序</h2><p>我们将使用一个基于 Spring 的示例应用程序，其中包含客户端应用程序可以调用的 <code>GET</code> 和 <code>POST</code> 请求。请注意，您会发现两个独立的应用程序：一个使用 Spring MVC (REST)，另一个使用 Spring Reactive 堆栈。</p><p>为简单起见，两个应用程序之间的 CORS 配置相同，并且定义了相同的端点。两台服务器都从不同的端口 8091 和 8092 启动。</p><p>与应用程序捆绑在一起的 Maven Wrapper 将用于启动服务。您可以查看 <a href=https://github.com/thombergs/code-examples/tree/master/spring-boot/cors/configuring-cors-with-spring/SimpleLibraryApplication target=_blank>Spring REST 源代码</a>和 <a href=https://github.com/thombergs/code-examples/tree/master/spring-boot/cors/configuring-cors-with-spring/LibraryWebfluxApplication target=_blank>Spring Reactive 源代码</a>。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mvnw clean verify spring-boot:run <span style=color:#f92672>(</span><span style=color:#66d9ef>for</span> Windows<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>./mvnw clean verify spring-boot:run <span style=color:#f92672>(</span><span style=color:#66d9ef>for</span> Linux<span style=color:#f92672>)</span>
</span></span></code></pre></div><p>一旦 Spring 应用程序成功启动，客户端应用程序应该能够成功从服务器加载数据。</p><p>调用 Spring REST 服务器：</p><p><img src=/images/configuring-cors-with-spring-02.webp alt=settings>
调用 Spring Reactive 服务器：</p><p><img src=/images/configuring-cors-with-spring-03.webp alt=settings></p><h2 id=了解-crossorigin-属性>了解 <code>@CrossOrigin</code> 属性</h2><p>在 Spring Boot 应用程序中，我们使用 <code>@CrossOrigin</code> 注解来启用跨域调用。我们先了解一下 <code>@CrossOrigin</code> 支持的属性。</p><table><thead><tr><th>属性</th><th>Description 描述</th></tr></thead><tbody><tr><td><code>origins</code></td><td>允许您指定允许的来源列表。默认情况下，它允许所有来源。 该属性值将在预检响应和实际响应的 <code>Access-Control-Allow-Origin</code> 标头中设置。 用法示例： <code>@CrossOrigin(origins = "http://localhost:8080")</code> <code>@CrossOrigin(origins = {"http://localhost:8080", "http://testserver:8087"})</code></td></tr><tr><td><code>allowedHeaders</code></td><td>允许您指定浏览器发出请求时将接受的标头列表。默认情况下，任何标头都将被允许。此属性中指定的值用于预检响应中的 <code>Access-Control-Allow-Headers</code> 中。 <strong>用法示例：</strong> <code>@CrossOrigin(allowedHeaders = {"Authorization", "Origin"})</code></td></tr><tr><td><code>exposedHeaders</code></td><td>在实际响应标头中设置的标头列表。如果未指定，则只有安全列表中的标头才会被认为可以安全地由客户端脚本公开。 <strong>用法示例：</strong> <code>@CrossOrigin(exposedHeaders = {"Access-Control-Allow-Origin","Access-Control-Allow-Credentials"})</code></td></tr><tr><td><code>allowCredentials</code></td><td>当需要凭据来调用 API 时，请将 <code>Access-Control-Allow-Credentials</code> 标头值设置为 true。如果不需要凭据，请省略标头。 <strong>用法示例：</strong> <code>@CrossOrigin(allowCredentials = true)</code></td></tr><tr><td><code>maxAge</code></td><td>默认 <code>maxAge</code> 设置为 1800 秒（30 分钟）。指示预检响应可以缓存多长时间。 <strong>用法示例：</strong> <code>@CrossOrigin(maxAge = 300)</code></td></tr></tbody></table><h2 id=如果不配置-cors-怎么办>如果不配置 CORS 怎么办？</h2><p>考虑我们的 Spring Boot 应用程序尚未配置为 CORS 支持。如果我们尝试访问在端口 4200 上运行的 Angular 应用程序，我们会在开发人员控制台上看到以下错误：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>Access to XMLHttpRequest at http://localhost:8091
</span></span><span style=display:flex><span>from origin http://localhost:4200 has been blocked by CORS policy:
</span></span><span style=display:flex><span>No &#39;Access-Control-Allow-Origin` header is present on the requested
</span></span><span style=display:flex><span>resource
</span></span></code></pre></div><p><img src=/images/configuring-cors-with-spring-04.webp alt=settings></p><p>这是因为，即使两个应用程序均由 <code>localhost</code> 提供服务，但<a href=https://reflectoring.io/complete-guide-to-cors/#same-origin-vs-cross-origin target=_blank>由于端口不同</a>，它们不会被视为同一来源。</p><h2 id=在-spring-web-mvc-应用程序中配置-cors>在 Spring Web MVC 应用程序中配置 CORS</h2><p>使用 Spring Initializr 创建的初始设置包含所有必需的 CORS 依赖项。无需添加外部依赖项。请参阅此<a href=https://github.com/thombergs/code-examples/tree/master/spring-boot/cors/configuring-cors-with-spring/SpringWebApplication target=_blank>示例 Spring Web 应用程序项目</a>。</p><h3 id=在类级别定义-crossorigin>在类级别定义 <code>@CrossOrigin</code></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@CrossOrigin</span>(maxAge <span style=color:#f92672>=</span> 3600)
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RestController</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RequestMapping</span>(<span style=color:#e6db74>&#34;cors-library/managed/books&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>LibraryController</span> {}
</span></span></code></pre></div><p>由于我们已经定义了 <code>@CrossOrigin</code> ：</p><ul><li>控制器中的所有 <code>@RequestMapping</code> 方法（以及使用速记注释 <code>@GetMapping</code> 、 <code>@PostMapping</code> 等的方法）都将接受跨域请求。</li><li>自 <code>maxAge = 3600</code> 起，所有飞行前响应将被缓存 60 分钟。</li></ul><h3 id=在方法级别定义-crossorigin>在方法级别定义 <code>@CrossOrigin</code></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@CrossOrigin</span>(origins <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;http://localhost:4200&#34;</span>, allowedHeaders <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Requestor-Type&#34;</span>, exposedHeaders <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;X-Get-Header&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>@GetMapping</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> ResponseEntity<span style=color:#f92672>&lt;</span>List<span style=color:#f92672>&lt;</span>BookDto<span style=color:#f92672>&gt;&gt;</span> <span style=color:#a6e22e>getBooks</span>(<span style=color:#a6e22e>@RequestParam</span> String type) {
</span></span><span style=display:flex><span>    HttpHeaders headers <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HttpHeaders();
</span></span><span style=display:flex><span>    headers.<span style=color:#a6e22e>set</span>(<span style=color:#e6db74>&#34;X-Get-Header&#34;</span>, <span style=color:#e6db74>&#34;ExampleHeader&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> ResponseEntity.<span style=color:#a6e22e>ok</span>().<span style=color:#a6e22e>headers</span>(headers).<span style=color:#a6e22e>body</span>(libraryService.<span style=color:#a6e22e>getAllBooks</span>(type));
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>这将产生以下效果：</p><ul><li><p>仅接受来自来源 <code>http://localhost:4200</code> 的请求。</p></li><li><p>如果我们希望只接受某些标头，则可以在 <code>allowedHeaders</code> 属性中指定这些标头。如果浏览器未发送 <code>Requestor-Type</code> 标头，则不会处理该请求。</p></li><li><p>如果我们设置某些响应标头，为了让客户端应用程序能够使用它们，我们需要使用 <code>exposedHeaders</code> 属性显式设置要公开的响应标头列表。</p></li></ul><h3 id=类和方法级别的-crossorigin-组合>类和方法级别的 <code>@CrossOrigin</code> 组合</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@CrossOrigin</span>(maxAge <span style=color:#f92672>=</span> 3600)
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RestController</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RequestMapping</span>(<span style=color:#e6db74>&#34;cors-library/managed/books&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>LibraryController</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> Logger log <span style=color:#f92672>=</span> LoggerFactory.<span style=color:#a6e22e>getLogger</span>(LibraryController.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> LibraryService libraryService;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>LibraryController</span>(LibraryService libraryService) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>libraryService</span> <span style=color:#f92672>=</span> libraryService;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@CrossOrigin</span>(origins <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;http://localhost:4200&#34;</span>, allowedHeaders <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Requestor-Type&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@GetMapping</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> ResponseEntity<span style=color:#f92672>&lt;</span>List<span style=color:#f92672>&lt;</span>BookDto<span style=color:#f92672>&gt;&gt;</span> <span style=color:#a6e22e>getBooks</span>(<span style=color:#a6e22e>@RequestParam</span> String type) {
</span></span><span style=display:flex><span>        HttpHeaders headers <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HttpHeaders();
</span></span><span style=display:flex><span>        headers.<span style=color:#a6e22e>set</span>(<span style=color:#e6db74>&#34;X-Get-Header&#34;</span>, <span style=color:#e6db74>&#34;ExampleHeader&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> ResponseEntity.<span style=color:#a6e22e>ok</span>().<span style=color:#a6e22e>headers</span>(headers).<span style=color:#a6e22e>body</span>(libraryService.<span style=color:#a6e22e>getAllBooks</span>(type));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li><p>通过在类和方法级别定义注释，其组合属性将应用于方法，即（ <code>origins</code> 、 <code>allowedHeaders</code> 、``）</p></li><li><p>在上述所有情况下，我们可以使用 <code>@CrossOrigin</code> 定义全局 CORS cmaxAgeonconfiguration 和本地配置。对于接受多个值的属性，将应用全局值和本地值的组合（即它们被合并）。对于仅接受单个值的属性，本地值将优先于全局值。</p></li></ul><h3 id=全局启用-cors>全局启用 CORS</h3><p>我们可以定义一个适用于定义的所有资源的通用 CORS 配置，而不是分别向每个资源添加 CORS。</p><p>在这里，我们将使用 <code>WebMvcConfigurer</code> ，它是 Spring Web MVC 库的一部分</p><p>通过重写 <code>addCorsMapping()</code> 方法，我们将为 Spring Web MVC 处理的所有 URL 配置 CORS。</p><p>为了全局定义相同的配置（如前几节所述），我们将使用 <code>application.yml</code> 中定义的配置参数来创建一个 bean，如下定义。</p><p><code>application.yml</code> 中定义的属性（ <code>allowed-origins</code> 、 <code>allowed-methods</code> 、 <code>max-age</code> 、 <code>allowed-headers</code> 、 <code>exposed-headers</code> ) 是通过 <code>@ConfigurationProperties(prefix = "web")</code> 映射到自定义类 Cors 的自定义属性</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>web</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>cors</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>allowed-origins</span>: <span style=color:#e6db74>&#34;http://localhost:4200&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>allowed-methods</span>: <span style=color:#ae81ff>GET, POST, PATCH, PUT, DELETE, OPTIONS, HEAD</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>max-age</span>: <span style=color:#ae81ff>3600</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>allowed-headers</span>: <span style=color:#e6db74>&#34;Requestor-Type&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>exposed-headers</span>: <span style=color:#e6db74>&#34;X-Get-Header&#34;</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> WebMvcConfigurer <span style=color:#a6e22e>corsMappingConfigurer</span>() {
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> WebMvcConfigurer() {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>addCorsMappings</span>(CorsRegistry registry) {
</span></span><span style=display:flex><span>           WebConfigProperties.<span style=color:#a6e22e>Cors</span> cors <span style=color:#f92672>=</span> webConfigProperties.<span style=color:#a6e22e>getCors</span>();
</span></span><span style=display:flex><span>           registry.<span style=color:#a6e22e>addMapping</span>(<span style=color:#e6db74>&#34;/**&#34;</span>)
</span></span><span style=display:flex><span>             .<span style=color:#a6e22e>allowedOrigins</span>(cors.<span style=color:#a6e22e>getAllowedOrigins</span>())
</span></span><span style=display:flex><span>             .<span style=color:#a6e22e>allowedMethods</span>(cors.<span style=color:#a6e22e>getAllowedMethods</span>())
</span></span><span style=display:flex><span>             .<span style=color:#a6e22e>maxAge</span>(cors.<span style=color:#a6e22e>getMaxAge</span>())
</span></span><span style=display:flex><span>             .<span style=color:#a6e22e>allowedHeaders</span>(cors.<span style=color:#a6e22e>getAllowedHeaders</span>())
</span></span><span style=display:flex><span>             .<span style=color:#a6e22e>exposedHeaders</span>(cors.<span style=color:#a6e22e>getExposedHeaders</span>());
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>   };
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><blockquote><h4 id=corsconfiguration-默认值><code>CorsConfiguration</code> 默认值</h4><p>如果未显式定义一个或多个方法（ <code>allowedOrigins</code> 、 <code>allowedMethods</code> 、 <code>maxAge</code> 、 <code>allowedHeaders</code> 、 <code>exposedHeaders</code> ），则 <code>addMapping()</code> 返回一个 <code>CorsRegistration</code> 对象，该对象应用默认的 <code>CorsConfiguration</code> 。请参阅 Spring 库方法 <a href=https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/web/cors/CorsConfiguration.html#applyPermitDefaultValues-- target=_blank>CorsConfiguration.applyPermitDefaultValues()</a> 以了解应用的默认值。</p></blockquote><h2 id=在-spring-webflux-应用程序中配置-cors>在 Spring Webflux 应用程序中配置 CORS</h2><p>初始设置是使用 Spring Initializr 创建的，并使用 Spring Webflux、Spring Data R2DBC 和 H2 数据库。无需添加外部依赖项。请参阅<a href=https://github.com/thombergs/code-examples/tree/master/spring-boot/cors/configuring-cors-with-spring/SpringWebfluxApplication target=_blank>此示例 Spring Webflux 项目</a>。</p><h3 id=使用-crossorigin-进行-spring-webflux-的-cors-配置>使用 <code>@CrossOrigin</code> 进行 Spring Webflux 的 CORS 配置</h3><p>与 Spring MVC 类似，在 Spring Webflux 中我们可以在类级别或方法级别定义 <code>@CrossOrigin</code> 。前面几节中描述的相同 <code>@CrossOrigin</code> 属性将适用。此外，当在类和方法中都定义了注释时，其组合属性将应用于方法。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@CrossOrigin</span>(origins <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;http://localhost:4200&#34;</span>, allowedHeaders <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Requestor-Type&#34;</span>, exposedHeaders <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;X-Get-Header&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>@GetMapping</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> ResponseEntity<span style=color:#f92672>&lt;</span>Mono<span style=color:#f92672>&lt;</span>List<span style=color:#f92672>&lt;</span>BookDto<span style=color:#f92672>&gt;&gt;&gt;</span> <span style=color:#a6e22e>getBooks</span>(<span style=color:#a6e22e>@RequestParam</span> String type) {
</span></span><span style=display:flex><span>    HttpHeaders headers <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HttpHeaders();
</span></span><span style=display:flex><span>    headers.<span style=color:#a6e22e>set</span>(<span style=color:#e6db74>&#34;X-Get-Header&#34;</span>, <span style=color:#e6db74>&#34;ExampleHeader&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> ResponseEntity.<span style=color:#a6e22e>ok</span>().<span style=color:#a6e22e>headers</span>(headers).<span style=color:#a6e22e>body</span>(libraryService.<span style=color:#a6e22e>getAllBooks</span>(type));
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=在-spring-webflux-中全局启用-cors-配置>在 Spring Webflux 中全局启用 CORS 配置</h3><p>要在 Spring Webflux 应用程序中全局定义 CORS，我们使用 <code>WebfluxConfigurer</code> 并覆盖 <code>addCorsMappings()</code> 。与 Spring MVC 类似，它使用带有默认值的 <code>CorsConfiguration</code> ，可以根据需要覆盖默认值。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> WebFluxConfigurer <span style=color:#a6e22e>corsMappingConfigurer</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> WebFluxConfigurer() {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>addCorsMappings</span>(CorsRegistry registry) {
</span></span><span style=display:flex><span>            WebConfigProperties.<span style=color:#a6e22e>Cors</span> cors <span style=color:#f92672>=</span> webConfigProperties.<span style=color:#a6e22e>getCors</span>();
</span></span><span style=display:flex><span>            registry.<span style=color:#a6e22e>addMapping</span>(<span style=color:#e6db74>&#34;/**&#34;</span>)
</span></span><span style=display:flex><span>              .<span style=color:#a6e22e>allowedOrigins</span>(cors.<span style=color:#a6e22e>getAllowedOrigins</span>())
</span></span><span style=display:flex><span>              .<span style=color:#a6e22e>allowedMethods</span>(cors.<span style=color:#a6e22e>getAllowedMethods</span>())
</span></span><span style=display:flex><span>              .<span style=color:#a6e22e>maxAge</span>(cors.<span style=color:#a6e22e>getMaxAge</span>())
</span></span><span style=display:flex><span>              .<span style=color:#a6e22e>allowedHeaders</span>(cors.<span style=color:#a6e22e>getAllowedHeaders</span>())
</span></span><span style=display:flex><span>              .<span style=color:#a6e22e>exposedHeaders</span>(cors.<span style=color:#a6e22e>getExposedHeaders</span>());
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=使用-webfilter-启用-cors>使用 <code>WebFilter</code> 启用 CORS</h3><p>Webflux 框架允许通过 <code>CorsWebFilter</code> 全局设置 CORS 配置。我们可以使用 <code>CorsConfiguration</code> 对象来设置所需的配置并注册要与过滤器一起使用的 <code>CorsConfigurationSource</code> 。</p><p>但是，默认情况下，过滤器中的 <code>CorsConfiguration</code> 不会将默认配置分配给端点！只能应用指定的配置。</p><p>另一种选择是显式调用 <code>CorsConfiguration.applyPermitDefaultValues()</code> 。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> CorsWebFilter <span style=color:#a6e22e>corsWebFilter</span>() {
</span></span><span style=display:flex><span>    CorsConfiguration corsConfig <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> CorsConfiguration();
</span></span><span style=display:flex><span>    corsConfig.<span style=color:#a6e22e>setAllowedOrigins</span>(Arrays.<span style=color:#a6e22e>asList</span>(<span style=color:#e6db74>&#34;http://localhost:4200&#34;</span>));
</span></span><span style=display:flex><span>    corsConfig.<span style=color:#a6e22e>setMaxAge</span>(3600L);
</span></span><span style=display:flex><span>    corsConfig.<span style=color:#a6e22e>addAllowedMethod</span>(<span style=color:#e6db74>&#34;*&#34;</span>);
</span></span><span style=display:flex><span>    corsConfig.<span style=color:#a6e22e>addAllowedHeader</span>(<span style=color:#e6db74>&#34;Requestor-Type&#34;</span>);
</span></span><span style=display:flex><span>    corsConfig.<span style=color:#a6e22e>addExposedHeader</span>(<span style=color:#e6db74>&#34;X-Get-Header&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    UrlBasedCorsConfigurationSource source <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>new</span> UrlBasedCorsConfigurationSource();
</span></span><span style=display:flex><span>    source.<span style=color:#a6e22e>registerCorsConfiguration</span>(<span style=color:#e6db74>&#34;/**&#34;</span>, corsConfig);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> CorsWebFilter(source);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=使用-spring-security-启用-cors>使用 Spring Security 启用 CORS</h2><p>如果 Spring Security 应用于 Spring 应用程序，则必须在 Spring Security 生效之前处理 CORS，因为预检请求不会包含 cookie，并且 Spring Security 将拒绝该请求，因为它将确定用户未经过身份验证。这里显示的示例将演示基本身份验证。</p><p>为了应用 Spring 安全性，我们将添加以下依赖 Maven：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;groupId&gt;</span>org.springframework.boot<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;artifactId&gt;</span>spring-boot-starter-security<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>Gradle:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-groovy data-lang=groovy><span style=display:flex><span>  implementation <span style=color:#e6db74>&#39;org.springframework.boot:spring-boot-starter-security&#39;</span>
</span></span></code></pre></div><h3 id=spring-security-应用于-spring-web-mvc>Spring Security 应用于 Spring Web MVC</h3><p>Spring security 默认保护每个端点。但是，这会导致 CORS 错误，因为浏览器的 <code>OPTIONS</code> 预检请求将被阻止。要使 Spring Security 绕过预检请求，我们需要将 <code>http.cors()</code> 添加到 <code>HTTPSecurity</code> 对象，如下所示：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Configuration</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@EnableConfigurationProperties</span>(BasicAuthConfigProperties.<span style=color:#a6e22e>class</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>@EnableWebSecurity</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SecurityConfiguration</span> <span style=color:#66d9ef>extends</span> WebSecurityConfigurerAdapter {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> BasicAuthConfigProperties basicAuth;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>SecurityConfiguration</span>(BasicAuthConfigProperties basicAuth) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>basicAuth</span> <span style=color:#f92672>=</span> basicAuth;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>configure</span>(HttpSecurity http) <span style=color:#66d9ef>throws</span> Exception {
</span></span><span style=display:flex><span>        http.<span style=color:#a6e22e>cors</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>要在绕过预检请求后使用 Spring Security 设置额外的 CORS 配置，我们可以使用 <code>@CrossOrigin</code> 注释来配置 CORS：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@CrossOrigin</span>(maxAge <span style=color:#f92672>=</span> 3600, allowCredentials <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;true&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RestController</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RequestMapping</span>(<span style=color:#e6db74>&#34;cors-library/managed/books&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>LibraryController</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> Logger log <span style=color:#f92672>=</span> LoggerFactory.<span style=color:#a6e22e>getLogger</span>(LibraryController.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> LibraryService libraryService;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>LibraryController</span>(LibraryService libraryService) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>libraryService</span> <span style=color:#f92672>=</span> libraryService;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@CrossOrigin</span>(origins <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;http://localhost:4200&#34;</span>, allowedHeaders <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#34;Requestor-Type&#34;</span>, <span style=color:#e6db74>&#34;Authorization&#34;</span>}, exposedHeaders <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;X-Get-Header&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@GetMapping</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> ResponseEntity<span style=color:#f92672>&lt;</span>List<span style=color:#f92672>&lt;</span>BookDto<span style=color:#f92672>&gt;&gt;</span> <span style=color:#a6e22e>getBooks</span>(<span style=color:#a6e22e>@RequestParam</span> String type) {
</span></span><span style=display:flex><span>        HttpHeaders headers <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HttpHeaders();
</span></span><span style=display:flex><span>        headers.<span style=color:#a6e22e>set</span>(<span style=color:#e6db74>&#34;X-Get-Header&#34;</span>, <span style=color:#e6db74>&#34;ExampleHeader&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> ResponseEntity.<span style=color:#a6e22e>ok</span>().<span style=color:#a6e22e>headers</span>(headers).<span style=color:#a6e22e>body</span>(libraryService.<span style=color:#a6e22e>getAllBooks</span>(type));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>或者，我们可以创建一个 <code>CorsConfigurationSource</code> bean：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>CorsConfigurationSource <span style=color:#a6e22e>corsConfigurationSource</span>() {
</span></span><span style=display:flex><span>  CorsConfiguration configuration <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> CorsConfiguration();
</span></span><span style=display:flex><span>  configuration.<span style=color:#a6e22e>setAllowedOrigins</span>(Arrays.<span style=color:#a6e22e>asList</span>(<span style=color:#e6db74>&#34;http://localhost:4200&#34;</span>));
</span></span><span style=display:flex><span>  configuration.<span style=color:#a6e22e>setAllowedMethods</span>(Arrays.<span style=color:#a6e22e>asList</span>(<span style=color:#e6db74>&#34;GET&#34;</span>,<span style=color:#e6db74>&#34;POST&#34;</span>,<span style=color:#e6db74>&#34;PATCH&#34;</span>, <span style=color:#e6db74>&#34;PUT&#34;</span>, <span style=color:#e6db74>&#34;DELETE&#34;</span>, <span style=color:#e6db74>&#34;OPTIONS&#34;</span>, <span style=color:#e6db74>&#34;HEAD&#34;</span>));
</span></span><span style=display:flex><span>  configuration.<span style=color:#a6e22e>setAllowCredentials</span>(<span style=color:#66d9ef>true</span>);
</span></span><span style=display:flex><span>  configuration.<span style=color:#a6e22e>setAllowedHeaders</span>(Arrays.<span style=color:#a6e22e>asList</span>(<span style=color:#e6db74>&#34;Authorization&#34;</span>, <span style=color:#e6db74>&#34;Requestor-Type&#34;</span>));
</span></span><span style=display:flex><span>  configuration.<span style=color:#a6e22e>setExposedHeaders</span>(Arrays.<span style=color:#a6e22e>asList</span>(<span style=color:#e6db74>&#34;X-Get-Header&#34;</span>));
</span></span><span style=display:flex><span>  configuration.<span style=color:#a6e22e>setMaxAge</span>(3600L);
</span></span><span style=display:flex><span>  UrlBasedCorsConfigurationSource source <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> UrlBasedCorsConfigurationSource();
</span></span><span style=display:flex><span>  source.<span style=color:#a6e22e>registerCorsConfiguration</span>(<span style=color:#e6db74>&#34;/**&#34;</span>, configuration);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> source;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=spring-security-应用于-spring-webflux>Spring Security 应用于 Spring Webflux</h3><p>对于 Webflux，尽管使用 Spring Security，将 CORS 配置应用于传入请求的最首选方法是使用 <code>CorsWebFilter</code> 。我们可以禁用 CORS 与 Spring security 的集成，而是通过提供 <code>CorsConfigurationSource</code> 与 <code>CorsWebFilter</code> 集成：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Configuration</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@EnableWebFluxSecurity</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@EnableConfigurationProperties</span>(BasicAuthConfigProperties.<span style=color:#a6e22e>class</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SecurityConfiguration</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> BasicAuthConfigProperties basicAuth;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>SecurityConfiguration</span>(BasicAuthConfigProperties basicAuth) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>basicAuth</span> <span style=color:#f92672>=</span> basicAuth;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> SecurityWebFilterChain <span style=color:#a6e22e>securityWebFilterChain</span>(ServerHttpSecurity http) {
</span></span><span style=display:flex><span>        http.<span style=color:#a6e22e>cors</span>(cors <span style=color:#f92672>-&gt;</span> cors.<span style=color:#a6e22e>disable</span>())
</span></span><span style=display:flex><span>                .<span style=color:#a6e22e>securityMatcher</span>(<span style=color:#66d9ef>new</span> PathPatternParserServerWebExchangeMatcher(<span style=color:#e6db74>&#34;/**&#34;</span>))
</span></span><span style=display:flex><span>                .<span style=color:#a6e22e>authorizeExchange</span>()
</span></span><span style=display:flex><span>                .<span style=color:#a6e22e>anyExchange</span>().<span style=color:#a6e22e>authenticated</span>().<span style=color:#a6e22e>and</span>()
</span></span><span style=display:flex><span>                .<span style=color:#a6e22e>httpBasic</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> http.<span style=color:#a6e22e>build</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> MapReactiveUserDetailsService <span style=color:#a6e22e>userDetailsService</span>() {
</span></span><span style=display:flex><span>        UserDetails user <span style=color:#f92672>=</span> User.<span style=color:#a6e22e>withDefaultPasswordEncoder</span>()
</span></span><span style=display:flex><span>                .<span style=color:#a6e22e>username</span>(basicAuth.<span style=color:#a6e22e>getUsername</span>())
</span></span><span style=display:flex><span>                .<span style=color:#a6e22e>password</span>(basicAuth.<span style=color:#a6e22e>getPassword</span>())
</span></span><span style=display:flex><span>                .<span style=color:#a6e22e>roles</span>(<span style=color:#e6db74>&#34;USER&#34;</span>)
</span></span><span style=display:flex><span>                .<span style=color:#a6e22e>build</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> MapReactiveUserDetailsService(user);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> CorsConfigurationSource <span style=color:#a6e22e>corsConfiguration</span>() {
</span></span><span style=display:flex><span>        CorsConfiguration corsConfig <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> CorsConfiguration();
</span></span><span style=display:flex><span>        corsConfig.<span style=color:#a6e22e>applyPermitDefaultValues</span>();
</span></span><span style=display:flex><span>        corsConfig.<span style=color:#a6e22e>setAllowCredentials</span>(<span style=color:#66d9ef>true</span>);
</span></span><span style=display:flex><span>        corsConfig.<span style=color:#a6e22e>addAllowedMethod</span>(<span style=color:#e6db74>&#34;GET&#34;</span>);
</span></span><span style=display:flex><span>        corsConfig.<span style=color:#a6e22e>addAllowedMethod</span>(<span style=color:#e6db74>&#34;PATCH&#34;</span>);
</span></span><span style=display:flex><span>        corsConfig.<span style=color:#a6e22e>addAllowedMethod</span>(<span style=color:#e6db74>&#34;POST&#34;</span>);
</span></span><span style=display:flex><span>        corsConfig.<span style=color:#a6e22e>addAllowedMethod</span>(<span style=color:#e6db74>&#34;OPTIONS&#34;</span>);
</span></span><span style=display:flex><span>        corsConfig.<span style=color:#a6e22e>setAllowedOrigins</span>(Arrays.<span style=color:#a6e22e>asList</span>(<span style=color:#e6db74>&#34;http://localhost:4200&#34;</span>));
</span></span><span style=display:flex><span>        corsConfig.<span style=color:#a6e22e>setAllowedHeaders</span>(Arrays.<span style=color:#a6e22e>asList</span>(<span style=color:#e6db74>&#34;Authorization&#34;</span>, <span style=color:#e6db74>&#34;Requestor-Type&#34;</span>));
</span></span><span style=display:flex><span>        corsConfig.<span style=color:#a6e22e>setExposedHeaders</span>(Arrays.<span style=color:#a6e22e>asList</span>(<span style=color:#e6db74>&#34;X-Get-Header&#34;</span>));
</span></span><span style=display:flex><span>        UrlBasedCorsConfigurationSource source <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>new</span> UrlBasedCorsConfigurationSource();
</span></span><span style=display:flex><span>        source.<span style=color:#a6e22e>registerCorsConfiguration</span>(<span style=color:#e6db74>&#34;/**&#34;</span>, corsConfig);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> source;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> CorsWebFilter <span style=color:#a6e22e>corsWebFilter</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> CorsWebFilter(corsConfiguration());
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=结论>结论</h2><p>简而言之，CORS 配置取决于多个因素：</p><ul><li>Spring Web / Spring Webflux</li><li>本地/全局 CORS 配置</li><li>是否使用 Spring Security</li></ul><p>根据框架，我们可以决定哪种方法效果最好并且最容易实现，这样我们就可以避免 CORS 错误。您可以使用 <a href=https://github.com/thombergs/code-examples/tree/master/spring-boot/cors/configuring-cors-with-spring target=_blank>GitHub 上的示例应用程序</a>。</p><p>原文链接：<a href=https://reflectoring.io/spring-cors/ target=_blank>https://reflectoring.io/spring-cors/</a></p></div><div><div style=font-weight:700>Share this post:</div><a class=social-link-item href="https://twitter.com/intent/tweet?text=%5b%e8%af%91%5d%e4%bd%bf%e7%94%a8%20Spring%20Boot%20%e5%92%8c%20Spring%20Security%20%e9%85%8d%e7%bd%ae%20CORS https%3a%2f%2fblog.chensoul.cc%2fposts%2f2023%2f07%2f26%2fspring-cors%2f" target=_blank rel="noopener noreferrer" title="Click to share on Twitter"><i class="fa-brands fa-square-twitter fa-2xl" style=color:#55acee></i>
</a><a class=social-link-item href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fblog.chensoul.cc%2fposts%2f2023%2f07%2f26%2fspring-cors%2f&title=%5b%e8%af%91%5d%e4%bd%bf%e7%94%a8%20Spring%20Boot%20%e5%92%8c%20Spring%20Security%20%e9%85%8d%e7%bd%ae%20CORS" target=_blank rel="noopener noreferrer" title="Click to share on LinkedIn"><i class="fa-brands fa-linkedin fa-2xl" style=color:#007bb5></i>
</a><a class=social-link-item href="https://telegram.me/share/url?text=%5b%e8%af%91%5d%e4%bd%bf%e7%94%a8%20Spring%20Boot%20%e5%92%8c%20Spring%20Security%20%e9%85%8d%e7%bd%ae%20CORS&amp;url=https%3a%2f%2fblog.chensoul.cc%2fposts%2f2023%2f07%2f26%2fspring-cors%2f" target=_blank rel="noopener noreferrer" title="Click to share on telegram"><i class="fa-brands fa-telegram fa-2xl" style=color:#007bb5></i>
</a><a class=social-link-item href="https://reddit.com/submit?url=https%3a%2f%2fblog.chensoul.cc%2fposts%2f2023%2f07%2f26%2fspring-cors%2f&title=%5b%e8%af%91%5d%e4%bd%bf%e7%94%a8%20Spring%20Boot%20%e5%92%8c%20Spring%20Security%20%e9%85%8d%e7%bd%ae%20CORS" target=_blank rel="noopener noreferrer" title="Click to share on reddit"><i class="fa-brands fa-reddit fa-2xl" style=color:#007bb5></i>
</a><a class=social-link-item href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fblog.chensoul.cc%2fposts%2f2023%2f07%2f26%2fspring-cors%2f" target=_blank rel="noopener noreferrer" title="Click to share on facebook"><i class="fa-brands fa-facebook fa-2xl" style=color:#007bb5></i>
</a><a class=social-link-item href="https://api.whatsapp.com/send?text=%5b%e8%af%91%5d%e4%bd%bf%e7%94%a8%20Spring%20Boot%20%e5%92%8c%20Spring%20Security%20%e9%85%8d%e7%bd%ae%20CORS%20-%20https%3a%2f%2fblog.chensoul.cc%2fposts%2f2023%2f07%2f26%2fspring-cors%2f" target=_blank rel="noopener noreferrer" title="Click to share on whatsapp"><i class="fa-brands fa-whatsapp fa-2xl" style=color:#007bb5></i></a></div></div></article><nav class="navigation post-navigation" role=navigation><h2 class=screen-reader-text>Post navigation</h2><div class=nav-links><div class=nav-previous><a href=/posts/2023/07/26/spring-boot-authorization-server/ rel=next><span class=post-title>[译]Spring Boot授权服务器 - 使用 Java 的资源服务器和客户端凭证示例</span></a></div><div class=nav-next><a href=/posts/2023/07/26/spring-boot-null-safety-annotations/ rel=prev><span class=post-title>[译]使用 Spring 的 Null-Safety 注解保护您的代码免受 NullPointerExceptions 的影响</span></a></div></div></nav><h2>Related content</h2><ul><li><a href=/posts/2023/10/13/new-features-in-spring-boot-3-and-spring-6/>[译]Spring Boot3和Spring6中的新特性</a></li><li><a href=/posts/2023/10/12/spring-security-interview-questions/>[译]Spring Security 面试问题</a></li><li><a href=/posts/2023/09/19/spring-security-tutorial/>[译]Spring Security 与 JWT for REST API</a></li><li><a href=/posts/2023/09/19/spring-security-jwt/>[译]如何使用Spring Security和JWT保护您的REST API</a></li><li><a href=/posts/2023/08/25/global-error-handler-in-a-spring-rest-api/>[译]REST API 的自定义错误消息处理</a></li><li><a href=/posts/2023/08/25/spring-events/>[译]Spring Events</a></li><li><a href=/posts/2023/08/25/spring-security-async-principal-propagation/>[译]使用@Async进行Spring Security上下文传播</a></li><li><a href=/posts/2023/08/25/exception-handling-for-rest-with-spring/>[译]使用Spring进行REST的错误处理</a></li><li><a href=/posts/2023/08/25/spring-async/>[译]如何在Spring中执行@Async</a></li><li><a href=/posts/2023/08/18/how-to-implement-jwt-authentication-in-spring-boot-project/>[译]Spring Boot项目如何实现JWT认证？</a></li></ul></main></section></div><div id=footer class=footer-wrap><footer id=colophon class="site-footer container clearfix" role=contentinfo><div id=footer-text class=site-info><span class=credit-link><a href=/ target=_blank rel="noopener noreferrer">ChenSoul</a>
Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreferrer">Hugo</a>
<a style=margin-left:20px href=/privacy_policy/ target=_blank rel="noopener noreferrer">Privacy Policy</a></span></div></footer></div></div><script type=text/javascript src=/main.min.js></script></body></html>