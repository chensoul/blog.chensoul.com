<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>2023-12-15｜JNDI InitialContext源码分析、ClassLoader加载机制 | ChenSoul</title>
<meta name=keywords content="java,jndi,classloader"><meta name=description content="Today I Learned. 今天分享内容：JNDI InitialContext源码分析、ClassLoader加载机制。 JNDI InitialContext 源码分析 JNDI包结构 javax.naming Context InitialContext Name CompositeName CompoundName NameImpl NameParser NamingEnumeration Referenceable RefAddr BinaryRefAddr StringRefAddr NameClassPair Binding Reference LinkRef javax.naming.directory Attribute BasicAttribute Attributes BasicAttributes DirContext InitialDirContext ModificationItem SearchControls SearchResult javax.naming.spi NamingManager DirectoryManager ObjectFactory DirObjectFactory ObjectFactoryBuilder StateFactory DirStateFactory InitialContextFactory InitialContextFactoryBuilder Resolver"><meta name=author content="chensoul"><link rel=canonical href=https://blog.chensoul.cc/posts/2023/12/15/til/><meta name=google-site-verification content="nBXwg45SBRjTX78SA-mH0asrAbsdu9c1nk0ObSry7aQ"><link crossorigin=anonymous href=/assets/css/stylesheet.899d9a536396b9b03c9eae0c99cc6ec954a90da94036f5390d131eb8071bb417.css integrity="sha256-iZ2aU2OWubA8nq4MmcxuyVSpDalANvU5DRMeuAcbtBc=" rel="preload stylesheet" as=style><link rel=icon href=https://blog.chensoul.cc/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://blog.chensoul.cc/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://blog.chensoul.cc/favicon-32x32.png><link rel=apple-touch-icon href=https://blog.chensoul.cc/apple-touch-icon.png><link rel=mask-icon href=https://blog.chensoul.cc/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://blog.chensoul.cc/posts/2023/12/15/til/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta name=baidu-site-verification content="codeva-FYpQY8JdLU"><meta property="og:title" content="2023-12-15｜JNDI InitialContext源码分析、ClassLoader加载机制"><meta property="og:description" content="Today I Learned. 今天分享内容：JNDI InitialContext源码分析、ClassLoader加载机制。 JNDI InitialContext 源码分析 JNDI包结构 javax.naming Context InitialContext Name CompositeName CompoundName NameImpl NameParser NamingEnumeration Referenceable RefAddr BinaryRefAddr StringRefAddr NameClassPair Binding Reference LinkRef javax.naming.directory Attribute BasicAttribute Attributes BasicAttributes DirContext InitialDirContext ModificationItem SearchControls SearchResult javax.naming.spi NamingManager DirectoryManager ObjectFactory DirObjectFactory ObjectFactoryBuilder StateFactory DirStateFactory InitialContextFactory InitialContextFactoryBuilder Resolver"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.chensoul.cc/posts/2023/12/15/til/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-12-15T00:00:00+08:00"><meta property="article:modified_time" content="2023-12-15T00:00:00+08:00"><meta property="og:site_name" content="ChenSoul"><meta name=twitter:card content="summary"><meta name=twitter:title content="2023-12-15｜JNDI InitialContext源码分析、ClassLoader加载机制"><meta name=twitter:description content="Today I Learned. 今天分享内容：JNDI InitialContext源码分析、ClassLoader加载机制。 JNDI InitialContext 源码分析 JNDI包结构 javax.naming Context InitialContext Name CompositeName CompoundName NameImpl NameParser NamingEnumeration Referenceable RefAddr BinaryRefAddr StringRefAddr NameClassPair Binding Reference LinkRef javax.naming.directory Attribute BasicAttribute Attributes BasicAttributes DirContext InitialDirContext ModificationItem SearchControls SearchResult javax.naming.spi NamingManager DirectoryManager ObjectFactory DirObjectFactory ObjectFactoryBuilder StateFactory DirStateFactory InitialContextFactory InitialContextFactoryBuilder Resolver"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://blog.chensoul.cc/posts/"},{"@type":"ListItem","position":2,"name":"2023-12-15｜JNDI InitialContext源码分析、ClassLoader加载机制","item":"https://blog.chensoul.cc/posts/2023/12/15/til/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"2023-12-15｜JNDI InitialContext源码分析、ClassLoader加载机制","name":"2023-12-15｜JNDI InitialContext源码分析、ClassLoader加载机制","description":"Today I Learned. 今天分享内容：JNDI InitialContext源码分析、ClassLoader加载机制。 JNDI InitialContext 源码分析 JNDI包结构 javax.naming Context InitialContext Name CompositeName CompoundName NameImpl NameParser NamingEnumeration Referenceable RefAddr BinaryRefAddr StringRefAddr NameClassPair Binding Reference LinkRef javax.naming.directory Attribute BasicAttribute Attributes BasicAttributes DirContext InitialDirContext ModificationItem SearchControls SearchResult javax.naming.spi NamingManager DirectoryManager ObjectFactory DirObjectFactory ObjectFactoryBuilder StateFactory DirStateFactory InitialContextFactory InitialContextFactoryBuilder Resolver","keywords":["java","jndi","classloader"],"articleBody":"Today I Learned. 今天分享内容：JNDI InitialContext源码分析、ClassLoader加载机制。\nJNDI InitialContext 源码分析 JNDI包结构 javax.naming\nContext InitialContext Name CompositeName CompoundName NameImpl NameParser NamingEnumeration Referenceable RefAddr BinaryRefAddr StringRefAddr NameClassPair Binding Reference LinkRef javax.naming.directory\nAttribute\nBasicAttribute Attributes\nBasicAttributes DirContext\nInitialDirContext ModificationItem\nSearchControls\nSearchResult\njavax.naming.spi\nNamingManager DirectoryManager ObjectFactory DirObjectFactory ObjectFactoryBuilder StateFactory DirStateFactory InitialContextFactory InitialContextFactoryBuilder Resolver ContinuationContext ContinuationDirContext ResolveResult InitialContext 构造方法 InitialContext的初始化有几种方式：\n通过构造方法 通过 InitialContextFactory#getInitialContext 通过协议转换创建 InitialContext.getURLOrDefaultInitCtx(String name) 一个 JNDI 示例：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 public class DNSClient { public static void main(String[] args) { Hashtable\u003cString, String\u003e env = new Hashtable\u003c\u003e(); env.put(Context.INITIAL_CONTEXT_FACTORY, \"com.sun.jndi.dns.DnsContextFactory\"); env.put(Context.PROVIDER_URL, \"dns://114.114.114.114\"); try { DirContext ctx = new InitialDirContext(env); Attributes res = ctx.getAttributes(\"example.com\", new String[]{\"A\"}); System.out.println(res); } catch (NamingException e) { e.printStackTrace(); } } } InitialDirContext 构造方法初始化过程：\n调用 new InitialContext(Hashtable\u003c?,?\u003e environment)\n如果 environment 不为空，则克隆一个\n调用 init(environment)\n调用 ResourceManager.getInitialEnvironment(environment) 获取初始化的环境变量\n如果入参为空，则 new 一个 Hashtable ，大小 11\nJNDI 有7个预定义的变量，key 值如下\njava.naming.factory.initial java.naming.factory.object java.naming.factory.state java.naming.factory.url.pkgs java.naming.provider.url java.naming.dns.url java.naming.factory.control 如果定义了 java.naming.applet，则调用 AppletParameter 获取变量的值；否则从 System Properties 中获取\n如果定义了 com.sun.naming.disable.app.resource.files，且该变量的值为 true，即禁用应用的资源文件，则返回；否则调用 ResourceManager.getApplicationResources() 读取应用资源文件（即 jndi.properties）定义的变量调用 mergeTables 方法合并到 environment\n通过 classloader 读取应用资源即 jndi.properties 文件内容，可能会读取到多个，读取到之后合并到 environment 通过 IO 读取 JavaHome 的 lib 目录下的 jndi.properties 文件内容，然后合并到 environment mergeTables 合并逻辑： 变量新的 environment 的 key，如果旧的 environment对应 key 的值为空，则使用新的值；如果不为空，并且 key 是 JNDI 预定义的 java.naming.factory.object、java.naming.factory.url.pkgs、java.naming.factory.state、java.naming.factory.control，则使用冒号连接新旧的值。相当于则几个值的属性可以配置多个值。 如果 java.naming.factory.initial 不为空，则调用 getDefaultInitCtx() 初始化默认的 Context\ngotDefault 变量控制只能初始化一次\n调用 NamingManager.getInitialContext(myProps) 获取默认的 Context\n如果 InitialContextFactoryBuilder 不为空，则使用 InitialContextFactoryBuilder 创建 InitialContextFactory；否则，使用反射创建 InitialContextFactory\n获取 ClassLoader 使用的是 VersionHelper 工具栏的 getContextClassLoader 方法 先获取当前线程的 ClassLoader，如果为空，再获取 SystemClassLoader 调用 InitialContextFactory 的 getInitialContext(env) 创建 Context\n说明：\n1、读取或者合并 environment 的顺序\n程序设置 -\u003e Applet -\u003e System Properties -\u003e 应用的 jndi.properties -\u003e JavaHome 的 jndi.properties 2、VersionHelper 工具类有读取 System Properties（使用 Java Security 的 AccessController ） 、获取 ClassLoader、反射的方法\nVersionHelper是抽象的单例类，定义为抽象类的好处是可以将方法和实现进行分离。\n1 2 3 4 5 6 7 8 9 10 11 12 13 public abstract class VersionHelper { private static VersionHelper helper = null; VersionHelper() {} // Disallow anyone from creating one of these. static { helper = new VersionHelper12(); } public static VersionHelper getVersionHelper() { return helper; } } 3、ResourceManager.getApplicationResources() 使用了缓存和同步。缓存使用的是 WeakHashMap\nWeakHashMap 是 Java 中的一种特殊类型的 Map 实现，它使用弱引用（Weak Reference）来存储键对象。在 WeakHashMap 中，当键对象没有被其他强引用所引用时，它们可以被垃圾回收器回收，即使它们存在于 WeakHashMap 中。\n1 2 3 // WeakHashMap private static final WeakHashMap\u003cObject, Hashtable\u003c? super String, Object\u003e\u003e propertiesCache = new WeakHashMap\u003c\u003e(11); 需要注意的是，WeakHashMap 的性能可能会受到影响，因为它需要在垃圾回收时清理无效的键值对。此外，由于键对象的弱引用特性，可能会导致一些与预期不符的行为，因此在使用 WeakHashMap 时需要仔细考虑其适用性和潜在的影响。\n读写 propertiesCache 时，对 propertiesCache 对象添加 synchronized 关键字\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 private static Hashtable\u003c? super String, Object\u003e getProviderResource(Object obj)throws NamingException{ if (obj == null) { return (new Hashtable\u003c\u003e(1)); } synchronized (propertiesCache) { Class\u003c?\u003e c = obj.getClass(); Hashtable\u003c? super String, Object\u003e props = propertiesCache.get(c); if (props != null) { return props; } props = new Properties(); InputStream istream = helper.getResourceAsStream(c, PROVIDER_RESOURCE_FILE_NAME); if (istream != null) { try { ((Properties)props).load(istream); } catch (IOException e) { NamingException ne = new ConfigurationException( \"Error reading provider resource file for \" + c); ne.setRootCause(e); throw ne; } } propertiesCache.put(c, props); return props; } } WeakHashMap 是非线程安全的，它不是设计用于在多线程环境下进行并发访问的。如果多个线程同时对 WeakHashMap 进行修改操作，可能会导致不一致的结果或抛出异常。\n如果需要在多线程环境中使用 WeakHashMap，可以考虑以下两种方式：\n使用同步机制：您可以使用 synchronized 关键字或其他同步机制（如 ReentrantLock）来保护对 WeakHashMap 的访问。通过确保只有一个线程可以同时修改 WeakHashMap，可以避免并发访问的问题。 使用线程安全的替代类：如果需要在多线程环境中使用并发访问的 Map，可以考虑使用线程安全的实现，如 ConcurrentHashMap。 4、JNDI 还使用了工厂模式和构造者模式。相关类：InitialContextFactory、InitialContextFactoryBuilder，则两个类的方法参数都是使用的 Hashtable\u003c?,?\u003e environment，这样可以传入多个参数。JNDI 有定义 spi 包，但是却没有使用Java 的 ServiceLoader 类实现 SPI。原因是 JNDI 是 Java 1.3 引入的，而 ServiceLoader 是在 Java 1.6 引入的。\nContext 初始化 InitialContext 实现了 Context 接口，其内部有一个 Context 引用，表示默认的 Context。Context 接口定义的方法都和命名有关，每个命名都有一个名称，通过这个名称获取 Context 时，可能会获取默认的 Context ，也可能获取自定义的 Context 。\n代码如下：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 protected Context getURLOrDefaultInitCtx(String name) throws NamingException { if (NamingManager.hasInitialContextFactoryBuilder()) { return getDefaultInitCtx(); } String scheme = getURLScheme(name); if (scheme != null) { Context ctx = NamingManager.getURLContext(scheme, myProps); if (ctx != null) { return ctx; } } return getDefaultInitCtx(); } 1、如果设置了InitialContextFactoryBuilder，则直接返回默认的 Context\n2、如果名称中有 schema，则调用 NamingManager.getURLContext(scheme, myProps) 获取 Context。例如：java:comp/env/jdbc/UserPlatformDB\n调用 getURLObject 方法 返回对象 通过 ResourceManager 获取 ObjectFactory 读取 java.naming.factory.url.pkgs 值作为包名，如果值为空，则使用 com.sun.jndi.url；否则将该值使用冒号拼接上 com.sun.jndi.url 类名前缀为 \".\" + scheme + \".\" + scheme + \"URLContextFactory\" 使用冒号分隔符遍历包名，将包名加上类名，得到全类名的 URLContextFactory，然后通过反射加载类，直到得到一个不为空的 factory，并放入二级缓存中（WeakHashMap","wordCount":"5504","inLanguage":"en","datePublished":"2023-12-15T00:00:00+08:00","dateModified":"2023-12-15T00:00:00+08:00","author":{"@type":"Person","name":"chensoul"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.chensoul.cc/posts/2023/12/15/til/"},"publisher":{"@type":"Organization","name":"ChenSoul","logo":{"@type":"ImageObject","url":"https://blog.chensoul.cc/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://blog.chensoul.cc/ accesskey=h title="ChenSoul (Alt + H)">ChenSoul</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://blog.chensoul.cc/categories title=分类><span>分类</span></a></li><li><a href=https://blog.chensoul.cc/tags title=标签><span>标签</span></a></li><li><a href=https://blog.chensoul.cc/search title="搜索 (Alt + /)" accesskey=/><span>搜索</span></a></li><li><a href=https://blog.chensoul.cc/index.xml title=订阅><span>订阅</span></a></li><li><a href=https://github.com/chensoul title=关于><span>关于</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">2023-12-15｜JNDI InitialContext源码分析、ClassLoader加载机制</h1><div class=post-meta><span title='2023-12-15 00:00:00 +0800 CST'>2023-12-15</span>&nbsp;·&nbsp;11 min&nbsp;·&nbsp;5504 words&nbsp;·&nbsp;chensoul</div></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#jndi-initialcontext-%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90 aria-label="JNDI InitialContext 源码分析">JNDI InitialContext 源码分析</a><ul><li><a href=#jndi%e5%8c%85%e7%bb%93%e6%9e%84 aria-label=JNDI包结构>JNDI包结构</a></li><li><a href=#initialcontext-%e6%9e%84%e9%80%a0%e6%96%b9%e6%b3%95 aria-label="InitialContext 构造方法">InitialContext 构造方法</a></li><li><a href=#context-%e5%88%9d%e5%a7%8b%e5%8c%96 aria-label="Context 初始化">Context 初始化</a></li></ul></li><li><a href=#java-%e7%b1%bb%e5%8a%a0%e8%bd%bd%e6%9c%ba%e5%88%b6 aria-label="Java 类加载机制">Java 类加载机制</a><ul><li><a href=#classloader-%e7%b1%bb%e7%bb%93%e6%9e%84 aria-label="ClassLoader 类结构">ClassLoader 类结构</a></li><li><a href=#classloader-%e5%a6%82%e4%bd%95%e5%b7%a5%e4%bd%9c aria-label="ClassLoader 如何工作">ClassLoader 如何工作</a></li><li><a href=#classloader-%e4%b8%89%e4%b8%aa%e7%89%b9%e6%80%a7 aria-label="ClassLoader 三个特性">ClassLoader 三个特性</a></li><li><a href=#classloader-%e6%ba%90%e7%a0%81 aria-label="ClassLoader 源码">ClassLoader 源码</a></li><li><a href=#context-classloaders aria-label="Context Classloaders">Context Classloaders</a></li><li><a href=#%e5%8f%82%e8%80%83 aria-label=参考>参考</a></li></ul></li></ul></div></details></div><div class=post-content><p>Today I Learned. 今天分享内容：JNDI InitialContext源码分析、ClassLoader加载机制。</p><h2 id=jndi-initialcontext-源码分析>JNDI InitialContext 源码分析<a hidden class=anchor aria-hidden=true href=#jndi-initialcontext-源码分析>#</a></h2><h3 id=jndi包结构>JNDI包结构<a hidden class=anchor aria-hidden=true href=#jndi包结构>#</a></h3><p><strong>javax.naming</strong></p><ul><li>Context<ul><li>InitialContext</li></ul></li><li>Name<ul><li>CompositeName</li><li>CompoundName</li></ul></li><li>NameImpl</li><li>NameParser</li><li>NamingEnumeration</li><li>Referenceable</li><li>RefAddr<ul><li>BinaryRefAddr</li><li>StringRefAddr</li></ul></li><li>NameClassPair<ul><li>Binding</li></ul></li><li>Reference<ul><li>LinkRef</li></ul></li></ul><p><strong>javax.naming.directory</strong></p><ul><li><p>Attribute</p><ul><li>BasicAttribute</li></ul></li><li><p>Attributes</p><ul><li>BasicAttributes</li></ul></li><li><p>DirContext</p><ul><li>InitialDirContext</li></ul></li><li><p>ModificationItem</p></li><li><p>SearchControls</p></li><li><p>SearchResult</p></li></ul><p><strong>javax.naming.spi</strong></p><ul><li>NamingManager<ul><li>DirectoryManager</li></ul></li><li>ObjectFactory<ul><li>DirObjectFactory</li></ul></li><li>ObjectFactoryBuilder</li><li>StateFactory<ul><li>DirStateFactory</li></ul></li><li>InitialContextFactory</li><li>InitialContextFactoryBuilder</li><li>Resolver<ul><li>ContinuationContext<ul><li>ContinuationDirContext</li></ul></li></ul></li><li>ResolveResult</li></ul><h3 id=initialcontext-构造方法>InitialContext 构造方法<a hidden class=anchor aria-hidden=true href=#initialcontext-构造方法>#</a></h3><p>InitialContext的初始化有几种方式：</p><ul><li>通过构造方法</li><li>通过 <code>InitialContextFactory#getInitialContext</code></li><li>通过协议转换创建 <code>InitialContext.getURLOrDefaultInitCtx(String name)</code></li></ul><p>一个 JNDI 示例：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>DNSClient</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=n>Hashtable</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>env</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Hashtable</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=n>env</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>Context</span><span class=p>.</span><span class=na>INITIAL_CONTEXT_FACTORY</span><span class=p>,</span><span class=w> </span><span class=s>&#34;com.sun.jndi.dns.DnsContextFactory&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=n>env</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>Context</span><span class=p>.</span><span class=na>PROVIDER_URL</span><span class=p>,</span><span class=w> </span><span class=s>&#34;dns://114.114.114.114&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=n>DirContext</span><span class=w> </span><span class=n>ctx</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>InitialDirContext</span><span class=p>(</span><span class=n>env</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=n>Attributes</span><span class=w> </span><span class=n>res</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ctx</span><span class=p>.</span><span class=na>getAttributes</span><span class=p>(</span><span class=s>&#34;example.com&#34;</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>String</span><span class=o>[]</span><span class=p>{</span><span class=s>&#34;A&#34;</span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>res</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>NamingException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>InitialDirContext 构造方法初始化过程：</p><p>调用 <code>new InitialContext(Hashtable&lt;?,?> environment)</code></p><ul><li><p>如果 environment 不为空，则克隆一个</p></li><li><p>调用 <code>init(environment)</code></p><ul><li><p>调用 <code>ResourceManager.getInitialEnvironment(environment)</code> 获取初始化的环境变量</p><ul><li><p>如果入参为空，则 new 一个 Hashtable ，大小 11</p></li><li><p>JNDI 有7个预定义的变量，key 值如下</p><ul><li><code>java.naming.factory.initial</code></li><li><code>java.naming.factory.object</code></li><li><code>java.naming.factory.state</code></li><li><code>java.naming.factory.url.pkgs</code></li><li><code>java.naming.provider.url</code></li><li><code>java.naming.dns.url</code></li><li><code>java.naming.factory.control</code></li></ul></li><li><p>如果定义了 <code>java.naming.applet</code>，则调用 AppletParameter 获取变量的值；否则从 System Properties 中获取</p></li><li><p>如果定义了 <code>com.sun.naming.disable.app.resource.files</code>，且该变量的值为 true，即禁用应用的资源文件，则返回；否则调用 <code>ResourceManager.getApplicationResources()</code> 读取应用资源文件（即 jndi.properties）定义的变量调用 <code>mergeTables</code> 方法合并到 environment</p><ul><li>通过 classloader 读取应用资源即 jndi.properties 文件内容，可能会读取到多个，读取到之后合并到 environment</li><li>通过 IO 读取 JavaHome 的 lib 目录下的 jndi.properties 文件内容，然后合并到 environment</li><li><code>mergeTables</code> 合并逻辑：<ul><li>变量新的 environment 的 key，如果旧的 environment对应 key 的值为空，则使用新的值；如果不为空，并且 key 是 JNDI 预定义的<code> java.naming.factory.object</code>、<code>java.naming.factory.url.pkgs</code>、<code>java.naming.factory.state</code>、<code>java.naming.factory.control</code>，则使用冒号连接新旧的值。相当于则几个值的属性可以配置多个值。</li></ul></li></ul></li></ul></li></ul></li><li><p>如果 <code>java.naming.factory.initial</code> 不为空，则调用 <code>getDefaultInitCtx()</code> 初始化默认的 Context</p><ul><li><p>gotDefault 变量控制只能初始化一次</p></li><li><p>调用 <code>NamingManager.getInitialContext(myProps)</code> 获取默认的 Context</p><ul><li><p>如果 <code>InitialContextFactoryBuilder</code> 不为空，则使用 <code>InitialContextFactoryBuilder</code> 创建 <code>InitialContextFactory</code>；否则，使用反射创建 InitialContextFactory</p><ul><li>获取 ClassLoader 使用的是 VersionHelper 工具栏的 getContextClassLoader 方法<ul><li>先获取当前线程的 ClassLoader，如果为空，再获取 <code>SystemClassLoader</code></li></ul></li></ul></li><li><p>调用 InitialContextFactory 的 <code>getInitialContext(env) </code>创建 Context</p></li></ul></li></ul></li></ul><p>说明：</p><ul><li><p>1、读取或者合并 environment 的顺序</p><ul><li>程序设置 -> Applet -> System Properties -> 应用的 jndi.properties -> JavaHome 的 jndi.properties</li></ul></li><li><p>2、VersionHelper 工具类有读取 System Properties（使用 Java Security 的 AccessController ） 、获取 ClassLoader、反射的方法</p><p>VersionHelper是抽象的单例类，定义为抽象类的好处是可以将方法和实现进行分离。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>abstract</span><span class=w> </span><span class=kd>class</span> <span class=nc>VersionHelper</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>VersionHelper</span><span class=w> </span><span class=n>helper</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  	</span><span class=n>VersionHelper</span><span class=p>()</span><span class=w> </span><span class=p>{}</span><span class=w> </span><span class=c1>// Disallow anyone from creating one of these.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>static</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>helper</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>VersionHelper12</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>VersionHelper</span><span class=w> </span><span class=nf>getVersionHelper</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>helper</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>  
</span></span></span></code></pre></td></tr></table></div></div></li><li><p>3、<code>ResourceManager.getApplicationResources()</code> 使用了缓存和同步。缓存使用的是 WeakHashMap</p><blockquote><p><code>WeakHashMap</code> 是 Java 中的一种特殊类型的 <code>Map</code> 实现，它使用弱引用（Weak Reference）来存储键对象。在 <code>WeakHashMap</code> 中，当键对象没有被其他强引用所引用时，它们可以被垃圾回收器回收，即使它们存在于 <code>WeakHashMap</code> 中。</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// WeakHashMap&lt;Class | ClassLoader, Hashtable&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>WeakHashMap</span><span class=o>&lt;</span><span class=n>Object</span><span class=p>,</span><span class=w> </span><span class=n>Hashtable</span><span class=o>&lt;?</span><span class=w> </span><span class=kd>super</span><span class=w> </span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>&gt;&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>propertiesCache</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>WeakHashMap</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>11</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><blockquote><p>需要注意的是，<code>WeakHashMap</code> 的性能可能会受到影响，因为它需要在垃圾回收时清理无效的键值对。此外，由于键对象的弱引用特性，可能会导致一些与预期不符的行为，因此在使用 <code>WeakHashMap</code> 时需要仔细考虑其适用性和潜在的影响。</p></blockquote><p>读写 propertiesCache 时，对 propertiesCache 对象添加 synchronized 关键字</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>	</span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>Hashtable</span><span class=o>&lt;?</span><span class=w> </span><span class=kd>super</span><span class=w> </span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nf>getProviderResource</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>obj</span><span class=p>)</span><span class=kd>throws</span><span class=w> </span><span class=n>NamingException</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>obj</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Hashtable</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>1</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>propertiesCache</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Class</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>c</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>obj</span><span class=p>.</span><span class=na>getClass</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Hashtable</span><span class=o>&lt;?</span><span class=w> </span><span class=kd>super</span><span class=w> </span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=n>props</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>propertiesCache</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>c</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>props</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>props</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>props</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Properties</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>InputStream</span><span class=w> </span><span class=n>istream</span><span class=w> </span><span class=o>=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>helper</span><span class=p>.</span><span class=na>getResourceAsStream</span><span class=p>(</span><span class=n>c</span><span class=p>,</span><span class=w> </span><span class=n>PROVIDER_RESOURCE_FILE_NAME</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>istream</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>((</span><span class=n>Properties</span><span class=p>)</span><span class=n>props</span><span class=p>).</span><span class=na>load</span><span class=p>(</span><span class=n>istream</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>IOException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>NamingException</span><span class=w> </span><span class=n>ne</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ConfigurationException</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=s>&#34;Error reading provider resource file for &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>c</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>ne</span><span class=p>.</span><span class=na>setRootCause</span><span class=p>(</span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>throw</span><span class=w> </span><span class=n>ne</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>propertiesCache</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>c</span><span class=p>,</span><span class=w> </span><span class=n>props</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>props</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><blockquote><p><code>WeakHashMap</code> 是非线程安全的，它不是设计用于在多线程环境下进行并发访问的。如果多个线程同时对 <code>WeakHashMap</code> 进行修改操作，可能会导致不一致的结果或抛出异常。</p><p>如果需要在多线程环境中使用 <code>WeakHashMap</code>，可以考虑以下两种方式：</p><ol><li>使用同步机制：您可以使用 <code>synchronized</code> 关键字或其他同步机制（如 <code>ReentrantLock</code>）来保护对 <code>WeakHashMap</code> 的访问。通过确保只有一个线程可以同时修改 <code>WeakHashMap</code>，可以避免并发访问的问题。</li><li>使用线程安全的替代类：如果需要在多线程环境中使用并发访问的 <code>Map</code>，可以考虑使用线程安全的实现，如 <code>ConcurrentHashMap</code>。</li></ol></blockquote></li><li><p>4、JNDI 还使用了工厂模式和构造者模式。相关类：InitialContextFactory、InitialContextFactoryBuilder，则两个类的方法参数都是使用的 <code>Hashtable&lt;?,?> environment</code>，这样可以传入多个参数。JNDI 有定义 spi 包，但是却没有使用Java 的 ServiceLoader 类实现 SPI。原因是 JNDI 是 Java 1.3 引入的，而 ServiceLoader 是在 Java 1.6 引入的。</p></li></ul><h3 id=context-初始化>Context 初始化<a hidden class=anchor aria-hidden=true href=#context-初始化>#</a></h3><p>InitialContext 实现了 Context 接口，其内部有一个 Context 引用，表示默认的 Context。Context 接口定义的方法都和命名有关，每个命名都有一个名称，通过这个名称获取 Context 时，可能会获取默认的 Context ，也可能获取自定义的 Context 。</p><p>代码如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>protected</span><span class=w> </span><span class=n>Context</span><span class=w> </span><span class=nf>getURLOrDefaultInitCtx</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>name</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>throws</span><span class=w> </span><span class=n>NamingException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>NamingManager</span><span class=p>.</span><span class=na>hasInitialContextFactoryBuilder</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>getDefaultInitCtx</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>String</span><span class=w> </span><span class=n>scheme</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getURLScheme</span><span class=p>(</span><span class=n>name</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>scheme</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Context</span><span class=w> </span><span class=n>ctx</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>NamingManager</span><span class=p>.</span><span class=na>getURLContext</span><span class=p>(</span><span class=n>scheme</span><span class=p>,</span><span class=w> </span><span class=n>myProps</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>ctx</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>ctx</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>getDefaultInitCtx</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>1、如果设置了<code>InitialContextFactoryBuilder</code>，则直接返回默认的 Context</p><p>2、如果名称中有 schema，则调用 <code>NamingManager.getURLContext(scheme, myProps)</code> 获取 Context。例如：<code>java:comp/env/jdbc/UserPlatformDB</code></p><ul><li>调用 getURLObject 方法 返回对象<ul><li>通过 ResourceManager 获取 ObjectFactory<ul><li>读取 <code>java.naming.factory.url.pkgs</code> 值作为包名，如果值为空，则使用 <code>com.sun.jndi.url</code>；否则将该值使用冒号拼接上 <code>com.sun.jndi.url</code></li><li>类名前缀为 <code>"." + scheme + "." + scheme + "URLContextFactory"</code></li><li>使用冒号分隔符遍历包名，将包名加上类名，得到全类名的 URLContextFactory，然后通过反射加载类，直到得到一个不为空的 factory，并放入二级缓存中（<code>WeakHashMap&lt;ClassLoader, Map&lt;String, List&lt;NamedWeakReference&lt;Object>>>></code>）。<ul><li>例如，对于 <code>java:comp/env/jdbc/UserPlatformDB</code>，如果没有指定 <code>java.naming.factory.url.pkgs</code>，则得到的包名为：<code>com.sun.jndi.url.java.javaURLContextFactory</code></li></ul></li></ul></li><li>如果 factory 不为空，则调用 <code>factory.getObjectInstance(urlInfo, name, nameCtx, environment) </code>返回对象</li></ul></li><li>如果返回的对象是 Context，则返回</li></ul><p>3、返回默认的 Context</p><h2 id=java-类加载机制>Java 类加载机制<a hidden class=anchor aria-hidden=true href=#java-类加载机制>#</a></h2><p>Java的ClassLoader（类加载器）机制是Java虚拟机（JVM）用于加载Java类的一种机制。它负责在运行时查找、加载和链接Java类，并生成对应的Class对象。</p><p>ClassLoader 机制的主要目标是实现Java的动态扩展性和代码的隔离性。它允许开发人员加载来自不同来源的类，例如本地文件系统、网络、JAR文件等，并将它们组织成一个类层次结构。</p><h3 id=classloader-类结构>ClassLoader 类结构<a hidden class=anchor aria-hidden=true href=#classloader-类结构>#</a></h3><p>ClassLoader 类继承结构：</p><ul><li><code>SecureClassLoader</code><ul><li><code>URLClassLoader</code></li><li><code>FactoryURLClassLoader</code></li><li><code>AppClassLoader</code>：</li><li><code>ExtClassLoader</code>：</li></ul></li></ul><p>常见的ClassLoader包括：</p><ol><li>Bootstrap ClassLoader：也称为原生类加载器，它是JVM的一部分并且是使用 native 代码编写，负责加载JVM运行时，如<code>java.lang.Object</code>。Bootstrap ClassLoader 是所有 ClassLoader 的父类。</li><li>Extension ClassLoader：<code>ExtClassLoader</code>，用于加载Java的扩展类库，位于<code>jre/lib/ext</code>目录中 或者由 <code>java.ext.dirs</code> 指定目录下的JAR文件。</li><li>System ClassLoader：<code>AppClassLoader</code>，也称为应用程序类加载器，加载用户自定义的类和第三方类库。</li></ol><p><code>AppClassLoader</code>是默认的类加载器，如果类加载时我们不指定类加载器的情况下，默认会使用<code>AppClassLoader</code>加载类，<code>ClassLoader.getSystemClassLoader()</code>返回的系统类加载器也是<code>AppClassLoader</code>。</p><p>Java中的ClassLoader是一个层次结构，由多个ClassLoader组成。每个ClassLoader都有一个父ClassLoader，除了顶层的原生类加载器（bootstrap class loader）之外。当需要加载一个类时，ClassLoader会首先尝试委托给其父ClassLoader进行加载。只有当父ClassLoader无法加载时，ClassLoader才会尝试自己加载。</p><p><img loading=lazy src=https://chensoul.oss-cn-hangzhou.aliyuncs.com/images/classloader-in-java.png alt="ClassLoader in Java - Javatpoint"></p><h3 id=classloader-如何工作>ClassLoader 如何工作<a hidden class=anchor aria-hidden=true href=#classloader-如何工作>#</a></h3><p><img loading=lazy src=https://chensoul.oss-cn-hangzhou.aliyuncs.com/images/classloader-request.png alt="How does Classloader work in Java? | by Deepti Swain | InterviewNoodle"></p><p>类加载器是 Java 运行时环境的一部分。当 JVM 请求一个类时，类加载器会尝试定位该类，并使用完全限定的类名将类定义加载到运行时中。</p><p><code>java.lang.ClassLoader.loadClass() </code>方法负责将类定义加载到运行时。它尝试根据完全限定名称加载类。</p><p>如果该类尚未加载，它将请求委托给父类加载器。这个过程递归地发生。</p><p>最终，如果父类加载器找不到该类，则子类将调用 <code>java.net.URLClassLoader.findClass()</code> 方法在文件系统本身中查找类。</p><p>如果最后一个子类加载器也无法加载该类，则会抛出 <code>java.lang.NoClassDefFoundError</code> 或 <code>java.lang.ClassNotFoundException</code>。</p><p>让我们看一下抛出 <code>ClassNotFoundException</code> 时的输出示例：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>java</span><span class=p>.</span><span class=na>lang</span><span class=p>.</span><span class=na>ClassNotFoundException</span><span class=p>:</span><span class=w>     
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>at</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=na>net</span><span class=p>.</span><span class=na>URLClassLoader</span><span class=p>.</span><span class=na>findClass</span><span class=p>(</span><span class=n>URLClassLoader</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>381</span><span class=p>)</span><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>at</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=na>lang</span><span class=p>.</span><span class=na>ClassLoader</span><span class=p>.</span><span class=na>loadClass</span><span class=p>(</span><span class=n>ClassLoader</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>424</span><span class=p>)</span><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>at</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=na>lang</span><span class=p>.</span><span class=na>ClassLoader</span><span class=p>.</span><span class=na>loadClass</span><span class=p>(</span><span class=n>ClassLoader</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>357</span><span class=p>)</span><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>at</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=na>lang</span><span class=p>.</span><span class=na>Class</span><span class=p>.</span><span class=na>forName0</span><span class=p>(</span><span class=n>Native</span><span class=w> </span><span class=n>Method</span><span class=p>)</span><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>at</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=na>lang</span><span class=p>.</span><span class=na>Class</span><span class=p>.</span><span class=na>forName</span><span class=p>(</span><span class=n>Class</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>348</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>如果我们从调用 <code>java.lang.Class.forName() </code>开始查看错误日志，我们可以看到它首先尝试通过父类加载器加载该类，然后 <code>java.net.URLClassLoader.findClass() </code>来加载该类。当它仍然找不到该类时，它会抛出 <code>ClassNotFoundException</code>。</p><h3 id=classloader-三个特性>ClassLoader 三个特性<a hidden class=anchor aria-hidden=true href=#classloader-三个特性>#</a></h3><ol><li><p><strong>双亲委派模型</strong></p><p>类加载器遵循委托模型，在请求查找类或资源时，ClassLoader 实例会将类或资源的搜索委托给父类加载器。</p><p>假设我们有一个将应用程序类加载到 JVM 中的请求。系统类加载器首先将该类的加载委托给其父扩展类加载器，后者又将其委托给引导类加载器。</p><p>仅当引导程序和扩展类加载器加载类失败时，系统类加载器才会尝试加载类本身。</p></li><li><p><strong>可见性</strong></p><p>子类加载器对其父类加载器加载的类是可见的。</p><p>例如，系统类加载器加载的类可以看到扩展和引导类加载器加载的类，但反之则不然。</p><p>为了说明这一点，如果类 A 由应用程序类加载器加载，类 B 由扩展类加载器加载，则就应用程序类加载器加载的其他类而言，A 类和 B 类都是可见的。</p><p>然而，B 类是唯一对扩展类加载器加载的其他类可见的类。</p></li><li><p><strong>唯一性</strong></p><p>由于委托模型的结果，很容易确保唯一的类，因为我们总是尝试向上委托。如果父类加载器无法找到该类，只有当前实例才会尝试自行查找。</p></li></ol><h3 id=classloader-源码>ClassLoader 源码<a hidden class=anchor aria-hidden=true href=#classloader-源码>#</a></h3><p>1、<strong>loadClass() 方法</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>loadClass</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>resolve</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>ClassNotFoundException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>该方法负责加载给定名称参数的类。 <code>name</code> 参数指的是完全限定的类名。</p><p>Java虚拟机调用 <code>loadClass()</code> 方法来解析类引用，并将 <code>resolve</code> 设置为true。然而，并不总是需要解析一个类。如果我们只需要判断类是否存在，那么 <code>resolve</code> 参数设置为 false。</p><p>该方法充当类加载器的入口点。</p><p>我们可以尝试 <code>从java.lang.ClassLoader </code>的源码中了解 <code>loadClass() </code>方法的内部工作原理：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>protected</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>loadClass</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>resolve</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>throws</span><span class=w> </span><span class=n>ClassNotFoundException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>getClassLoadingLock</span><span class=p>(</span><span class=n>name</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c1>// First, check if the class has already been loaded</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>Class</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>c</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>findLoadedClass</span><span class=p>(</span><span class=n>name</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>c</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=kt>long</span><span class=w> </span><span class=n>t0</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>nanoTime</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>parent</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                      </span><span class=n>c</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>parent</span><span class=p>.</span><span class=na>loadClass</span><span class=p>(</span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                  </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                      </span><span class=n>c</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>findBootstrapClassOrNull</span><span class=p>(</span><span class=n>name</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>ClassNotFoundException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                  </span><span class=c1>// ClassNotFoundException thrown if class not found</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                  </span><span class=c1>// from the non-null parent class loader</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>c</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                  </span><span class=c1>// If still not found, then invoke findClass in order</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                  </span><span class=c1>// to find the class.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                  </span><span class=n>c</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>findClass</span><span class=p>(</span><span class=n>name</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>resolve</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=n>resolveClass</span><span class=p>(</span><span class=n>c</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=k>return</span><span class=w> </span><span class=n>c</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>该方法的默认实现按以下顺序搜索类：</p><ul><li>调用 <code>findLoadedClass(String)</code> 方法以查看该类是否已加载。</li><li>调用父类加载器上的 <code>loadClass(String)</code> 方法。</li><li>调用 <code>findClass(String) </code>方法来查找该类。</li></ul><p>2、<strong>defineClass() 方法</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>protected</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>defineClass</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>String</span><span class=w> </span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=kt>byte</span><span class=o>[]</span><span class=w> </span><span class=n>b</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>off</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>len</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>ClassFormatError</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>该方法负责将字节数组转换为类的实例。在使用该类之前，我们需要定义它。如果数据不包含有效的类，则会抛出 <code>ClassFormatError</code>。</p><p>此外，我们无法重写此方法，因为它被标记为最终方法。</p><p>3、<strong>findClass() 方法</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>protected</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>findClass</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>name</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>ClassNotFoundException</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>此方法查找以完全限定名称作为参数的类。我们需要在遵循加载类的委托模型的自定义类加载器实现中重写此方法。</p><p>此外，如果父类加载器找不到所请求的类，<code>loadClass() </code>会调用此方法。</p><p>如果类加载器的父级没有找到该类，则默认实现会抛出 <code>ClassNotFoundException</code>。</p><p>4、<strong>getParent() 方法</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>ClassLoader</span><span class=w> </span><span class=nf>getParent</span><span class=p>()</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>该方法返回委托的父类加载器。某些实现使用 <code>null</code> 来表示引导类加载器。</p><p>5、<strong>getResource() 方法</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=n>URL</span><span class=w> </span><span class=nf>getResource</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>name</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>此方法尝试查找具有给定名称的资源。</p><p>它首先将资源委托给父类加载器。如果 parent 为null，则查找虚拟机内置的类加载器的路径。如果失败，该方法将调用 <code>findResource(String)</code> 来查找资源。指定为输入的资源名称可以是相对于类路径的，也可以是绝对的。</p><p>它返回一个用于读取资源的 URL 对象，如果找不到资源或调用者没有足够的权限来返回资源，则返回 null。</p><p>需要注意的是，Java 从类路径加载资源。</p><p>最后，Java 中的资源加载被认为是与位置无关的，因为只要设置环境来查找资源，代码在哪里运行并不重要。</p><h3 id=context-classloaders>Context Classloaders<a hidden class=anchor aria-hidden=true href=#context-classloaders>#</a></h3><p>一般来说，上下文类加载器为 J2SE 中引入的类加载委托方案提供了一种替代方法。</p><p>正如我们之前了解到的，JVM 中的类加载器遵循分层模型，因此除了引导类加载器之外，每个类加载器都有一个父类加载器。</p><p>然而，有时当 JVM 核心类需要动态加载应用程序开发人员提供的类或资源时，我们可能会遇到问题。</p><p>例如，在 JNDI 中，核心功能是由 <code>rt.jar</code> 中的引导类实现的。但这些 JNDI 类可能会加载由独立供应商实现的 JNDI 提供程序（部署在应用程序类路径中）。这种情况需要引导类加载器（父类加载器）来加载应用程序加载器（子类加载器）可见的类。</p><p><strong>J2SE 委托在这里不起作用，为了解决这个问题，我们需要找到类加载的替代方法。这可以使用线程上下文加载器来实现。</strong></p><p><code>java.lang.Thread</code> 类有一个方法 <code>getContextClassLoader()</code>，它返回特定线程的 Context ClassLoader。 Context ClassLoader 是线程的创建者在加载资源和类时提供的。如果未设置该值，则默认为父线程的 Context ClassLoader。</p><p>正如前面在 JNDI 源码分析中提到的，在 JNDI 中，获取 ClassLoader 的代码在 VersionHelper12 类的 <code>getContextClassLoader</code> 方法中。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>final</span><span class=w> </span><span class=kd>class</span> <span class=nc>VersionHelper12</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>VersionHelper</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=n>ClassLoader</span><span class=w> </span><span class=nf>getContextClassLoader</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>AccessController</span><span class=p>.</span><span class=na>doPrivileged</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>new</span><span class=w> </span><span class=n>PrivilegedAction</span><span class=o>&lt;</span><span class=n>ClassLoader</span><span class=o>&gt;</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>public</span><span class=w> </span><span class=n>ClassLoader</span><span class=w> </span><span class=nf>run</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>ClassLoader</span><span class=w> </span><span class=n>loader</span><span class=w> </span><span class=o>=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>().</span><span class=na>getContextClassLoader</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>loader</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=c1>// Don&#39;t use bootstrap class loader directly!</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>loader</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ClassLoader</span><span class=p>.</span><span class=na>getSystemClassLoader</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>return</span><span class=w> </span><span class=n>loader</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w> 
</span></span></span></code></pre></td></tr></table></div></div><h3 id=参考>参考<a hidden class=anchor aria-hidden=true href=#参考>#</a></h3><ul><li><p><a href=https://javasec.org/javase/ClassLoader/ target=_blank>ClassLoader</a></p></li><li><p><a href=https://www.baeldung.com/java-classloaders target=_blank>Class Loaders in Java</a></p></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://blog.chensoul.cc/tags/java/>Java</a></li><li><a href=https://blog.chensoul.cc/tags/jndi/>Jndi</a></li><li><a href=https://blog.chensoul.cc/tags/classloader/>Classloader</a></li></ul><nav class=paginav><a class=prev href=https://blog.chensoul.cc/posts/2023/12/18/til/><span class=title>« Prev</span><br><span>2023-12-18｜使用Spring Security实现OAuth2授权和认证</span>
</a><a class=next href=https://blog.chensoul.cc/posts/2023/12/14/designing-twitter/><span class=title>Next »</span><br><span>[译]《Grokking the System Design Interview》设计Twitter</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share 2023-12-15｜JNDI InitialContext源码分析、ClassLoader加载机制 on x" href="https://x.com/intent/tweet/?text=2023-12-15%ef%bd%9cJNDI%20InitialContext%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90%e3%80%81ClassLoader%e5%8a%a0%e8%bd%bd%e6%9c%ba%e5%88%b6&amp;url=https%3a%2f%2fblog.chensoul.cc%2fposts%2f2023%2f12%2f15%2ftil%2f&amp;hashtags=java%2cjndi%2cclassloader"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 2023-12-15｜JNDI InitialContext源码分析、ClassLoader加载机制 on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fblog.chensoul.cc%2fposts%2f2023%2f12%2f15%2ftil%2f&amp;title=2023-12-15%ef%bd%9cJNDI%20InitialContext%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90%e3%80%81ClassLoader%e5%8a%a0%e8%bd%bd%e6%9c%ba%e5%88%b6&amp;summary=2023-12-15%ef%bd%9cJNDI%20InitialContext%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90%e3%80%81ClassLoader%e5%8a%a0%e8%bd%bd%e6%9c%ba%e5%88%b6&amp;source=https%3a%2f%2fblog.chensoul.cc%2fposts%2f2023%2f12%2f15%2ftil%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 2023-12-15｜JNDI InitialContext源码分析、ClassLoader加载机制 on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fblog.chensoul.cc%2fposts%2f2023%2f12%2f15%2ftil%2f&title=2023-12-15%ef%bd%9cJNDI%20InitialContext%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90%e3%80%81ClassLoader%e5%8a%a0%e8%bd%bd%e6%9c%ba%e5%88%b6"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 2023-12-15｜JNDI InitialContext源码分析、ClassLoader加载机制 on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fblog.chensoul.cc%2fposts%2f2023%2f12%2f15%2ftil%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 2023-12-15｜JNDI InitialContext源码分析、ClassLoader加载机制 on whatsapp" href="https://api.whatsapp.com/send?text=2023-12-15%ef%bd%9cJNDI%20InitialContext%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90%e3%80%81ClassLoader%e5%8a%a0%e8%bd%bd%e6%9c%ba%e5%88%b6%20-%20https%3a%2f%2fblog.chensoul.cc%2fposts%2f2023%2f12%2f15%2ftil%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 2023-12-15｜JNDI InitialContext源码分析、ClassLoader加载机制 on telegram" href="https://telegram.me/share/url?text=2023-12-15%ef%bd%9cJNDI%20InitialContext%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90%e3%80%81ClassLoader%e5%8a%a0%e8%bd%bd%e6%9c%ba%e5%88%b6&amp;url=https%3a%2f%2fblog.chensoul.cc%2fposts%2f2023%2f12%2f15%2ftil%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 2023-12-15｜JNDI InitialContext源码分析、ClassLoader加载机制 on ycombinator" href="https://news.ycombinator.com/submitlink?t=2023-12-15%ef%bd%9cJNDI%20InitialContext%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90%e3%80%81ClassLoader%e5%8a%a0%e8%bd%bd%e6%9c%ba%e5%88%b6&u=https%3a%2f%2fblog.chensoul.cc%2fposts%2f2023%2f12%2f15%2ftil%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://blog.chensoul.cc/>ChenSoul</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script async src=https://umami.chensoul.cc/random-string.js data-website-id=821c25f8-a31a-4607-92d7-91ee76843d00></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-FCSSTV9VRG"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-FCSSTV9VRG")</script><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>