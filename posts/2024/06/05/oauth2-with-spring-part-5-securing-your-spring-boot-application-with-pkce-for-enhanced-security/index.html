<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>[译][译]OAuth2 with Spring 第5部分：使用PKCE保护您的Spring Boot应用程序以增强安全性 | ChenSoul</title>
<meta name=keywords content="oauth2,java"><meta name=description content="原文地址：https://mainul35.medium.com/oauth2-with-spring-part-5-securing-your-spring-boot-application-with-pkce-for-enhanced-security-d8025cd08769
免责声明：本文技术性很强，需要清楚了解本系列前几篇文章，特别是第 1 部分和第 3 部分。
带有代码交换证明密钥 (PKCE) 的授权代码流用于无法存储客户端机密的应用程序。此类应用程序包括：
原生应用程序——可以反编译并检索客户端凭证的移动应用程序。 单页应用 — 整个源代码可在浏览器中使用。因此，无法安全地存储客户端机密。 怎么运行的 Spring Boot OAuth2 与 PKCE
希望这张图已经足够清晰易懂了。因此，我将直接进入演示。
对于此演示，我们有 3 台服务器。
授权服务器：在端口 9001 上运行。 资源服务器：在端口8090上运行。 社交登录客户端（BFF）：在端口 8080 上运行。 让我们看一下代码。
授权服务器 一、pom.xml
授权服务器的 pom.xml 中没有太多需要解释的变化
application.yml.yml
application.yml文件有很多更改，特别是删除了客户端注册。当前版本的application.yml非常简短，如下所示。
server: port: 9001 logging: level: org: springframework: security: trace 三. SecurityConfig 类
所有的安全配置以及客户端和用户详细信息注册、JWT token 解码都放在此类中
@Configuration public class SecurityConfig { // This first SecurityFilterChain Bean is only specific to authorization server specific configurations // More on this can be found in this stackoverflow question answers: // https://stackoverflow.com/questions/69126874/why-two-formlogin-configured-in-spring-authorization-server-sample-code @Bean @Order(1) public SecurityFilterChain authorizationServerSecurityFilterChain(HttpSecurity http) throws Exception { OAuth2AuthorizationServerConfiguration.applyDefaultSecurity(http); http.getConfigurer(OAuth2AuthorizationServerConfigurer.class).oidc(withDefaults()); return http .exceptionHandling(e -> e ."><meta name=author content="chensoul"><link rel=canonical href=https://blog.chensoul.cc/posts/2024/06/05/oauth2-with-spring-part-5-securing-your-spring-boot-application-with-pkce-for-enhanced-security/><link crossorigin=anonymous href=/assets/css/stylesheet.min.d6db7ab468e55ea6647d68be426a17bae21ff1cddbf1741e547ed2086d010444.css integrity="sha256-1tt6tGjlXqZkfWi+QmoXuuIf8c3b8XQeVH7SCG0BBEQ=" rel="preload stylesheet" as=style><link rel=icon href=https://blog.chensoul.cc/favicon.ico><link rel=apple-touch-icon href=https://blog.chensoul.cc/apple-touch-icon.png><link rel=alternate hreflang=en href=https://blog.chensoul.cc/posts/2024/06/05/oauth2-with-spring-part-5-securing-your-spring-boot-application-with-pkce-for-enhanced-security/><meta name=twitter:title content="[译][译]OAuth2 with Spring 第5部分：使用PKCE保护您的Spring Boot应用程序以增强安全性 | ChenSoul"><meta name=twitter:description content="原文地址：https://mainul35.medium.com/oauth2-with-spring-part-5-securing-your-spring-boot-application-with-pkce-for-enhanced-security-d8025cd08769
免责声明：本文技术性很强，需要清楚了解本系列前几篇文章，特别是第 1 部分和第 3 部分。
带有代码交换证明密钥 (PKCE) 的授权代码流用于无法存储客户端机密的应用程序。此类应用程序包括：
原生应用程序——可以反编译并检索客户端凭证的移动应用程序。 单页应用 — 整个源代码可在浏览器中使用。因此，无法安全地存储客户端机密。 怎么运行的 Spring Boot OAuth2 与 PKCE
希望这张图已经足够清晰易懂了。因此，我将直接进入演示。
对于此演示，我们有 3 台服务器。
授权服务器：在端口 9001 上运行。 资源服务器：在端口8090上运行。 社交登录客户端（BFF）：在端口 8080 上运行。 让我们看一下代码。
授权服务器 一、pom.xml
授权服务器的 pom.xml 中没有太多需要解释的变化
application.yml.yml
application.yml文件有很多更改，特别是删除了客户端注册。当前版本的application.yml非常简短，如下所示。
server: port: 9001 logging: level: org: springframework: security: trace 三. SecurityConfig 类
所有的安全配置以及客户端和用户详细信息注册、JWT token 解码都放在此类中
@Configuration public class SecurityConfig { // This first SecurityFilterChain Bean is only specific to authorization server specific configurations // More on this can be found in this stackoverflow question answers: // https://stackoverflow.com/questions/69126874/why-two-formlogin-configured-in-spring-authorization-server-sample-code @Bean @Order(1) public SecurityFilterChain authorizationServerSecurityFilterChain(HttpSecurity http) throws Exception { OAuth2AuthorizationServerConfiguration.applyDefaultSecurity(http); http.getConfigurer(OAuth2AuthorizationServerConfigurer.class).oidc(withDefaults()); return http .exceptionHandling(e -> e ."><meta property="og:title" content="[译][译]OAuth2 with Spring 第5部分：使用PKCE保护您的Spring Boot应用程序以增强安全性 | ChenSoul"><meta property="og:description" content="原文地址：https://mainul35.medium.com/oauth2-with-spring-part-5-securing-your-spring-boot-application-with-pkce-for-enhanced-security-d8025cd08769
免责声明：本文技术性很强，需要清楚了解本系列前几篇文章，特别是第 1 部分和第 3 部分。
带有代码交换证明密钥 (PKCE) 的授权代码流用于无法存储客户端机密的应用程序。此类应用程序包括：
原生应用程序——可以反编译并检索客户端凭证的移动应用程序。 单页应用 — 整个源代码可在浏览器中使用。因此，无法安全地存储客户端机密。 怎么运行的 Spring Boot OAuth2 与 PKCE
希望这张图已经足够清晰易懂了。因此，我将直接进入演示。
对于此演示，我们有 3 台服务器。
授权服务器：在端口 9001 上运行。 资源服务器：在端口8090上运行。 社交登录客户端（BFF）：在端口 8080 上运行。 让我们看一下代码。
授权服务器 一、pom.xml
授权服务器的 pom.xml 中没有太多需要解释的变化
application.yml.yml
application.yml文件有很多更改，特别是删除了客户端注册。当前版本的application.yml非常简短，如下所示。
server: port: 9001 logging: level: org: springframework: security: trace 三. SecurityConfig 类
所有的安全配置以及客户端和用户详细信息注册、JWT token 解码都放在此类中
@Configuration public class SecurityConfig { // This first SecurityFilterChain Bean is only specific to authorization server specific configurations // More on this can be found in this stackoverflow question answers: // https://stackoverflow.com/questions/69126874/why-two-formlogin-configured-in-spring-authorization-server-sample-code @Bean @Order(1) public SecurityFilterChain authorizationServerSecurityFilterChain(HttpSecurity http) throws Exception { OAuth2AuthorizationServerConfiguration.applyDefaultSecurity(http); http.getConfigurer(OAuth2AuthorizationServerConfigurer.class).oidc(withDefaults()); return http .exceptionHandling(e -> e ."><meta property="og:type" content="article"><meta property="og:url" content="https://blog.chensoul.cc/posts/2024/06/05/oauth2-with-spring-part-5-securing-your-spring-boot-application-with-pkce-for-enhanced-security/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-06-05T07:04:00+08:00"><meta property="article:modified_time" content="2024-06-05T07:04:00+08:00"><meta property="og:site_name" content="ChenSoul"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://blog.chensoul.cc/posts/"},{"@type":"ListItem","position":2,"name":"[译][译]OAuth2 with Spring 第5部分：使用PKCE保护您的Spring Boot应用程序以增强安全性","item":"https://blog.chensoul.cc/posts/2024/06/05/oauth2-with-spring-part-5-securing-your-spring-boot-application-with-pkce-for-enhanced-security/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"[译][译]OAuth2 with Spring 第5部分：使用PKCE保护您的Spring Boot应用程序以增强安全性 | ChenSoul","name":"[译][译]OAuth2 with Spring 第5部分：使用PKCE保护您的Spring Boot应用程序以增强安全性","description":"原文地址：https://mainul35.medium.com/oauth2-with-spring-part-5-securing-your-spring-boot-application-with-pkce-for-enhanced-security-d8025cd08769\n免责声明：本文技术性很强，需要清楚了解本系列前几篇文章，特别是第 1 部分和第 3 部分。\n带有代码交换证明密钥 (PKCE) 的授权代码流用于无法存储客户端机密的应用程序。此类应用程序包括：\n原生应用程序——可以反编译并检索客户端凭证的移动应用程序。 单页应用 — 整个源代码可在浏览器中使用。因此，无法安全地存储客户端机密。 怎么运行的 Spring Boot OAuth2 与 PKCE\n希望这张图已经足够清晰易懂了。因此，我将直接进入演示。\n对于此演示，我们有 3 台服务器。\n授权服务器：在端口 9001 上运行。 资源服务器：在端口8090上运行。 社交登录客户端（BFF）：在端口 8080 上运行。 让我们看一下代码。\n授权服务器 一、pom.xml\n授权服务器的 pom.xml 中没有太多需要解释的变化\napplication.yml.yml\napplication.yml文件有很多更改，特别是删除了客户端注册。当前版本的application.yml非常简短，如下所示。\nserver: port: 9001 logging: level: org: springframework: security: trace 三. SecurityConfig 类\n所有的安全配置以及客户端和用户详细信息注册、JWT token 解码都放在此类中\n@Configuration public class SecurityConfig { // This first SecurityFilterChain Bean is only specific to authorization server specific configurations // More on this can be found in this stackoverflow question answers: // https://stackoverflow.com/questions/69126874/why-two-formlogin-configured-in-spring-authorization-server-sample-code @Bean @Order(1) public SecurityFilterChain authorizationServerSecurityFilterChain(HttpSecurity http) throws Exception { OAuth2AuthorizationServerConfiguration.applyDefaultSecurity(http); http.getConfigurer(OAuth2AuthorizationServerConfigurer.class).oidc(withDefaults()); return http .exceptionHandling(e -\u0026gt; e .","keywords":["oauth2","java"],"wordCount":"900","inLanguage":"en","datePublished":"2024-06-05T07:04:00+08:00","dateModified":"2024-06-05T07:04:00+08:00","author":[{"@type":"Person","name":"chensoul"}],"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.chensoul.cc/posts/2024/06/05/oauth2-with-spring-part-5-securing-your-spring-boot-application-with-pkce-for-enhanced-security/"},"publisher":{"@type":"Organization","name":"ChenSoul","logo":{"@type":"ImageObject","url":"https://blog.chensoul.cc/favicon.ico"}}}</script><meta name=baidu-site-verification content="codeva-FYpQY8JdLU"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary-bg:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list-page{background:var(--theme)}.list-page:not(.dark)::-webkit-scrollbar-track{background:0 0}.list-page:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript></head><body class="type-posts kind-page layout-" id=top><script data-no-instant>function switchTheme(e){switch(e){case"light":document.body.classList.remove("dark");break;case"dark":document.body.classList.add("dark");break;default:window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")}}function isDarkTheme(){return document.body.className.includes("dark")}function getPrefTheme(){return localStorage.getItem("pref-theme")}function setPrefTheme(e){switchTheme(e),localStorage.setItem("pref-theme",e)}const toggleThemeCallbacks={};toggleThemeCallbacks.main=e=>{setPrefTheme(e?"light":"dark")},window.addEventListener("toggle-theme",function(){const e=isDarkTheme();for(const t in toggleThemeCallbacks)toggleThemeCallbacks[t](e)});function toggleThemeListener(){window.dispatchEvent(new CustomEvent("toggle-theme"))}</script><script>(function(){const t="auto",e=getPrefTheme(),n=e||t;switchTheme(n)})()</script><header class=header><nav class=nav><div class=logo><a href=https://blog.chensoul.cc/ accesskey=h title="ChenSoul (Alt + H)">ChenSoul</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://blog.chensoul.cc/categories/review/ title=总结>总结</a></li><li><a href=https://blog.chensoul.cc/categories/ title=分类>分类</a></li><li><a href=https://blog.chensoul.cc/tags/ title=标签>标签</a></li><li><a href=https://github.com/chensoul/ title=关于 target=_blank>关于<span class=external-link><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-external-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M11 7H6A2 2 0 004 9v9a2 2 0 002 2h9a2 2 0 002-2v-5"/><line x1="10" y1="14" x2="20" y2="4"/><polyline points="15 4 20 4 20 9"/></svg></span></a></li></ul></nav></header><main class="main post"><article class=post-single><header class=post-header><h1 class=post-title>[译][译]OAuth2 with Spring 第5部分：使用PKCE保护您的Spring Boot应用程序以增强安全性</h1><div class=post-meta><span class=meta-item><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar" style="user-select:text"><rect x="3" y="4" width="18" height="18" rx="2" ry="2" style="user-select:text"/><line x1="16" y1="2" x2="16" y2="6" style="user-select:text"/><line x1="8" y1="2" x2="8" y2="6" style="user-select:text"/><line x1="3" y1="10" x2="21" y2="10" style="user-select:text"/></svg>
<span>2024-06-05</span></span><span class=meta-item>
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon" style="user-select:text"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z" style="user-select:text"/><line x1="7" y1="7" x2="7" y2="7" style="user-select:text"/></svg>
<span class=post-tags><a href=https://blog.chensoul.cc/tags/oauth2/>Oauth2</a><a href=https://blog.chensoul.cc/tags/java/>Java</a></span></span><span class=meta-item>
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<span>5 min</span></span></div></header><div class="toc side right"><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%e6%80%8e%e4%b9%88%e8%bf%90%e8%a1%8c%e7%9a%84 aria-label=怎么运行的>怎么运行的</a></li><li><a href=#%e6%8e%88%e6%9d%83%e6%9c%8d%e5%8a%a1%e5%99%a8 aria-label=授权服务器>授权服务器</a></li><li><a href=#%e8%b5%84%e6%ba%90%e6%9c%8d%e5%8a%a1%e5%99%a8 aria-label=资源服务器>资源服务器</a></li><li><a href=#social-login-client aria-label=social-login-client>social-login-client</a></li><li><a href=#%e5%9c%a8%e6%b5%8f%e8%a7%88%e5%99%a8%e4%b8%ad%e6%b5%8b%e8%af%95%e7%9a%84%e6%97%b6%e9%97%b4 aria-label=在浏览器中测试的时间>在浏览器中测试的时间</a></li><li><a href=#%e4%b8%ba%e4%bb%80%e4%b9%88%e6%94%b6%e5%88%b0%e4%bb%a3%e7%a0%81%e5%90%8e%e6%b2%a1%e6%9c%89%e5%af%b9-oauthtoken-%e7%ab%af%e7%82%b9%e5%8f%91%e5%87%ba%e4%bb%bb%e4%bd%95%e8%af%b7%e6%b1%82 aria-label="为什么收到代码后没有对 /oauth/token 端点发出任何请求？">为什么收到代码后没有对 /oauth/token 端点发出任何请求？</a></li><li><a href=#%e5%8f%82%e8%80%83 aria-label=参考：>参考：</a></li></ul></div></details></div><div class=post-content><p>原文地址：https://mainul35.medium.com/oauth2-with-spring-part-5-securing-your-spring-boot-application-with-pkce-for-enhanced-security-d8025cd08769</p><blockquote><p>免责声明：本文技术性很强，需要清楚了解本系列前几篇文章，特别是第 1 部分和第 3 部分。</p></blockquote><p>带有代码交换证明密钥 (PKCE) 的授权代码流用于无法存储客户端机密的应用程序。此类应用程序包括：</p><ul><li>原生应用程序——可以反编译并检索客户端凭证的移动应用程序。</li><li>单页应用 — 整个源代码可在浏览器中使用。因此，无法安全地存储客户端机密。</li></ul><h2 id=怎么运行的>怎么运行的</h2><p><img loading=lazy src=https://miro.medium.com/v2/resize:fit:1400/1*YnmHkcAvZNQ0B__mIgdC_g.png alt=img></p><p>Spring Boot OAuth2 与 PKCE</p><p>希望这张图已经足够清晰易懂了。因此，我将直接进入演示。</p><p>对于此演示，我们有 3 台服务器。</p><p><img loading=lazy src=https://miro.medium.com/v2/resize:fit:1186/1*vi0ZFi2f62Lid7XzAoNdJA.png alt=img></p><ol><li>授权服务器：在端口 9001 上运行。</li><li>资源服务器：在端口8090上运行。</li><li>社交登录客户端（BFF）：在端口 8080 上运行。</li></ol><p>让我们看一下代码。</p><h2 id=授权服务器>授权服务器</h2><p><strong>一、pom.xml</strong></p><p>授权服务器的 pom.xml 中没有太多需要解释的变化</p><p><strong>application.yml.yml</strong></p><p><em>application.yml</em>文件有很多更改，特别是删除了客户端注册。当前版本的<em>application.yml</em>非常简短，如下所示。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=line><span class=cl><span class=nt>server</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>9001</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>logging</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>level</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>org</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>springframework</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>security</span><span class=p>:</span><span class=w> </span><span class=l>trace</span><span class=w>
</span></span></span></code></pre></div><p>三. <strong>SecurityConfig 类</strong></p><p>所有的安全配置以及客户端和用户详细信息注册、JWT token 解码都放在此类中</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Configuration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>SecurityConfig</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// This first SecurityFilterChain Bean is only specific to authorization server specific configurations</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// More on this can be found in this stackoverflow question answers:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// https://stackoverflow.com/questions/69126874/why-two-formlogin-configured-in-spring-authorization-server-sample-code</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Order</span><span class=p>(</span><span class=n>1</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>SecurityFilterChain</span><span class=w> </span><span class=nf>authorizationServerSecurityFilterChain</span><span class=p>(</span><span class=n>HttpSecurity</span><span class=w> </span><span class=n>http</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>OAuth2AuthorizationServerConfiguration</span><span class=p>.</span><span class=na>applyDefaultSecurity</span><span class=p>(</span><span class=n>http</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>http</span><span class=p>.</span><span class=na>getConfigurer</span><span class=p>(</span><span class=n>OAuth2AuthorizationServerConfigurer</span><span class=p>.</span><span class=na>class</span><span class=p>).</span><span class=na>oidc</span><span class=p>(</span><span class=n>withDefaults</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>http</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>exceptionHandling</span><span class=p>(</span><span class=n>e</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>e</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>.</span><span class=na>authenticationEntryPoint</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>LoginUrlAuthenticationEntryPoint</span><span class=p>(</span><span class=s>&#34;/login&#34;</span><span class=p>)))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>oauth2ResourceServer</span><span class=p>(</span><span class=n>httpSecurityOAuth2ResourceServerConfigurer</span><span class=w> </span><span class=o>-&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                              </span><span class=n>httpSecurityOAuth2ResourceServerConfigurer</span><span class=p>.</span><span class=na>jwt</span><span class=p>(</span><span class=n>withDefaults</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>build</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// This second SecurityFilterChain bean is responsible for any other security configurations</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Order</span><span class=p>(</span><span class=n>2</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>SecurityFilterChain</span><span class=w> </span><span class=nf>clientAppSecurityFilterChain</span><span class=p>(</span><span class=n>HttpSecurity</span><span class=w> </span><span class=n>http</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>http</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>formLogin</span><span class=p>(</span><span class=n>withDefaults</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>authorizeHttpRequests</span><span class=p>(</span><span class=n>authorize</span><span class=w> </span><span class=o>-&gt;</span><span class=n>authorize</span><span class=p>.</span><span class=na>anyRequest</span><span class=p>().</span><span class=na>authenticated</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>build</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// In-memory user registration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>UserDetailsService</span><span class=w> </span><span class=nf>userDetailsService</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>var</span><span class=w> </span><span class=n>user1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>User</span><span class=p>.</span><span class=na>withUsername</span><span class=p>(</span><span class=s>&#34;user&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>password</span><span class=p>(</span><span class=s>&#34;{noop}secret&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>authorities</span><span class=p>(</span><span class=s>&#34;read&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>build</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>InMemoryUserDetailsManager</span><span class=p>(</span><span class=n>user1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// In-memory authorization server client registration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>RegisteredClientRepository</span><span class=w> </span><span class=nf>registeredClientRepository</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>RegisteredClient</span><span class=w> </span><span class=n>registeredClient</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>RegisteredClient</span><span class=p>.</span><span class=na>withId</span><span class=p>(</span><span class=s>&#34;oidc-client&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>clientId</span><span class=p>(</span><span class=s>&#34;oidc-client&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>clientSecret</span><span class=p>(</span><span class=s>&#34;{noop}secret&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>scope</span><span class=p>(</span><span class=s>&#34;read&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>scope</span><span class=p>(</span><span class=n>OidcScopes</span><span class=p>.</span><span class=na>OPENID</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>scope</span><span class=p>(</span><span class=n>OidcScopes</span><span class=p>.</span><span class=na>PROFILE</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>scope</span><span class=p>(</span><span class=s>&#34;write&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>redirectUri</span><span class=p>(</span><span class=s>&#34;http://127.0.0.1:8080/login/oauth2/code/oidc-client&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>clientAuthenticationMethod</span><span class=p>(</span><span class=n>ClientAuthenticationMethod</span><span class=p>.</span><span class=na>CLIENT_SECRET_BASIC</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>authorizationGrantType</span><span class=p>(</span><span class=n>AuthorizationGrantType</span><span class=p>.</span><span class=na>AUTHORIZATION_CODE</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>authorizationGrantType</span><span class=p>(</span><span class=n>AuthorizationGrantType</span><span class=p>.</span><span class=na>REFRESH_TOKEN</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>clientSettings</span><span class=p>(</span><span class=n>clientSettings</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>build</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>InMemoryRegisteredClientRepository</span><span class=p>(</span><span class=n>registeredClient</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * Creating this bean initialized the following endpoints:
</span></span></span><span class=line><span class=cl><span class=cm>     * /oauth2/authorize
</span></span></span><span class=line><span class=cl><span class=cm>     * /oauth2/device_authorization
</span></span></span><span class=line><span class=cl><span class=cm>     * /oauth2/token
</span></span></span><span class=line><span class=cl><span class=cm>     * /oauth2/jwks
</span></span></span><span class=line><span class=cl><span class=cm>     * /oauth2/revoke
</span></span></span><span class=line><span class=cl><span class=cm>     * /oauth2/introspect
</span></span></span><span class=line><span class=cl><span class=cm>     * /connect/register
</span></span></span><span class=line><span class=cl><span class=cm>     * /userinfo
</span></span></span><span class=line><span class=cl><span class=cm>     * /connect/logout
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * For java based client registration configuration, it is very important to initialize this bean
</span></span></span><span class=line><span class=cl><span class=cm>    */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>AuthorizationServerSettings</span><span class=w> </span><span class=nf>authorizationServerSettings</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>AuthorizationServerSettings</span><span class=p>.</span><span class=na>builder</span><span class=p>().</span><span class=na>build</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ClientSettings</span><span class=w> </span><span class=nf>clientSettings</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>ClientSettings</span><span class=p>.</span><span class=na>builder</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>requireAuthorizationConsent</span><span class=p>(</span><span class=kc>true</span><span class=p>)</span><span class=w>  </span><span class=c1>// Display post-login authorization consent screen</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>requireProofKey</span><span class=p>(</span><span class=kc>true</span><span class=p>)</span><span class=w>              </span><span class=c1>// flag to enable Proof Key for Code Exchange (PKCE)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>build</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>JwtDecoder</span><span class=w> </span><span class=nf>jwtDecoder</span><span class=p>(</span><span class=n>JWKSource</span><span class=o>&lt;</span><span class=n>SecurityContext</span><span class=o>&gt;</span><span class=w> </span><span class=n>jwkSource</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>OAuth2AuthorizationServerConfiguration</span><span class=p>.</span><span class=na>jwtDecoder</span><span class=p>(</span><span class=n>jwkSource</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>JWKSource</span><span class=o>&lt;</span><span class=n>SecurityContext</span><span class=o>&gt;</span><span class=w> </span><span class=nf>jwkSource</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>RSAKey</span><span class=w> </span><span class=n>rsaKey</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>generateRsa</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>JWKSet</span><span class=w> </span><span class=n>jwkSet</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>JWKSet</span><span class=p>(</span><span class=n>rsaKey</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=p>(</span><span class=n>jwkSelector</span><span class=p>,</span><span class=w> </span><span class=n>securityContext</span><span class=p>)</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>jwkSelector</span><span class=p>.</span><span class=na>select</span><span class=p>(</span><span class=n>jwkSet</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>RSAKey</span><span class=w> </span><span class=nf>generateRsa</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>KeyPair</span><span class=w> </span><span class=n>keyPair</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>generateRsaKey</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>RSAPublicKey</span><span class=w> </span><span class=n>publicKey</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>RSAPublicKey</span><span class=p>)</span><span class=w> </span><span class=n>keyPair</span><span class=p>.</span><span class=na>getPublic</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>RSAPrivateKey</span><span class=w> </span><span class=n>privateKey</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>RSAPrivateKey</span><span class=p>)</span><span class=w> </span><span class=n>keyPair</span><span class=p>.</span><span class=na>getPrivate</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RSAKey</span><span class=p>.</span><span class=na>Builder</span><span class=p>(</span><span class=n>publicKey</span><span class=p>).</span><span class=na>privateKey</span><span class=p>(</span><span class=n>privateKey</span><span class=p>).</span><span class=na>keyID</span><span class=p>(</span><span class=n>UUID</span><span class=p>.</span><span class=na>randomUUID</span><span class=p>().</span><span class=na>toString</span><span class=p>()).</span><span class=na>build</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>static</span><span class=w> </span><span class=n>KeyPair</span><span class=w> </span><span class=nf>generateRsaKey</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>KeyPair</span><span class=w> </span><span class=n>keyPair</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>KeyPairGenerator</span><span class=w> </span><span class=n>keyPairGenerator</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>KeyPairGenerator</span><span class=p>.</span><span class=na>getInstance</span><span class=p>(</span><span class=s>&#34;RSA&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>keyPairGenerator</span><span class=p>.</span><span class=na>initialize</span><span class=p>(</span><span class=n>2048</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>keyPair</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>keyPairGenerator</span><span class=p>.</span><span class=na>generateKeyPair</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>ex</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalStateException</span><span class=p>(</span><span class=n>ex</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>keyPair</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>现在启动授权服务器。</p><h2 id=资源服务器>资源服务器</h2><p>一、<strong>pom.xml</strong></p><p>pom.xml 必须包含<em>spring-boot-starter-oauth2-resource-server</em>依赖项以及其他依赖项。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;groupId&gt;</span>org.springframework.boot<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;artifactId&gt;</span>spring-boot-starter-oauth2-resource-server<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>从配置角度来看，资源服务器仅包含application.yml</p><p><strong>application.yml</strong></p><p>我们需要在<em>application.yml</em>文件中提及令牌发行者 uri。</p><pre tabindex=0><code>server:
  port: 8090

spring:
  security:
    oauth2:
      resourceserver:
        jwt:
          issuer-uri: http://localhost:9001
</code></pre><p>三.<strong><strong>SecurityConfig</strong></strong></p><p>SecurityConfig 类的目的是验证来自授权服务器的访问令牌，并根据需要为资源服务器本身定义的端点添加额外的安全配置。</p><h2 id=social-login-client>social-login-client</h2><p>一、<strong>pom.xml</strong></p><p>pom.xml 必须包含<em>spring-boot-starter-oauth2-client</em>依赖项以及其他依赖项。此外，由于我们使用了 webClient，因此我们添加了<em>spring-boot-starter-webflux</em>依赖项。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>     <span class=nt>&lt;groupId&gt;</span>org.springframework.boot<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>     <span class=nt>&lt;artifactId&gt;</span>spring-boot-starter-oauth2-client<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;/dependency&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>     <span class=nt>&lt;groupId&gt;</span>org.springframework.boot<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>     <span class=nt>&lt;artifactId&gt;</span>spring-boot-starter-webflux<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;/dependency&gt;</span>
</span></span></code></pre></div><p><strong>application.yml</strong></p><p>application.yml<em>文件</em>包含客户端本身的配置以及授权过程中要通信的 URL。下面给出了我的<em>oidc-client</em>注册的完整代码。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=line><span class=cl><span class=nt>spring</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>security</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>oauth2</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>client</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>registration</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=c># Client registration starts here</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>oidc-client</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c># Our oidc-client needs a provider. The provider information has been registered</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c># at the bottom of this configuration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>provider</span><span class=p>:</span><span class=w> </span><span class=l>spring</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c># The following client-id and client-secret will be sent to the authorization server</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c># We don&#39;t need to mention the client_credentials in the grant type here.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c># Note that, here the client-secret must not contain {noop} or any other encoding type mentioned.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>client-id</span><span class=p>:</span><span class=w> </span><span class=l>oidc-client</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>client-secret</span><span class=p>:</span><span class=w> </span><span class=l>secret</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c># Our authorization grant type is authorization_code</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>authorization-grant-type</span><span class=p>:</span><span class=w> </span><span class=l>authorization_code</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c># The following redirect URL is the redirect URL definition of our client Server application.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c># It is generally the current application host address. The authorization server&#39;s redirect URL</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c># definition means that this URL will be triggered when auth server redirects data to here.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>redirect-uri</span><span class=p>:</span><span class=w> </span><span class=l>http://127.0.0.1:8080/login/oauth2/code/oidc-client</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c># Scopes that will be displayed for requesting in the consent page.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c># Authorization server must have equal or more scopes than these in number</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>scope</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span>- <span class=l>openid</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span>- <span class=l>profile</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span>- <span class=l>read</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span>- <span class=l>write</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c># This client name will display in the login screen as social login type</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>client-name</span><span class=p>:</span><span class=w> </span><span class=l>oidc-client</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c># As mentioned above about provider, here we register the provider details</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c># for any unknown provider with their issuer URI</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>provider</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>spring</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>issuer-uri</span><span class=p>:</span><span class=w> </span><span class=l>http://localhost:9001</span><span class=w>
</span></span></span></code></pre></div><p>三.<strong>SecurityConfig</strong></p><p>我们需要编写 SecurityConfig 类以使 PKCE 能够生成代码解析器和代码质询，放置 OAuth2Login 端点的逻辑并保护客户端应用程序中定义的端点。</p><p>完整的代码如下所示。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Configuration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>SecurityConfig</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>SecurityFilterChain</span><span class=w> </span><span class=nf>securityFilterChain</span><span class=p>(</span><span class=n>HttpSecurity</span><span class=w> </span><span class=n>http</span><span class=p>,</span><span class=w> </span><span class=n>ClientRegistrationRepository</span><span class=w> </span><span class=n>clientRegistrationRepository</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>base_uri</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>OAuth2AuthorizationRequestRedirectFilter</span><span class=p>.</span><span class=na>DEFAULT_AUTHORIZATION_REQUEST_BASE_URI</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>DefaultOAuth2AuthorizationRequestResolver</span><span class=w> </span><span class=n>resolver</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>DefaultOAuth2AuthorizationRequestResolver</span><span class=p>(</span><span class=n>clientRegistrationRepository</span><span class=p>,</span><span class=w> </span><span class=n>base_uri</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Responsible for enabling PKCE, to generate code verifier, code challenge</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>resolver</span><span class=p>.</span><span class=na>setAuthorizationRequestCustomizer</span><span class=p>(</span><span class=n>OAuth2AuthorizationRequestCustomizers</span><span class=p>.</span><span class=na>withPkce</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>http</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>authorizeHttpRequests</span><span class=p>(</span><span class=n>authorize</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>authorize</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>.</span><span class=na>requestMatchers</span><span class=p>(</span><span class=s>&#34;/&#34;</span><span class=p>).</span><span class=na>permitAll</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>.</span><span class=na>anyRequest</span><span class=p>().</span><span class=na>authenticated</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>oauth2Login</span><span class=p>(</span><span class=n>oauth2Login</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>oauth2Login</span><span class=p>.</span><span class=na>loginPage</span><span class=p>(</span><span class=s>&#34;/oauth2/authorization/oidc-client&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>oauth2Login</span><span class=p>.</span><span class=na>authorizationEndpoint</span><span class=p>(</span><span class=n>authorizationEndpointConfig</span><span class=w> </span><span class=o>-&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                  </span><span class=n>authorizationEndpointConfig</span><span class=p>.</span><span class=na>authorizationRequestResolver</span><span class=p>(</span><span class=n>resolver</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>oauth2Client</span><span class=p>(</span><span class=n>withDefaults</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>http</span><span class=p>.</span><span class=na>build</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>iv. <strong>WebClientConfig</strong></p><p>为了让 webClient 无缝地与 OAuth2 协同工作，我们需要定义<em>WebClientConfig</em>并添加更多 bean。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Configuration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>WebClientConfig</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>HelloClient</span><span class=w> </span><span class=nf>helloClient</span><span class=p>(</span><span class=n>OAuth2AuthorizedClientManager</span><span class=w> </span><span class=n>authorizedClientManager</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>httpServiceProxyFactory</span><span class=p>(</span><span class=n>authorizedClientManager</span><span class=p>).</span><span class=na>createClient</span><span class=p>(</span><span class=n>HelloClient</span><span class=p>.</span><span class=na>class</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>HttpServiceProxyFactory</span><span class=w> </span><span class=nf>httpServiceProxyFactory</span><span class=p>(</span><span class=n>OAuth2AuthorizedClientManager</span><span class=w> </span><span class=n>authorizedClientManager</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ServletOAuth2AuthorizedClientExchangeFilterFunction</span><span class=w> </span><span class=n>oauth2Client</span><span class=w> </span><span class=o>=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>new</span><span class=w> </span><span class=n>ServletOAuth2AuthorizedClientExchangeFilterFunction</span><span class=p>(</span><span class=n>authorizedClientManager</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>oauth2Client</span><span class=p>.</span><span class=na>setDefaultOAuth2AuthorizedClient</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>WebClient</span><span class=w> </span><span class=n>webClient</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>WebClient</span><span class=p>.</span><span class=na>builder</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>apply</span><span class=p>(</span><span class=n>oauth2Client</span><span class=p>.</span><span class=na>oauth2Configuration</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>build</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>WebClientAdapter</span><span class=w> </span><span class=n>client</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>WebClientAdapter</span><span class=p>.</span><span class=na>forClient</span><span class=p>(</span><span class=n>webClient</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>HttpServiceProxyFactory</span><span class=p>.</span><span class=na>builder</span><span class=p>(</span><span class=n>client</span><span class=p>).</span><span class=na>build</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>OAuth2AuthorizedClientManager</span><span class=w> </span><span class=nf>authorizedClientManager</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ClientRegistrationRepository</span><span class=w> </span><span class=n>clientRegistrationRepository</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>OAuth2AuthorizedClientRepository</span><span class=w> </span><span class=n>authorizedClientRepository</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>OAuth2AuthorizedClientProvider</span><span class=w> </span><span class=n>authorizedClientProvider</span><span class=w> </span><span class=o>=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>OAuth2AuthorizedClientProviderBuilder</span><span class=p>.</span><span class=na>builder</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>.</span><span class=na>authorizationCode</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>.</span><span class=na>refreshToken</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>.</span><span class=na>build</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>DefaultOAuth2AuthorizedClientManager</span><span class=w> </span><span class=n>authorizedClientManager</span><span class=w> </span><span class=o>=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>new</span><span class=w> </span><span class=n>DefaultOAuth2AuthorizedClientManager</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>clientRegistrationRepository</span><span class=p>,</span><span class=w> </span><span class=n>authorizedClientRepository</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>authorizedClientManager</span><span class=p>.</span><span class=na>setAuthorizedClientProvider</span><span class=p>(</span><span class=n>authorizedClientProvider</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>authorizedClientManager</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p><em>如果您注意到HelloClient</em>的 bean ，这样我们就可以定义更多的客户端，使业务服务（资源服务器）调用过程更容易。</p><p>v.<strong>调用资源服务器</strong></p><p>我们需要定义一个</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@HttpExchange</span><span class=p>(</span><span class=s>&#34;http://localhost:8090&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>interface</span> <span class=nc>HelloClient</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@GetExchange</span><span class=p>(</span><span class=s>&#34;/&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>String</span><span class=w> </span><span class=nf>getHello</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>现在让我们从控制器调用*getHello()*方法。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@RestController</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@RequestMapping</span><span class=p>(</span><span class=s>&#34;/&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>AppController</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>AppService</span><span class=w> </span><span class=n>appService</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>HelloClient</span><span class=w> </span><span class=n>helloClient</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>AppController</span><span class=p>(</span><span class=n>HelloClient</span><span class=w> </span><span class=n>helloClient</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>helloClient</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>helloClient</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@GetMapping</span><span class=p>(</span><span class=s>&#34;/&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>ResponseEntity</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=nf>getPublicData</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>ResponseEntity</span><span class=p>.</span><span class=na>ok</span><span class=p>(</span><span class=s>&#34;Public data&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@GetMapping</span><span class=p>(</span><span class=s>&#34;/private-data&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>ResponseEntity</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=nf>getPrivateData</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>ResponseEntity</span><span class=p>.</span><span class=na>ok</span><span class=p>(</span><span class=n>appService</span><span class=p>.</span><span class=na>getJwtToken</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@GetMapping</span><span class=p>(</span><span class=s>&#34;/hello&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>ResponseEntity</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=nf>sayHello</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>ResponseEntity</span><span class=p>.</span><span class=na>ok</span><span class=p>(</span><span class=n>helloClient</span><span class=p>.</span><span class=na>getHello</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h2 id=在浏览器中测试的时间>在浏览器中测试的时间</h2><p>在开始之前，让我们更改 application.yml 中的日志配置以查看所有 3 个服务器的调试日志。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=line><span class=cl><span class=nt>logging</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>level</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>org.springframework.boot</span><span class=p>:</span><span class=w> </span><span class=l>error</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>org.springframework.security</span><span class=p>:</span><span class=w> </span><span class=l>debug</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>org.springframework.security.web</span><span class=p>:</span><span class=w> </span><span class=l>debug</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>org.apache.catalina</span><span class=p>:</span><span class=w> </span><span class=l>error</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>com.mainul35</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>info</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>trace</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>debug</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>error</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>warn</span><span class=w>
</span></span></span></code></pre></div><p>现在，我们在浏览器中输入**(1)** <a href=http://localhost:8080/hello>http://localhost:8080/hello 。它将带我们到授权服务器的登录端点，在我们的例子中是</a>http://localhost:9001/login。但在此之前，它会进行几次重定向。让我们先通过浏览器的网络选项卡查看它。</p><p><img loading=lazy src=https://miro.medium.com/v2/resize:fit:2000/1*UAOfW4lFWH7BK5IxDLwxsA.png alt=img></p><p>网络响应</p><p>如果我们注意到上述网络响应，我们可以看到，当我们请求 /hello 端点时，它首先将我们重定向到**(2)** http://localhost:8080/oauth2/authorization/oidc-client端点。</p><p>然后，从客户端授权端点，我们再次被重定向到授权服务器的以下端点。<strong>（3）</strong></p><p><a href="http://localhost:9001/oauth2/authorize?response_type=code&amp;client_id=oidc-client&amp;scope=openid+profile+read+write&amp;state=vyMkXghiz-H25RLcNWijBsduVpmam2sAA4_OMWmTysw%3D&amp;redirect_uri=http%3A%2F%2F127.0.0.1%3A8080%2Flogin%2Foauth2%2Fcode%2Foidc-client&amp;nonce=yBuntyu9zBQ_HnSpi4iB1npHn4FvbUffNwzAA6st-wc&amp;code_challenge=rSsAc3XOlEWf3GpDfPMVM7OhQX6RLXN-_X7ozWvJyrM&amp;code_challenge_method=S256">http://localhost:9001/oauth2/authorize?response_type=code&amp;client_id=oidc-client&amp;scope=openid%20profile%20read%20write&amp;state=vyMkXghiz-H25RLcNWijBsduVpmam2sAA4_OMWmTysw%3D&amp;redirect_uri=http://127.0.0.1:8080/login/oauth2/code/oidc-client&amp;nonce=yBuntyu9zBQ_HnSpi4iB1npHn4FvbUffNwzAA6st-wc&amp;code_challenge=rSsAc3XOlEWf3GpDfPMVM7OhQX6RLXN-_X7ozWvJyrM&amp;code_challenge_method=S256</a></p><p>当授权服务器发现该请求尚未获得授权时，它会再次重定向到授权服务器的登录端点。（4）</p><p><a href=http://localhost:9001/login>http://localhost:9001/登录</a></p><p>现在，让我们提供正确的用户凭证并观察。</p><p><img loading=lazy src=https://miro.medium.com/v2/resize:fit:2000/1*em8RBQlJpFTNa-_z7FI5hw.png alt=img></p><p>提供登录凭证后</p><p>它首先使用 POST 方法将表单提交到登录端点。我们可以在浏览器网络选项卡中看到另一个重定向。</p><p>接下来，如果身份验证成功，我们将进入授权同意屏幕。网址如下。<strong>（5）</strong></p><p><a href="http://localhost:9001/oauth2/authorize?response_type=code&amp;client_id=oidc-client&amp;scope=openid+profile+read+write&amp;state=hD5CGxSzNt_PZrzbUBKDqjszrouPKsfk027pRTzaPFY%3D&amp;redirect_uri=http%3A%2F%2F127.0.0.1%3A8080%2Flogin%2Foauth2%2Fcode%2Foidc-client&amp;nonce=azp457lnXYfTag62hBwuThxMQ66NeVmdlMQSnzI4lfQ&amp;code_challenge=8ZfGPgaJ96i14R39t7IM_540GdxFIo0XAlmmfnelgIE&amp;code_challenge_method=S256&amp;continue=">http://localhost:9001/oauth2/authorize?response_type=code&amp;client_id=oidc-client&amp;scope=openid%20profile%20read%20write&amp;state=hD5CGxSzNt_PZrzbUBKDqjszrouPKsfk027pRTzaPFY%3D&amp;redirect_uri=http://127.0.0.1:8080/login/oauth2/code/oidc-client&amp;nonce=azp457lnXYfTag62hBwuThxMQ66NeVmdlMQSnzI4lfQ&amp;code_challenge=8ZfGPgaJ96i14R39t7IM_540GdxFIo0XAlmmfnelgIE&amp;code_challenge_method=S256&amp;continue</a></p><blockquote><p>注意，如果我们授权应用程序但未获得所有同意，则可能会将我们重定向到相同的同意屏幕。因此，在提供一些同意后，我们可以点击取消，或提供所有同意。</p></blockquote><p>现在，让我们提供一些同意并继续。就我的情况而言，我将提供所有同意并提交。</p><p><img loading=lazy src=https://miro.medium.com/v2/resize:fit:2000/1*CL0plA_Brb9CiwTUmovNOw.png alt=img></p><p>长话短说，成功登录后，它会将我们重定向到客户端应用程序的 /login/oauth2/code/oidc-client 端点，并附带授权码参数。使用此代码，我们可以请求 /oauth2/token 端点来获取访问令牌。</p><p>现在我们可以再次向 /hello 端点发出请求并查看其是否正常工作。</p><p><img loading=lazy src=https://miro.medium.com/v2/resize:fit:2000/1*_Iv6blUC3yzPGaxIK_a-_Q.png alt=img></p><p>来自 /hello 端点的响应</p><h2 id=为什么收到代码后没有对-oauthtoken-端点发出任何请求>为什么收到代码后没有对 /oauth/token 端点发出任何请求？</h2><p><strong>从IETF网站提供的以下OAuth2 for Browser based Apps</strong>草案中我们可以看到，对于PKCE，它不必在授权服务器中颁发访问令牌。</p><p><img loading=lazy src=https://miro.medium.com/v2/resize:fit:2000/1*GYmJohheMh0Y1FLdPdf1Dw.png alt=img></p><p>以下是草案的链接：<a href=https://datatracker.ietf.org/doc/html/draft-ietf-oauth-browser-based-apps-10#name-notational-conventions>draft-ietf-oauth-browser-based-apps-10</a></p><p>如果我们仍然想获取令牌，在我的客户端应用程序中，我提供了一个端点<a href=http://127.0.0.1:8080/private-data>127.0.0.1:8080/private-data</a>，我们可以通过它获取令牌。</p><p><img loading=lazy src=https://miro.medium.com/v2/resize:fit:2000/1*sIDG4eODKLQU-ntBGcdHLw.png alt=img></p><p>完整的源代码可以在<a href=https://github.com/mainul35/authorization-server-demo/tree/authorization-server-demo/social-login-with-oidc-pkce>这里</a>找到</p><h2 id=参考>参考：</h2><ol><li><a href=https://datatracker.ietf.org/doc/html/draft-ietf-oauth-browser-based-apps-10#name-notational-conventions>draft-ietf-oauth-基于浏览器的应用程序-10</a></li><li><a href=https://github.com/spring-projects/spring-authorization-server/issues/297>基于浏览器的应用程序 (SPA) 的实施指南 · 问题 #297 · spring-projects/spring-authorization-server (github.com)</a></li><li><a href="https://www.youtube.com/watch?v=mKvi9RWGn3M">Spring Boot 3 教程：使用 PKCE 实现安全 Oauth2 — Spring 授权服务器 — 和 OAuth2 客户端 — YouTube</a></li></ol></div><footer class=post-footer><nav class=paginav><a class=prev href=https://blog.chensoul.cc/posts/2024/06/05/oauth2/><span class=title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left" style="user-select:text"><line x1="19" y1="12" x2="5" y2="12" style="user-select:text"/><polyline points="12 19 5 12 12 5" style="user-select:text"/></svg>&nbsp;Prev Page</span><br><span>RFC6749 | OAuth2.0授权框架中文版</span>
</a><a class=next href=https://blog.chensoul.cc/posts/2024/06/05/oauth2-with-spring-part-4-spring-authorization-client-social-login-demo-with-google/><span class=title>Next Page&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right" style="user-select:text"><line x1="5" y1="12" x2="19" y2="12" style="user-select:text"/><polyline points="12 5 19 12 12 19" style="user-select:text"/></svg></span><br><span>[译]OAuth2 with Spring 第4部分：Spring授权客户端与Google授权服务器的社交登录演示</span></a></nav></footer><div class=comments-separator></div></article></main><footer class=footer><span>&copy; 2024 <a href=https://blog.chensoul.cc/>ChenSoul</a></span><span style=display:inline-block;margin-left:1em>
<a href=https://creativecommons.org/licenses/by-sa/4.0/>CC BY-SA</a>
</span><span style=display:inline-block;margin-left:1em>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
    <a href=https://github.com/reorx/hugo-PaperModX/ rel=noopener target=_blank>PaperModX</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script async src=https://umami.chensoul.cc/random-string.js data-website-id=821c25f8-a31a-4607-92d7-91ee76843d00></script><script>(function(){const t=""=="1";if(t)return;let e=document.getElementById("theme-toggle");e.removeEventListener("click",toggleThemeListener),e.addEventListener("click",toggleThemeListener)})()</script><script>(function(){let e=document.getElementById("menu");e&&(e.scrollLeft=localStorage.getItem("menu-scroll-position"),e.onscroll=function(){localStorage.setItem("menu-scroll-position",e.scrollLeft)});const t=""=="1",n="1"=="1";if(window.matchMedia("(prefers-reduced-motion: reduce)").matches||t||n)return;document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})})()</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>if(window.scrollListeners)for(const e of scrollListeners)window.removeEventListener("scroll",e);window.scrollListeners=[]</script><script src=/js/medium-zoom.min.js data-no-instant></script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerText="copy";function s(){t.innerText="copied!",setTimeout(()=>{t.innerText="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script><script>(function(){const a="1"=="1";if(!a)return;if(!document.querySelector(".toc")){console.log("no toc found, ignore toc scroll");return}const r=window.scrollListeners,t=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id]"),n="active";let e=t[0];o(e).classList.add(n);const c=()=>{const s=[];for(const e of t)if(l(e)<5)s.push(e);else break;s.length>0?newActiveHeading=s[s.length-1]:newActiveHeading=t[0],e!=newActiveHeading&&(o(e).classList.remove(n),e=newActiveHeading,o(e).classList.add(n))};let s=null;const i=()=>{s!==null&&clearTimeout(s),s=setTimeout(c,50)};window.addEventListener("scroll",i,!1),r.push(i);function o(e){const t=encodeURI(e.getAttribute("id")).toLowerCase();return document.querySelector(`.toc ul li a[href="#${t}"]`)}function l(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect();return t.top}})()</script><script>mediumZoom(".entry-cover img"),mediumZoom(".post-content img:not([no-zoom])")</script><script src=/js/instantclick.min.js data-no-instant></script><script data-no-instant>InstantClick.init()</script></body></html>