<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>[译]Spring Security 和 JWT 入门 | ChenSoul</title>
<meta name=keywords content="spring-security,jwt"><meta name=description content="Spring Security 为 Java 应用程序提供了一套全面的安全功能，涵盖身份验证、授权、会话管理以及针对CSRF（跨站点请求伪造）等常见安全威胁的防护。Spring Security 框架具有高度可定制性，允许开发人员根据其应用程序需求来管理安全配置。它提供了一个灵活的架构，支持各种身份验证机制，如基本身份验证、JWT 和 OAuth。"><meta name=author content="chensoul"><link rel=canonical href=https://blog.chensoul.cc/posts/2024/10/15/spring-security-jwt/><meta name=google-site-verification content="nBXwg45SBRjTX78SA-mH0asrAbsdu9c1nk0ObSry7aQ"><link crossorigin=anonymous href=/assets/css/stylesheet.899d9a536396b9b03c9eae0c99cc6ec954a90da94036f5390d131eb8071bb417.css integrity="sha256-iZ2aU2OWubA8nq4MmcxuyVSpDalANvU5DRMeuAcbtBc=" rel="preload stylesheet" as=style><link rel=icon href=https://blog.chensoul.cc/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://blog.chensoul.cc/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://blog.chensoul.cc/favicon-32x32.png><link rel=apple-touch-icon href=https://blog.chensoul.cc/apple-touch-icon.png><link rel=mask-icon href=https://blog.chensoul.cc/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://blog.chensoul.cc/posts/2024/10/15/spring-security-jwt/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta name=baidu-site-verification content="codeva-FYpQY8JdLU"><meta property="og:title" content="[译]Spring Security 和 JWT 入门"><meta property="og:description" content="Spring Security 为 Java 应用程序提供了一套全面的安全功能，涵盖身份验证、授权、会话管理以及针对CSRF（跨站点请求伪造）等常见安全威胁的防护。Spring Security 框架具有高度可定制性，允许开发人员根据其应用程序需求来管理安全配置。它提供了一个灵活的架构，支持各种身份验证机制，如基本身份验证、JWT 和 OAuth。"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.chensoul.cc/posts/2024/10/15/spring-security-jwt/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-10-15T00:00:00+08:00"><meta property="article:modified_time" content="2024-10-15T00:00:00+08:00"><meta property="og:site_name" content="ChenSoul"><meta name=twitter:card content="summary"><meta name=twitter:title content="[译]Spring Security 和 JWT 入门"><meta name=twitter:description content="Spring Security 为 Java 应用程序提供了一套全面的安全功能，涵盖身份验证、授权、会话管理以及针对CSRF（跨站点请求伪造）等常见安全威胁的防护。Spring Security 框架具有高度可定制性，允许开发人员根据其应用程序需求来管理安全配置。它提供了一个灵活的架构，支持各种身份验证机制，如基本身份验证、JWT 和 OAuth。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://blog.chensoul.cc/posts/"},{"@type":"ListItem","position":2,"name":"[译]Spring Security 和 JWT 入门","item":"https://blog.chensoul.cc/posts/2024/10/15/spring-security-jwt/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"[译]Spring Security 和 JWT 入门","name":"[译]Spring Security 和 JWT 入门","description":"Spring Security 为 Java 应用程序提供了一套全面的安全功能，涵盖身份验证、授权、会话管理以及针对CSRF（跨站点请求伪造）等常见安全威胁的防护。Spring Security 框架具有高度可定制性，允许开发人员根据其应用程序需求来管理安全配置。它提供了一个灵活的架构，支持各种身份验证机制，如基本身份验证、JWT 和 OAuth。\n","keywords":["spring-security","jwt"],"articleBody":"Spring Security 为 Java 应用程序提供了一套全面的安全功能，涵盖身份验证、授权、会话管理以及针对CSRF（跨站点请求伪造）等常见安全威胁的防护。Spring Security 框架具有高度可定制性，允许开发人员根据其应用程序需求来管理安全配置。它提供了一个灵活的架构，支持各种身份验证机制，如基本身份验证、JWT 和 OAuth。\nSpring Security 提供了开箱即用的基本身份验证。要了解其工作原理，请参阅本文。在本文中，我们将深入探讨 JWT 的工作原理以及如何使用 Spring Security 对其进行配置。\n示例代码 本文附带了GitHub 可用的代码示例。\n什么是 JWT JWT（JSON Web Token）是一种在双方之间传递 JSON 消息的安全方式。它是RFC 7519中定义的标准。JWT 令牌中包含的信息可以验证和信任，因为它是经过数字签名的。可以使用密钥（使用 HMAC 算法）或使用 RSA 或 ECDSA 的公钥/私钥对对 JWT 进行签名。\n对于本文，我们将使用密钥创建一个 JWT 令牌，并使用它来保护我们的 REST 端点。\nJWT 结构 在本节中，我们将了解一个示例 JWT 结构。JSON Web Token 由三部分组成：\n标头 有效载荷 签名 JWT 标头 标头由两部分组成：令牌的类型（即 JWT）和正在使用的签名算法（如 HMAC SHA 256 或 RSA）。示例 JSON 标头：\n1 2 3 4 { \"alg\": \"HS256\", \"typ\": \"JWT\" } 然后对此 JSON 进行 Base64 编码，从而形成 JWT 令牌的第一部分。\nJWT 有效负载 有效载荷是包含实际数据的主体。数据可以是用户数据或任何需要安全传输的信息。这些数据也称为claims。声明有三种类型：注册声明、公共声明和私有声明。\n已登记的索赔 它们是一组预定义的三个字符声明，定义在RFC7519中。一些常用的声明包括iss (Issuer Claim)、sub (Subject Claim)、aud (Audience Claim)、exp (Expiration Time Claim)、iat (Issued At Time)、nbf (Not Before)。让我们详细了解一下它们：\niss：此声明用于指定 JWT 的颁发者。它用于标识颁发令牌的实体，例如身份验证服务器或身份提供者。 sub：此声明用于识别 JWT 的主题，即颁发令牌的用户或实体。 aud：此声明用于指定 JWT 的目标受众。这通常用于限制令牌仅供某些服务或应用程序使用。 exp：此声明用于指定 JWT 的过期时间，超过此时间后，令牌将不再有效。以自 Unix 纪元以来的秒数表示。 iat：签发 JWT 的时间。可用于确定 JWT 的年龄。以自 Unix 纪元以来的秒数表示。 nbf：标识在此之前 JWT 不能被接受处理的时间。 在此处查看已注册声明的完整列表。在后续章节中，我们将介绍几个如何使用它们的示例。\n公开声明 与已注册的、具有预定义含义的声明不同，这些声明可以根据应用程序的要求进行定制。大多数公开声明属于以下类别：\n用户/客户端数据：包括用户名、客户端 ID、电子邮件、地址、角色、权限、范围、特权以及用于身份验证或授权的任何用户/客户端相关信息。 应用程序数据：包括会话详细信息、用户偏好（例如语言偏好）、应用程序设置或任何应用程序特定的数据。 安全信息：包括其他安全相关信息，如密钥、证书、令牌等。 私人索赔 私有声明是特定于特定组织的自定义声明。它们不是由官方 JWT 规范标准化的，而是由参与 JWT 交换的各方定义的。\nJWT 声明推荐最佳实践 尽可能使用 JWT 规范中定义的标准声明。它们被广泛认可并且具有明确的含义。 为了获得更好的可维护性，JWT 有效负载应该仅具有所需的最少声明，并限制令牌大小。 公共声明应该具有清晰且描述性的名称。 遵循一致的命名约定以保持一致性和可读性。 避免包含 PII 信息以最大限度地降低数据泄露的风险。 确保使用注册声明中指定的推荐算法对 JWT 进行加密alg。声明none中的值alg表示 JWT 未签名且不推荐使用。 JWT 签名 为了创建签名，我们对标头进行编码，对有效负载进行编码，并使用密钥通过标头中指定的算法对元素进行签名。 生成的令牌将具有三个以点分隔的 Base64 URL 字符串。JWT 的图示如下所示：\n签名的目的是验证消息在传输过程中没有被更改。由于它们也使用密钥签名，因此可以验证 JWT 的发送者是否是其声称的那个人。\nJWT 的常见用例 JWT 用途广泛，可用于如下所述的各种场景：\n单点登录：JWT 允许跨多个服务或应用程序进行用户身份验证，从而实现单点登录 (SSO)。用户登录到一个应用程序后，会收到一个 JWT，该 JWT 可用于登录其他服务（用户有权访问），而无需输入/维护单独的登录凭据。 API 身份验证：JWT 通常用于对 API 的访问进行身份验证和授权。客户端将 JWT 令牌包含在API 请求的授权标头中，以验证其对 API 的访问权限。然后，API 将解码 JWT 以授予或拒绝访问权限。 无状态会话：JWT 有助于提供无状态会话管理，因为会话信息存储在令牌本身中。 信息交换：由于 JWT 安全可靠，因此它们不仅可用于交换用户信息，还可用于交换任何需要在双方之间安全传输的信息。 微服务：JWT 是微服务生态系统中最受欢迎的 API 通信方式之一，因为微服务可以独立验证令牌，而无需依赖外部身份验证服务器，从而更易于扩展。 使用 JWT 的注意事项 现在我们了解了 JWT 提供的好处，让我们看看使用 JWT 的缺点。这里的想法是让开发人员权衡手头的选项，并做出在应用程序中使用基于令牌的架构的明智决定。\n在 JWT 取代会话的情况下，如果我们最终使用较大的有效负载，JWT 令牌可能会膨胀。最重要的是，如果我们添加加密签名，则会导致整体性能开销。对于存储简单的用户会话来说，这最终会变得过度。 JWT 会以一定的时间间隔过期，过期后需要刷新令牌并生成新的令牌。从安全角度来看，这很好，但过期时间需要仔细考虑。例如，24 小时的过期时间是一个糟糕的设计考虑。 现在，我们已经了解了重点，我们将能够就如何以及何时使用 JWT 做出明智的决定。在下一节中，我们将用 Java 创建一个简单的 JWT 令牌。\n使用 Java 创建 JWT 令牌 JJWT是在 Java 和 Android 中创建 JWT 令牌最常用的 Java 库。我们将首先将其依赖项添加到我们的应用程序中。\n配置 JWT 依赖项 Maven 依赖项：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 io.jsonwebtoken jjwt-api 0.11.1 io.jsonwebtoken jjwt-impl 0.11.1 runtime io.jsonwebtoken jjwt-jackson 0.11.1 runtime Gradle 依赖性：\n1 2 3 compile 'io.jsonwebtoken:jjwt-api:0.11.1' runtime 'io.jsonwebtoken:jjwt-impl:0.11.1' runtime 'io.jsonwebtoken:jjwt-jackson:0.11.1' 我们的 Java 应用程序基于 Maven，因此我们将上述 Maven 依赖项添加到我们的pom.xml中。\n创建 JWT 令牌 我们将使用包Jwts中的类io.jsonwebtoken。我们可以指定声明（已注册和公开）和其他 JWT 属性，并创建一个令牌，如下所示：\n1 2 3 4 5 6 7 8 9 10 11 12 public static String createJwt() { return Jwts.builder() .claim(\"id\", \"abc123\") .claim(\"role\", \"admin\") /*.addClaims(Map.of(\"id\", \"abc123\", \"role\", \"admin\"))*/ .setIssuer(\"TestApplication\") .setIssuedAt(java.util.Date.from(Instant.now())) .setExpiration(Date.from(Instant.now().plus(10, ChronoUnit.MINUTES))) .compact(); } 此方法创建一个 JWT 令牌，如下所示：\n1 2 eyJhbGciOiJub25lIn0.eyJpZCI6ImFiYzEyMyIsInJvbGUiOiJhZG1pbiIsImlzcyI6IlR lc3RBcHBsaWNhdGlvbiIsImlhdCI6MTcxMTY2MTA1MiwiZXhwIjoxNzExNjYxNjUyfQ. 接下来我们看一下用于生成令牌的构建器方法：\nclaim：允许我们指定任意数量的自定义名称值对声明。我们还可以使用addClaims方法添加声明映射作为替代方案。 setIssuer：此方法与已注册的权利要求相对应iss。 setIssuedAt：此方法对应于已注册的声明iat。此方法以java.util.Date作为参数。这里我们将此值设置为当前时刻。 setExpiration：此方法对应于已注册的声明exp。此方法以java.util.Date作为参数。这里我们将此值设置为从当前时刻开始的 10 分钟。 让我们尝试使用在线JWT 解码器解码该 JWT ：\n如果我们仔细查看标头，我们会看到alg:none。这是因为我们没有指定要使用的任何算法。正如我们之前看到的，建议我们使用算法来生成签名。\n因此，让我们在我们的方法中使用HMAC SHA256 算法：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 public static String createJwt() { // Recommended to be stored in Secret String secret = \"5JzoMbk6E5qIqHSuBTgeQCARtUsxAkBiHwdjXOSW8kWdXzYmP3X51C0\"; Key hmacKey = new SecretKeySpec(Base64.getDecoder().decode(secret), SignatureAlgorithm.HS256.getJcaName()); return Jwts.builder() .claim(\"id\", \"abc123\") .claim(\"role\", \"admin\") .setIssuer(\"TestApplication\") .setIssuedAt(java.util.Date.from(Instant.now())) .setExpiration(Date.from(Instant.now().plus(10, ChronoUnit.MINUTES))) .signWith(hmacKey) .compact(); } 生成的令牌结果如下：\n1 2 3 eyJthbGciOiJIUzI1NiJ9.eyJpZCI6ImFiYzEyMyIsInJvbGUiOiJhZG1pbiIsImlz cyI6IlRlc3RBcHBsaWNhdGlvbiIsImlhdCI6MTcxMjMyODQzMSwiZXhwIjoxNzEyMzI5MDMxfQ. pj9AvbLtwITqBYazDnaTibCLecM-cQ5RAYw2YYtkyeA 解码此 JWT 可得到：\n解析 JWT 令牌 现在我们已经创建了 JWT，让我们看看如何解析令牌以提取声明。只有当我们知道最初用于创建 JWT 的密钥时，我们才能解析令牌。以下代码可用于实现此目的：\n1 2 3 4 5 6 7 8 9 10 11 12 13 public static Jws\u003cClaims\u003e parseJwt(String jwtString) { // Recommended to be stored in Secret String secret = \"5JzoMbk6E5qIqHSuBTgeQCARtUsxAkBiHwdjXOSW8kWdXzYmP3X51C0\"; Key hmacKey = new SecretKeySpec(Base64.getDecoder().decode(secret), SignatureAlgorithm.HS256.getJcaName()); Jws\u003cClaims\u003e jwt = Jwts.parserBuilder() .setSigningKey(hmacKey) .build() .parseClaimsJws(jwtString); return jwt; } 这里，该方法parseJwt将 JWT 令牌作为字符串参数。使用相同的密钥（用于创建令牌），可以解析此令牌以检索声明。可以使用以下测试来验证这一点：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 @Test public void testParseJwtClaims() { String jwtToken = JWTCreator.createJwt(); assertNotNull(jwtToken); Jws\u003cClaims\u003e claims = JWTCreator.parseJwt(jwtToken); assertNotNull(claims); Assertions.assertAll( () -\u003e assertNotNull(claims.getSignature()), () -\u003e assertNotNull(claims.getHeader()), () -\u003e assertNotNull(claims.getBody()), () -\u003e assertEquals(claims.getHeader().getAlgorithm(), \"HS256\"), () -\u003e assertEquals(claims.getBody().get(\"id\"), \"abc123\"), () -\u003e assertEquals(claims.getBody().get(\"role\"), \"admin\"), () -\u003e assertEquals(claims.getBody().getIssuer(), \"TestApplication\") ); } 有关可用解析方法的完整列表，请参阅文档。\nSpring Security 中基本身份验证和 JWT 的比较 在深入研究示例 Spring Boot 应用程序中 JWT 的实现之前，让我们先看看 BasicAuth 和 JWT 之间的几个比较点。\n比较依据 基本身份验证 智威汤逊 授权标头 示例基本身份验证标头：授权：基本 xxx。 示例 JWT 标头：授权：Bearer xxx。 有效期和到期日 基本身份验证凭据只需配置一次，每次请求都需要传递相同的凭据。它永不过期。 使用 JWT 令牌，我们可以使用exp已注册的声明来设置有效性/到期时间，之后令牌将抛出一个io.jsonwebtoken.ExpiredJwtException。由于令牌有效期较短，这使得 JWT 更加安全。用户必须重新发送请求才能生成新令牌。 数据 基本身份验证仅用于处理凭证（通常是用户名-密码）。 JWT 可以包含其他信息，例如 id、角色等。一旦签名被验证，服务器就可以信任客户端发送的数据，从而避免可能需要的任何额外查找。 在 Spring Boot 应用程序中实现 JWT 现在我们更好地了解了 JWT，让我们在一个简单的 Spring Boot 应用程序中实现它。在我们的pom.xml中，让我们添加以下依赖项：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 org.springframework.boot spring-boot-starter-web org.springframework.boot spring-boot-starter-security io.jsonwebtoken jjwt-api 0.11.1 io.jsonwebtoken jjwt-impl 0.11.1 runtime io.jsonwebtoken jjwt-jackson 0.11.1 runtime 我们创建了一个简单的 Spring Boot Library 应用程序，该应用程序使用内存中的 H2 数据库来存储数据。该应用程序配置为在端口 8083 上运行。要运行该应用程序：\n1 2 mvnw clean verify spring-boot:run (for Windows) ./mvnw clean verify spring-boot:run (for Linux) 拦截 JWT 的 Spring Security 过滤器链 该应用程序有一个 REST 端点/library/books/all，用于获取数据库中存储的所有书籍。如果我们通过 Postman 进行此 GET 调用，则会收到401 UnAuthorized错误：\n这是因为，我们在pom.xml中添加的依赖项会自动为所有创建的端点引入基本身份验证。spring-boot-starter-security 由于我们没有在 Postman 中指定任何凭据，因此我们收到UnAuthorized错误。就本文而言，我们需要用基于 JWT 的身份验证替换基本身份验证。我们知道 Spring 通过触发处理每个请求的身份验证和授权的过滤器链来为我们的端点提供安全性。[UsernamePasswordAuthenticationFilter](https://docs.spring.io/spring-security/site/docs/current/api/org/springframework/security/web/authentication/UsernamePasswordAuthenticationFilter.html)负责验证每个请求的凭据。为了覆盖此过滤器，让我们创建一个Filter名为的新过滤器JwtFilter。此过滤器将扩展OncePerRequestFilter`类，因为我们希望每个请求仅调用一次过滤器：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 @Component @Slf4j public class JwtFilter extends OncePerRequestFilter { private final AuthUserDetailsService userDetailsService; private final JwtHelper jwtHelper; public JwtFilter(AuthUserDetailsService userDetailsService, JwtHelper jwtHelper) { this.userDetailsService = userDetailsService; this.jwtHelper = jwtHelper; } @Override protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain) throws ServletException, IOException { log.info(\"Inside JWT filter\"); // Code to validate the Authorization header } } 该类JwtHelper负责创建和验证 token。我们先看看如何创建 token：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 public String createToken(Map\u003cString, Object\u003e claims, String subject) { Date expiryDate = Date.from(Instant.ofEpochMilli(System.currentTimeMillis() + jwtProperties.getValidity())); Key hmacKey = new SecretKeySpec(Base64.getDecoder() .decode(jwtProperties.getSecretKey()), SignatureAlgorithm.HS256.getJcaName()); return Jwts.builder() .setClaims(claims) .setSubject(subject) .setIssuedAt(new Date(System.currentTimeMillis())) .setExpiration(expiryDate) .signWith(hmacKey) .compact(); } 以下参数负责创建令牌：\nclaims指的是空映射。此示例尚未定义任何用户特定的声明。 subject指的是用户在调用 API 创建 token 时传递的用户名。 expiryDate指的是在当前日期上添加“x”毫秒后的日期。“x”的值在属性中定义jwt.validity。 hmacKey指的是jva.security.Key用于签署 JWT 请求的对象。对于此示例，使用的密钥在属性中定义jwt.secretKey，并HS256使用算法。 此方法返回一个字符串 token，每次请求时都需要传递给它Authorization header。现在我们已经创建了一个 token，让我们看看类doFilterInternal中的方法JwtFilter，并了解这个类的职责Filter：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 @Override protected void doFilterInternal( HttpServletRequest request, HttpServletResponse response, FilterChain filterChain ) throws ServletException, IOException { final String authorizationHeader = request.getHeader(AUTHORIZATION); String jwt = null; String username = null; if (Objects.nonNull(authorizationHeader) \u0026\u0026 authorizationHeader.startsWith(\"Bearer \")) { jwt = authorizationHeader.substring(7); username = jwtHelper.extractUsername(jwt); } if (Objects.nonNull(username) \u0026\u0026 SecurityContextHolder.getContext().getAuthentication() == null) { UserDetails userDetails = this.userDetailsService.loadUserByUsername(username); boolean isTokenValidated = jwtHelper.validateToken(jwt, userDetails); if (isTokenValidated) { UsernamePasswordAuthenticationToken usernamePasswordAuthenticationToken = new UsernamePasswordAuthenticationToken( userDetails, null, userDetails.getAuthorities()); usernamePasswordAuthenticationToken.setDetails( new WebAuthenticationDetailsSource().buildDetails(request)); SecurityContextHolder.getContext().setAuthentication( usernamePasswordAuthenticationToken); } } filterChain.doFilter(request, response); } 步骤1。读取Authorization标头并提取 JWT 字符串。\n步骤2。解析 JWT 字符串并提取用户名。我们为此使用该io.jsonwebtoken库。如下所示：Jwts.parseBuilder()、jwtHelper.extractUsername()\n1 2 3 4 5 6 7 8 9 10 11 12 public String extractUsername(String bearerToken) { return extractClaimBody(bearerToken, Claims::getSubject); } public \u003cT\u003e T extractClaimBody(String bearerToken, Function\u003cClaims, T\u003e claimsResolver) { Jws\u003cClaims\u003e jwsClaims = extractClaims(bearerToken); return claimsResolver.apply(jwsClaims.getBody()); } private Jws\u003cClaims\u003e extractClaims(String bearerToken) { return Jwts.parserBuilder().setSigningKey(jwtProperties.getSecretKey()) .build().parseClaimsJws(bearerToken); } 步骤 3。提取用户名后，我们将使用 验证Authentication对象是否有效，即是否有登录用户SecurityContextHolder.getContext().getAuthentication()。如果没有，我们将使用 Spring SecurityUserDetailsService加载UserDetails对象。对于此示例，我们创建了AuthUserDetailsService返回对象的类UserDetails。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 public class AuthUserDetailsService implements UserDetailsService { private final UserProperties userProperties; @Autowired public AuthUserDetailsService(UserProperties userProperties) { this.userProperties = userProperties; } @Override public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException { if (StringUtils.isEmpty(username) || !username.equals(userProperties.getName())) { throw new UsernameNotFoundException( String.format(\"User not found, or unauthorized %s\", username)); } return new User(userProperties.getName(), userProperties.getPassword(), new ArrayList\u003c\u003e()); } } 下面的用户名和密码UserProperties是从application.yml以下位置加载的：\n1 2 3 4 5 spring: security: user: name: libUser password: libPassword 步骤4。接下来，JwtFilter调用jwtHelper.validateToken()来验证提取的用户名并确保jwt令牌尚未过期。\n1 2 3 4 5 6 7 8 9 10 public boolean validateToken(String token, UserDetails userDetails) { final String userName = extractUsername(token); return userName.equals(userDetails.getUsername()) \u0026\u0026 !isTokenExpired(token); } private Boolean isTokenExpired(String bearerToken) { return extractExpiry(bearerToken).before(new Date()); } public Date extractExpiry(String bearerToken) { return extractClaimBody(bearerToken, Claims::getExpiration); } 步骤 5。一旦令牌被验证，我们就创建一个对象实例。在这里，创建Authentication对象对象（它是接口的一个实现）并将其设置为。这表明用户现在已通过身份验证。SecurityContextHolder.getContext().setAuthentication(usernamePasswordAuthenticationToken)\n步骤6。最后，我们调用filterChain.doFilter(request, response)以便在中调用下一个过滤器FilterChain。\n这样，我们就成功创建了一个过滤器类来验证令牌。我们将在后续章节中讨论异常处理。\nJWT 令牌创建端点 Authorization在本节中，我们将创建一个 Controller 类来创建一个端点，这将允许我们创建一个 JWT 令牌字符串。当我们调用 Library 应用程序时，此令牌将在标头中设置。让我们创建一个TokenController类：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 @RestController public class TokenController { private final TokenService tokenService; public TokenController(TokenService tokenService) { this.tokenService = tokenService; } @PostMapping(\"/token/create\") public TokenResponse createToken(@RequestBody TokenRequest tokenRequest) { return tokenService.generateToken(tokenRequest); } } 请求主体TokenRequest类将接受用户名和密码：\n1 2 3 4 5 6 7 8 @Data @NoArgsConstructor @AllArgsConstructor @Builder public class TokenRequest { private String username; private String password; } 该类TokenService负责验证请求主体中传递的凭据并jwtHelper.createToken()按照上一节中的定义进行调用。为了验证凭据，我们需要实现一个AuthenticationManager。让我们创建一个SecurityConfiguration类来定义所有与 Spring 安全相关的配置。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 @Configuration @EnableWebSecurity public class SecurityConfiguration { private final JwtFilter jwtFilter; private final AuthUserDetailsService authUserDetailsService; private final JwtAuthenticationEntryPoint jwtAuthenticationEntryPoint; @Autowired public SecurityConfiguration(JwtFilter jwtFilter, AuthUserDetailsService authUserDetailsService, JwtAuthenticationEntryPoint jwtAuthenticationEntryPoint) { this.jwtFilter = jwtFilter; this.authUserDetailsService = authUserDetailsService; this.jwtAuthenticationEntryPoint = jwtAuthenticationEntryPoint; } @Bean public DaoAuthenticationProvider authenticationProvider() { final DaoAuthenticationProvider daoAuthenticationProvider = new DaoAuthenticationProvider(); daoAuthenticationProvider.setUserDetailsService(authUserDetailsService); daoAuthenticationProvider.setPasswordEncoder( PlainTextPasswordEncoder.getInstance()); return daoAuthenticationProvider; } @Bean public AuthenticationManager authenticationManager(HttpSecurity httpSecurity) throws Exception { return httpSecurity.getSharedObject(AuthenticationManagerBuilder.class) .authenticationProvider(authenticationProvider()) .build(); } } 使用AuthenticationManager，AuthUserDetailsService它使用spring.security.user属性。现在我们已经有了AuthenticationManager，让我们看看 是如何TokenService定义的：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 @Service public class TokenService { private final AuthenticationManager authenticationManager; private final AuthUserDetailsService userDetailsService; private final JwtHelper jwtHelper; public TokenService(AuthenticationManager authenticationManager, AuthUserDetailsService userDetailsService, JwtHelper jwtHelper) { this.authenticationManager = authenticationManager; this.userDetailsService = userDetailsService; this.jwtHelper = jwtHelper; } public TokenResponse generateToken(TokenRequest tokenRequest) { this.authenticationManager.authenticate( new UsernamePasswordAuthenticationToken( tokenRequest.getUsername(), tokenRequest.getPassword())); final UserDetails userDetails = userDetailsService.loadUserByUsername(tokenRequest.getUsername()); String token = jwtHelper.createToken( Collections.emptyMap(), userDetails.getUsername()); return TokenResponse.builder() .token(token) .build(); } } TokenResponse是包含标记字符串的 Response 对象：\n1 2 3 4 5 6 7 8 9 @Data @NoArgsConstructor @AllArgsConstructor @Builder public class TokenResponse { private String token; } 现在创建了 API，让我们启动应用程序并尝试使用 Postman 访问端点。我们看到401 Unauthorized以下错误：\n原因和我们之前遇到的一样。Spring Security 默认保护所有端点。我们需要一种方法来仅排除令牌端点的保护。此外，在启动日志中我们可以看到，虽然我们已经定义JwtFilter并且我们期望此过滤器覆盖UsernamePasswordAuthenticationFilter，但我们没有看到此过滤器连接到安全链中，如下所示：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 2024-05-22 15:41:09.441 INFO 20432 --- [ main] o.s.s.web.DefaultSecurityFilterChain : Will secure any request with [org.springframework.security.web.session.DisableEncodeUrlFilter@14d36bb2, org.springframework.security.web.context.request.async. WebAsyncManagerIntegrationFilter@432448, org.springframework.security.web.context.SecurityContextPersistenceFilter@54d46c8, org.springframework.security.web.header.HeaderWriterFilter@c7cf8c4, org.springframework.security.web.csrf.CsrfFilter@17fb5184, org.springframework.security.web.authentication.logout.LogoutFilter@42fa5cb, org.springframework.security.web.authentication. UsernamePasswordAuthenticationFilter@70d7a49b, org.springframework.security.web.authentication.ui. DefaultLoginPageGeneratingFilter@67cd84f9, org.springframework.security.web.authentication.ui. DefaultLogoutPageGeneratingFilter@4452e13c, org.springframework.security.web.authentication.www. BasicAuthenticationFilter@788d9139, org.springframework.security.web.savedrequest.RequestCacheAwareFilter@5c34b0f2, org.springframework.security.web.servletapi. SecurityContextHolderAwareRequestFilter@7dfec0bc, org.springframework.security.web.authentication. AnonymousAuthenticationFilter@4d964c9e, org.springframework.security.web.session.SessionManagementFilter@731fae, org.springframework.security.web.access.ExceptionTranslationFilter@66d61298, org.springframework.security.web.access.intercept.FilterSecurityInterceptor@55c20a91] 为了链接JwtFilter到另一组过滤器并排除保护令牌端点，让我们在类SecurityFilterChain中创建一个 bean SecurityConfiguration：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 @Bean public SecurityFilterChain configure (HttpSecurity http) throws Exception { return http.csrf().disable() .authorizeRequests() .antMatchers(\"/token/*\").permitAll() .anyRequest().authenticated().and() .sessionManagement(session -\u003e session.sessionCreationPolicy(SessionCreationPolicy.STATELESS)) .addFilterBefore(jwtFilter, UsernamePasswordAuthenticationFilter.class) .exceptionHandling(exception -\u003e exception.authenticationEntryPoint(jwtAuthenticationEntryPoint)) .build(); } 在此配置中，我们关注以下内容：\nantMatchers(\"/token/*\").permitAll() - 这将允许与模式匹配的 API 端点/token/*并将其从安全性中排除。 anyRequest().authenticated() - Spring Security 将保护所有其他 API 请求。 addFilterBefore(jwtFilter, UsernamePasswordAuthenticationFilter.class) - 这将在 FilterChainJwtFilter中将其连接起来。UsernamePasswordAuthenticationFilter exceptionHandling(exception -\u003e exception.authenticationEntryPoint(jwtAuthenticationEntryPoint) - 如果发生身份验证异常，JwtAuthenticationEntryPoint将调用类。在这里，我们创建了一个JwtAuthenticationEntryPoint实现的类，org.springframework.security.web.AuthenticationEntryPoint以便优雅地处理未经授权的错误。我们将在后面的部分中详细介绍如何处理异常。 完成这些更改后，让我们重新启动应用程序并检查日志：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 2024-05-22 16:13:07.803 INFO 16188 --- [ main] o.s.s.web.DefaultSecurityFilterChain : Will secure any request with [org.springframework.security.web.session.DisableEncodeUrlFilter@73e25780, org.springframework.security.web.context.request.async. WebAsyncManagerIntegrationFilter@1f4cb17b, org.springframework.security.web.context.SecurityContextPersistenceFilter@b548f51, org.springframework.security.web.header.HeaderWriterFilter@4f9980e1, org.springframework.security.web.authentication.logout.LogoutFilter@6b92a0d1, com.reflectoring.security.filter.JwtFilter@5961e92d, org.springframework.security.web.savedrequest.RequestCacheAwareFilter@56976b8b, org.springframework.security.web.servletapi. SecurityContextHolderAwareRequestFilter@74844216, org.springframework.security.web.authentication. AnonymousAuthenticationFilter@280099a0, org.springframework.security.web.session.SessionManagementFilter@144dc2f7, org.springframework.security.web.access.ExceptionTranslationFilter@7a0f43dc, org.springframework.security.web.access.intercept. FilterSecurityInterceptor@735167e1] 我们看到JwtFilter被链接起来，这表明基本身份验证现在已被基于令牌的身份验证所覆盖。现在，让我们再次尝试访问端点/token/create。我们看到端点现在能够成功返回生成的令牌：\n保护图书馆应用程序端点 现在，我们能够成功创建令牌，我们需要将此令牌传递给我们的库应用程序以成功调用/library/books/all。让我们添加一个带有生成的令牌值Authorization的类型的标头Bearer Token并触发请求。我们现在可以看到 200 OK 响应，如下所示：\n使用 JWT 处理异常 在本节中，我们将了解io.jsonwebtoken包中一些常见的异常：\nExpiredJwtException - JWT token 包含过期时间，解析 token 时，如果已经超过过期时间，则会抛出 ExpiredJwtException。 UnsupportedJwtException - 当收到的 JWT 格式不符合预期时，会抛出此异常。此错误最常见的用例是当我们尝试使用方法Jwts.parserBuilder().setSigningKey(jwtProperties.getSecretKey()) .build().parseClaimsJwt而不是Jwts.parserBuilder().setSigningKey(jwtProperties.getSecretKey()) .build().parseClaimsJws MalformedJwtException - 此异常表示 JWT 构造不正确。 IncorrectClaimException - 表示所需声明没有预期值。因此，JWT 无效。 MissingClaimException - 此异常表示 JWT 中缺少所需声明，因此无效。 通常，妥善处理与身份验证相关的异常被认为是一种很好的做法。在基本身份验证的情况下，Spring Security默认将添加BasicAuthenticationEntryPoint到安全过滤器链中，该过滤器链将基本身份验证相关错误包装为 401 Unauthorized。 同样，在我们的示例中，我们明确创建了JwtAuthenticationEntryPoint处理可能的身份验证错误，例如 Spring SecurityBadCredentialsException或 JJwt 的MalformedJwtException：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 @Component @Slf4j public class JwtAuthenticationEntryPoint implements AuthenticationEntryPoint { @Override public void commence(HttpServletRequest request, HttpServletResponse response, AuthenticationException authException) throws IOException, ServletException { Exception exception = (Exception) request.getAttribute(\"exception\"); response.setStatus(HttpServletResponse.SC_UNAUTHORIZED); response.setContentType(APPLICATION_JSON_VALUE); log.error(\"Authentication Exception: {} \", exception, exception); Map\u003cString, Object\u003e data = new HashMap\u003c\u003e(); data.put(\"message\", exception != null ? exception.getMessage() : authException.getCause().toString()); OutputStream out = response.getOutputStream(); ObjectMapper mapper = new ObjectMapper(); mapper.writeValue(out, data); out.flush(); } } 在我们的JwtFilter类中，我们将异常消息添加到HttpServletRequest exception属性中。这使我们能够使用request.getAttribute(\"exception\")它并将其写入输出流。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 public class JwtFilter extends OncePerRequestFilter { @Override protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain) throws ServletException, IOException { try { //validate token here } catch (ExpiredJwtException jwtException) { request.setAttribute(\"exception\", jwtException); } catch (BadCredentialsException | UnsupportedJwtException | MalformedJwtException e) { log.error(\"Filter exception: {}\", e.getMessage()); request.setAttribute(\"exception\", e); } filterChain.doFilter(request, response); } } 401 Unauthorized通过这些更改，我们现在可以看到包含以下异常的异常消息：\n但是，需要注意的是，JwtFilter只有通过 Spring Security 过滤器链保护的端点才会调用 。在我们的例子中，端点是/library/books/all。由于我们已经从 Spring Security 中排除了令牌端点/token/create，因此下面的异常处理JwtAuthenticationEntryPoint将不适用于此处。对于这种情况，我们将使用 Spring 的全局异常处理程序来处理异常。\n1 2 3 4 5 6 7 8 9 @ControllerAdvice public class GlobalExceptionHandler { @ExceptionHandler({BadCredentialsException.class}) public ResponseEntity\u003cObject\u003e handleBadCredentialsException(BadCredentialsException exception) { return ResponseEntity .status(HttpStatus.UNAUTHORIZED) .body(exception.getMessage()); } } 401 Unauthorized通过此异常处理，由于凭证不良而导致的异常现在将通过错误处理：\nSwagger 文档 在本节中，我们将了解如何为 JWT 配置 Open API。我们将添加以下 Maven 依赖项：\n1 2 3 4 5 org.springdoc springdoc-openapi-ui 1.7.0 接下来，让我们添加以下配置：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 @OpenAPIDefinition( info = @Info( title = \"Library application\", description = \"Get all library books\", version = \"1.0.0\", license = @License( name = \"Apache 2.0\", url = \"http://www.apache.org/licenses/LICENSE-2.0\" )), security = { @SecurityRequirement( name = \"bearerAuth\" ) } ) @SecurityScheme( name = \"bearerAuth\", description = \"JWT Authorization\", scheme = \"bearer\", type = SecuritySchemeType.HTTP, bearerFormat = \"JWT\", in = SecuritySchemeIn.HEADER ) public class OpenApiConfig { } 这里，使用一个或多个 来描述安全性@SecurityScheme。type此处定义的SecuritySchemeType.HTTP适用于基本身份验证和 JWT。其他属性（如 和scheme）bearerFormat依赖于此type属性。定义安全方案后，我们可以通过 security在根级别或操作级别添加 部分将它们应用于整个应用程序或单个操作。在我们的示例中，所有 API 操作都将使用 bearer token 身份验证方案。有关配置多个安全方案以及在 API 级别应用不同方案的更多信息，请参阅其文档。\n接下来，让我们向控制器类添加一些基本的 swagger 注释，以便为 API 操作添加描述。\n1 2 3 4 5 6 7 8 9 @RestController @Tag(name = \"Library Controller\", description = \"Get library books\") public class BookController { } @RestController @Tag(name = \"Create Token\", description = \"Create Token\") public class TokenController { } 此外，我们将使用以下属性来覆盖 Springdoc 的 Swagger-UI 加载的 URL。\n1 2 3 springdoc: swagger-ui: path: /swagger-ui 通过此配置，Swagger UI 现在可在http://localhost:8083/swagger-ui/index.html\n让我们尝试运行该应用程序并在上述 URL 处加载 Swagger 页面。当我们尝试访问端点时，我们会看到以下内容：\n这是因为应用程序中的所有端点都自动受到保护。我们需要一种方法来明确排除 swagger 端点不受保护。 我们可以通过在类中添加WebSecurityCustomizerbean 并排除 swagger 端点来实现这一点SecurityConfiguration。\n1 2 3 4 5 6 7 8 9 @Bean public WebSecurityCustomizer webSecurityCustomizer() { return web -\u003e web.ignoring().antMatchers( ArrayUtils.addAll(buildExemptedRoutes())); } private String[] buildExemptedRoutes() { return new String[] {\"/swagger-ui/**\",\"/v3/api-docs/**\"}; } 现在，当我们运行应用程序时，swagger 页面将按如下方式加载：\n由于我们只有一个安全方案，因此我们将 JWT 令牌添加到Authorizeswagger 页面顶部的按钮中：\n设置了承载令牌后，让我们尝试访问/library/books/all端点：\n这样，我们就成功地为我们的应用程序配置了 swagger 端点。\n添加 Spring Security 测试 在我们的示例中，我们需要编写测试来测试我们的令牌端点，并为我们的库应用程序编写另一个测试。\n让我们为测试添加一些必需的属性以及内存数据库来处理真实数据。测试application.yml：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 spring: security: user: name: libUser password: libPassword datasource: driver-class-name: org.hsqldb.jdbc.JDBCDriver url: jdbc:hsqldb:mem:testdb;DB_CLOSE_DELAY=-1 username: sa password: jwt: secretKey: 5JzoMbk6E5qIqHSuBTgeQCARtUsxAkBiHwdjXOSW8kWdXzYmP3X51C0 validity: 600000 接下来，让我们编写测试来验证我们的令牌端点：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 @SpringBootTest @AutoConfigureMockMvc public class TokenControllerTest { @Autowired private MockMvc mvc; @Test public void shouldNotAllowAccessToUnauthenticatedUsers() throws Exception { TokenRequest request = TokenRequest.builder() .username(\"testUser\") .password(\"testPassword\") .build(); mvc.perform(MockMvcRequestBuilders.post(\"/token/create\") .contentType(MediaType.APPLICATION_JSON) .content(new ObjectMapper().writeValueAsString(request))) .andExpect(status().isUnauthorized()); } @Test public void shouldGenerateAuthToken() throws Exception { TokenRequest request = TokenRequest.builder() .username(\"libUser\") .password(\"libPassword\") .build(); mvc.perform(MockMvcRequestBuilders.post(\"/token/create\") .contentType(MediaType.APPLICATION_JSON) .content(new ObjectMapper().writeValueAsString(request))) .andExpect(status().isOk()); } } 在这里，我们将用来@MockMvc验证我们的TokenController类端点在正面和负面场景中是否按预期工作。\n类似地，我们的BookControllerTest意愿是这样的：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 @SpringBootTest @AutoConfigureMockMvc @SqlGroup({ @Sql(value = \"classpath:init/first.sql\", executionPhase = BEFORE_TEST_METHOD), @Sql(value = \"classpath:init/second.sql\", executionPhase = BEFORE_TEST_METHOD) }) public class BookControllerTest { @Autowired private MockMvc mockMvc; @Test void failsAsBearerTokenNotSet() throws Exception { mockMvc.perform(get(\"/library/books/all\")) .andDo(print()) .andExpect(status().isUnauthorized()); } @Test void testWithValidBearerToken() throws Exception { TokenRequest request = TokenRequest.builder() .username(\"libUser\") .password(\"libPassword\") .build(); MvcResult mvcResult = mockMvc.perform( MockMvcRequestBuilders.post(\"/token/create\") .contentType(MediaType.APPLICATION_JSON) .content(new ObjectMapper().writeValueAsString(request))) .andExpect(status().isOk()).andReturn(); String resultStr = mvcResult.getResponse().getContentAsString(); TokenResponse token = new ObjectMapper().readValue( resultStr, TokenResponse.class); mockMvc.perform(get(\"/library/books/all\") .header(\"Authorization\", \"Bearer \" + token.getToken())) .andDo(print()) .andExpect(status().isOk()) .andExpect(jsonPath(\"$\", hasSize(5))); } @Test void testWithInvalidBearerToken() throws Exception { mockMvc.perform(get(\"/library/books/all\") .header(\"Authorization\", \"Bearer 123\")) .andDo(print()) .andExpect(status().isUnauthorized()); } } 为了测试应用程序端点，我们将使用 SpringMockMvc类并使用示例 SQL 脚本将数据加载到内存数据库中。为此，我们将使用注释@SqlGroup并将@Sql插入脚本放在/resources/init文件夹中。\n为了验证端点是否成功运行testWithValidBearerToken()，我们将首先/token/create 使用 调用端点MockMvc，从响应中提取令牌，并将令牌设置在下Authorization一次调用的标头中/library/books/all。\n结论 总而言之，在安全性方面，JWT 身份验证比 Spring 的基本身份验证领先一步。它是最受欢迎的身份验证和授权方式之一。在本文中，我们探讨了一些最佳实践、使用 JWT 的优势，并研究了如何配置一个简单的 Spring Boot 应用程序以使用 JWT 来确保安全性。\n原文链接：https://reflectoring.io/spring-security-jwt/\n","wordCount":"10410","inLanguage":"en","datePublished":"2024-10-15T00:00:00+08:00","dateModified":"2024-10-15T00:00:00+08:00","author":{"@type":"Person","name":"chensoul"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.chensoul.cc/posts/2024/10/15/spring-security-jwt/"},"publisher":{"@type":"Organization","name":"ChenSoul","logo":{"@type":"ImageObject","url":"https://blog.chensoul.cc/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://blog.chensoul.cc/ accesskey=h title="ChenSoul (Alt + H)">ChenSoul</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://blog.chensoul.cc/categories title=分类><span>分类</span></a></li><li><a href=https://blog.chensoul.cc/tags title=标签><span>标签</span></a></li><li><a href=https://blog.chensoul.cc/search title="搜索 (Alt + /)" accesskey=/><span>搜索</span></a></li><li><a href=https://blog.chensoul.cc/index.xml title=订阅><span>订阅</span></a></li><li><a href=https://github.com/chensoul title=关于><span>关于</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">[译]Spring Security 和 JWT 入门</h1><div class=post-meta><span title='2024-10-15 00:00:00 +0800 CST'>2024-10-15</span>&nbsp;·&nbsp;21 min&nbsp;·&nbsp;10410 words&nbsp;·&nbsp;chensoul</div></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%e7%a4%ba%e4%be%8b%e4%bb%a3%e7%a0%81 aria-label=示例代码>示例代码</a></li><li><a href=#%e4%bb%80%e4%b9%88%e6%98%af-jwt aria-label="什么是 JWT">什么是 JWT</a></li><li><a href=#jwt-%e7%bb%93%e6%9e%84 aria-label="JWT 结构">JWT 结构</a><ul><li><a href=#jwt-%e6%a0%87%e5%a4%b4 aria-label="JWT 标头">JWT 标头</a></li><li><a href=#jwt-%e6%9c%89%e6%95%88%e8%b4%9f%e8%bd%bd aria-label="JWT 有效负载">JWT 有效负载</a><ul><li><a href=#%e5%b7%b2%e7%99%bb%e8%ae%b0%e7%9a%84%e7%b4%a2%e8%b5%94 aria-label=已登记的索赔>已登记的索赔</a></li><li><a href=#%e5%85%ac%e5%bc%80%e5%a3%b0%e6%98%8e aria-label=公开声明>公开声明</a></li><li><a href=#%e7%a7%81%e4%ba%ba%e7%b4%a2%e8%b5%94 aria-label=私人索赔>私人索赔</a></li><li><a href=#jwt-%e5%a3%b0%e6%98%8e%e6%8e%a8%e8%8d%90%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5 aria-label="JWT 声明推荐最佳实践">JWT 声明推荐最佳实践</a></li></ul></li><li><a href=#jwt-%e7%ad%be%e5%90%8d aria-label="JWT 签名">JWT 签名</a></li></ul></li><li><a href=#jwt-%e7%9a%84%e5%b8%b8%e8%a7%81%e7%94%a8%e4%be%8b aria-label="JWT 的常见用例">JWT 的常见用例</a></li><li><a href=#%e4%bd%bf%e7%94%a8-jwt-%e7%9a%84%e6%b3%a8%e6%84%8f%e4%ba%8b%e9%a1%b9 aria-label="使用 JWT 的注意事项">使用 JWT 的注意事项</a></li><li><a href=#%e4%bd%bf%e7%94%a8-java-%e5%88%9b%e5%bb%ba-jwt-%e4%bb%a4%e7%89%8c aria-label="使用 Java 创建 JWT 令牌">使用 Java 创建 JWT 令牌</a><ul><li><a href=#%e9%85%8d%e7%bd%ae-jwt-%e4%be%9d%e8%b5%96%e9%a1%b9 aria-label="配置 JWT 依赖项">配置 JWT 依赖项</a></li><li><a href=#%e5%88%9b%e5%bb%ba-jwt-%e4%bb%a4%e7%89%8c aria-label="创建 JWT 令牌">创建 JWT 令牌</a></li><li><a href=#%e8%a7%a3%e6%9e%90-jwt-%e4%bb%a4%e7%89%8c aria-label="解析 JWT 令牌">解析 JWT 令牌</a></li><li><a href=#spring-security-%e4%b8%ad%e5%9f%ba%e6%9c%ac%e8%ba%ab%e4%bb%bd%e9%aa%8c%e8%af%81%e5%92%8c-jwt-%e7%9a%84%e6%af%94%e8%be%83 aria-label="Spring Security 中基本身份验证和 JWT 的比较">Spring Security 中基本身份验证和 JWT 的比较</a></li></ul></li><li><a href=#%e5%9c%a8-spring-boot-%e5%ba%94%e7%94%a8%e7%a8%8b%e5%ba%8f%e4%b8%ad%e5%ae%9e%e7%8e%b0-jwt aria-label="在 Spring Boot 应用程序中实现 JWT">在 Spring Boot 应用程序中实现 JWT</a><ul><li><a href=#%e6%8b%a6%e6%88%aa-jwt-%e7%9a%84-spring-security-%e8%bf%87%e6%bb%a4%e5%99%a8%e9%93%be aria-label="拦截 JWT 的 Spring Security 过滤器链">拦截 JWT 的 Spring Security 过滤器链</a></li><li><a href=#jwt-%e4%bb%a4%e7%89%8c%e5%88%9b%e5%bb%ba%e7%ab%af%e7%82%b9 aria-label="JWT 令牌创建端点">JWT 令牌创建端点</a></li><li><a href=#%e4%bf%9d%e6%8a%a4%e5%9b%be%e4%b9%a6%e9%a6%86%e5%ba%94%e7%94%a8%e7%a8%8b%e5%ba%8f%e7%ab%af%e7%82%b9 aria-label=保护图书馆应用程序端点>保护图书馆应用程序端点</a></li><li><a href=#%e4%bd%bf%e7%94%a8-jwt-%e5%a4%84%e7%90%86%e5%bc%82%e5%b8%b8 aria-label="使用 JWT 处理异常">使用 JWT 处理异常</a></li></ul></li><li><a href=#swagger-%e6%96%87%e6%a1%a3 aria-label="Swagger 文档">Swagger 文档</a></li><li><a href=#%e6%b7%bb%e5%8a%a0-spring-security-%e6%b5%8b%e8%af%95 aria-label="添加 Spring Security 测试">添加 Spring Security 测试</a></li><li><a href=#%e7%bb%93%e8%ae%ba aria-label=结论>结论</a></li></ul></div></details></div><div class=post-content><p><a href=https://docs.spring.io/spring-security/reference/index.html target=_blank>Spring Security</a> 为 Java 应用程序提供了一套全面的安全功能，涵盖身份验证、授权、会话管理以及针对<a href=https://reflectoring.io/spring-csrf/ target=_blank>CSRF（跨站点请求伪造）</a>等常见安全威胁的防护。Spring Security 框架具有高度可定制性，允许开发人员根据其应用程序需求来管理安全配置。它提供了一个灵活的架构，支持各种身份验证机制，如基本身份验证、JWT 和 OAuth。</p><p>Spring Security 提供了开箱即用的基本身份验证。要了解其工作原理，请参阅<a href=https://reflectoring.io/spring-security/ target=_blank>本文</a>。在本文中，我们将深入探讨 JWT 的工作原理以及如何使用 Spring Security 对其进行配置。</p><h2 id=示例代码>示例代码<a hidden class=anchor aria-hidden=true href=#示例代码>#</a></h2><p>本文附带了<a href=https://github.com/thombergs/code-examples/tree/master/spring-security-jwt/getting-started target=_blank>GitHub </a>可用的代码示例。</p><h2 id=什么是-jwt>什么是 JWT<a hidden class=anchor aria-hidden=true href=#什么是-jwt>#</a></h2><p>JWT（JSON Web Token）是一种在双方之间传递 JSON 消息的安全方式。它是<a href=https://www.rfc-editor.org/rfc/rfc7519 target=_blank>RFC 7519</a>中定义的标准。JWT 令牌中包含的信息可以验证和信任，因为它是经过数字签名的。可以使用密钥（使用 HMAC 算法）或使用 RSA 或 ECDSA 的公钥/私钥对对 JWT 进行签名。</p><p>对于本文，我们将使用密钥创建一个 JWT 令牌，并使用它来保护我们的 REST 端点。</p><h2 id=jwt-结构>JWT 结构<a hidden class=anchor aria-hidden=true href=#jwt-结构>#</a></h2><p>在本节中，我们将了解一个示例 JWT 结构。JSON Web Token 由三部分组成：</p><ul><li><strong>标头</strong></li><li><strong>有效载荷</strong></li><li><strong>签名</strong></li></ul><h3 id=jwt-标头>JWT 标头<a hidden class=anchor aria-hidden=true href=#jwt-标头>#</a></h3><p>标头由两部分组成：令牌的类型（即 JWT）和正在使用的签名算法（如 HMAC SHA 256 或 RSA）。示例 JSON 标头：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;alg&#34;</span><span class=p>:</span> <span class=s2>&#34;HS256&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;typ&#34;</span><span class=p>:</span> <span class=s2>&#34;JWT&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>然后对此 JSON 进行 Base64 编码，从而形成 JWT 令牌的第一部分。</p><h3 id=jwt-有效负载>JWT 有效负载<a hidden class=anchor aria-hidden=true href=#jwt-有效负载>#</a></h3><p>有效载荷是包含实际数据的主体。数据可以是用户数据或任何需要安全传输的信息。这些数据也称为<code>claims</code>。声明有三种类型：<strong>注册声明、公共声明和私有声明</strong>。</p><h4 id=已登记的索赔>已登记的索赔<a hidden class=anchor aria-hidden=true href=#已登记的索赔>#</a></h4><p>它们是一组预定义的三个字符声明，定义在<a href=https://datatracker.ietf.org/doc/html/rfc7519#section-4.1 target=_blank>RFC7519</a>中。一些常用的声明包括<strong>iss (Issuer Claim)</strong>、<strong>sub (Subject Claim)</strong>、<strong>aud (Audience Claim)</strong>、<strong>exp (Expiration Time Claim)</strong>、<strong>iat (Issued At Time)</strong>、<strong>nbf (Not Before)</strong>。让我们详细了解一下它们：</p><ul><li><strong>iss</strong>：此声明用于指定 JWT 的颁发者。它用于标识颁发令牌的实体，例如身份验证服务器或身份提供者。</li><li><strong>sub</strong>：此声明用于识别 JWT 的主题，即颁发令牌的用户或实体。</li><li><strong>aud</strong>：此声明用于指定 JWT 的目标受众。这通常用于限制令牌仅供某些服务或应用程序使用。</li><li><strong>exp</strong>：此声明用于指定 JWT 的过期时间，超过此时间后，令牌将不再有效。以自 Unix 纪元以来的秒数表示。</li><li><strong>iat</strong>：签发 JWT 的时间。可用于确定 JWT 的年龄。以自 Unix 纪元以来的秒数表示。</li><li><strong>nbf</strong>：标识在此之前 JWT 不能被接受处理的时间。</li></ul><p><a href=https://www.iana.org/assignments/jwt/jwt.xhtml#claims target=_blank>在此处</a>查看已注册声明的完整列表。在后续章节中，我们将介绍几个如何使用它们的示例。</p><h4 id=公开声明>公开声明<a hidden class=anchor aria-hidden=true href=#公开声明>#</a></h4><p>与已注册的、具有预定义含义的声明不同，这些声明可以根据应用程序的要求进行定制。大多数公开声明属于以下类别：</p><ul><li><strong>用户/客户端数据</strong>：包括用户名、客户端 ID、电子邮件、地址、角色、权限、范围、特权以及用于身份验证或授权的任何用户/客户端相关信息。</li><li><strong>应用程序数据</strong>：包括会话详细信息、用户偏好（例如语言偏好）、应用程序设置或任何应用程序特定的数据。</li><li><strong>安全信息</strong>：包括其他安全相关信息，如密钥、证书、令牌等。</li></ul><h4 id=私人索赔>私人索赔<a hidden class=anchor aria-hidden=true href=#私人索赔>#</a></h4><p>私有声明是特定于特定组织的自定义声明。它们不是由官方 JWT 规范标准化的，而是由参与 JWT 交换的各方定义的。</p><h4 id=jwt-声明推荐最佳实践>JWT 声明推荐最佳实践<a hidden class=anchor aria-hidden=true href=#jwt-声明推荐最佳实践>#</a></h4><ul><li>尽可能使用 JWT 规范中定义的标准声明。它们被广泛认可并且具有明确的含义。</li><li>为了获得更好的可维护性，JWT 有效负载应该仅具有所需的最少声明，并限制令牌大小。</li><li>公共声明应该具有清晰且描述性的名称。</li><li>遵循一致的命名约定以保持一致性和可读性。</li><li>避免包含 PII 信息以最大限度地降低数据泄露的风险。</li><li>确保使用注册声明中指定<a href=https://www.iana.org/assignments/jose/jose.xhtml#web-signature-encryption-algorithms target=_blank>的推荐算法</a>对 JWT 进行加密<code>alg</code>。声明<code>none</code>中的值<code>alg</code>表示 JWT 未签名且不推荐使用。</li></ul><h3 id=jwt-签名>JWT 签名<a hidden class=anchor aria-hidden=true href=#jwt-签名>#</a></h3><p>为了创建签名，我们对标头进行编码，对有效负载进行编码，并使用密钥通过标头中指定的算法对元素进行签名。 <strong>生成的令牌将具有三个以点分隔的 Base64 URL 字符串。JWT</strong> 的图示如下所示：</p><p><img loading=lazy src=https://reflectoring.io/images/posts/spring-security-and-jwt/jwt_hud9c35aacfe2ae4a6e437b6aaefa9a317_95751_1764x0_resize_box_3.png alt=设置></p><p>签名的目的是验证消息在传输过程中没有被更改。由于它们也使用密钥签名，因此可以验证 JWT 的发送者是否是其声称的那个人。</p><h2 id=jwt-的常见用例>JWT 的常见用例<a hidden class=anchor aria-hidden=true href=#jwt-的常见用例>#</a></h2><p>JWT 用途广泛，可用于如下所述的各种场景：</p><ul><li><strong>单点登录</strong>：JWT 允许跨多个服务或应用程序进行用户身份验证，从而实现单点登录 (SSO)。用户登录到一个应用程序后，会收到一个 JWT，该 JWT 可用于登录其他服务（用户有权访问），而无需输入/维护单独的登录凭据。</li><li><strong>API 身份验证</strong>：JWT 通常用于对 API 的访问进行身份验证和授权。客户端将 JWT 令牌包含在API 请求的<strong>授权</strong>标头中，以验证其对 API 的访问权限。然后，API 将解码 JWT 以授予或拒绝访问权限。</li><li><strong>无状态会话</strong>：JWT 有助于提供无状态会话管理，因为会话信息存储在令牌本身中。</li><li><strong>信息交换</strong>：由于 JWT 安全可靠，因此它们不仅可用于交换用户信息，还可用于交换任何需要在双方之间安全传输的信息。</li><li><strong>微服务</strong>：JWT 是微服务生态系统中最受欢迎的 API 通信方式之一，因为微服务可以独立验证令牌，而无需依赖外部身份验证服务器，从而更易于扩展。</li></ul><h2 id=使用-jwt-的注意事项>使用 JWT 的注意事项<a hidden class=anchor aria-hidden=true href=#使用-jwt-的注意事项>#</a></h2><p>现在我们了解了 JWT 提供的好处，让我们看看使用 JWT 的缺点。这里的想法是让开发人员权衡手头的选项，并做出在应用程序中使用基于令牌的架构的明智决定。</p><ul><li>在 JWT 取代会话的情况下，如果我们最终使用较大的有效负载，JWT 令牌可能会膨胀。最重要的是，如果我们添加加密签名，则会导致整体性能开销。对于存储简单的用户会话来说，这最终会变得过度。</li><li>JWT 会以一定的时间间隔过期，过期后需要刷新令牌并生成新的令牌。从安全角度来看，这很好，但过期时间需要仔细考虑。例如，24 小时的过期时间是一个糟糕的设计考虑。</li></ul><p>现在，我们已经了解了重点，我们将能够就如何以及何时使用 JWT 做出明智的决定。在下一节中，我们将用 Java 创建一个简单的 JWT 令牌。</p><h2 id=使用-java-创建-jwt-令牌>使用 Java 创建 JWT 令牌<a hidden class=anchor aria-hidden=true href=#使用-java-创建-jwt-令牌>#</a></h2><p><a href=https://github.com/jwtk/jjwt target=_blank>JJWT</a>是在 Java 和 Android 中创建 JWT 令牌最常用的 Java 库。我们将首先将其依赖项添加到我们的应用程序中。</p><h3 id=配置-jwt-依赖项>配置 JWT 依赖项<a hidden class=anchor aria-hidden=true href=#配置-jwt-依赖项>#</a></h3><p><em>Maven 依赖项：</em></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;groupId&gt;</span>io.jsonwebtoken<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;artifactId&gt;</span>jjwt-api<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;version&gt;</span>0.11.1<span class=nt>&lt;/version&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/dependency&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;groupId&gt;</span>io.jsonwebtoken<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;artifactId&gt;</span>jjwt-impl<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;version&gt;</span>0.11.1<span class=nt>&lt;/version&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;scope&gt;</span>runtime<span class=nt>&lt;/scope&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/dependency&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;groupId&gt;</span>io.jsonwebtoken<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;artifactId&gt;</span>jjwt-jackson<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;version&gt;</span>0.11.1<span class=nt>&lt;/version&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;scope&gt;</span>runtime<span class=nt>&lt;/scope&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p><em>Gradle 依赖性</em>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-groovy data-lang=groovy><span class=line><span class=cl><span class=n>compile</span> <span class=s1>&#39;io.jsonwebtoken:jjwt-api:0.11.1&#39;</span>
</span></span><span class=line><span class=cl><span class=n>runtime</span> <span class=s1>&#39;io.jsonwebtoken:jjwt-impl:0.11.1&#39;</span>
</span></span><span class=line><span class=cl><span class=n>runtime</span> <span class=s1>&#39;io.jsonwebtoken:jjwt-jackson:0.11.1&#39;</span>
</span></span></code></pre></td></tr></table></div></div><p>我们的 Java 应用程序基于 Maven，因此我们将上述 Maven 依赖项添加到我们的<em>pom.xml</em>中。</p><h3 id=创建-jwt-令牌>创建 JWT 令牌<a hidden class=anchor aria-hidden=true href=#创建-jwt-令牌>#</a></h3><p>我们将使用包<code>Jwts</code>中的类<code>io.jsonwebtoken</code>。我们可以指定声明（已注册和公开）和其他 JWT 属性，并创建一个令牌，如下所示：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>createJwt</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>Jwts</span><span class=p>.</span><span class=na>builder</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>claim</span><span class=p>(</span><span class=s>&#34;id&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;abc123&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>claim</span><span class=p>(</span><span class=s>&#34;role&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;admin&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=cm>/*.addClaims(Map.of(&#34;id&#34;, &#34;abc123&#34;,
</span></span></span><span class=line><span class=cl><span class=cm>                        &#34;role&#34;, &#34;admin&#34;))*/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>setIssuer</span><span class=p>(</span><span class=s>&#34;TestApplication&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>setIssuedAt</span><span class=p>(</span><span class=n>java</span><span class=p>.</span><span class=na>util</span><span class=p>.</span><span class=na>Date</span><span class=p>.</span><span class=na>from</span><span class=p>(</span><span class=n>Instant</span><span class=p>.</span><span class=na>now</span><span class=p>()))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>setExpiration</span><span class=p>(</span><span class=n>Date</span><span class=p>.</span><span class=na>from</span><span class=p>(</span><span class=n>Instant</span><span class=p>.</span><span class=na>now</span><span class=p>().</span><span class=na>plus</span><span class=p>(</span><span class=n>10</span><span class=p>,</span><span class=w> </span><span class=n>ChronoUnit</span><span class=p>.</span><span class=na>MINUTES</span><span class=p>)))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>compact</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span></code></pre></td></tr></table></div></div><p>此方法创建一个 JWT 令牌，如下所示：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>eyJhbGciOiJub25lIn0.eyJpZCI6ImFiYzEyMyIsInJvbGUiOiJhZG1pbiIsImlzcyI6IlR
</span></span><span class=line><span class=cl>lc3RBcHBsaWNhdGlvbiIsImlhdCI6MTcxMTY2MTA1MiwiZXhwIjoxNzExNjYxNjUyfQ.
</span></span></code></pre></td></tr></table></div></div><p>接下来我们看一下用于生成令牌的构建器方法：</p><ul><li><code>claim</code>：允许我们指定任意数量的自定义名称值对声明。我们还可以使用<code>addClaims</code>方法添加声明映射作为替代方案。</li><li><code>setIssuer</code>：此方法与已注册的权利要求相对应<code>iss</code>。</li><li><code>setIssuedAt</code>：此方法对应于已注册的声明<code>iat</code>。此方法以<code>java.util.Date</code>作为参数。这里我们将此值设置为当前时刻。</li><li><code>setExpiration</code>：此方法对应于已注册的声明<code>exp</code>。此方法以<code>java.util.Date</code>作为参数。这里我们将此值设置为从当前时刻开始的 10 分钟。</li></ul><p>让我们尝试使用在线<a href=https://jwt.is/ target=_blank>JWT 解码器</a>解码该 JWT ：</p><p><img loading=lazy src=https://reflectoring.io/images/posts/spring-security-and-jwt/JWTDecode_hu8d9d2bc8f2ead9221904f17a31fc7769_221082_2612x0_resize_box_3.png alt=设置></p><p>如果我们仔细查看标头，我们会看到<code>alg:none</code>。这是因为我们没有指定要使用的任何算法。正如我们之前看到的，建议我们使用算法来生成签名。</p><p>因此，让我们在我们的方法中使用<strong>HMAC SHA256 算法</strong>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>createJwt</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Recommended to be stored in Secret</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>secret</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;5JzoMbk6E5qIqHSuBTgeQCARtUsxAkBiHwdjXOSW8kWdXzYmP3X51C0&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Key</span><span class=w> </span><span class=n>hmacKey</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>SecretKeySpec</span><span class=p>(</span><span class=n>Base64</span><span class=p>.</span><span class=na>getDecoder</span><span class=p>().</span><span class=na>decode</span><span class=p>(</span><span class=n>secret</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>SignatureAlgorithm</span><span class=p>.</span><span class=na>HS256</span><span class=p>.</span><span class=na>getJcaName</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>Jwts</span><span class=p>.</span><span class=na>builder</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>claim</span><span class=p>(</span><span class=s>&#34;id&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;abc123&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>claim</span><span class=p>(</span><span class=s>&#34;role&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;admin&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>setIssuer</span><span class=p>(</span><span class=s>&#34;TestApplication&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>setIssuedAt</span><span class=p>(</span><span class=n>java</span><span class=p>.</span><span class=na>util</span><span class=p>.</span><span class=na>Date</span><span class=p>.</span><span class=na>from</span><span class=p>(</span><span class=n>Instant</span><span class=p>.</span><span class=na>now</span><span class=p>()))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>setExpiration</span><span class=p>(</span><span class=n>Date</span><span class=p>.</span><span class=na>from</span><span class=p>(</span><span class=n>Instant</span><span class=p>.</span><span class=na>now</span><span class=p>().</span><span class=na>plus</span><span class=p>(</span><span class=n>10</span><span class=p>,</span><span class=w> </span><span class=n>ChronoUnit</span><span class=p>.</span><span class=na>MINUTES</span><span class=p>)))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>signWith</span><span class=p>(</span><span class=n>hmacKey</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>compact</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>生成的令牌结果如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>eyJthbGciOiJIUzI1NiJ9.eyJpZCI6ImFiYzEyMyIsInJvbGUiOiJhZG1pbiIsImlz
</span></span><span class=line><span class=cl>cyI6IlRlc3RBcHBsaWNhdGlvbiIsImlhdCI6MTcxMjMyODQzMSwiZXhwIjoxNzEyMzI5MDMxfQ.
</span></span><span class=line><span class=cl>pj9AvbLtwITqBYazDnaTibCLecM-cQ5RAYw2YYtkyeA
</span></span></code></pre></td></tr></table></div></div><p>解码此 JWT 可得到：</p><p><img loading=lazy src=https://reflectoring.io/images/posts/spring-security-and-jwt/JWT2_hu645e117a2bef9bf7dd17103aeb398930_260858_2520x0_resize_box_3.png alt=设置></p><h3 id=解析-jwt-令牌>解析 JWT 令牌<a hidden class=anchor aria-hidden=true href=#解析-jwt-令牌>#</a></h3><p>现在我们已经创建了 JWT，让我们看看如何解析令牌以提取声明。只有当我们知道最初用于创建 JWT 的密钥时，我们才能解析令牌。以下代码可用于实现此目的：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>Jws</span><span class=o>&lt;</span><span class=n>Claims</span><span class=o>&gt;</span><span class=w> </span><span class=nf>parseJwt</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>jwtString</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Recommended to be stored in Secret</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>secret</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;5JzoMbk6E5qIqHSuBTgeQCARtUsxAkBiHwdjXOSW8kWdXzYmP3X51C0&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Key</span><span class=w> </span><span class=n>hmacKey</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>SecretKeySpec</span><span class=p>(</span><span class=n>Base64</span><span class=p>.</span><span class=na>getDecoder</span><span class=p>().</span><span class=na>decode</span><span class=p>(</span><span class=n>secret</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>SignatureAlgorithm</span><span class=p>.</span><span class=na>HS256</span><span class=p>.</span><span class=na>getJcaName</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Jws</span><span class=o>&lt;</span><span class=n>Claims</span><span class=o>&gt;</span><span class=w> </span><span class=n>jwt</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Jwts</span><span class=p>.</span><span class=na>parserBuilder</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>setSigningKey</span><span class=p>(</span><span class=n>hmacKey</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>build</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>parseClaimsJws</span><span class=p>(</span><span class=n>jwtString</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>jwt</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>这里，该方法<code>parseJwt</code>将 JWT 令牌作为字符串参数。使用相同的密钥（用于创建令牌），可以解析此令牌以检索声明。可以使用以下测试来验证这一点：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>testParseJwtClaims</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>jwtToken</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>JWTCreator</span><span class=p>.</span><span class=na>createJwt</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>assertNotNull</span><span class=p>(</span><span class=n>jwtToken</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Jws</span><span class=o>&lt;</span><span class=n>Claims</span><span class=o>&gt;</span><span class=w> </span><span class=n>claims</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>JWTCreator</span><span class=p>.</span><span class=na>parseJwt</span><span class=p>(</span><span class=n>jwtToken</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>assertNotNull</span><span class=p>(</span><span class=n>claims</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Assertions</span><span class=p>.</span><span class=na>assertAll</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>assertNotNull</span><span class=p>(</span><span class=n>claims</span><span class=p>.</span><span class=na>getSignature</span><span class=p>()),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>assertNotNull</span><span class=p>(</span><span class=n>claims</span><span class=p>.</span><span class=na>getHeader</span><span class=p>()),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>assertNotNull</span><span class=p>(</span><span class=n>claims</span><span class=p>.</span><span class=na>getBody</span><span class=p>()),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>assertEquals</span><span class=p>(</span><span class=n>claims</span><span class=p>.</span><span class=na>getHeader</span><span class=p>().</span><span class=na>getAlgorithm</span><span class=p>(),</span><span class=w> </span><span class=s>&#34;HS256&#34;</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>assertEquals</span><span class=p>(</span><span class=n>claims</span><span class=p>.</span><span class=na>getBody</span><span class=p>().</span><span class=na>get</span><span class=p>(</span><span class=s>&#34;id&#34;</span><span class=p>),</span><span class=w> </span><span class=s>&#34;abc123&#34;</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>assertEquals</span><span class=p>(</span><span class=n>claims</span><span class=p>.</span><span class=na>getBody</span><span class=p>().</span><span class=na>get</span><span class=p>(</span><span class=s>&#34;role&#34;</span><span class=p>),</span><span class=w> </span><span class=s>&#34;admin&#34;</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>assertEquals</span><span class=p>(</span><span class=n>claims</span><span class=p>.</span><span class=na>getBody</span><span class=p>().</span><span class=na>getIssuer</span><span class=p>(),</span><span class=w> </span><span class=s>&#34;TestApplication&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>有关可用解析方法的完整列表，请参阅<a href=https://javadoc.io/doc/io.jsonwebtoken/jjwt-api/0.11.2/io/jsonwebtoken/JwtParser.html target=_blank>文档</a>。</p><h3 id=spring-security-中基本身份验证和-jwt-的比较>Spring Security 中基本身份验证和 JWT 的比较<a hidden class=anchor aria-hidden=true href=#spring-security-中基本身份验证和-jwt-的比较>#</a></h3><p>在深入研究示例 Spring Boot 应用程序中 JWT 的实现之前，让我们先看看 BasicAuth 和 JWT 之间的几个比较点。</p><table><thead><tr><th style=text-align:left>比较依据</th><th style=text-align:left>基本身份验证</th><th style=text-align:left>智威汤逊</th></tr></thead><tbody><tr><td style=text-align:left><strong>授权标头</strong></td><td style=text-align:left>示例基本身份验证标头：<strong>授权：基本 xxx</strong>。</td><td style=text-align:left>示例 JWT 标头：<strong>授权：Bearer xxx</strong>。</td></tr><tr><td style=text-align:left><strong>有效期和到期日</strong></td><td style=text-align:left>基本身份验证凭据只需配置一次，每次请求都需要传递相同的凭据。它永不过期。</td><td style=text-align:left>使用 JWT 令牌，我们可以使用<code>exp</code>已注册的声明来设置有效性/到期时间，之后令牌将抛出一个<code>io.jsonwebtoken.ExpiredJwtException</code>。由于令牌有效期较短，这使得 JWT 更加安全。用户必须重新发送请求才能生成新令牌。</td></tr><tr><td style=text-align:left><strong>数据</strong></td><td style=text-align:left>基本身份验证仅用于处理凭证（通常是用户名-密码）。</td><td style=text-align:left>JWT 可以包含其他信息，例如 id、角色等。一旦签名被验证，服务器就可以信任客户端发送的数据，从而避免可能需要的任何额外查找。</td></tr></tbody></table><h2 id=在-spring-boot-应用程序中实现-jwt>在 Spring Boot 应用程序中实现 JWT<a hidden class=anchor aria-hidden=true href=#在-spring-boot-应用程序中实现-jwt>#</a></h2><p>现在我们更好地了解了 JWT，让我们在一个简单的 Spring Boot 应用程序中实现它。在我们的<em>pom.xml</em>中，让我们添加以下依赖项：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;groupId&gt;</span>org.springframework.boot<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;artifactId&gt;</span>spring-boot-starter-web<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/dependency&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;groupId&gt;</span>org.springframework.boot<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;artifactId&gt;</span>spring-boot-starter-security<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/dependency&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;groupId&gt;</span>io.jsonwebtoken<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;artifactId&gt;</span>jjwt-api<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;version&gt;</span>0.11.1<span class=nt>&lt;/version&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/dependency&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;groupId&gt;</span>io.jsonwebtoken<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;artifactId&gt;</span>jjwt-impl<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;version&gt;</span>0.11.1<span class=nt>&lt;/version&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;scope&gt;</span>runtime<span class=nt>&lt;/scope&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/dependency&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;groupId&gt;</span>io.jsonwebtoken<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;artifactId&gt;</span>jjwt-jackson<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;version&gt;</span>0.11.1<span class=nt>&lt;/version&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;scope&gt;</span>runtime<span class=nt>&lt;/scope&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>我们创建了一个简单的 Spring Boot Library 应用程序，该应用程序使用内存中的 H2 数据库来存储数据。该应用程序配置为在端口 8083 上运行。要运行该应用程序：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>mvnw clean verify spring-boot:run (for Windows)
</span></span><span class=line><span class=cl>./mvnw clean verify spring-boot:run (for Linux)
</span></span></code></pre></td></tr></table></div></div><h3 id=拦截-jwt-的-spring-security-过滤器链>拦截 JWT 的 Spring Security 过滤器链<a hidden class=anchor aria-hidden=true href=#拦截-jwt-的-spring-security-过滤器链>#</a></h3><p>该应用程序有一个 REST 端点<code>/library/books/all</code>，用于获取数据库中存储的所有书籍。如果我们通过 Postman 进行此 GET 调用，则会收到<code>401 UnAuthorized</code>错误：</p><p><img loading=lazy src=https://reflectoring.io/images/posts/spring-security-and-jwt/Postman401_hufa447b544662314047da7769a64981af_119970_2335x0_resize_box_3.png alt=设置></p><p>这是因为，我们在pom.xml中添加的依赖项会自动为所有创建的端点引入基本身份验证。<code>spring-boot-starter-security 由于我们没有在 Postman 中指定任何凭据，因此我们收到</code>UnAuthorized<code>错误。就本文而言，我们需要用基于 JWT 的身份验证替换基本身份验证。我们知道 Spring 通过触发处理每个请求的身份验证和授权的过滤器链来为我们的端点提供安全性。[</code>UsernamePasswordAuthenticationFilter<code>](https://docs.spring.io/spring-security/site/docs/current/api/org/springframework/security/web/authentication/UsernamePasswordAuthenticationFilter.html)负责验证每个请求的凭据。为了覆盖此过滤器，让我们创建一个</code>Filter<code>名为的新过滤器</code>JwtFilter<code>。此过滤器将扩展</code>OncePerRequestFilter`类，因为我们希望每个请求仅调用一次过滤器：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Component</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Slf4j</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>JwtFilter</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>OncePerRequestFilter</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>AuthUserDetailsService</span><span class=w> </span><span class=n>userDetailsService</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>JwtHelper</span><span class=w> </span><span class=n>jwtHelper</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>JwtFilter</span><span class=p>(</span><span class=n>AuthUserDetailsService</span><span class=w> </span><span class=n>userDetailsService</span><span class=p>,</span><span class=w> </span><span class=n>JwtHelper</span><span class=w> </span><span class=n>jwtHelper</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>userDetailsService</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>userDetailsService</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>jwtHelper</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>jwtHelper</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>doFilterInternal</span><span class=p>(</span><span class=n>HttpServletRequest</span><span class=w> </span><span class=n>request</span><span class=p>,</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>                                    </span><span class=n>HttpServletResponse</span><span class=w> </span><span class=n>response</span><span class=p>,</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>                                    </span><span class=n>FilterChain</span><span class=w> </span><span class=n>filterChain</span><span class=p>)</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>throws</span><span class=w> </span><span class=n>ServletException</span><span class=p>,</span><span class=w> </span><span class=n>IOException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;Inside JWT filter&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Code to validate the Authorization header</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>该类<code>JwtHelper</code>负责创建和验证 token。我们先看看如何创建 token：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>createToken</span><span class=p>(</span><span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=n>claims</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>subject</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Date</span><span class=w> </span><span class=n>expiryDate</span><span class=w> </span><span class=o>=</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Date</span><span class=p>.</span><span class=na>from</span><span class=p>(</span><span class=n>Instant</span><span class=p>.</span><span class=na>ofEpochMilli</span><span class=p>(</span><span class=n>System</span><span class=p>.</span><span class=na>currentTimeMillis</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>jwtProperties</span><span class=p>.</span><span class=na>getValidity</span><span class=p>()));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Key</span><span class=w> </span><span class=n>hmacKey</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>SecretKeySpec</span><span class=p>(</span><span class=n>Base64</span><span class=p>.</span><span class=na>getDecoder</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>decode</span><span class=p>(</span><span class=n>jwtProperties</span><span class=p>.</span><span class=na>getSecretKey</span><span class=p>()),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>SignatureAlgorithm</span><span class=p>.</span><span class=na>HS256</span><span class=p>.</span><span class=na>getJcaName</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>Jwts</span><span class=p>.</span><span class=na>builder</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>setClaims</span><span class=p>(</span><span class=n>claims</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>setSubject</span><span class=p>(</span><span class=n>subject</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>setIssuedAt</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Date</span><span class=p>(</span><span class=n>System</span><span class=p>.</span><span class=na>currentTimeMillis</span><span class=p>()))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>setExpiration</span><span class=p>(</span><span class=n>expiryDate</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>signWith</span><span class=p>(</span><span class=n>hmacKey</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>compact</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>以下参数负责创建令牌：</p><ul><li><code>claims</code>指的是空映射。此示例尚未定义任何用户特定的声明。</li><li><code>subject</code>指的是用户在调用 API 创建 token 时传递的用户名。</li><li><code>expiryDate</code>指的是在当前日期上添加“x”毫秒后的日期。“x”的值在属性中定义<code>jwt.validity</code>。</li><li><code>hmacKey</code>指的是<code>jva.security.Key</code>用于签署 JWT 请求的对象。对于此示例，使用的密钥在属性中定义<code>jwt.secretKey</code>，并<code>HS256</code>使用算法。</li></ul><p>此方法返回一个字符串 token，每次请求时都需要传递给它<code>Authorization header</code>。现在我们已经创建了一个 token，让我们看看类<code>doFilterInternal</code>中的方法<code>JwtFilter</code>，并了解这个类的职责<code>Filter</code>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>protected</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>doFilterInternal</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>HttpServletRequest</span><span class=w> </span><span class=n>request</span><span class=p>,</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>HttpServletResponse</span><span class=w> </span><span class=n>response</span><span class=p>,</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>FilterChain</span><span class=w> </span><span class=n>filterChain</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>ServletException</span><span class=p>,</span><span class=w> </span><span class=n>IOException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=kd>final</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>authorizationHeader</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>request</span><span class=p>.</span><span class=na>getHeader</span><span class=p>(</span><span class=n>AUTHORIZATION</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>String</span><span class=w> </span><span class=n>jwt</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>String</span><span class=w> </span><span class=n>username</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>Objects</span><span class=p>.</span><span class=na>nonNull</span><span class=p>(</span><span class=n>authorizationHeader</span><span class=p>)</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=n>authorizationHeader</span><span class=p>.</span><span class=na>startsWith</span><span class=p>(</span><span class=s>&#34;Bearer &#34;</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=n>jwt</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>authorizationHeader</span><span class=p>.</span><span class=na>substring</span><span class=p>(</span><span class=n>7</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=n>username</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>jwtHelper</span><span class=p>.</span><span class=na>extractUsername</span><span class=p>(</span><span class=n>jwt</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>Objects</span><span class=p>.</span><span class=na>nonNull</span><span class=p>(</span><span class=n>username</span><span class=p>)</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=n>SecurityContextHolder</span><span class=p>.</span><span class=na>getContext</span><span class=p>().</span><span class=na>getAuthentication</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=n>UserDetails</span><span class=w> </span><span class=n>userDetails</span><span class=w> </span><span class=o>=</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=k>this</span><span class=p>.</span><span class=na>userDetailsService</span><span class=p>.</span><span class=na>loadUserByUsername</span><span class=p>(</span><span class=n>username</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=kt>boolean</span><span class=w> </span><span class=n>isTokenValidated</span><span class=w> </span><span class=o>=</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=n>jwtHelper</span><span class=p>.</span><span class=na>validateToken</span><span class=p>(</span><span class=n>jwt</span><span class=p>,</span><span class=w> </span><span class=n>userDetails</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>isTokenValidated</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=n>UsernamePasswordAuthenticationToken</span><span class=w> </span><span class=n>usernamePasswordAuthenticationToken</span><span class=w> </span><span class=o>=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                      </span><span class=k>new</span><span class=w> </span><span class=n>UsernamePasswordAuthenticationToken</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                  </span><span class=n>userDetails</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=n>userDetails</span><span class=p>.</span><span class=na>getAuthorities</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=n>usernamePasswordAuthenticationToken</span><span class=p>.</span><span class=na>setDetails</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                      </span><span class=k>new</span><span class=w> </span><span class=n>WebAuthenticationDetailsSource</span><span class=p>().</span><span class=na>buildDetails</span><span class=p>(</span><span class=n>request</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=n>SecurityContextHolder</span><span class=p>.</span><span class=na>getContext</span><span class=p>().</span><span class=na>setAuthentication</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                      </span><span class=n>usernamePasswordAuthenticationToken</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>filterChain</span><span class=p>.</span><span class=na>doFilter</span><span class=p>(</span><span class=n>request</span><span class=p>,</span><span class=w> </span><span class=n>response</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>步骤1。读取<code>Authorization</code>标头并提取 JWT 字符串。</p><p>步骤2。解析 JWT 字符串并提取用户名。我们为此使用该<code>io.jsonwebtoken</code>库。如下所示：<code>Jwts.parseBuilder()、jwtHelper.extractUsername()</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>extractUsername</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>bearerToken</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>extractClaimBody</span><span class=p>(</span><span class=n>bearerToken</span><span class=p>,</span><span class=w> </span><span class=n>Claims</span><span class=p>::</span><span class=n>getSubject</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=n>T</span><span class=w> </span><span class=nf>extractClaimBody</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>bearerToken</span><span class=p>,</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Function</span><span class=o>&lt;</span><span class=n>Claims</span><span class=p>,</span><span class=w> </span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=n>claimsResolver</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Jws</span><span class=o>&lt;</span><span class=n>Claims</span><span class=o>&gt;</span><span class=w> </span><span class=n>jwsClaims</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>extractClaims</span><span class=p>(</span><span class=n>bearerToken</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>claimsResolver</span><span class=p>.</span><span class=na>apply</span><span class=p>(</span><span class=n>jwsClaims</span><span class=p>.</span><span class=na>getBody</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=n>Jws</span><span class=o>&lt;</span><span class=n>Claims</span><span class=o>&gt;</span><span class=w> </span><span class=nf>extractClaims</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>bearerToken</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>Jwts</span><span class=p>.</span><span class=na>parserBuilder</span><span class=p>().</span><span class=na>setSigningKey</span><span class=p>(</span><span class=n>jwtProperties</span><span class=p>.</span><span class=na>getSecretKey</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>build</span><span class=p>().</span><span class=na>parseClaimsJws</span><span class=p>(</span><span class=n>bearerToken</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>步骤 3。提取用户名后，我们将使用 验证<code>Authentication</code>对象是否有效，即是否有登录用户<code>SecurityContextHolder.getContext().getAuthentication()</code>。如果没有，我们将使用 Spring Security<code>UserDetailsService</code>加载<code>UserDetails</code>对象。对于此示例，我们创建了<code>AuthUserDetailsService</code>返回对象的类<code>UserDetails</code>。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>AuthUserDetailsService</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>UserDetailsService</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>UserProperties</span><span class=w> </span><span class=n>userProperties</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>AuthUserDetailsService</span><span class=p>(</span><span class=n>UserProperties</span><span class=w> </span><span class=n>userProperties</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>userProperties</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>userProperties</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>UserDetails</span><span class=w> </span><span class=nf>loadUserByUsername</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>username</span><span class=p>)</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>throws</span><span class=w> </span><span class=n>UsernameNotFoundException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>StringUtils</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>(</span><span class=n>username</span><span class=p>)</span><span class=w> </span><span class=o>||</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=o>!</span><span class=n>username</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>userProperties</span><span class=p>.</span><span class=na>getName</span><span class=p>()))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>UsernameNotFoundException</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>String</span><span class=p>.</span><span class=na>format</span><span class=p>(</span><span class=s>&#34;User not found, or unauthorized %s&#34;</span><span class=p>,</span><span class=w> </span><span class=n>username</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>User</span><span class=p>(</span><span class=n>userProperties</span><span class=p>.</span><span class=na>getName</span><span class=p>(),</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>userProperties</span><span class=p>.</span><span class=na>getPassword</span><span class=p>(),</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>下面的用户名和密码<code>UserProperties</code>是从<code>application.yml</code>以下位置加载的：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>spring</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>security</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>user</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>libUser</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>password</span><span class=p>:</span><span class=w> </span><span class=l>libPassword</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>步骤4。接下来，<code>JwtFilter</code>调用<code>jwtHelper.validateToken()</code>来验证提取的用户名并确保jwt令牌尚未过期。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>validateToken</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>token</span><span class=p>,</span><span class=w> </span><span class=n>UserDetails</span><span class=w> </span><span class=n>userDetails</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>final</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>userName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>extractUsername</span><span class=p>(</span><span class=n>token</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>return</span><span class=w> </span><span class=n>userName</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>userDetails</span><span class=p>.</span><span class=na>getUsername</span><span class=p>())</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>!</span><span class=n>isTokenExpired</span><span class=p>(</span><span class=n>token</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=n>Boolean</span><span class=w> </span><span class=nf>isTokenExpired</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>bearerToken</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>return</span><span class=w> </span><span class=n>extractExpiry</span><span class=p>(</span><span class=n>bearerToken</span><span class=p>).</span><span class=na>before</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Date</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=n>Date</span><span class=w> </span><span class=nf>extractExpiry</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>bearerToken</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>return</span><span class=w> </span><span class=n>extractClaimBody</span><span class=p>(</span><span class=n>bearerToken</span><span class=p>,</span><span class=w> </span><span class=n>Claims</span><span class=p>::</span><span class=n>getExpiration</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>步骤 5。一旦令牌被验证，我们就创建一个对象实例。在这里，创建<code>Authentication</code>对象对象（它是接口的一个实现）并将其设置为。这表明用户现在已通过身份验证。<code>SecurityContextHolder.getContext().setAuthentication(usernamePasswordAuthenticationToken)</code></p><p>步骤6。最后，我们调用<code>filterChain.doFilter(request, response)</code>以便在中调用下一个过滤器<code>FilterChain</code>。</p><p>这样，我们就成功创建了一个过滤器类来验证令牌。我们将在后续章节中讨论异常处理。</p><h3 id=jwt-令牌创建端点>JWT 令牌创建端点<a hidden class=anchor aria-hidden=true href=#jwt-令牌创建端点>#</a></h3><p><code>Authorization</code>在本节中，我们将创建一个 Controller 类来创建一个端点，这将允许我们创建一个 JWT 令牌字符串。当我们调用 Library 应用程序时，此令牌将在标头中设置。让我们创建一个<code>TokenController</code>类：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@RestController</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>TokenController</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>TokenService</span><span class=w> </span><span class=n>tokenService</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>TokenController</span><span class=p>(</span><span class=n>TokenService</span><span class=w> </span><span class=n>tokenService</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>tokenService</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tokenService</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@PostMapping</span><span class=p>(</span><span class=s>&#34;/token/create&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>TokenResponse</span><span class=w> </span><span class=nf>createToken</span><span class=p>(</span><span class=nd>@RequestBody</span><span class=w> </span><span class=n>TokenRequest</span><span class=w> </span><span class=n>tokenRequest</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>tokenService</span><span class=p>.</span><span class=na>generateToken</span><span class=p>(</span><span class=n>tokenRequest</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>请求主体<code>TokenRequest</code>类将接受用户名和密码：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@NoArgsConstructor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@AllArgsConstructor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Builder</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>TokenRequest</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>username</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>password</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>该类<code>TokenService</code>负责验证请求主体中传递的凭据并<code>jwtHelper.createToken()</code>按照上一节中的定义进行调用。为了验证凭据，我们需要实现一个<code>AuthenticationManager</code>。让我们创建一个<code>SecurityConfiguration</code>类来定义所有与 Spring 安全相关的配置。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Configuration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@EnableWebSecurity</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>SecurityConfiguration</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>JwtFilter</span><span class=w> </span><span class=n>jwtFilter</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>AuthUserDetailsService</span><span class=w> </span><span class=n>authUserDetailsService</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>JwtAuthenticationEntryPoint</span><span class=w> </span><span class=n>jwtAuthenticationEntryPoint</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>SecurityConfiguration</span><span class=p>(</span><span class=n>JwtFilter</span><span class=w> </span><span class=n>jwtFilter</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                 </span><span class=n>AuthUserDetailsService</span><span class=w> </span><span class=n>authUserDetailsService</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                 </span><span class=n>JwtAuthenticationEntryPoint</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>                                             </span><span class=n>jwtAuthenticationEntryPoint</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>jwtFilter</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>jwtFilter</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>authUserDetailsService</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>authUserDetailsService</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>jwtAuthenticationEntryPoint</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>jwtAuthenticationEntryPoint</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>DaoAuthenticationProvider</span><span class=w> </span><span class=nf>authenticationProvider</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=n>DaoAuthenticationProvider</span><span class=w> </span><span class=n>daoAuthenticationProvider</span><span class=w> </span><span class=o>=</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>new</span><span class=w> </span><span class=n>DaoAuthenticationProvider</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>daoAuthenticationProvider</span><span class=p>.</span><span class=na>setUserDetailsService</span><span class=p>(</span><span class=n>authUserDetailsService</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>daoAuthenticationProvider</span><span class=p>.</span><span class=na>setPasswordEncoder</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>PlainTextPasswordEncoder</span><span class=p>.</span><span class=na>getInstance</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>daoAuthenticationProvider</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>AuthenticationManager</span><span class=w> </span><span class=nf>authenticationManager</span><span class=p>(</span><span class=n>HttpSecurity</span><span class=w> </span><span class=n>httpSecurity</span><span class=p>)</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>httpSecurity</span><span class=p>.</span><span class=na>getSharedObject</span><span class=p>(</span><span class=n>AuthenticationManagerBuilder</span><span class=p>.</span><span class=na>class</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>authenticationProvider</span><span class=p>(</span><span class=n>authenticationProvider</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>build</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>使用<code>AuthenticationManager</code>，<code>AuthUserDetailsService</code>它使用<code>spring.security.user</code>属性。现在我们已经有了<code>AuthenticationManager</code>，让我们看看 是如何<code>TokenService</code>定义的：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>TokenService</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>AuthenticationManager</span><span class=w> </span><span class=n>authenticationManager</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>AuthUserDetailsService</span><span class=w> </span><span class=n>userDetailsService</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>JwtHelper</span><span class=w> </span><span class=n>jwtHelper</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>TokenService</span><span class=p>(</span><span class=n>AuthenticationManager</span><span class=w> </span><span class=n>authenticationManager</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>AuthUserDetailsService</span><span class=w> </span><span class=n>userDetailsService</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>JwtHelper</span><span class=w> </span><span class=n>jwtHelper</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>authenticationManager</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>authenticationManager</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>userDetailsService</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>userDetailsService</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>jwtHelper</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>jwtHelper</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>TokenResponse</span><span class=w> </span><span class=nf>generateToken</span><span class=p>(</span><span class=n>TokenRequest</span><span class=w> </span><span class=n>tokenRequest</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>authenticationManager</span><span class=p>.</span><span class=na>authenticate</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>new</span><span class=w> </span><span class=n>UsernamePasswordAuthenticationToken</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>tokenRequest</span><span class=p>.</span><span class=na>getUsername</span><span class=p>(),</span><span class=w> </span><span class=n>tokenRequest</span><span class=p>.</span><span class=na>getPassword</span><span class=p>()));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=n>UserDetails</span><span class=w> </span><span class=n>userDetails</span><span class=w> </span><span class=o>=</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>userDetailsService</span><span class=p>.</span><span class=na>loadUserByUsername</span><span class=p>(</span><span class=n>tokenRequest</span><span class=p>.</span><span class=na>getUsername</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>token</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>jwtHelper</span><span class=p>.</span><span class=na>createToken</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Collections</span><span class=p>.</span><span class=na>emptyMap</span><span class=p>(),</span><span class=w> </span><span class=n>userDetails</span><span class=p>.</span><span class=na>getUsername</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>TokenResponse</span><span class=p>.</span><span class=na>builder</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>token</span><span class=p>(</span><span class=n>token</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>build</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><code>TokenResponse</code>是包含标记字符串的 Response 对象：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@NoArgsConstructor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@AllArgsConstructor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Builder</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>TokenResponse</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>token</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>现在创建了 API，让我们启动应用程序并尝试使用 Postman 访问端点。我们看到<code>401 Unauthorized</code>以下错误：</p><p><img loading=lazy src=https://reflectoring.io/images/posts/spring-security-and-jwt/PostmanToken-401_hu34e783643ac6895f604d258284e9b4f6_108604_2040x0_resize_box_3.png alt=设置></p><p>原因和我们之前遇到的一样。Spring Security 默认保护所有端点。我们需要一种方法来仅排除令牌端点的保护。此外，在启动日志中我们可以看到，虽然我们已经定义<code>JwtFilter</code>并且我们期望此过滤器覆盖<code>UsernamePasswordAuthenticationFilter</code>，但我们没有看到此过滤器连接到安全链中，如下所示：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>2024-05-22 15:41:09.441  INFO 20432 --- [           main] 
</span></span><span class=line><span class=cl>o.s.s.web.DefaultSecurityFilterChain     : 
</span></span><span class=line><span class=cl>Will secure any request with 
</span></span><span class=line><span class=cl>    [org.springframework.security.web.session.DisableEncodeUrlFilter@14d36bb2, 
</span></span><span class=line><span class=cl>org.springframework.security.web.context.request.async.
</span></span><span class=line><span class=cl>    WebAsyncManagerIntegrationFilter@432448, 
</span></span><span class=line><span class=cl>org.springframework.security.web.context.SecurityContextPersistenceFilter@54d46c8, 
</span></span><span class=line><span class=cl>org.springframework.security.web.header.HeaderWriterFilter@c7cf8c4, 
</span></span><span class=line><span class=cl>org.springframework.security.web.csrf.CsrfFilter@17fb5184, 
</span></span><span class=line><span class=cl>org.springframework.security.web.authentication.logout.LogoutFilter@42fa5cb, 
</span></span><span class=line><span class=cl>org.springframework.security.web.authentication.
</span></span><span class=line><span class=cl>    UsernamePasswordAuthenticationFilter@70d7a49b, 
</span></span><span class=line><span class=cl>org.springframework.security.web.authentication.ui.
</span></span><span class=line><span class=cl>    DefaultLoginPageGeneratingFilter@67cd84f9, 
</span></span><span class=line><span class=cl>org.springframework.security.web.authentication.ui.
</span></span><span class=line><span class=cl>    DefaultLogoutPageGeneratingFilter@4452e13c, 
</span></span><span class=line><span class=cl>org.springframework.security.web.authentication.www.
</span></span><span class=line><span class=cl>    BasicAuthenticationFilter@788d9139, 
</span></span><span class=line><span class=cl>org.springframework.security.web.savedrequest.RequestCacheAwareFilter@5c34b0f2, 
</span></span><span class=line><span class=cl>org.springframework.security.web.servletapi.
</span></span><span class=line><span class=cl>    SecurityContextHolderAwareRequestFilter@7dfec0bc, 
</span></span><span class=line><span class=cl>org.springframework.security.web.authentication.
</span></span><span class=line><span class=cl>    AnonymousAuthenticationFilter@4d964c9e, 
</span></span><span class=line><span class=cl>org.springframework.security.web.session.SessionManagementFilter@731fae, 
</span></span><span class=line><span class=cl>org.springframework.security.web.access.ExceptionTranslationFilter@66d61298, 
</span></span><span class=line><span class=cl>org.springframework.security.web.access.intercept.FilterSecurityInterceptor@55c20a91]
</span></span></code></pre></td></tr></table></div></div><p>为了链接<code>JwtFilter</code>到另一组过滤器并排除保护令牌端点，让我们在类<code>SecurityFilterChain</code>中创建一个 bean <code>SecurityConfiguration</code>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>SecurityFilterChain</span><span class=w> </span><span class=nf>configure</span><span class=w> </span><span class=p>(</span><span class=n>HttpSecurity</span><span class=w> </span><span class=n>http</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>http</span><span class=p>.</span><span class=na>csrf</span><span class=p>().</span><span class=na>disable</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>authorizeRequests</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>antMatchers</span><span class=p>(</span><span class=s>&#34;/token/*&#34;</span><span class=p>).</span><span class=na>permitAll</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>anyRequest</span><span class=p>().</span><span class=na>authenticated</span><span class=p>().</span><span class=na>and</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>sessionManagement</span><span class=p>(</span><span class=n>session</span><span class=w> </span><span class=o>-&gt;</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>session</span><span class=p>.</span><span class=na>sessionCreationPolicy</span><span class=p>(</span><span class=n>SessionCreationPolicy</span><span class=p>.</span><span class=na>STATELESS</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>addFilterBefore</span><span class=p>(</span><span class=n>jwtFilter</span><span class=p>,</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>UsernamePasswordAuthenticationFilter</span><span class=p>.</span><span class=na>class</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>exceptionHandling</span><span class=p>(</span><span class=n>exception</span><span class=w> </span><span class=o>-&gt;</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>exception</span><span class=p>.</span><span class=na>authenticationEntryPoint</span><span class=p>(</span><span class=n>jwtAuthenticationEntryPoint</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>build</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>在此配置中，我们关注以下内容：</p><ul><li><strong>antMatchers("/token/*").permitAll()</strong> - 这将允许与模式匹配的 API 端点<code>/token/*</code>并将其从安全性中排除。</li><li><strong>anyRequest().authenticated()</strong> - Spring Security 将保护所有其他 API 请求。</li><li><strong>addFilterBefore(jwtFilter, UsernamePasswordAuthenticationFilter.class)</strong> - 这将在 FilterChain<code>JwtFilter</code>中将其连接起来。<code>UsernamePasswordAuthenticationFilter</code></li><li><strong>exceptionHandling(exception -> exception.authenticationEntryPoint(jwtAuthenticationEntryPoint)</strong> - 如果发生身份验证异常，<code>JwtAuthenticationEntryPoint</code>将调用类。在这里，我们创建了一个<code>JwtAuthenticationEntryPoint</code>实现的类，<code>org.springframework.security.web.AuthenticationEntryPoint</code>以便优雅地处理未经授权的错误。我们将在后面的部分中详细介绍如何处理异常。</li></ul><p>完成这些更改后，让我们重新启动应用程序并检查日志：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>2024-05-22 16:13:07.803  INFO 16188 --- [           main] 
</span></span><span class=line><span class=cl>o.s.s.web.DefaultSecurityFilterChain     : Will secure any request with 
</span></span><span class=line><span class=cl>[org.springframework.security.web.session.DisableEncodeUrlFilter@73e25780, 
</span></span><span class=line><span class=cl>org.springframework.security.web.context.request.async.
</span></span><span class=line><span class=cl>    WebAsyncManagerIntegrationFilter@1f4cb17b, 
</span></span><span class=line><span class=cl>org.springframework.security.web.context.SecurityContextPersistenceFilter@b548f51, 
</span></span><span class=line><span class=cl>org.springframework.security.web.header.HeaderWriterFilter@4f9980e1, 
</span></span><span class=line><span class=cl>org.springframework.security.web.authentication.logout.LogoutFilter@6b92a0d1, 
</span></span><span class=line><span class=cl>com.reflectoring.security.filter.JwtFilter@5961e92d, 
</span></span><span class=line><span class=cl>org.springframework.security.web.savedrequest.RequestCacheAwareFilter@56976b8b, 
</span></span><span class=line><span class=cl>org.springframework.security.web.servletapi.
</span></span><span class=line><span class=cl>    SecurityContextHolderAwareRequestFilter@74844216, 
</span></span><span class=line><span class=cl>org.springframework.security.web.authentication.
</span></span><span class=line><span class=cl>    AnonymousAuthenticationFilter@280099a0, 
</span></span><span class=line><span class=cl>org.springframework.security.web.session.SessionManagementFilter@144dc2f7, 
</span></span><span class=line><span class=cl>org.springframework.security.web.access.ExceptionTranslationFilter@7a0f43dc, 
</span></span><span class=line><span class=cl>org.springframework.security.web.access.intercept.
</span></span><span class=line><span class=cl>    FilterSecurityInterceptor@735167e1]
</span></span></code></pre></td></tr></table></div></div><p>我们看到<code>JwtFilter</code>被链接起来，这表明基本身份验证现在已被基于令牌的身份验证所覆盖。现在，让我们再次尝试访问端点<code>/token/create</code>。我们看到端点现在能够成功返回生成的令牌：</p><p><img loading=lazy src=https://reflectoring.io/images/posts/spring-security-and-jwt/token-200_hu1afdfcd5ac2b7dbf93da7780ca3a88cf_153716_2289x0_resize_box_3.png alt=设置></p><h3 id=保护图书馆应用程序端点>保护图书馆应用程序端点<a hidden class=anchor aria-hidden=true href=#保护图书馆应用程序端点>#</a></h3><p>现在，我们能够成功创建令牌，我们需要将此令牌传递给我们的库应用程序以成功调用<code>/library/books/all</code>。让我们添加一个带有生成的令牌值<code>Authorization</code>的类型的标头<code>Bearer Token</code>并触发请求。我们现在可以看到 200 OK 响应，如下所示：</p><p><img loading=lazy src=https://reflectoring.io/images/posts/spring-security-and-jwt/libapp_hu2a0d8de0272385ef40d228ea4e84c7e6_227142_2259x0_resize_box_3.png alt=设置></p><h3 id=使用-jwt-处理异常>使用 JWT 处理异常<a hidden class=anchor aria-hidden=true href=#使用-jwt-处理异常>#</a></h3><p>在本节中，我们将了解<code>io.jsonwebtoken</code>包中一些常见的异常：</p><ol><li><a href=https://javadoc.io/doc/io.jsonwebtoken/jjwt/0.9.1/io/jsonwebtoken/ExpiredJwtException.html target=_blank>ExpiredJwtException</a> - JWT token 包含过期时间，解析 token 时，如果已经超过过期时间，则会抛出 ExpiredJwtException。</li><li><a href=https://javadoc.io/doc/io.jsonwebtoken/jjwt/0.9.1/io/jsonwebtoken/UnsupportedJwtException.html target=_blank>UnsupportedJwtException</a> - 当收到的 JWT 格式不符合预期时，会抛出此异常。此错误最常见的用例是当我们尝试使用方法<code>Jwts.parserBuilder().setSigningKey(jwtProperties.getSecretKey()) .build().parseClaimsJwt</code>而不是<code>Jwts.parserBuilder().setSigningKey(jwtProperties.getSecretKey()) .build().parseClaimsJws</code></li><li><a href=https://javadoc.io/doc/io.jsonwebtoken/jjwt/0.9.1/io/jsonwebtoken/MalformedJwtException.html target=_blank>MalformedJwtException</a> - 此异常表示 JWT 构造不正确。</li><li><a href=https://javadoc.io/doc/io.jsonwebtoken/jjwt-api/latest/io/jsonwebtoken/IncorrectClaimException.html target=_blank>IncorrectClaimException</a> - 表示所需声明没有预期值。因此，JWT 无效。</li><li><a href=https://javadoc.io/doc/io.jsonwebtoken/jjwt-api/latest/io/jsonwebtoken/MissingClaimException.html target=_blank>MissingClaimException</a> - 此异常表示 JWT 中缺少所需声明，因此无效。</li></ol><p>通常，妥善处理与身份验证相关的异常被认为是一种很好的做法。在基本身份验证的情况下，Spring Security<strong>默认将添加<code>BasicAuthenticationEntryPoint</code>到安全过滤器链中，该过滤器链将基本身份验证相关错误包装为 401 Unauthorized。</strong> 同样，在我们的示例中，我们明确创建了<code>JwtAuthenticationEntryPoint</code>处理可能的身份验证错误，例如 Spring Security<code>BadCredentialsException</code>或 JJwt 的<code>MalformedJwtException</code>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Component</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Slf4j</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>JwtAuthenticationEntryPoint</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>AuthenticationEntryPoint</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>commence</span><span class=p>(</span><span class=n>HttpServletRequest</span><span class=w> </span><span class=n>request</span><span class=p>,</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>                         </span><span class=n>HttpServletResponse</span><span class=w> </span><span class=n>response</span><span class=p>,</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>                         </span><span class=n>AuthenticationException</span><span class=w> </span><span class=n>authException</span><span class=p>)</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>throws</span><span class=w> </span><span class=n>IOException</span><span class=p>,</span><span class=w> </span><span class=n>ServletException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Exception</span><span class=w> </span><span class=n>exception</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=p>)</span><span class=w> </span><span class=n>request</span><span class=p>.</span><span class=na>getAttribute</span><span class=p>(</span><span class=s>&#34;exception&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>response</span><span class=p>.</span><span class=na>setStatus</span><span class=p>(</span><span class=n>HttpServletResponse</span><span class=p>.</span><span class=na>SC_UNAUTHORIZED</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>response</span><span class=p>.</span><span class=na>setContentType</span><span class=p>(</span><span class=n>APPLICATION_JSON_VALUE</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>error</span><span class=p>(</span><span class=s>&#34;Authentication Exception: {} &#34;</span><span class=p>,</span><span class=w> </span><span class=n>exception</span><span class=p>,</span><span class=w> </span><span class=n>exception</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=n>data</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>HashMap</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>data</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=s>&#34;message&#34;</span><span class=p>,</span><span class=w> </span><span class=n>exception</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>?</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>exception</span><span class=p>.</span><span class=na>getMessage</span><span class=p>()</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>authException</span><span class=p>.</span><span class=na>getCause</span><span class=p>().</span><span class=na>toString</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>OutputStream</span><span class=w> </span><span class=n>out</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>response</span><span class=p>.</span><span class=na>getOutputStream</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ObjectMapper</span><span class=w> </span><span class=n>mapper</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ObjectMapper</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mapper</span><span class=p>.</span><span class=na>writeValue</span><span class=p>(</span><span class=n>out</span><span class=p>,</span><span class=w> </span><span class=n>data</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>out</span><span class=p>.</span><span class=na>flush</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>在我们的<code>JwtFilter</code>类中，我们将异常消息添加到<code>HttpServletRequest</code> <code>exception</code>属性中。这使我们能够使用<code>request.getAttribute("exception")</code>它并将其写入输出流。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>JwtFilter</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>OncePerRequestFilter</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=kd>protected</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>doFilterInternal</span><span class=p>(</span><span class=n>HttpServletRequest</span><span class=w> </span><span class=n>request</span><span class=p>,</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>                                   </span><span class=n>HttpServletResponse</span><span class=w> </span><span class=n>response</span><span class=p>,</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>                                   </span><span class=n>FilterChain</span><span class=w> </span><span class=n>filterChain</span><span class=p>)</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=kd>throws</span><span class=w> </span><span class=n>ServletException</span><span class=p>,</span><span class=w> </span><span class=n>IOException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=c1>//validate token here</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>ExpiredJwtException</span><span class=w> </span><span class=n>jwtException</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=n>request</span><span class=p>.</span><span class=na>setAttribute</span><span class=p>(</span><span class=s>&#34;exception&#34;</span><span class=p>,</span><span class=w> </span><span class=n>jwtException</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>BadCredentialsException</span><span class=w> </span><span class=o>|</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>               </span><span class=n>UnsupportedJwtException</span><span class=w> </span><span class=o>|</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>               </span><span class=n>MalformedJwtException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=n>log</span><span class=p>.</span><span class=na>error</span><span class=p>(</span><span class=s>&#34;Filter exception: {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>getMessage</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=n>request</span><span class=p>.</span><span class=na>setAttribute</span><span class=p>(</span><span class=s>&#34;exception&#34;</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>filterChain</span><span class=p>.</span><span class=na>doFilter</span><span class=p>(</span><span class=n>request</span><span class=p>,</span><span class=w> </span><span class=n>response</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><code>401 Unauthorized</code>通过这些更改，我们现在可以看到包含以下异常的异常消息：</p><p><img loading=lazy src=https://reflectoring.io/images/posts/spring-security-and-jwt/exceptionMsg_hu0ef44b42224611b0529dc9f021fe5962_199105_2281x0_resize_box_3.png alt=设置></p><p>但是，需要注意的是，<code>JwtFilter</code>只有通过 Spring Security 过滤器链保护的端点才会调用 。在我们的例子中，端点是<code>/library/books/all</code>。由于我们已经从 Spring Security 中排除了令牌端点<code>/token/create</code>，因此下面的异常处理<code>JwtAuthenticationEntryPoint</code>将不适用于此处。对于这种情况，我们将使用 Spring 的全局异常处理程序来处理异常。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@ControllerAdvice</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>GlobalExceptionHandler</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@ExceptionHandler</span><span class=p>({</span><span class=n>BadCredentialsException</span><span class=p>.</span><span class=na>class</span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>ResponseEntity</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=nf>handleBadCredentialsException</span><span class=p>(</span><span class=n>BadCredentialsException</span><span class=w> </span><span class=n>exception</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>ResponseEntity</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>status</span><span class=p>(</span><span class=n>HttpStatus</span><span class=p>.</span><span class=na>UNAUTHORIZED</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>body</span><span class=p>(</span><span class=n>exception</span><span class=p>.</span><span class=na>getMessage</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><code>401 Unauthorized</code>通过此异常处理，由于凭证不良而导致的异常现在将通过错误处理：</p><p><img loading=lazy src=https://reflectoring.io/images/posts/spring-security-and-jwt/badCreds_hucd5081ad18b5873959201d468ddc7064_124362_2315x0_resize_box_3.png alt=设置></p><h2 id=swagger-文档>Swagger 文档<a hidden class=anchor aria-hidden=true href=#swagger-文档>#</a></h2><p>在本节中，我们将了解如何为 JWT 配置 Open API。我们将添加以下 Maven 依赖项：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>   <span class=nt>&lt;groupId&gt;</span>org.springdoc<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>   <span class=nt>&lt;artifactId&gt;</span>springdoc-openapi-ui<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>   <span class=nt>&lt;version&gt;</span>1.7.0<span class=nt>&lt;/version&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>接下来，让我们添加以下配置：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@OpenAPIDefinition</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>info</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nd>@Info</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>title</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;Library application&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>description</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;Get all library books&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>version</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;1.0.0&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>license</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nd>@License</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;Apache 2.0&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>url</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;http://www.apache.org/licenses/LICENSE-2.0&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>)),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>security</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nd>@SecurityRequirement</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;bearerAuth&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@SecurityScheme</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;bearerAuth&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>description</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;JWT Authorization&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>scheme</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;bearer&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>type</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>SecuritySchemeType</span><span class=p>.</span><span class=na>HTTP</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>bearerFormat</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;JWT&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>in</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>SecuritySchemeIn</span><span class=p>.</span><span class=na>HEADER</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>OpenApiConfig</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>这里，使用一个或多个 来描述安全性<code>@SecurityScheme</code>。<code>type</code>此处定义的<code>SecuritySchemeType.HTTP</code>适用于基本身份验证和 JWT。其他属性（如 和<code>scheme</code>）<code>bearerFormat</code>依赖于此<code>type</code>属性。定义安全方案后，我们可以通过 <code>security</code>在根级别或操作级别添加 部分将它们应用于整个应用程序或单个操作。在我们的示例中，所有 API 操作都将使用 bearer token 身份验证方案。有关配置多个安全方案以及在 API 级别应用不同方案的更多信息，请参阅其<a href=https://swagger.io/docs/specification/authentication/ target=_blank>文档</a>。</p><p>接下来，让我们向控制器类添加一些基本的 swagger 注释，以便为 API 操作添加描述。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@RestController</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Tag</span><span class=p>(</span><span class=n>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;Library Controller&#34;</span><span class=p>,</span><span class=w> </span><span class=n>description</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;Get library books&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>BookController</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@RestController</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Tag</span><span class=p>(</span><span class=n>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;Create Token&#34;</span><span class=p>,</span><span class=w> </span><span class=n>description</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;Create Token&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>TokenController</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>此外，我们将使用以下属性来覆盖 Springdoc 的 Swagger-UI 加载的 URL。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>springdoc</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>swagger-ui</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/swagger-ui</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>通过此配置，Swagger UI 现在可在<code>http://localhost:8083/swagger-ui/index.html</code></p><p>让我们尝试运行该应用程序并在上述 URL 处加载 Swagger 页面。当我们尝试访问端点时，我们会看到以下内容：</p><p><img loading=lazy src=https://reflectoring.io/images/posts/spring-security-and-jwt/swagger-err_hub114a25cebe2b828a6c08c121cf7c80c_82728_1575x0_resize_box_3.png alt=设置></p><p><strong>这是因为应用程序中的所有端点都自动受到保护。我们需要一种方法来明确排除 swagger 端点不受保护。</strong> 我们可以通过在类中添加<code>WebSecurityCustomizer</code>bean 并排除 swagger 端点来实现这一点<code>SecurityConfiguration</code>。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>WebSecurityCustomizer</span><span class=w> </span><span class=nf>webSecurityCustomizer</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>web</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>web</span><span class=p>.</span><span class=na>ignoring</span><span class=p>().</span><span class=na>antMatchers</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>ArrayUtils</span><span class=p>.</span><span class=na>addAll</span><span class=p>(</span><span class=n>buildExemptedRoutes</span><span class=p>()));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=nf>buildExemptedRoutes</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=p>{</span><span class=s>&#34;/swagger-ui/**&#34;</span><span class=p>,</span><span class=s>&#34;/v3/api-docs/**&#34;</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>现在，当我们运行应用程序时，swagger 页面将按如下方式加载：</p><p><img loading=lazy src=https://reflectoring.io/images/posts/spring-security-and-jwt/swagger_hu3765d6a9b28cfd7c6275d84c2ebdf1fb_206904_3780x0_resize_box_3.png alt=设置></p><p>由于我们只有一个安全方案，因此我们将 JWT 令牌添加到<code>Authorize</code>swagger 页面顶部的按钮中：</p><p><img loading=lazy src=https://reflectoring.io/images/posts/spring-security-and-jwt/swagger-auth_hu6d3a081d8b8f4f335ce9b642a622ec72_141518_2817x0_resize_box_3.png alt=设置></p><p>设置了承载令牌后，让我们尝试访问<code>/library/books/all</code>端点：</p><p><img loading=lazy src=https://reflectoring.io/images/posts/spring-security-and-jwt/swagger-lib_hua571fd0f1b1cf18fa4cfe76ca9f1a0b5_158273_3560x0_resize_box_3.png alt=设置></p><p>这样，我们就成功地为我们的应用程序配置了 swagger 端点。</p><h2 id=添加-spring-security-测试>添加 Spring Security 测试<a hidden class=anchor aria-hidden=true href=#添加-spring-security-测试>#</a></h2><p>在我们的示例中，我们需要编写测试来测试我们的令牌端点，并为我们的库应用程序编写另一个测试。</p><p>让我们为测试添加一些必需的属性以及内存数据库来处理真实数据。测试<code>application.yml</code>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>spring</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>security</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>user</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>libUser</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>password</span><span class=p>:</span><span class=w> </span><span class=l>libPassword</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>datasource</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>driver-class-name</span><span class=p>:</span><span class=w> </span><span class=l>org.hsqldb.jdbc.JDBCDriver</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=l>jdbc:hsqldb:mem:testdb;DB_CLOSE_DELAY=-1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>username</span><span class=p>:</span><span class=w> </span><span class=l>sa</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>password</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>jwt</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>secretKey</span><span class=p>:</span><span class=w> </span><span class=l>5JzoMbk6E5qIqHSuBTgeQCARtUsxAkBiHwdjXOSW8kWdXzYmP3X51C0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>validity</span><span class=p>:</span><span class=w> </span><span class=m>600000</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>接下来，让我们编写测试来验证我们的令牌端点：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@SpringBootTest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@AutoConfigureMockMvc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>TokenControllerTest</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>MockMvc</span><span class=w> </span><span class=n>mvc</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>shouldNotAllowAccessToUnauthenticatedUsers</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>TokenRequest</span><span class=w> </span><span class=n>request</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>TokenRequest</span><span class=p>.</span><span class=na>builder</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>username</span><span class=p>(</span><span class=s>&#34;testUser&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>password</span><span class=p>(</span><span class=s>&#34;testPassword&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>build</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mvc</span><span class=p>.</span><span class=na>perform</span><span class=p>(</span><span class=n>MockMvcRequestBuilders</span><span class=p>.</span><span class=na>post</span><span class=p>(</span><span class=s>&#34;/token/create&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>.</span><span class=na>contentType</span><span class=p>(</span><span class=n>MediaType</span><span class=p>.</span><span class=na>APPLICATION_JSON</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>.</span><span class=na>content</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>ObjectMapper</span><span class=p>().</span><span class=na>writeValueAsString</span><span class=p>(</span><span class=n>request</span><span class=p>)))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>andExpect</span><span class=p>(</span><span class=n>status</span><span class=p>().</span><span class=na>isUnauthorized</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>shouldGenerateAuthToken</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>TokenRequest</span><span class=w> </span><span class=n>request</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>TokenRequest</span><span class=p>.</span><span class=na>builder</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>username</span><span class=p>(</span><span class=s>&#34;libUser&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>password</span><span class=p>(</span><span class=s>&#34;libPassword&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>build</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mvc</span><span class=p>.</span><span class=na>perform</span><span class=p>(</span><span class=n>MockMvcRequestBuilders</span><span class=p>.</span><span class=na>post</span><span class=p>(</span><span class=s>&#34;/token/create&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>.</span><span class=na>contentType</span><span class=p>(</span><span class=n>MediaType</span><span class=p>.</span><span class=na>APPLICATION_JSON</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>.</span><span class=na>content</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>ObjectMapper</span><span class=p>().</span><span class=na>writeValueAsString</span><span class=p>(</span><span class=n>request</span><span class=p>)))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>andExpect</span><span class=p>(</span><span class=n>status</span><span class=p>().</span><span class=na>isOk</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>在这里，我们将用来<code>@MockMvc</code>验证我们的<code>TokenController</code>类端点在正面和负面场景中是否按预期工作。</p><p>类似地，我们的<code>BookControllerTest</code>意愿是这样的：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@SpringBootTest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@AutoConfigureMockMvc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@SqlGroup</span><span class=p>({</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nd>@Sql</span><span class=p>(</span><span class=n>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;classpath:init/first.sql&#34;</span><span class=p>,</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>executionPhase</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>BEFORE_TEST_METHOD</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nd>@Sql</span><span class=p>(</span><span class=n>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;classpath:init/second.sql&#34;</span><span class=p>,</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>executionPhase</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>BEFORE_TEST_METHOD</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>BookControllerTest</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>MockMvc</span><span class=w> </span><span class=n>mockMvc</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>failsAsBearerTokenNotSet</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mockMvc</span><span class=p>.</span><span class=na>perform</span><span class=p>(</span><span class=n>get</span><span class=p>(</span><span class=s>&#34;/library/books/all&#34;</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>andDo</span><span class=p>(</span><span class=n>print</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>andExpect</span><span class=p>(</span><span class=n>status</span><span class=p>().</span><span class=na>isUnauthorized</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>testWithValidBearerToken</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>TokenRequest</span><span class=w> </span><span class=n>request</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>TokenRequest</span><span class=p>.</span><span class=na>builder</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>username</span><span class=p>(</span><span class=s>&#34;libUser&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>password</span><span class=p>(</span><span class=s>&#34;libPassword&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>build</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>MvcResult</span><span class=w> </span><span class=n>mvcResult</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mockMvc</span><span class=p>.</span><span class=na>perform</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>MockMvcRequestBuilders</span><span class=p>.</span><span class=na>post</span><span class=p>(</span><span class=s>&#34;/token/create&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>.</span><span class=na>contentType</span><span class=p>(</span><span class=n>MediaType</span><span class=p>.</span><span class=na>APPLICATION_JSON</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>.</span><span class=na>content</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>ObjectMapper</span><span class=p>().</span><span class=na>writeValueAsString</span><span class=p>(</span><span class=n>request</span><span class=p>)))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>andExpect</span><span class=p>(</span><span class=n>status</span><span class=p>().</span><span class=na>isOk</span><span class=p>()).</span><span class=na>andReturn</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>resultStr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mvcResult</span><span class=p>.</span><span class=na>getResponse</span><span class=p>().</span><span class=na>getContentAsString</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>TokenResponse</span><span class=w> </span><span class=n>token</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ObjectMapper</span><span class=p>().</span><span class=na>readValue</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>resultStr</span><span class=p>,</span><span class=w> </span><span class=n>TokenResponse</span><span class=p>.</span><span class=na>class</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mockMvc</span><span class=p>.</span><span class=na>perform</span><span class=p>(</span><span class=n>get</span><span class=p>(</span><span class=s>&#34;/library/books/all&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>.</span><span class=na>header</span><span class=p>(</span><span class=s>&#34;Authorization&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Bearer &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>token</span><span class=p>.</span><span class=na>getToken</span><span class=p>()))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>andDo</span><span class=p>(</span><span class=n>print</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>andExpect</span><span class=p>(</span><span class=n>status</span><span class=p>().</span><span class=na>isOk</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>andExpect</span><span class=p>(</span><span class=n>jsonPath</span><span class=p>(</span><span class=s>&#34;$&#34;</span><span class=p>,</span><span class=w> </span><span class=n>hasSize</span><span class=p>(</span><span class=n>5</span><span class=p>)));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>testWithInvalidBearerToken</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mockMvc</span><span class=p>.</span><span class=na>perform</span><span class=p>(</span><span class=n>get</span><span class=p>(</span><span class=s>&#34;/library/books/all&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>.</span><span class=na>header</span><span class=p>(</span><span class=s>&#34;Authorization&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Bearer 123&#34;</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>andDo</span><span class=p>(</span><span class=n>print</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>andExpect</span><span class=p>(</span><span class=n>status</span><span class=p>().</span><span class=na>isUnauthorized</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>为了测试应用程序端点，我们将使用 Spring<code>MockMvc</code>类并使用示例 SQL 脚本将数据加载到内存数据库中。为此，我们将使用注释<code>@SqlGroup</code>并将<code>@Sql</code>插入脚本放在<code>/resources/init</code>文件夹中。</p><p>为了验证端点是否成功运行<code>testWithValidBearerToken()</code>，我们将首先<code>/token/create</code> 使用 调用端点<code>MockMvc</code>，从响应中提取令牌，并将令牌设置在下<code>Authorization</code>一次调用的标头中<code>/library/books/all</code>。</p><h2 id=结论>结论<a hidden class=anchor aria-hidden=true href=#结论>#</a></h2><p>总而言之，在安全性方面，JWT 身份验证比 Spring 的基本身份验证领先一步。它是最受欢迎的身份验证和授权方式之一。在本文中，我们探讨了一些最佳实践、使用 JWT 的优势，并研究了如何配置一个简单的 Spring Boot 应用程序以使用 JWT 来确保安全性。</p><p>原文链接：<a href=https://reflectoring.io/spring-security-jwt/ target=_blank>https://reflectoring.io/spring-security-jwt/</a></p></div><footer class=post-footer><ul class=post-tags><li><a href=https://blog.chensoul.cc/tags/spring-security/>Spring-Security</a></li><li><a href=https://blog.chensoul.cc/tags/jwt/>Jwt</a></li></ul><nav class=paginav><a class=next href=https://blog.chensoul.cc/posts/2024/10/14/testing-spring-boot-applications-best-practices-and-frameworks/><span class=title>Next »</span><br><span>[译]测试 Spring Boot 应用程序：最佳实践和框架</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share [译]Spring Security 和 JWT 入门 on x" href="https://x.com/intent/tweet/?text=%5b%e8%af%91%5dSpring%20Security%20%e5%92%8c%20JWT%20%e5%85%a5%e9%97%a8&amp;url=https%3a%2f%2fblog.chensoul.cc%2fposts%2f2024%2f10%2f15%2fspring-security-jwt%2f&amp;hashtags=spring-security%2cjwt"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share [译]Spring Security 和 JWT 入门 on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fblog.chensoul.cc%2fposts%2f2024%2f10%2f15%2fspring-security-jwt%2f&amp;title=%5b%e8%af%91%5dSpring%20Security%20%e5%92%8c%20JWT%20%e5%85%a5%e9%97%a8&amp;summary=%5b%e8%af%91%5dSpring%20Security%20%e5%92%8c%20JWT%20%e5%85%a5%e9%97%a8&amp;source=https%3a%2f%2fblog.chensoul.cc%2fposts%2f2024%2f10%2f15%2fspring-security-jwt%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share [译]Spring Security 和 JWT 入门 on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fblog.chensoul.cc%2fposts%2f2024%2f10%2f15%2fspring-security-jwt%2f&title=%5b%e8%af%91%5dSpring%20Security%20%e5%92%8c%20JWT%20%e5%85%a5%e9%97%a8"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share [译]Spring Security 和 JWT 入门 on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fblog.chensoul.cc%2fposts%2f2024%2f10%2f15%2fspring-security-jwt%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share [译]Spring Security 和 JWT 入门 on whatsapp" href="https://api.whatsapp.com/send?text=%5b%e8%af%91%5dSpring%20Security%20%e5%92%8c%20JWT%20%e5%85%a5%e9%97%a8%20-%20https%3a%2f%2fblog.chensoul.cc%2fposts%2f2024%2f10%2f15%2fspring-security-jwt%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share [译]Spring Security 和 JWT 入门 on telegram" href="https://telegram.me/share/url?text=%5b%e8%af%91%5dSpring%20Security%20%e5%92%8c%20JWT%20%e5%85%a5%e9%97%a8&amp;url=https%3a%2f%2fblog.chensoul.cc%2fposts%2f2024%2f10%2f15%2fspring-security-jwt%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share [译]Spring Security 和 JWT 入门 on ycombinator" href="https://news.ycombinator.com/submitlink?t=%5b%e8%af%91%5dSpring%20Security%20%e5%92%8c%20JWT%20%e5%85%a5%e9%97%a8&u=https%3a%2f%2fblog.chensoul.cc%2fposts%2f2024%2f10%2f15%2fspring-security-jwt%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://blog.chensoul.cc/>ChenSoul</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script async src=https://umami.chensoul.cc/random-string.js data-website-id=821c25f8-a31a-4607-92d7-91ee76843d00></script><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>